---
title: "Results publication"
author: "Jens Daniel MÃ¼ller"
date:  "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  workflowr::wflow_html:
    number_sections: true
    toc_depth: 3
    toc_float:
      collapsed: false
editor_options:
  chunk_output_type: console
---

```{r parent, child = "/nfs/kryo/work/jenmueller/emlr_cant/utilities/setup_obs.Rmd"}
# this chunk runs the code stored in setup.Rmd
# if required, please refer to instructions given here:
# https://jdblischak.github.io/workflowr/articles/wflow-07-common-code.html
```

# Libraries


```{r load_libraries_specific, include = FALSE}
library(patchwork)
library(ggalluvial)
library(marelac)
```


# Read files

## Paths and Versions

```{r define_paths, include = FALSE}

# only path_observations needs to be changed to model
path_observations <-
  paste(path_root, "/observations/", sep = "")

path_preprocessing    <-
  paste(path_observations, "preprocessing/", sep = "")


path_preprocessing_model    <-
  paste(path_root, "/model/preprocessing/", sep = "")

```


```{r define_Version_IDs}

version_id_pattern <- "103"

# identify required version IDs

Version_IDs_1 <- list.files(path = "/nfs/kryo/work/jenmueller/emlr_cant/observations",
                            pattern = paste0("v_1", version_id_pattern))

Version_IDs_2 <- list.files(path = "/nfs/kryo/work/jenmueller/emlr_cant/observations",
                            pattern = paste0("v_2", version_id_pattern))

Version_IDs_3 <- list.files(path = "/nfs/kryo/work/jenmueller/emlr_cant/observations",
                            pattern = paste0("v_3", version_id_pattern))

Version_IDs <- c(Version_IDs_1, Version_IDs_2, Version_IDs_3)

print(Version_IDs)

```

```{r define_Version_IDs_ensemble}

version_id_pattern <- "1"

# identify required version IDs

Version_IDs_1 <- list.files(path = "/nfs/kryo/work/jenmueller/emlr_cant/observations",
                            pattern = paste0("v_1", version_id_pattern))

Version_IDs_2 <- list.files(path = "/nfs/kryo/work/jenmueller/emlr_cant/observations",
                            pattern = paste0("v_2", version_id_pattern))

Version_IDs_3 <- list.files(path = "/nfs/kryo/work/jenmueller/emlr_cant/observations",
                            pattern = paste0("v_3", version_id_pattern))

Version_IDs_b <- c(Version_IDs_1, Version_IDs_2, Version_IDs_3)

version_id_pattern <- "o"

# identify required version IDs

Version_IDs_1 <- list.files(path = "/nfs/kryo/work/jenmueller/emlr_cant/observations",
                            pattern = paste0("v_1", version_id_pattern))

Version_IDs_2 <- list.files(path = "/nfs/kryo/work/jenmueller/emlr_cant/observations",
                            pattern = paste0("v_2", version_id_pattern))

Version_IDs_3 <- list.files(path = "/nfs/kryo/work/jenmueller/emlr_cant/observations",
                            pattern = paste0("v_3", version_id_pattern))

Version_IDs_o <- c(Version_IDs_1, Version_IDs_2, Version_IDs_3)

Version_IDs_ensemble <- c(Version_IDs_b, Version_IDs_o)

```

## Parameters

```{r read_parameters}

for (i_Version_IDs in Version_IDs) {
  path_version_data     <-
    paste(path_observations,
          i_Version_IDs,
          "/data/",
          sep = "")
  
  params_local <-
    read_rds(paste(path_version_data,
                   "params_local.rds",
                   sep = ""))
  
  params_local <- bind_cols(
    Version_ID = i_Version_IDs,
    tref1 = params_local$tref1,
    tref2 = params_local$tref2
  )
  
  tref <- read_csv(paste(path_version_data,
                         "tref.csv",
                         sep = ""))
  
  params_local <- params_local %>%
    mutate(
      median_year_1 = sort(tref$median_year)[1],
      median_year_2 = sort(tref$median_year)[2],
      duration = median_year_2 - median_year_1,
      period = paste(median_year_1, "-", median_year_2)
    )
  if (exists("params_local_all")) {
    params_local_all <- bind_rows(params_local_all, params_local)
  }
  
  if (!exists("params_local_all")) {
    params_local_all <- params_local
  }
  
  
}

rm(params_local,
   tref)

params_local_all <- params_local_all %>% 
  select(Version_ID, period, tref1, tref2)

```

```{r read_parameters_ensemble}

for (i_Version_IDs in Version_IDs_ensemble) {
  path_version_data     <-
    paste(path_observations,
          i_Version_IDs,
          "/data/",
          sep = "")
  
  params_local <-
    read_rds(paste(path_version_data,
                   "params_local.rds",
                   sep = ""))
  
  params_local <- bind_cols(
    Version_ID = i_Version_IDs,
    tref1 = params_local$tref1,
    tref2 = params_local$tref2
  )
  
  tref <- read_csv(paste(path_version_data,
                         "tref.csv",
                         sep = ""))
  
  params_local <- params_local %>%
    mutate(
      median_year_1 = sort(tref$median_year)[1],
      median_year_2 = sort(tref$median_year)[2],
      duration = median_year_2 - median_year_1,
      period = paste(median_year_1, "-", median_year_2)
    )
  
  if (exists("params_local_all_ensemble")) {
    params_local_all_ensemble <- bind_rows(params_local_all_ensemble, params_local)
  }
  
  if (!exists("params_local_all_ensemble")) {
    params_local_all_ensemble <- params_local
  }
  
  
}

rm(params_local,
   tref)

params_local_all_ensemble <- params_local_all_ensemble %>% 
  select(Version_ID, period, tref1, tref2)

```


## Budgets

```{r read_budget_files_global}

for (i_Version_IDs in Version_IDs) {
  # i_Version_IDs <- Version_IDs[1]
  
  path_version_data     <-
    paste(path_observations,
          i_Version_IDs,
          "/data/",
          sep = "")
  
  # load and join data files
  
  dcant_budget_global <-
    read_csv(paste(path_version_data,
                   "dcant_budget_global.csv",
                   sep = ""))
  
  dcant_budget_global_mod_truth <-
    read_csv(paste(
      path_version_data,
      "dcant_budget_global_mod_truth.csv",
      sep = ""
    ))
  # 
  # dcant_budget_global_bias <-
  #   read_csv(paste(path_version_data,
  #                  "dcant_budget_global_bias.csv",
  #                  sep = ""))
  # 
  # lm_best_predictor_counts <-
  #   read_csv(paste(path_version_data,
  #                  "lm_best_predictor_counts.csv",
  #                  sep = ""))
  # 
  # lm_best_dcant <-
  #   read_csv(paste(path_version_data,
  #                  "lm_best_dcant.csv",
  #                  sep = ""))
  
  dcant_budget_global <- bind_rows(dcant_budget_global,
                                      dcant_budget_global_mod_truth)
  
  dcant_budget_global <- dcant_budget_global %>%
    mutate(Version_ID = i_Version_IDs)
  
  # dcant_budget_global_bias <- dcant_budget_global_bias %>%
  #   mutate(Version_ID = i_Version_IDs)
  # 
  # lm_best_predictor_counts <- lm_best_predictor_counts %>%
  #   mutate(Version_ID = i_Version_IDs)
  # 
  # lm_best_dcant <- lm_best_dcant %>%
  #   mutate(Version_ID = i_Version_IDs)

  if (exists("dcant_budget_global_all")) {
    dcant_budget_global_all <-
      bind_rows(dcant_budget_global_all, dcant_budget_global)
  }
  
  if (!exists("dcant_budget_global_all")) {
    dcant_budget_global_all <- dcant_budget_global
  }
  
  # if (exists("dcant_budget_global_bias_all")) {
  #   dcant_budget_global_bias_all <-
  #     bind_rows(dcant_budget_global_bias_all,
  #               dcant_budget_global_bias)
  # }
  # 
  # if (!exists("dcant_budget_global_bias_all")) {
  #   dcant_budget_global_bias_all <- dcant_budget_global_bias
  # }
  # 
  #   
  # if (exists("lm_best_predictor_counts_all")) {
  #   lm_best_predictor_counts_all <-
  #     bind_rows(lm_best_predictor_counts_all, lm_best_predictor_counts)
  # }
  # 
  # if (!exists("lm_best_predictor_counts_all")) {
  #   lm_best_predictor_counts_all <- lm_best_predictor_counts
  # }
  #   
  # if (exists("lm_best_dcant_all")) {
  #   lm_best_dcant_all <-
  #     bind_rows(lm_best_dcant_all, lm_best_dcant)
  # }
  # 
  # if (!exists("lm_best_dcant_all")) {
  #   lm_best_dcant_all <- lm_best_dcant
  # }
  # 
  # if (exists("params_local_all")) {
  #   params_local_all <- bind_rows(params_local_all, params_local)
  # }
  # 
  # if (!exists("params_local_all")) {
  #   params_local_all <- params_local
  # }
  # 
  
}

rm(
  dcant_budget_global,
  # dcant_budget_global_bias,
  dcant_budget_global_mod_truth
  # lm_best_predictor_counts,
  # lm_best_dcant
)

```


```{r read_budget_files_basins_hemisphere}

for (i_Version_IDs in Version_IDs) {
  # i_Version_IDs <- Version_IDs[1]
  
  print(i_Version_IDs)
  
  path_version_data     <-
    paste(path_observations,
          i_Version_IDs,
          "/data/",
          sep = "")
  
  # load and join data files
  
  dcant_budget_basin_MLR <-
    read_csv(paste(path_version_data,
                   "dcant_budget_basin_MLR.csv",
                   sep = ""))
  
  dcant_budget_basin_MLR_mod_truth <-
    read_csv(paste(
      path_version_data,
      "dcant_budget_basin_MLR_mod_truth.csv",
      sep = ""
    ))
  
    
  dcant_budget_basin_MLR <- bind_rows(dcant_budget_basin_MLR,
                                      dcant_budget_basin_MLR_mod_truth)
  
  dcant_budget_basin_MLR <- dcant_budget_basin_MLR %>%
    mutate(Version_ID = i_Version_IDs)
  

  if (exists("dcant_budget_basin_MLR_all")) {
    dcant_budget_basin_MLR_all <-
      bind_rows(dcant_budget_basin_MLR_all, dcant_budget_basin_MLR)
  }
  
  if (!exists("dcant_budget_basin_MLR_all")) {
    dcant_budget_basin_MLR_all <- dcant_budget_basin_MLR
  }

}

rm(
  dcant_budget_basin_MLR,
  dcant_budget_basin_MLR_mod_truth
)


```

```{r read_budget_files_basins_hemisphere_ensemble}

for (i_Version_IDs in Version_IDs_ensemble) {
  # i_Version_IDs <- Version_IDs[1]
  
  print(i_Version_IDs)
  
  path_version_data     <-
    paste(path_observations,
          i_Version_IDs,
          "/data/",
          sep = "")
  
  # load and join data files
  
  dcant_budget_basin_MLR_ensemble <-
    read_csv(paste(path_version_data,
                   "dcant_budget_basin_MLR.csv",
                   sep = ""))
  
  dcant_budget_basin_MLR_mod_truth_ensemble <-
    read_csv(paste(
      path_version_data,
      "dcant_budget_basin_MLR_mod_truth.csv",
      sep = ""
    ))
  
    
  dcant_budget_basin_MLR_ensemble <- bind_rows(dcant_budget_basin_MLR_ensemble,
                                      dcant_budget_basin_MLR_mod_truth_ensemble)
  
  dcant_budget_basin_MLR_ensemble <- dcant_budget_basin_MLR_ensemble %>%
    mutate(Version_ID = i_Version_IDs)
  

  if (exists("dcant_budget_basin_MLR_all_ensemble")) {
    dcant_budget_basin_MLR_all_ensemble <-
      bind_rows(dcant_budget_basin_MLR_all_ensemble, dcant_budget_basin_MLR_ensemble)
  }
  
  if (!exists("dcant_budget_basin_MLR_all_ensemble")) {
    dcant_budget_basin_MLR_all_ensemble <- dcant_budget_basin_MLR_ensemble
  }

}

rm(
  dcant_budget_basin_MLR_ensemble,
  dcant_budget_basin_MLR_mod_truth_ensemble
)


```

```{r join_budget_data_and_meta_data, include=FALSE}


dcant_budget_global_all <- full_join(dcant_budget_global_all,
                                     params_local_all)

# dcant_budget_global_bias_all <-
#   full_join(dcant_budget_global_bias_all,
#             params_local_all)
# 
# 
# dcant_budget_basin_AIP_all <- full_join(dcant_budget_basin_AIP_all,
#                                         params_local_all)
# 
# dcant_budget_basin_AIP_bias_all <-
#   full_join(dcant_budget_basin_AIP_bias_all,
#             params_local_all)


dcant_budget_basin_MLR_all <- dcant_budget_basin_MLR_all %>%
  filter(MLR_basins == "5") %>% 
  select(-MLR_basins)

dcant_budget_basin_MLR_all <- full_join(dcant_budget_basin_MLR_all,
                                        params_local_all)


dcant_budget_basin_MLR_all_ensemble <- dcant_budget_basin_MLR_all_ensemble %>%
  filter(MLR_basins == "5") %>% 
  select(-MLR_basins)

dcant_budget_basin_MLR_all_ensemble <- full_join(dcant_budget_basin_MLR_all_ensemble,
                                        params_local_all_ensemble)

# dcant_slab_budget_all <- full_join(dcant_slab_budget_all,
#                                         params_local_all)
# 
# dcant_slab_budget_bias_all <-
#   full_join(dcant_slab_budget_bias_all,
#             params_local_all)
# 
# 
# dcant_obs_budget_all <- full_join(dcant_obs_budget_all,
#                              params_local_all)


```


```{r filter_standard_inventory_depth_global}

dcant_budget_global_all <- dcant_budget_global_all %>%
  filter(estimate == "dcant", 
         method == "total") %>% 
  select(-c(estimate, method)) %>% 
  rename(dcant = value)

# dcant_budget_global_all_depth <- dcant_budget_global_all

dcant_budget_global_all <- dcant_budget_global_all %>%
  filter(inv_depth == params_global$inventory_depth_standard)

# dcant_budget_global_bias_all <- dcant_budget_global_bias_all %>%
#   filter(estimate == "dcant") %>%
#   select(-c(estimate))

# dcant_budget_global_bias_all_depth <- dcant_budget_global_bias_all
# 
# dcant_budget_global_bias_all <- dcant_budget_global_bias_all %>%
#   filter(inv_depth == params_global$inventory_depth_standard)

```

```{r filter_standard_inventory_depth_basins_hemisphere}

dcant_budget_basin_MLR_all <- dcant_budget_basin_MLR_all %>%
  filter(estimate == "dcant", 
         method == "total") %>% 
  select(-c(estimate, method)) %>% 
  rename(dcant = value)

dcant_budget_basin_MLR_all <- dcant_budget_basin_MLR_all %>%
  filter(inv_depth == params_global$inventory_depth_standard)

dcant_budget_basin_MLR_all_ensemble <- dcant_budget_basin_MLR_all_ensemble %>%
  filter(estimate == "dcant", 
         method == "total") %>% 
  select(-c(estimate, method)) %>% 
  rename(dcant = value)

dcant_budget_basin_MLR_all_ensemble <- dcant_budget_basin_MLR_all_ensemble %>%
  filter(inv_depth == params_global$inventory_depth_standard)

```



## Inventories

```{r read_inventory_files_ensemble}

for (i_Version_IDs in Version_IDs_ensemble) {
  # i_Version_IDs <- Version_IDs[1]
  
  path_version_data     <-
    paste(path_observations,
          i_Version_IDs,
          "/data/",
          sep = "")
  
  # load and join data files
  
  dcant_inv <-
    read_csv(paste(path_version_data,
                   "dcant_inv.csv",
                   sep = ""))
  
  dcant_inv_mod_truth <-
    read_csv(paste(path_version_data,
                   "dcant_inv_mod_truth.csv",
                   sep = "")) %>%
    filter(method == "total") %>%
    select(-method)
  
  dcant_inv_bias <-
    read_csv(paste(path_version_data,
                   "dcant_inv_bias.csv",
                   sep = "")) %>%
    mutate(Version_ID = i_Version_IDs)
  
  dcant_inv <- bind_rows(dcant_inv,
                         dcant_inv_mod_truth) %>%
    mutate(Version_ID = i_Version_IDs)
  
  dcant_budget_lat_grid <-
    read_csv(paste(path_version_data,
                   "dcant_budget_lat_grid.csv",
                   sep = "")) %>%
    mutate(Version_ID = i_Version_IDs)
  
  dcant_budget_lon_grid <-
    read_csv(paste(path_version_data,
                   "dcant_budget_lon_grid.csv",
                   sep = "")) %>%
    mutate(Version_ID = i_Version_IDs)
  if (exists("dcant_inv_all")) {
    dcant_inv_all <- bind_rows(dcant_inv_all, dcant_inv)
  }
  
  if (!exists("dcant_inv_all")) {
    dcant_inv_all <- dcant_inv
  }
  
  if (exists("dcant_inv_bias_all")) {
    dcant_inv_bias_all <- bind_rows(dcant_inv_bias_all, dcant_inv_bias)
  }
  
  if (!exists("dcant_inv_bias_all")) {
    dcant_inv_bias_all <- dcant_inv_bias
  }
  
  if (exists("dcant_budget_lat_grid_all")) {
    dcant_budget_lat_grid_all <- bind_rows(dcant_budget_lat_grid_all, dcant_budget_lat_grid)
  }
  
  if (!exists("dcant_budget_lat_grid_all")) {
    dcant_budget_lat_grid_all <- dcant_budget_lat_grid
  }
  
  if (exists("dcant_budget_lon_grid_all")) {
    dcant_budget_lon_grid_all <- bind_rows(dcant_budget_lon_grid_all, dcant_budget_lon_grid)
  }
  
  if (!exists("dcant_budget_lon_grid_all")) {
    dcant_budget_lon_grid_all <- dcant_budget_lon_grid
  }
}

rm(dcant_inv,
   dcant_inv_bias,
   dcant_inv_mod_truth,
   dcant_budget_lat_grid,
   dcant_budget_lon_grid)

```

```{r filter_standard_inventory_depth_inventory}

dcant_inv_all <- dcant_inv_all %>%
  filter(inv_depth == params_global$inventory_depth_standard)

dcant_budget_lat_grid_all <- dcant_budget_lat_grid_all %>% 
  filter(inv_depth == params_global$inventory_depth_standard)

dcant_budget_lon_grid_all <- dcant_budget_lon_grid_all %>% 
  filter(inv_depth == params_global$inventory_depth_standard)

```

```{r r join_iventory_data_and_meta_data, include=FALSE}


dcant_inv_all <- full_join(dcant_inv_all,
                           params_local_all_ensemble)

dcant_inv_bias_all <- full_join(dcant_inv_bias_all,
                                params_local_all_ensemble)


dcant_budget_lat_grid_all <- full_join(dcant_budget_lat_grid_all,
                                       params_local_all_ensemble)

dcant_budget_lon_grid_all <- full_join(dcant_budget_lon_grid_all,
                                       params_local_all_ensemble)

```

```{r adapt_iventory_format}

dcant_budget_lat_grid_all <- dcant_budget_lat_grid_all %>%
  pivot_wider(names_from = estimate,
              values_from = value) %>%
  filter(period != "1994 - 2014",
         method == "total")

dcant_budget_lon_grid_all <- dcant_budget_lon_grid_all %>%
  pivot_wider(names_from = estimate,
              values_from = value) %>%
  filter(period != "1994 - 2014",
         method == "total")


```


```{r r distuinguish_standard_case_and_ensemble, include=FALSE}


dcant_inv_bias_all_ensemble <- dcant_inv_bias_all
dcant_inv_bias_all <- dcant_inv_bias_all %>% 
  filter(Version_ID %in% Version_IDs)


dcant_budget_lat_grid_all_ensemble <- dcant_budget_lat_grid_all
dcant_budget_lat_grid_all <- dcant_budget_lat_grid_all %>% 
  filter(Version_ID %in% Version_IDs)


dcant_budget_lon_grid_all_ensemble <- dcant_budget_lon_grid_all
dcant_budget_lon_grid_all <- dcant_budget_lon_grid_all %>% 
  filter(Version_ID %in% Version_IDs)

```


## Zonal sections

```{r read_zonal_section_files}

for (i_Version_IDs in Version_IDs) {

  path_version_data     <-
  paste(path_observations,
        i_Version_IDs,
        "/data/",
        sep = "")
  
  # load and join data files
  
  dcant_zonal <-
    read_csv(paste(path_version_data,
                   "dcant_zonal.csv",
                   sep = ""))
  
  dcant_zonal_mod_truth <-
    read_csv(paste(path_version_data,
                   "dcant_zonal_mod_truth.csv",
                   sep = ""))
  
  dcant_zonal <- bind_rows(dcant_zonal,
                         dcant_zonal_mod_truth)
  
  dcant_profile <-
    read_csv(paste(path_version_data,
                   "dcant_profile.csv",
                   sep = ""))
  
  dcant_profile_mod_truth <-
    read_csv(paste(path_version_data,
                   "dcant_profile_mod_truth.csv",
                   sep = ""))
  
  
  dcant_profile_basin_MLR <-
    read_csv(paste(path_version_data,
                   "dcant_profile_basin_MLR.csv",
                   sep = ""))
  
  dcant_profile <- bind_rows(dcant_profile,
                             dcant_profile_mod_truth)
  
  dcant_budget_basin_AIP_layer <-
    read_csv(paste(path_version_data,
                   "dcant_budget_basin_AIP_layer.csv",
                   sep = ""))

  dcant_budget_basin_MLR_layer <-
    read_csv(paste(path_version_data,
                   "dcant_budget_basin_MLR_layer.csv",
                   sep = ""))
  
  dcant_zonal_bias <-
    read_csv(paste(path_version_data,
                   "dcant_zonal_bias.csv",
                   sep = ""))
  

  dcant_zonal <- dcant_zonal %>% 
    mutate(Version_ID = i_Version_IDs)
  
  dcant_profile <- dcant_profile %>% 
    mutate(Version_ID = i_Version_IDs)

  dcant_profile_basin_MLR <- dcant_profile_basin_MLR %>% 
    mutate(Version_ID = i_Version_IDs)
  
  dcant_budget_basin_AIP_layer <- dcant_budget_basin_AIP_layer %>% 
    mutate(Version_ID = i_Version_IDs)
  
  dcant_budget_basin_MLR_layer <- dcant_budget_basin_MLR_layer %>% 
    mutate(Version_ID = i_Version_IDs)
  
  dcant_zonal_bias <- dcant_zonal_bias %>% 
    mutate(Version_ID = i_Version_IDs)

  
  if (exists("dcant_zonal_all")) {
    dcant_zonal_all <- bind_rows(dcant_zonal_all, dcant_zonal)
  }
  
  if (!exists("dcant_zonal_all")) {
    dcant_zonal_all <- dcant_zonal
  }

  if (exists("dcant_profile_all")) {
    dcant_profile_all <- bind_rows(dcant_profile_all, dcant_profile)
  }
  
  if (!exists("dcant_profile_all")) {
    dcant_profile_all <- dcant_profile
  }

  if (exists("dcant_profile_basin_MLR_all")) {
    dcant_profile_basin_MLR_all <- bind_rows(dcant_profile_basin_MLR_all, dcant_profile_basin_MLR)
  }
  
  if (!exists("dcant_profile_basin_MLR_all")) {
    dcant_profile_basin_MLR_all <- dcant_profile_basin_MLR
  }

  if (exists("dcant_budget_basin_AIP_layer_all")) {
    dcant_budget_basin_AIP_layer_all <-
      bind_rows(dcant_budget_basin_AIP_layer_all,
                dcant_budget_basin_AIP_layer)
  }
  
  if (!exists("dcant_budget_basin_AIP_layer_all")) {
    dcant_budget_basin_AIP_layer_all <- dcant_budget_basin_AIP_layer
  }

  if (exists("dcant_budget_basin_MLR_layer_all")) {
    dcant_budget_basin_MLR_layer_all <-
      bind_rows(dcant_budget_basin_MLR_layer_all,
                dcant_budget_basin_MLR_layer)
  }
  
  if (!exists("dcant_budget_basin_MLR_layer_all")) {
    dcant_budget_basin_MLR_layer_all <- dcant_budget_basin_MLR_layer
  }

  if (exists("dcant_zonal_bias_all")) {
    dcant_zonal_bias_all <- bind_rows(dcant_zonal_bias_all, dcant_zonal_bias)
  }
  
  if (!exists("dcant_zonal_bias_all")) {
    dcant_zonal_bias_all <- dcant_zonal_bias
  }

}

rm(dcant_zonal, dcant_zonal_bias, dcant_zonal_mod_truth,
   dcant_budget_basin_AIP_layer, dcant_budget_basin_MLR_layer)

```

```{r r join_zonal_section_data_and_meta_data, include=FALSE}

dcant_zonal_all <- full_join(dcant_zonal_all,
                             params_local_all)

dcant_profile_all <- full_join(dcant_profile_all,
                               params_local_all)

dcant_profile_basin_MLR_all <- full_join(dcant_profile_basin_MLR_all,
                               params_local_all)


dcant_budget_basin_AIP_layer_all <-
  full_join(dcant_budget_basin_AIP_layer_all,
            params_local_all)

dcant_budget_basin_MLR_layer_all <- dcant_budget_basin_MLR_layer_all %>%
  filter(MLR_basins == "5") %>% 
  select(-MLR_basins)

dcant_budget_basin_MLR_layer_all <-
  full_join(dcant_budget_basin_MLR_layer_all,
            params_local_all)

dcant_zonal_bias_all <- full_join(dcant_zonal_bias_all,
                                  params_local_all)

```

## Observations coverage

```{r read_coverage_grid_files}


for (i_Version_IDs in Version_IDs) {
  path_version_data     <-
    paste(path_observations,
          i_Version_IDs,
          "/data/",
          sep = "")
  
  # load and join data files
  
  GLODAP_grid_era  <-
    read_csv(paste(
      path_version_data,
      "GLODAPv2.2020_clean_obs_grid_era.csv",
      sep = ""
    ))
  
  
  GLODAP_grid_era <- GLODAP_grid_era %>%
    mutate(Version_ID = i_Version_IDs)
  
  if (exists("GLODAP_grid_era_all")) {
    GLODAP_grid_era_all <-
      bind_rows(GLODAP_grid_era_all, GLODAP_grid_era)
  }
  
  if (!exists("GLODAP_grid_era_all")) {
    GLODAP_grid_era_all <- GLODAP_grid_era
  }
  
}

rm(GLODAP_grid_era)

GLODAP_grid_era_all <- full_join(GLODAP_grid_era_all,
                                 params_local_all)

```



## Atm CO2

```{r read_atm_co2}

co2_atm <-
  read_csv(paste(path_preprocessing,
                 "co2_atm.csv",
                 sep = ""))

co2_atm_reccap2 <-
  read_csv(paste(path_preprocessing,
                  "co2_atm_reccap2.csv",
                  sep = ""))

```

## Sabine total Cant

```{r Sabine_tCant}


tcant_inv <-
  read_csv(paste(path_preprocessing,
                  "S04_tcant_inv.csv", sep = ""))

tcant_inv <- tcant_inv %>% 
  filter(inv_depth == 3000) %>% 
  rename(dcant = tcant,
         dcant_pos = tcant_pos) %>% 
  mutate(tref1 = 1800,
         tref2 = 1994)

```

## Surface flux products

```{r read_RECCAP2_flux_products_observations}

RECCAP2_fgco2_glob_all_annual_obs <-
  read_csv(paste0(path_preprocessing,
                   "fgco2_glob_RECCAP2_all_annual.csv"))

```

```{r read_RECCAP2_flux_products_models}

RECCAP2_fgco2_glob_all_annual_mod <-
  read_csv(paste0(path_preprocessing_model,
                   "RECCAP2_fgco2_glob_all_annual.csv"))

```


```{r read_SeaFlux_flux_products_observations}

SeaFlux_fgco2_glob_all_annual_obs <-
  read_csv(paste0(path_preprocessing,
                   "fgco2_glob_Seaflux_annual.csv"))

```


# Define labels

```{r define_legend_titles}

dcant_pgc_label <- expression(Delta * C["ant"]~(PgC))
dcant_pgc_scaled_label <- expression(beta~(PgC~Âµatm^{-1}))

dcant_umol_label <- expression(Delta * C[ant]~(mu * mol ~ kg ^ {-1}))
ddcant_umol_label <- expression(Delta * Delta * C[ant]~(mu * mol ~ kg ^ {-1}))

dcant_layer_budget_label <- 
  expression(Delta ~ C[ant] ~ "budget per 500m depth layer (PgC)")

```

# Coverage maps

```{r coverage_maps}

coverage_map <- map +
  geom_tile(data = GLODAP_grid_era_all,
            aes(lon, lat)) +
  facet_grid(. ~ era) +
  theme(axis.text = element_blank(),
        axis.ticks = element_blank())

coverage_map

# ggsave(plot = coverage_map,
#        path = "output/publication",
#        filename = "FigS_coverage_map_observations.png",
#        height = 2,
#        width = 8)

```



# Inventory maps

## Absoulte values

### dcant - absolute

```{r calculate_scaled_inventories}

dcant_inv_all <- dcant_inv_all %>%
  filter(data_source %in% c("obs"),
         period != "1994 - 2014")

dcant_inv_all <- left_join(dcant_inv_all,
                           co2_atm %>% rename(tref1 = year,
                                              pCO21 = pCO2))

dcant_inv_all <- left_join(dcant_inv_all,
                           co2_atm %>% rename(tref2 = year,
                                              pCO22 = pCO2))


tcant_inv <- tcant_inv %>% 
  mutate(pCO21 = 280)

tcant_inv <- left_join(tcant_inv,
                       co2_atm %>% rename(tref2 = year,
                                          pCO22 = pCO2))

dcant_inv_all <- bind_rows(
  dcant_inv_all,
  tcant_inv %>% mutate(period = paste(tref1, tref2, sep = " - "))
)


dcant_inv_all <- dcant_inv_all %>% 
  mutate(delta_pCO2 = pCO22 - pCO21,
         beta = dcant / delta_pCO2,
         beta_pos = dcant_pos / delta_pCO2) %>% 
  select(-starts_with("pCO2"))

dcant_inv_all_ensemble <- dcant_inv_all

unique(dcant_inv_all$Version_ID)

dcant_inv_all <- dcant_inv_all %>% 
  filter(Version_ID %in% Version_IDs | is.na(Version_ID))


```


```{r invetory_maps_absolute, fig.asp=1.2}


dcant_inv_all %>%
  p_map_cant_inv(var = "dcant") +
  facet_grid(period ~ .) +
  theme(axis.text = element_blank(),
        axis.ticks = element_blank())

dcant_inv_all %>%
  p_map_cant_inv(var = "beta",
                 breaks = c(-Inf, seq(0, 1, 0.1), Inf),) +
  facet_grid(period ~ .) +
  theme(axis.text = element_blank(),
        axis.ticks = element_blank())

dcant_inv_all %>%
  filter(period != "1800 - 1994") %>% 
  p_map_cant_inv(var = "beta",
                 breaks = c(-Inf, seq(0, 1, 0.1), Inf),) +
  facet_grid(period ~ .) +
  theme(axis.text = element_blank(),
        axis.ticks = element_blank())


```

#### test color palettes

```{r inventory_maps_absolute_test_color_scales, fig.asp=0.4, eval=FALSE}

breaks <- c(-Inf, seq(0, 16, 2), Inf)

legend_title <- expression(atop(Delta * C["ant"],
                                (mol ~ m ^ {
                                  -2
                                })))

breaks_n <- length(breaks) - 1

dcant_inv_all_color_test <- dcant_inv_all %>%
  filter(data_source %in% c("obs"),
         period == "2004 - 2014") %>%
  mutate(dcant_int = cut(dcant,
                         breaks,
                         right = FALSE))

scico_continous_palettes <- c(
  "acton",
  "bamako",
  "batlow",
  "bilbao",
  "buda",
  "davos",
  "devon",
  "grayC",
  "hawaii",
  "imola",
  "lajolla",
  "lapaz",
  "nuuk",
  "oslo",
  "tokyo",
  "turku"
)

p_test_scico <- function(df, i_palette) {
  p_reg <- map +
    geom_raster(data = df,
                aes(lon, lat, fill = dcant_int)) +
    scale_fill_scico_d(
      palette = i_palette,
      drop = FALSE,
      name = legend_title,
      guide = "none"
    ) +
    labs(title = i_palette) +
    theme(axis.text = element_blank(),
          axis.ticks = element_blank())
  
  p_rev <- map +
    geom_raster(data = df,
              aes(lon, lat, fill = dcant_int)) +
    scale_fill_scico_d(
      palette = i_palette,
      drop = FALSE,
      name = legend_title,
      direction = -1,
      guide = "none"
    ) +
    labs(title = paste(i_palette, "rev")) +
    theme(axis.text = element_blank(),
          axis.ticks = element_blank())
  
  p_comb <- p_reg / p_rev
  
  return(p_comb)
}


all_plots_scico <- scico_continous_palettes %>% 
  # head(1) %>% 
  map(~p_test_scico(df = dcant_inv_all_color_test,
                      i_palette = .x))

viridis_continous_palettes <- c(
  "viridis",
  "magma",
  "inferno",
  "plasma"
)

p_test_viridis <- function(df, i_palette) {
  p_reg <- map +
    geom_raster(data = df,
                aes(lon, lat, fill = dcant_int)) +
    scale_fill_viridis_d(
      option = i_palette,
      drop = FALSE,
      name = legend_title,
      guide = "none"
    ) +
    labs(title = i_palette) +
    theme(axis.text = element_blank(),
          axis.ticks = element_blank())
  
  p_rev <- map +
    geom_raster(data = df,
              aes(lon, lat, fill = dcant_int)) +
    scale_fill_viridis_d(
      option = i_palette,
      drop = FALSE,
      name = legend_title,
      direction = -1,
      guide = "none"
    ) +
    labs(title = paste(i_palette, "rev")) +
    theme(axis.text = element_blank(),
          axis.ticks = element_blank())
  
  p_comb <- p_reg / p_rev
  
  return(p_comb)
}

all_plots_viridis <- viridis_continous_palettes %>% 
  # head(1) %>% 
  map(~p_test_viridis(df = dcant_inv_all_color_test,
                      i_palette = .x))



library(colorspace)

colorspace_continous_palettes <- c(
  # "Purple - Blue",
  # "Red - Purple",
  # "Blue - Yellow",
  # "Heat",
  # "Heat 2",
  "Rocket"
  # "Mako",
  # "Dark",
  # "Mint",
  # "Mint",
  # "BluGrn",
  # "Teal",
  # "Sunset",
  # "SunsetDark",
  # "ag_Sunset",
  # "YlOrRd",
  # "YlGnBu",
  # "RdPu"
)

p_test_colorspace <- function(df, i_palette) {
  
  i_palette <<- i_palette
  
  p_reg <- map +
    geom_raster(data = df,
                aes(lon, lat, fill = dcant_int)) +
    scale_fill_discrete_sequential(
      palette = i_palette,
      drop = FALSE,
      name = legend_title,
      guide = "none"
    ) +
    labs(title = i_palette) +
    theme(axis.text = element_blank(),
          axis.ticks = element_blank())
  
  p_rev <- map +
    geom_raster(data = df,
                aes(lon, lat, fill = dcant_int)) +
    scale_fill_discrete_sequential(
      palette = i_palette,
      drop = FALSE,
      name = legend_title,
      rev = FALSE,
      guide = "none"
    ) +
    labs(title = paste(i_palette, "rev")) +
    theme(axis.text = element_blank(),
          axis.ticks = element_blank())

  p_comb <- p_reg / p_rev
  
  return(p_comb)
  rm(i_palette)
  
}

all_plots_colorspace <- colorspace_continous_palettes %>%
  # head(2) %>%
  map(~p_test_colorspace(df = dcant_inv_all_color_test,
                           i_palette = .x))

all_plots_colorspace

all_plots <- c(all_plots_colorspace, all_plots_viridis, all_plots_scico)

pdf(here::here("output/publication/test_color_scales.pdf"),
    width = 4, height = 4)
all_plots
dev.off()

```

### dcant - absolute delta

```{r invetory_maps_absolute_delta}


dcant_inv_all %>%
  filter(data_source %in% c("mod", "obs"),
         period != "1994 - 2014") %>%
  select(data_source, lon, lat, basin_AIP, period, dcant) %>% 
  pivot_wider(names_from = period,
              values_from = dcant) %>% 
  mutate(delta_dcant = `2004 - 2014` - `1994 - 2004`) %>% 
  group_by(data_source) %>%
  group_split() %>%
  # head(1) %>%
  map(
    ~ p_map_cant_inv(df = .x,
                     var = "delta_dcant",
                     subtitle_text = paste("data_source:",
                                           unique(.x$data_source)),
                     col = "divergent") +
      # facet_grid(period ~ .) +
      theme(axis.text = element_blank(),
            axis.ticks = element_blank())
  )


```

### dcant - absolute delta scaled

```{r invetory_maps_absolute_delta_scaled}

dcant_budget_scaling <- dcant_budget_global_all %>%
  filter(#data_source %in% c("mod", "obs"),
         period != "1994 - 2014") %>%
  select(data_source, period, dcant) %>%
  pivot_wider(names_from = period,
              values_from = dcant) %>% 
  mutate(dcant_scaling = `2004 - 2014` / `1994 - 2004`) %>% 
  select(data_source, dcant_scaling)


left_join(dcant_inv_all,
          dcant_budget_scaling) %>%
  filter(#data_source %in% c("mod", "obs"),
         period != "1994 - 2014") %>%
  select(data_source, lon, lat, basin_AIP, period, dcant, dcant_scaling) %>% 
  pivot_wider(names_from = period,
              values_from = dcant) %>% 
  mutate(delta_dcant = `2004 - 2014` - `1994 - 2004`*dcant_scaling) %>% 
  group_by(data_source) %>%
  group_split() %>%
  # head(1) %>%
  map(
    ~ p_map_cant_inv(df = .x,
                     var = "delta_dcant",
                     subtitle_text = paste("data_source:",
                                           unique(.x$data_source)),
                     col = "divergent") +
      # facet_grid(period ~ .) +
      theme(axis.text = element_blank(),
            axis.ticks = element_blank())
  )


```


### dcant pos - absolute

```{r cases_absolute_dcant_pos, fig.asp=0.9}


dcant_inv_all %>%
  filter(data_source %in% c("mod", "obs"),
         period != "1994 - 2014") %>%
  group_by(data_source) %>%
  group_split() %>%
  # head(1) %>%
  map(
    ~ p_map_cant_inv(df = .x,
                     var = "dcant_pos",
                     subtitle_text = paste("data_source:",
                                           unique(.x$data_source))) +
      facet_grid(period ~ .) +
      theme(axis.text = element_blank(),
            axis.ticks = element_blank())
  )


```

## Zonal means

```{r zonal_mean_storage}

beta_label <- expression(beta~(mol ~ m ^ {-2} ~ Âµatm ^ {-1}))

dcant_inv_all <- m_grid_horizontal_coarse(dcant_inv_all)

dcant_inv_all_lat_mean <- dcant_inv_all %>% 
  group_by(basin_AIP, period, lat_grid) %>% 
  summarise(beta = mean(beta, na.rm = TRUE)) %>% 
  ungroup()

dcant_inv_all_ensemble <- m_grid_horizontal_coarse(dcant_inv_all_ensemble)

dcant_inv_all_ensemble_lat_mean <- dcant_inv_all_ensemble %>% 
  group_by(basin_AIP, period, lat_grid, Version_ID) %>% 
  summarise(beta_mean = mean(beta, na.rm = TRUE)) %>% 
  ungroup()

dcant_inv_all_ensemble_lat_mean_average <- dcant_inv_all_ensemble_lat_mean %>% 
  group_by(basin_AIP, period, lat_grid) %>% 
  summarise(beta_sd = sd(beta_mean, na.rm = TRUE),
            beta_mean = mean(beta_mean, na.rm = TRUE)) %>% 
  ungroup()

dcant_inv_all_lat_mean <- full_join(dcant_inv_all_lat_mean,
                                    dcant_inv_all_ensemble_lat_mean_average)

dcant_inv_all_lat_mean %>% 
  ggplot(aes(lat_grid, beta, fill=period)) +
  geom_hline(yintercept = 0) +
  geom_ribbon(aes(ymin = beta - beta_sd,
                  ymax = beta + beta_sd),
              alpha = 0.3) +
  geom_path(aes(col=period)) +
  geom_point(shape = 21) +
  scale_color_viridis_d() +
  scale_fill_viridis_d() +
  coord_flip() +
  facet_grid(. ~ basin_AIP) +
  labs(x = "Latitude (Â°N)",
       y = beta_label)

dcant_inv_all_ensemble_lat_mean %>% 
  ggplot(aes(lat_grid, beta_mean, fill=period, group=Version_ID)) +
  geom_hline(yintercept = 0) +
  geom_path(aes(col=period)) +
  geom_point(shape = 21) +
  scale_color_viridis_d() +
  scale_fill_viridis_d() +
  coord_flip() +
  facet_grid(. ~ basin_AIP) +
  labs(x = "Latitude (Â°N)",
       y = beta_label)

```


# Zonal sections

## dcant - absolut

```{r zonal_sections}

dcant_zonal_all %>%
  filter(data_source == "obs",
         period != "1994 - 2014",
         depth <= params_global$inventory_depth_standard) %>%
  p_section_zonal_continous_depth(var = "dcant",
                                  plot_slabs = "n",
                                  title_text = NULL) +
  facet_grid(basin_AIP ~ period)


```

## dcant - absolute delta

```{r inventory_maps_absolute_delta}

dcant_zonal_all %>%
  filter(data_source %in% c("mod", "obs"),
         period != "1994 - 2014") %>%
  select(data_source, lat, depth, basin_AIP, period, dcant) %>%
  pivot_wider(names_from = period,
              values_from = dcant) %>%
  mutate(delta_dcant = `2004 - 2014` - `1994 - 2004`) %>%
  group_by(data_source) %>%
  group_split() %>%
  # head(1) %>%
  map(
    ~ p_section_zonal_continous_depth(
      df = .x,
      var = "delta_dcant",
      plot_slabs = "n",
      title_text = NULL,
      col = "bias"
    ) +
      facet_grid(basin_AIP ~ .)
  )


```


# Concentration profiles

## dcant - absolute

```{r concentration_profiles, fig.asp=1.6}


dcant_profile_all %>%
  arrange(depth) %>%
  filter(period != "1994 - 2014") %>%
  group_split(data_source) %>%
  # head(1) %>%
  map(
    ~ ggplot(data = .x,
             aes(dcant,
                 depth)) +
      geom_hline(yintercept = params_global$inventory_depth_standard) +
      geom_vline(xintercept = 0) +
      geom_ribbon(
        aes(
          xmin = dcant - dcant_sd,
          xmax = dcant + dcant_sd,
          fill = period
        ),
        alpha = 0.3
      ) +
      geom_path(aes(col = period)) +
      scale_y_continuous(trans = trans_reverser("sqrt"),
                         breaks = c(0, 100, 500, seq(1500, 5000, 1000))) +
      coord_cartesian(expand = 0) +
      scale_color_brewer(palette = "Set1", name = "mean \u00B1 sd", direction = -1) +
      scale_fill_brewer(palette = "Set1", name = "mean \u00B1 sd", direction = -1) +
      labs(
        title = paste("data_source", unique(.x$data_source)),
        y = "Depth (m)",
        x = dcant_umol_label
      ) +
      facet_grid(basin_AIP ~ .)
  )


```

```{r concentration_profiles_MLR_basins, fig.asp=0.9}

dcant_profile_basin_MLR_all %>%
  arrange(depth) %>%
  filter(period != "1994 - 2014",
         MLR_basins == "5", 
         depth <= params_global$inventory_depth_standard) %>%
    mutate(
    basin = str_replace(basin, "_", ". "),
    basin = fct_relevel(
      basin,
      "N. Pacific",
      "S. Pacific",
      "N. Atlantic",
      "S. Atlantic",
      "Indian"
    )
  ) %>% 
  group_split(data_source) %>%
  # head(1) %>%
  map(
    ~ ggplot(data = .x,
             aes(dcant,
                 depth)) +
      geom_hline(yintercept = params_global$inventory_depth_standard) +
      geom_vline(xintercept = 0) +
      geom_ribbon(
        aes(
          xmin = dcant - dcant_sd,
          xmax = dcant + dcant_sd,
          fill = period
        ),
        alpha = 0.3
      ) +
      geom_path(aes(col = period)) +
      scale_y_continuous(trans = trans_reverser("sqrt"),
                         breaks = c(0, 100, 500, seq(1500, 5000, 1000))) +
      coord_cartesian(expand = 0) +
      scale_color_brewer(palette = "Set1", name = "mean \u00B1 sd", direction = -1) +
      scale_fill_brewer(palette = "Set1", name = "mean \u00B1 sd", direction = -1) +
      labs(
        title = paste("data_source", unique(.x$data_source)),
        y = "Depth (m)",
        x = dcant_umol_label
      ) +
      facet_wrap(~ basin, ncol = 3, dir = "v") +
      theme(legend.position = c(0.8,0.2))
  )


```

## dcant - absolute delta

```{r concentration_profiles_basin_AIP_offset, fig.asp=1.6}

delta <- dcant_profile_all %>%
  arrange(depth) %>%
  filter(period != "1994 - 2014") %>%
  select(data_source, depth, basin_AIP, period, dcant) %>% 
  pivot_wider(names_from = period,
              values_from = dcant) %>%
  mutate(delta_dcant = `2004 - 2014` - `1994 - 2004`) %>% 
  select(-c(`2004 - 2014`, `1994 - 2004`))

delta_sd <- dcant_profile_all %>%
  arrange(depth) %>%
  filter(period != "1994 - 2014") %>%
  select(data_source, depth, basin_AIP, period, dcant_sd) %>% 
  pivot_wider(names_from = period,
              values_from = dcant_sd) %>%
  mutate(delta_dcant_sd = (`2004 - 2014` + `1994 - 2004`) / 2) %>% 
  select(-c(`2004 - 2014`, `1994 - 2004`))

dcant_profile_all_delta <- full_join(delta, delta_sd)
rm(delta, delta_sd)

dcant_profile_all_delta %>%
  group_split(data_source) %>%
  # head(1) %>%
  map(
    ~ ggplot(data = .x,
             aes(delta_dcant,
                 depth)) +
      geom_hline(yintercept = params_global$inventory_depth_standard) +
      geom_vline(xintercept = 0) +
      geom_ribbon(
        aes(
          xmin = delta_dcant - delta_dcant_sd,
          xmax = delta_dcant + delta_dcant_sd
        ),
        alpha = 0.3
      ) +
      geom_path() +
      scale_y_continuous(trans = trans_reverser("sqrt"),
                         breaks = c(0, 100, 500, seq(1500, 5000, 1000))) +
      coord_cartesian(expand = 0) +
      scale_color_brewer(palette = "Set1", name = "mean \u00B1 sd") +
      scale_fill_brewer(palette = "Set1", name = "mean \u00B1 sd") +
      labs(title = paste("data_source", unique(.x$data_source)),
           y = "Depth (m)",
           x = ddcant_umol_label) +
      facet_grid(basin_AIP ~ .))


```



```{r concentration_profiles_MLR_basins_offset, fig.asp=2}

delta <- dcant_profile_basin_MLR_all %>%
  arrange(depth) %>%
  filter(period != "1994 - 2014",
         MLR_basins == "5") %>%
  select(data_source, depth, basin, period, dcant) %>%
  pivot_wider(names_from = period,
              values_from = dcant) %>%
  mutate(delta_dcant = `2004 - 2014` - `1994 - 2004`) %>%
  select(-c(`2004 - 2014`, `1994 - 2004`))

delta_sd <- dcant_profile_basin_MLR_all %>%
  arrange(depth) %>%
  filter(period != "1994 - 2014",
         MLR_basins == "5") %>%
  select(data_source, depth, basin, period, dcant_sd) %>% 
  pivot_wider(names_from = period,
              values_from = dcant_sd) %>%
  mutate(delta_dcant_sd = (`2004 - 2014` + `1994 - 2004`) / 2) %>% 
  select(-c(`2004 - 2014`, `1994 - 2004`))

dcant_profile_basin_MLR_all_delta <- full_join(delta, delta_sd)
rm(delta, delta_sd)



dcant_profile_basin_MLR_all_delta %>%
  mutate(
    basin = str_replace(basin, "_", ". "),
    basin = fct_relevel(
      basin,
      "N. Pacific",
      "S. Pacific",
      "N. Atlantic",
      "S. Atlantic",
      "Indian"
    )
  ) %>%
  group_split(data_source) %>%
  # head(3) %>%
  map(
    ~ ggplot(data = .x,
             aes(delta_dcant,
                 depth)) +
      geom_hline(yintercept = params_global$inventory_depth_standard) +
      geom_vline(xintercept = 0) +
      geom_ribbon(
        aes(
          xmin = delta_dcant - delta_dcant_sd,
          xmax = delta_dcant + delta_dcant_sd
        ),
        alpha = 0.3
      ) +
      geom_path() +
      scale_y_continuous(trans = trans_reverser("sqrt"),
                         breaks = c(0, 100, 500, seq(1500, 5000, 1000))) +
      coord_cartesian(expand = 0) +
      scale_color_brewer(palette = "Set1", name = "mean \u00B1 sd") +
      scale_fill_brewer(palette = "Set1", name = "mean \u00B1 sd") +
      labs(
        title = paste("data_source", unique(.x$data_source)),
        y = "Depth (m)",
        x = ddcant_umol_label
      ) +
      facet_grid(basin ~ .)
  )

```




# Budgets


## Ensemble

```{r dcant_budget_basin_ensemble}

dcant_budget_basin_MLR_all_ensemble %>%
  mutate(class = str_sub(Version_ID, 4, 4)) %>% 
  ggplot(aes(period, dcant, col = class)) +
  geom_point() +
  facet_grid(basin ~ data_source)

dcant_budget_basin_MLR_all_ensemble %>%
  filter(data_source == "obs") %>% 
  mutate(class = str_sub(Version_ID, 4, 4)) %>% 
  ggplot(aes(dcant)) +
  geom_histogram() +
  geom_density() +
  facet_grid(basin ~ period, scales = "free")

dcant_budget_basin_MLR_all_ensemble_summary <- dcant_budget_basin_MLR_all_ensemble %>% 
  group_by(data_source, basin, period) %>% 
  summarise(dcant_mean = mean(dcant),
            dcant_sd = sd(dcant)*2) %>% 
  ungroup()

dcant_budget_global_all_ensemble_summary <-
  dcant_budget_basin_MLR_all_ensemble %>%
  filter(period != "1994 - 2014") %>%
  group_by(data_source, Version_ID, tref1, tref2, period) %>%
  summarise(dcant = sum(dcant)) %>%
  ungroup() %>%
  group_by(data_source, tref1, tref2, period) %>%
  summarise(dcant_mean = mean(dcant),
            dcant_sd = sd(dcant)*2) %>%
  ungroup() %>%
  filter(data_source == "obs")

```



## Basin & hemisphere

```{r budgets_basins_hemisphere, fig.asp=1.2}

dcant_budget_basin_MLR_all <- left_join(dcant_budget_basin_MLR_all,
                           co2_atm %>% rename(tref1 = year,
                                              pCO21 = pCO2))

dcant_budget_basin_MLR_all <- left_join(dcant_budget_basin_MLR_all,
                           co2_atm %>% rename(tref2 = year,
                                              pCO22 = pCO2))


dcant_budget_basin_MLR_all_plot <- dcant_budget_basin_MLR_all %>%
  filter(period != "1994 - 2014",
         data_source == "obs")

```

```{r budgets_basins_hemisphere_tcant}


tcant_budget_basin_MLR <-
  inner_join(tcant_inv, basinmask %>% filter(MLR_basins == "5")) %>%
  mutate(method = "layer",
         data_source = "obs") %>% 
  group_by(basin) %>%
  nest() %>% 
  mutate(budget = map(.x = data, ~m_dcant_budget(.x))) %>% 
  select(-data) %>%
  unnest(budget)



tcant_budget_basin_MLR <- tcant_budget_basin_MLR %>% 
  mutate(pCO21 = 280,
         tref1 = 1800,
         tref2 = 1994)

tcant_budget_basin_MLR <- left_join(tcant_budget_basin_MLR,
                                    co2_atm %>% rename(tref2 = year,
                                                       pCO22 = pCO2))

tcant_budget_basin_MLR <- tcant_budget_basin_MLR %>% 
  mutate(period = paste(tref1, tref2, sep = " - ")) %>% 
  filter(estimate == "dcant") %>% 
  select(-estimate) %>% 
  rename(dcant = value)

dcant_budget_basin_MLR_all_plot <- bind_rows(
  dcant_budget_basin_MLR_all_plot,
  tcant_budget_basin_MLR)

dcant_budget_basin_MLR_all_plot <-
  left_join(dcant_budget_basin_MLR_all_plot,
            dcant_budget_basin_MLR_all_ensemble_summary)

dcant_budget_basin_MLR_all_plot <- dcant_budget_basin_MLR_all_plot %>% 
  mutate(
    basin = str_replace(basin, "_", ". "),
        basin = fct_relevel(
      basin,
      "N. Pacific",
      "S. Pacific",
      "N. Atlantic",
      "S. Atlantic",
      "Indian"
    )
  )

```

### Absolute

```{r budgets_basins_hemisphere_alluvial_order_budget, fig.asp=0.9}

g1 <- dcant_budget_basin_MLR_all_plot %>%
  filter(period != "1800 - 1994") %>% 
  ggplot(aes(
    y = dcant,
    x = period,
    alluvium = basin,
    fill  = basin,
    stratum = basin
  )) +
  stat_alluvium(decreasing = FALSE) +
  stat_stratum(decreasing = FALSE) +
  stat_stratum(geom = "text",
               decreasing = FALSE,
               aes(label = paste(
                 round(after_stat(max-min),1)
                 # 100*round(after_stat(prop), 2), "%"
                 ))) +
  ggrepel::geom_label_repel(
    data = dcant_budget_basin_MLR_all_plot %>% filter(period == "2004 - 2014"),
    stat = "stratum",
    size = 4,
    nudge_x = .5,
    point.padding = 3,
    aes(fill = basin, label = basin),
    decreasing = FALSE
  )+
  scale_fill_brewer(palette = "Paired", guide = "none") +
  scale_y_continuous(limits = c(0, 32), expand = c(0, 0)) +
  labs(y = dcant_pgc_label) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        axis.title.x = element_blank()) +
  theme_classic()

newdat <- tibble(layer_data(g1))

change <- 
  newdat %>% 
  select(x, alluvium, count) %>% 
  pivot_wider(names_from = x,
              values_from = count) %>% 
  mutate(dcant_change = round(100*(`2` - `1`) / `1`)) %>% 
  select(alluvium, dcant_change)

coord <- newdat %>%
  filter(x == 2) %>% 
  select(x, y, alluvium)

new_layer <- full_join(
  change,
  coord
)

new_layer <- new_layer %>% 
  mutate(dcant_change = as.character(dcant_change),
         dcant_change = if_else(str_detect(dcant_change, "-"),
                                dcant_change,
                                paste0("+", dcant_change)),
         dcant_change = paste(dcant_change, "%"))

g1 +
  geom_text(data = new_layer,
            aes(
              x = x - 0.3,
              y = y,
              label = dcant_change
            ),
            inherit.aes = FALSE)


```


```{r budgets_basins_hemisphere_alluvial_order_basin, fig.asp=0.9}

g2 <- dcant_budget_basin_MLR_all_plot %>%
    filter(period != "1800 - 1994") %>%
  ggplot(aes(
    y = dcant,
    x = period,
    alluvium = basin,
    fill  = basin,
    stratum = basin,
    label = basin
  )) +
  geom_alluvium() +
  geom_stratum() +
  stat_stratum(geom = "text",
               aes(label = paste(
                 round(after_stat(count),1)
                 # 100*round(after_stat(prop), 2), "%"
                 ))) +
  ggrepel::geom_label_repel(
    data = dcant_budget_basin_MLR_all_plot %>% filter(period == "2004 - 2014"),
    stat = "stratum",
    size = 4,
    nudge_x = .5,
    point.padding = 3,
    aes(fill = basin)
  )+
  scale_fill_brewer(palette = "Paired", guide = "none") +
  scale_color_brewer(palette = "Paired", guide = "none") +
  scale_y_continuous(limits = c(0, 33), expand = c(0, 0)) +
  guides(y = "none") +
  labs(title = dcant_pgc_label) +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        plot.title = element_text(hjust = 0.5))


newdat <- tibble(layer_data(g2))

change_basin <- 
  newdat %>% 
  select(x, alluvium, count) %>% 
  pivot_wider(names_from = x,
              values_from = count) %>% 
  mutate(dcant_change = round(100*(`2` - `1`) / `1`)) %>% 
  select(alluvium, dcant_change)

coord_basin <- newdat %>%
  filter(x == 2) %>% 
  select(x, y, alluvium)

new_layer_basin <- full_join(
  change_basin,
  coord_basin
)

new_layer_basin <- new_layer_basin %>% 
  mutate(dcant_change = as.character(dcant_change),
         dcant_change = if_else(str_detect(dcant_change, "-"),
                                dcant_change,
                                paste0("+", dcant_change)),
         dcant_change = paste(dcant_change, "%"))

new_layer_total <- 
  newdat %>% 
  select(x, alluvium, count) %>% 
  group_by(x) %>% 
  summarise(dcant_change = sum(count)) %>% 
  ungroup()

new_layer_total <- new_layer_total %>% 
  mutate(y = dcant_change,
         dcant_change = as.character(round(dcant_change,1)),
         dcant_change = paste("global:",dcant_change))

g2 +
  geom_text(data = new_layer_basin,
            aes(
              x = x - 0.3,
              y = y,
              label = dcant_change
            ),
            inherit.aes = FALSE) +
  geom_label(data = new_layer_total,
            aes(
              x = x,
              y = y + 1,
              label = dcant_change
            ),
            inherit.aes = FALSE)


```

### Scaled

```{r scale_dcant_budget_to_atm_pCO2_growth}


dcant_budget_basin_MLR_all_plot <- left_join(dcant_budget_basin_MLR_all_plot,
                           co2_atm %>% rename(tref1 = year,
                                              pCO21 = pCO2))

dcant_budget_basin_MLR_all_plot <- left_join(dcant_budget_basin_MLR_all_plot,
                           co2_atm %>% rename(tref2 = year,
                                              pCO22 = pCO2))

dcant_budget_basin_MLR_all_plot <- dcant_budget_basin_MLR_all_plot %>% 
  mutate(delta_pCO2 = pCO22 - pCO21,
         beta = dcant / delta_pCO2,
         dcant_sd_scaled = dcant_sd / delta_pCO2) %>% 
  select(-starts_with("pCO2"))


dcant_budget_global_all_ensemble_summary <- left_join(dcant_budget_global_all_ensemble_summary,
                           co2_atm %>% rename(tref1 = year,
                                              pCO21 = pCO2))

dcant_budget_global_all_ensemble_summary <- left_join(dcant_budget_global_all_ensemble_summary,
                           co2_atm %>% rename(tref2 = year,
                                              pCO22 = pCO2))

dcant_budget_global_all_ensemble_summary <- dcant_budget_global_all_ensemble_summary %>% 
  mutate(delta_pCO2 = pCO22 - pCO21,
         beta = dcant_mean / delta_pCO2,
         dcant_sd_scaled = dcant_sd / delta_pCO2) %>% 
  select(-starts_with("pCO2"))


```


```{r budgets_basins_hemisphere_alluvial_order_basin_scaled, fig.asp=0.9}

g2 <- dcant_budget_basin_MLR_all_plot %>%
  filter(period != "1800 - 1994") %>% 
  ggplot(aes(
    y = beta,
    x = period,
    alluvium = basin,
    fill  = basin,
    stratum = basin,
    label = basin
  )) +
  geom_alluvium() +
  geom_stratum() +
  stat_stratum(geom = "text",
               aes(label = paste(
                 round(after_stat(count),2)
                 # 100*round(after_stat(prop), 2), "%"
                 ))) +
  ggrepel::geom_label_repel(
    data = dcant_budget_basin_MLR_all_plot %>% filter(period == "2004 - 2014"),
    stat = "stratum",
    size = 4,
    nudge_x = .5,
    point.padding = 3,
    aes(fill = basin)
  )+
  scale_fill_brewer(palette = "Paired", guide = "none") +
  scale_color_brewer(palette = "Paired", guide = "none") +
  # scale_y_continuous(limits = c(0, 33), expand = c(0, 0)) +
  guides(y = "none") +
  labs(title = dcant_pgc_scaled_label) +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        plot.title = element_text(hjust = 0.5))


newdat <- tibble(layer_data(g2))

change_basin <- 
  newdat %>% 
  select(x, alluvium, count) %>% 
  pivot_wider(names_from = x,
              values_from = count) %>% 
  mutate(dcant_change = round(100*(`2` - `1`) / `1`)) %>% 
  select(alluvium, dcant_change)

coord_basin <- newdat %>%
  filter(x == 2) %>% 
  select(x, y, alluvium)

new_layer_basin <- full_join(
  change_basin,
  coord_basin
)

new_layer_basin <- new_layer_basin %>% 
  mutate(dcant_change = as.character(dcant_change),
         dcant_change = if_else(str_detect(dcant_change, "-"),
                                dcant_change,
                                paste0("+", dcant_change)),
         dcant_change = paste(dcant_change, "%"))

new_layer_total <- 
  newdat %>% 
  select(x, alluvium, count) %>% 
  group_by(x) %>% 
  summarise(dcant_change = sum(count)) %>% 
  ungroup()

new_layer_total <- new_layer_total %>% 
  mutate(y = dcant_change,
         dcant_change = as.character(round(dcant_change,2)),
         dcant_change = paste("global:",dcant_change))

g2 +
  geom_text(data = new_layer_basin,
            aes(
              x = x - 0.3,
              y = y,
              label = dcant_change
            ),
            inherit.aes = FALSE) +
  geom_label(data = new_layer_total,
            aes(
              x = x,
              y = y + 0.05,
              label = dcant_change
            ),
            inherit.aes = FALSE)


```

```{r budgets_basins_hemisphere_alluvial_order_basin_scaled_incl_sabine}

g2 <- dcant_budget_basin_MLR_all_plot %>%
  ggplot(aes(
    y = beta,
    x = period,
    alluvium = basin,
    fill  = basin,
    stratum = basin,
    label = basin
  )) +
  geom_alluvium() +
  geom_stratum() +
  stat_stratum(geom = "text",
               aes(label = paste(
                 round(after_stat(count),2)
                 # 100*round(after_stat(prop), 2), "%"
                 ))) +
  ggrepel::geom_label_repel(
    data = dcant_budget_basin_MLR_all_plot %>% filter(period == "2004 - 2014"),
    stat = "stratum",
    size = 4,
    nudge_x = .5,
    point.padding = 3,
    aes(fill = basin)
  )+
  scale_fill_brewer(palette = "Paired", guide = "none") +
  scale_color_brewer(palette = "Paired", guide = "none") +
  scale_y_continuous(limits = c(0, 1.7), expand = c(0, 0)) +
  guides(y = "none") +
  labs(title = dcant_pgc_scaled_label) +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        plot.title = element_text(hjust = 0.5))


newdat <- tibble(layer_data(g2))

change_basin <- 
  newdat %>% 
  select(x, alluvium, count) %>% 
  group_by(alluvium) %>% 
  arrange(x) %>% 
  mutate(dcant_change = round(100*(count - lag(count)) / lag(count))) %>% 
  ungroup()

coord_basin <- newdat %>%
  select(x, y, alluvium)

new_layer_basin <- left_join(
  change_basin %>% drop_na(),
  coord_basin
)

new_layer_basin <- new_layer_basin %>% 
  mutate(dcant_change = as.character(dcant_change),
         dcant_change = if_else(str_detect(dcant_change, "-"),
                                dcant_change,
                                paste0("+", dcant_change)),
         dcant_change = paste(dcant_change, "%"))

new_layer_total <- 
  newdat %>% 
  select(x, alluvium, count) %>% 
  group_by(x) %>% 
  summarise(dcant_change = sum(count)) %>% 
  ungroup()

new_layer_total <- new_layer_total %>% 
  mutate(y = dcant_change,
         dcant_change = as.character(round(dcant_change,2)),
         dcant_change = paste("global:",dcant_change))

g2 +
  geom_text(data = new_layer_basin,
            aes(
              x = x - 0.3,
              y = y,
              label = dcant_change
            ),
            inherit.aes = FALSE) +
  geom_label(data = new_layer_total,
            aes(
              x = x,
              y = y + 0.1,
              label = dcant_change
            ),
            inherit.aes = FALSE)


```


```{r budgets_basins_hemisphere_alluvial_order_basin_scaled_incl_sabine_uncertainty, fig.asp=0.9}

g2 <- dcant_budget_basin_MLR_all_plot %>%
  ggplot(aes(
    y = beta,
    x = period,
    alluvium = basin,
    fill  = basin,
    stratum = basin,
    label = basin
  )) +
  geom_alluvium() +
  geom_stratum() +
  ggrepel::geom_label_repel(
    data = dcant_budget_basin_MLR_all_plot %>% filter(period == "2004 - 2014"),
    stat = "stratum",
    size = 4,
    nudge_x = .5,
    point.padding = 3,
    aes(fill = basin)
  )+
  scale_fill_brewer(palette = "Paired", guide = "none") +
  scale_color_brewer(palette = "Paired", guide = "none") +
  scale_y_continuous(limits = c(0, 1.6), expand = c(0, 0)) +
  guides(y = "none") +
  labs(title = dcant_pgc_scaled_label) +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        plot.title = element_text(hjust = 0.5))


newdat <- tibble(layer_data(g2))

# construct budget labels

budget_basin <- 
  newdat %>% 
  select(x, y, alluvium, count)

budget_layer_basin <- budget_basin %>% 
  mutate(dcant = as.character(round(count,2)))

# construct uncertainty labels

uncertainty_basin <- 
  dcant_budget_basin_MLR_all_plot %>% 
  mutate(x = fct_recode(period,
                        "2" = "1994 - 2004",
                        "3" = "2004 - 2014")) %>% 
  select(x, alluvium = basin, dcant_sd_scaled) %>% 
  drop_na() %>% 
  arrange(x, alluvium)
  

coord_basin <- newdat %>%
  select(x, y, alluvium) %>% 
  filter(x != 1)

uncertainty_layer_basin <- bind_cols(
  coord_basin,
  uncertainty_basin %>% select(dcant_sd_scaled),
)

# construct change labels

change_basin <- 
  newdat %>% 
  select(x, alluvium, count) %>% 
  group_by(alluvium) %>% 
  arrange(x) %>% 
  mutate(dcant_change_abs = count - lag(count),
         dcant_change = round(100*(dcant_change_abs) / lag(count))) %>% 
  ungroup()

coord_basin <- newdat %>%
  select(x, y, alluvium)

new_layer_basin <- left_join(
  change_basin %>% drop_na(),
  coord_basin
)

new_layer_basin <- new_layer_basin %>% 
  mutate(dcant_change = as.character(dcant_change),
         dcant_change = if_else(str_detect(dcant_change, "-"),
                                dcant_change,
                                paste0("+", dcant_change)),
         dcant_change = paste0(dcant_change, "%"))

# construct global budget labels

new_layer_total <- 
  newdat %>% 
  select(x, alluvium, count) %>% 
  group_by(x) %>% 
  summarise(dcant_change = sum(count)) %>% 
  ungroup()

dcant_sd_scaled <- round(c(
  0.24,
  dcant_budget_global_all_ensemble_summary %>%
    pull(dcant_sd_scaled)
), 2)

new_layer_total <- bind_cols(new_layer_total, dcant_sd_scaled = dcant_sd_scaled)

new_layer_total <- new_layer_total %>% 
  mutate(y = dcant_change,
         dcant_sd_scaled_rel = round(100 * dcant_sd_scaled/dcant_change),
         dcant_change = as.character(round(dcant_change,2)),
         dcant_sd_scaled = round(dcant_sd_scaled,1),
         dcant_change = paste0(dcant_change, "\n(Â±", dcant_sd_scaled, ")"))

# basin change + uncertainty

budget_layer_basin <- full_join(budget_layer_basin,
                                uncertainty_layer_basin)

budget_layer_basin <- 
  budget_layer_basin %>% 
  mutate(dcant_sd_scaled_rel = 100*dcant_sd_scaled/count,
         dcant_sd_scaled_rel = as.character(round(dcant_sd_scaled_rel)),
         dcant_sd_scaled_numeric = dcant_sd_scaled,
         dcant_sd_scaled = round(dcant_sd_scaled, 2),
         dcant_sd_scaled = paste0("(Â±", dcant_sd_scaled, ")"),
         dcant_label = if_else(dcant_sd_scaled != "(Â±NA)",
                               paste0(dcant, "\n", dcant_sd_scaled),
                               dcant))


# uncertainty changes

uncertainty_changes <- budget_layer_basin %>% 
  select(x, alluvium, dcant_sd_scaled = dcant_sd_scaled_numeric) %>% 
  group_by(alluvium) %>% 
  mutate(dcant_change_uncert = sqrt(dcant_sd_scaled^2 + lag(dcant_sd_scaled)^2)) %>% 
  ungroup()


new_layer_basin <- left_join(new_layer_basin, uncertainty_changes) %>% 
  mutate(dcant_change_uncert_rel = 100*dcant_change_uncert/abs((count + lag(count))/2),
         dcant_change_label = if_else(!is.na(dcant_change_uncert),
                                      paste0(dcant_change, "\n(Â±", round(dcant_change_uncert_rel), "%)"),
                                      dcant_change))


g2 +
  geom_text(data = budget_layer_basin,
            aes(
              x = x,
              y = y,
              label = dcant_label
            ),
            size = 3,
            inherit.aes = FALSE) +
  geom_text(data = new_layer_basin,
            aes(
              x = x - 0.3,
              y = y,
              label = dcant_change_label
            ),
            size = 4,
            inherit.aes = FALSE)
  # geom_label(data = new_layer_total,
  #           aes(
  #             x = x,
  #             y = y + 0.13,
  #             label = dcant_change
  #           ),
  #           size = 4,
  #           inherit.aes = FALSE)


ggsave(path = here::here("output/publication"),
       filename = "Fig_beta_budget_per_basin_hemisphere.png",
       height = 6,
       width = 8)


```



## Depth layer

### Basin AIP

```{r depth_layer_budget_basin_AIP, fig.asp=1.5}

dcant_budget_basin_AIP_layer_all %>%
  filter(estimate == "dcant",
         period != "1994 - 2014",
         inv_depth <= 3000,
         data_source == "obs") %>%
  rename(dcant = value) %>%
  ggplot(aes(inv_depth-250, dcant, col=period)) +
  geom_hline(yintercept = 0) +
  geom_step(direction = "vh") +
  coord_flip() +
  scale_x_reverse(breaks = seq(0, 3000, 500)) +
  scale_color_brewer(palette = "Set1", direction = -1) +
  facet_grid(basin_AIP ~ .) +
  labs(y = dcant_layer_budget_label,
       x = "Depth (m)")

```

### 5 basins


```{r depth_layer_budget_basin_MLR, fig.asp=2}

dcant_budget_change <- dcant_budget_basin_MLR_layer_all %>%
  filter(estimate == "dcant",
         period != "1994 - 2014",
         inv_depth <= 3000,
         data_source == "obs") %>%
  rename(dcant = value) %>%
  select(-c(tref2, Version_ID)) %>%
  pivot_wider(names_from = period,
              values_from = dcant) %>%
  mutate(sign = if_else(`2004 - 2014` - `1994 - 2004` > 0,
                        "increase",
                        "decrease")) %>%
  mutate(
    basin = str_replace(basin, "_", ". "),
    basin = fct_relevel(
      basin,
      "N. Pacific",
      "S. Pacific",
      "N. Atlantic",
      "S. Atlantic",
      "Indian"
    )
  )

dcant_budget_layer <- dcant_budget_basin_MLR_layer_all %>%
  filter(estimate == "dcant",
         period != "1994 - 2014",
         inv_depth <= 3400,
         data_source == "obs") %>%
  rename(dcant = value) %>%
  mutate(
    basin = str_replace(basin, "_", ". "),
    basin = fct_relevel(
      basin,
      "N. Pacific",
      "S. Pacific",
      "N. Atlantic",
      "S. Atlantic",
      "Indian"
    )
  ) %>% 
  group_by(basin, period, data_source) %>% 
  mutate(dcant = if_else(is.na(lead(dcant)), 888, dcant),
         dcant = na_if(dcant, 888)) %>%
  fill(dcant) %>% 
  ungroup()

dcant_budget_layer %>%
  ggplot() +
  geom_hline(yintercept = 0) +
  geom_rect(
    data = dcant_budget_change,
    aes(
      xmin = inv_depth - 250,
      xmax = inv_depth + 250,
      ymin = `1994 - 2004`,
      ymax = `2004 - 2014`,
      fill = sign
    ),
    alpha = 0.3
  ) +
  geom_step(aes(inv_depth - 250, dcant, col = period), direction = "vh",
            size = 1) +
  coord_flip() +
  scale_x_reverse(breaks = seq(0, 3000, 500)) +
  scale_color_brewer(palette = "Set1", direction = -1, name = "Decade") +
  scale_fill_brewer(palette = "Set1", direction = -1, name = "Decadal change") +
  facet_grid(basin ~ .) +
  labs(y = dcant_layer_budget_label,
       x = "Depth (m)",
       title = "Layer inventory change")


```

```{r depth_layer_budget_basin_MLR_cumulative, fig.asp=2}

dcant_budget_change <- dcant_budget_basin_MLR_layer_all %>%
  filter(estimate == "dcant",
         period != "1994 - 2014",
         inv_depth <= 3000,
         data_source == "obs") %>%
  rename(dcant = value) %>%
  arrange(inv_depth) %>% 
  group_by(data_source, basin, period) %>% 
  mutate(dcant_cum = cumsum(dcant)) %>% 
  ungroup() %>%
  select(-c(tref2, Version_ID, dcant)) %>%
  pivot_wider(names_from = period,
              values_from = dcant_cum) %>%
  mutate(sign = if_else(`2004 - 2014` - `1994 - 2004` > 0,
                        "increase",
                        "decrease")) %>%
  mutate(
    basin = str_replace(basin, "_", ". "),
    basin = fct_relevel(
      basin,
      "N. Pacific",
      "S. Pacific",
      "N. Atlantic",
      "S. Atlantic",
      "Indian"
    )
  )

dcant_budget_layer <- dcant_budget_basin_MLR_layer_all %>%
  filter(estimate == "dcant",
         period != "1994 - 2014",
         inv_depth <= 3400,
         data_source == "obs") %>%
  rename(dcant = value) %>%
  arrange(inv_depth) %>% 
  group_by(data_source, basin, period) %>% 
  mutate(dcant_cum = cumsum(dcant)) %>% 
  ungroup() %>%
  mutate(
    basin = str_replace(basin, "_", ". "),
    basin = fct_relevel(
      basin,
      "N. Pacific",
      "S. Pacific",
      "N. Atlantic",
      "S. Atlantic",
      "Indian"
    )
  ) %>% 
  group_by(basin, period, data_source) %>% 
  mutate(dcant_cum = if_else(is.na(lead(dcant_cum)), 888, dcant_cum),
         dcant_cum = na_if(dcant_cum, 888)) %>%
  fill(dcant_cum) %>% 
  ungroup()



dcant_budget_layer %>%
  ggplot() +
  geom_hline(yintercept = 0) +
  geom_rect(
    data = dcant_budget_change,
    aes(
      xmin = inv_depth - 250,
      xmax = inv_depth + 250,
      ymin = `1994 - 2004`,
      ymax = `2004 - 2014`,
      fill = sign
    ),
    alpha = 0.3
  ) +
  geom_step(aes(inv_depth - 250, dcant_cum, col = period), direction = "vh",
            size = 1) +
  coord_flip() +
  scale_x_reverse(breaks = seq(0, 3000, 500)) +
  scale_color_brewer(palette = "Set1", direction = -1, name = "Decade") +
  scale_fill_brewer(palette = "Set1", direction = -1, name = "Decadal change") +
  facet_grid(basin ~ .) +
  labs(y = dcant_layer_budget_label,
       x = "Depth (m)",
       title = "Cumulative layer inventory change")

```

# Time series

## Scale globale

- Accumulation beneath 3000m: +2%
- unmapped regions south of 65N: +1.5%
- Nordic Seas: +1%
- Arctic Ocean: +2%

```{r scaling_factor_budgets_to_global_coverage}

dcant_scaling <- 1.02*1.015*1.01*1.02


```




## eMLR only



```{r mean_tcant_over_time, fig.asp=0.6}

dcant_budget_global_ts <- dcant_budget_global_all %>% 
  filter(data_source == "obs",
         period != "1994 - 2014") %>% 
  select(year = tref2, dcant_mean = dcant)

dcant_budget_global_ts <- dcant_budget_global_ts %>% 
  mutate(dcant_mean = dcant_mean * dcant_scaling)

dcant_budget_global_all_ensemble_summary <-
  dcant_budget_global_all_ensemble_summary %>%
  mutate(dcant_sd = dcant_sd * dcant_scaling)


dcant_budget_global_ts <- left_join(dcant_budget_global_ts,
                                    dcant_budget_global_all_ensemble_summary %>% 
                                      select(year = tref2, dcant_sd))


tcant_S04 <- bind_cols(year = 1994, dcant_mean = 118, dcant_sd = 19)

tcant_ts <- full_join(dcant_budget_global_ts, tcant_S04)

tcant_ts <- left_join(tcant_ts, co2_atm)

co2_atm_pi <- bind_cols(pCO2 = 280, dcant_mean = 0, year = 1800, dcant_sd = 0)

tcant_ts <- full_join(tcant_ts, co2_atm_pi)

tcant_ts <- tcant_ts %>% 
  arrange(year) %>% 
  mutate(tcant = cumsum(dcant_mean),
         tcant_sd = cumsum(dcant_sd))

beta <- 1.57
co2_atm_pi_value <- 283
tCant_col <- "#56B4E9"

p_tcant_year <- tcant_ts %>%
  ggplot(aes(year, tcant)) +
  geom_line(data = co2_atm_reccap2 %>% filter(year > 1790),
            aes(year, (pCO2 - co2_atm_pi_value) * beta),
            col = tCant_col) +
  geom_linerange(aes(
    ymin = tcant - dcant_sd,
    ymax = tcant + dcant_sd,
    col = "interval\nuncertainty"
  )) +
  geom_point(fill = "white", shape = 21) +
  geom_text(aes(label = year), nudge_x = -13, nudge_y = 6) +
  scale_y_continuous(name = expression(Total ~ oceanic ~ C[ant] ~ (PgC)),
                     sec.axis = sec_axis( ~ (. / beta + co2_atm_pi_value),
                                          name = expression(Atm. ~ pCO[2] ~ (Âµatm)))) +
  scale_x_continuous(name = "Year", breaks = seq(1800, 2000, 50)) +
  scale_color_manual(values = "black") +
  theme(
    axis.title.y.right = element_text(color = tCant_col),
    axis.text.y.right = element_text(color = tCant_col),
    axis.ticks.y.right = element_line(color = tCant_col), 
    legend.background = element_rect(fill = "transparent"),
    legend.position = c(0.85, 0.2),
    legend.title = element_blank()
  )

p_tcant_year

tCant_col <- "transparent"

p_tcant_year_trans <- tcant_ts %>%
  ggplot(aes(year, tcant)) +
  geom_line(data = co2_atm_reccap2 %>% filter(year > 1790),
            aes(year, (pCO2 - co2_atm_pi_value) * beta),
            col = tCant_col) +
  geom_linerange(aes(
    ymin = tcant - dcant_sd,
    ymax = tcant + dcant_sd,
    col = "interval\nuncertainty"
  )) +
  geom_point(fill = "white", shape = 21) +
  geom_text(aes(label = year), nudge_x = -13, nudge_y = 6) +
  scale_y_continuous(name = expression(Total ~ oceanic ~ C[ant] ~ (PgC)),
                     sec.axis = sec_axis( ~ (. / beta + co2_atm_pi_value),
                                          name = expression(Atm. ~ pCO[2] ~ (Âµatm)))) +
  scale_x_continuous(name = "Year", breaks = seq(1800, 2000, 50)) +
  scale_color_manual(values = "black") +
  theme(
    axis.title.y.right = element_text(color = tCant_col),
    axis.text.y.right = element_text(color = tCant_col),
    axis.ticks.y.right = element_line(color = tCant_col),
    legend.background = element_rect(fill = "transparent"),
    legend.position = c(0.85, 0.2),
    legend.title = element_blank()
  )

p_tcant_year_trans

```

```{r mean_tcant_over_atm_co2, fig.asp=1}

dcant_uncert_2004 <- tcant_ts %>%
  filter(year %in% c(1994, 2004)) %>% 
  mutate(dcant_sd = if_else(year == 1994, 0, dcant_sd),
         period = "1994 - 2004")

dcant_uncert_2014 <- tcant_ts %>%
  filter(year %in% c(2004, 2014)) %>% 
  mutate(dcant_sd = if_else(year == 2004, 0, dcant_sd),
         period = "2004 - 2014")

dcant_uncert_ind <- bind_rows(
  dcant_uncert_2004,
  dcant_uncert_2014
)

dcant_uncert_2014_combined <-
  tcant_ts %>%
  filter(year %in% c(1994, 2004, 2014)) %>% 
  mutate(dcant_sd = if_else(year == 1994, 0, dcant_sd),
         dcant_sd_combined = sqrt(dcant_sd^2 + lag(dcant_sd, default = 0)^2),
         period = "1994 - 2014")

p_tcant_atm_co2 <- tcant_ts %>% 
  ggplot(aes(pCO2, tcant)) +
  geom_ribbon(aes(ymin = tcant - tcant_sd, ymax = tcant + tcant_sd, fill = "1800 - 2014"),
              alpha = 0.5) +
  geom_ribbon(data = dcant_uncert_2014_combined,
              aes(ymin = tcant - dcant_sd_combined, ymax = tcant + dcant_sd_combined, fill = "1994 - 2014"),
              alpha = 0.5) +
  # geom_linerange(aes(ymin = tcant - dcant_sd, ymax = tcant + dcant_sd, col = "interval\nuncertainty")) +
  geom_line() +
  geom_point(shape = 21, fill = "white") +
  scale_x_continuous(breaks = seq(280, 400, 30)
                     # sec.axis = dup_axis(labels =  c(1800, 1940, 1980, 2000, 2015),
                     #                     name = "Year")
                     ) +
  scale_fill_manual(values = c("grey60", "grey30"), name = "Cumulative\nuncertainty") +
  scale_color_manual(values = "black", name = "") +
  geom_text(aes(label = year), nudge_x = -6, nudge_y = 6) +
  labs(x = expression(Atmospheric~pCO[2]~(Âµatm)),
       y = expression(Total~oceanic~C[ant]~(PgC))) +
  theme(legend.background = element_rect(fill = "transparent"),
        legend.position=c(0.85, 0.2))

p_tcant_year / p_tcant_atm_co2

ggsave(path = here::here("output/publication"),
       filename = "Fig_global_dcant_budget_vs_atm_pCO2.png",
       height = 6,
       width = 7)

p_tcant_year_trans / p_tcant_atm_co2

ggsave(path = here::here("output/publication"),
       filename = "Fig_global_dcant_budget_vs_atm_pCO2_trans.png",
       height = 6,
       width = 7)

```

```{r beta_factors}

tcant_ts %>% 
  mutate(beta = dcant_mean / (pCO2-lag(pCO2)))

```



## incl fluxes

```{r RECCAP2_fluxes}


RECCAP2_fgco2_glob_all_annual_cum_1994 <- RECCAP2_fgco2_glob_all_annual_obs %>%
  filter(year >= 1994, year <= 2018) %>%
  mutate(fgco2_glob = if_else(year == 1994, 0, fgco2_glob),
         fgco2_glob_corr = fgco2_glob + 0.62 + 0.12) %>% 
  arrange(year) %>%
  group_by(product) %>%
  mutate(fgco2_glob_cum = cumsum(fgco2_glob),
         fgco2_glob_corr_cum = cumsum(fgco2_glob_corr)) %>%
  ungroup()

RECCAP2_fgco2_glob_all_annual_cum_1994 <-
left_join(RECCAP2_fgco2_glob_all_annual_cum_1994,
          co2_atm) 

RECCAP2_fgco2_glob_all_annual_cum_1994 %>%
  ggplot(aes(pCO2, fgco2_glob_corr_cum, col = product)) +
  geom_line() +
  geom_point(shape = 21, fill = "white") +
  theme(legend.position = "bottom")

RECCAP2_fgco2_glob_all_annual_cum_1994_mod <- RECCAP2_fgco2_glob_all_annual_mod %>%
  filter(year >= 1994, year <= 2018) %>%
  mutate(fgco2_glob = if_else(year == 1994, 0, fgco2_glob),
         fgco2_glob_corr = fgco2_glob) %>% 
  arrange(year) %>%
  group_by(product) %>%
  mutate(fgco2_glob_cum = cumsum(fgco2_glob),
         fgco2_glob_corr_cum = cumsum(fgco2_glob_corr)) %>%
  ungroup()

RECCAP2_fgco2_glob_all_annual_cum_1994_mod <-
left_join(RECCAP2_fgco2_glob_all_annual_cum_1994_mod,
          co2_atm) 

RECCAP2_fgco2_glob_all_annual_cum_1994_mod %>%
  ggplot(aes(pCO2, fgco2_glob_corr_cum, col = product)) +
  geom_line() +
  geom_point(shape = 21, fill = "white") +
  theme(legend.position = "bottom")

RECCAP2_fgco2_glob_all_annual_cum_1994 <- RECCAP2_fgco2_glob_all_annual_cum_1994 %>% 
  mutate(fgco2_glob_cum = fgco2_glob_cum + 118,
         fgco2_glob_corr_cum = fgco2_glob_corr_cum + 118) %>%
  select(pCO2, product, fgco2_glob_cum, fgco2_glob_corr_cum)

RECCAP2_fgco2_glob_all_annual_cum_1994_mod <- RECCAP2_fgco2_glob_all_annual_cum_1994_mod %>% 
  mutate(fgco2_glob_cum = fgco2_glob_cum + 118,
         fgco2_glob_corr_cum = fgco2_glob_corr_cum + 118) %>%
  select(pCO2, product, fgco2_glob_cum, fgco2_glob_corr_cum)


```

```{r SeaFlux_fluxes}


SeaFlux_fgco2_glob_all_annual_cum_1994 <- SeaFlux_fgco2_glob_all_annual_obs %>%
  filter(year >= 1994, year <= 2018) %>%
  mutate(fgco2_glob = if_else(year == 1994, 0, fgco2_glob),
         fgco2_glob_corr = fgco2_glob + 0.62) %>% 
  arrange(year) %>%
  group_by(product) %>%
  mutate(fgco2_glob_cum = cumsum(fgco2_glob),
         fgco2_glob_corr_cum = cumsum(fgco2_glob_corr)) %>%
  ungroup()

SeaFlux_fgco2_glob_all_annual_cum_1994 <-
left_join(SeaFlux_fgco2_glob_all_annual_cum_1994,
          co2_atm) 

SeaFlux_fgco2_glob_all_annual_cum_1994 %>%
  ggplot(aes(pCO2, fgco2_glob_corr_cum, col = product)) +
  geom_line() +
  geom_point(shape = 21, fill = "white") +
  theme(legend.position = "bottom")


SeaFlux_fgco2_glob_all_annual_cum_1994 <- SeaFlux_fgco2_glob_all_annual_cum_1994 %>% 
  mutate(fgco2_glob_cum = fgco2_glob_cum + 118,
         fgco2_glob_corr_cum = fgco2_glob_corr_cum + 118) %>%
  select(pCO2, product, fgco2_glob_cum, fgco2_glob_corr_cum)


```



```{r mean_tcant_over_atm_co2_incl_fluxes, fig.asp=0.6}

tcant_ts_zoom <- tcant_ts %>%
  filter(year != 1800) %>% 
  mutate(dcant_sd = if_else(year == 1994,0,dcant_sd))


tcant_ts_zoom %>%
  ggplot(aes(pCO2, tcant)) +
  geom_ribbon(
    data = dcant_uncert_2014_combined,
    aes(
      ymin = tcant - dcant_sd_combined,
      ymax = tcant + dcant_sd_combined,
      fill = "1994 - 2014"
    ),
    alpha = 0.5
  ) +
  geom_line(data = RECCAP2_fgco2_glob_all_annual_cum_1994_mod,
            aes(pCO2, fgco2_glob_corr_cum, group = product, col = "Models")) +
  # geom_line(data = RECCAP2_fgco2_glob_all_annual_cum_1994 %>%
  #             filter(product != "UOEX_Wat20_1985_2019_v20211204"),
  #           aes(pCO2, fgco2_glob_corr_cum, group = product, col = "1.1 x RECCAP2 flux")) +
  geom_line(data = RECCAP2_fgco2_glob_all_annual_cum_1994 %>%
              filter(product == "UOEX_Wat20_1985_2019_v20211204"),
            aes(pCO2, fgco2_glob_corr_cum, group = product, col = "Observation-based\nflux products"),
            linetype = 2) +
  geom_line(data = SeaFlux_fgco2_glob_all_annual_cum_1994,
            aes(pCO2, fgco2_glob_corr_cum, group = product, col = "Observation-based\nflux products")) +
  geom_line(aes(col = "eMLR(C*)")) +
  geom_point(aes(col = "eMLR(C*)"),
             shape = 21, fill = "white") +
  geom_text(aes(label = year), nudge_x = -3, nudge_y = 3) +
  scale_color_manual(values = c("black", "#E69F00", "#56B4E9", "pink"),
                     name = "Data source") +
  scale_fill_manual(values = c("grey60", "grey30"), name = "Cumulative\nuncertainty") +
  scale_x_continuous(limits = c(NA, 409)) +
  labs(x = expression(Atmospheric ~ pCO[2] ~ (Âµatm)),
       y = expression(Total ~ oceanic ~ C[ant] ~ (PgC))) +
  guides(colour = guide_legend(order = 2),
         fill = guide_legend(order = 1)) +
  theme(
    legend.background = element_rect(fill = "transparent"),
    legend.position = c(0.73, 0.25),
    legend.box.just = "bottom",
    legend.box = "horizontal"
  )

ggsave(path = here::here("output/publication"),
       filename = "Fig_global_dcant_budget_vs_atm_pCO2_RECCAP2.png",
       height = 3.2,
       width = 5.7)

```


