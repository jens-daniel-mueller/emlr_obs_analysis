---
title: "Results publication"
author: "Jens Daniel Müller"
date:  "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  workflowr::wflow_html:
    number_sections: true
    toc_depth: 3
    toc_float:
      collapsed: false
editor_options:
  chunk_output_type: console
---

```{r parent, child = "/nfs/kryo/work/jenmueller/emlr_cant/utilities/setup.Rmd"}
# this chunk runs the code stored in setup.Rmd
# if required, please refer to instructions given here:
# https://jdblischak.github.io/workflowr/articles/wflow-07-common-code.html
```

# Libraries


```{r load_libraries_specific, include = FALSE}
library(patchwork)
library(ggalluvial)
library(marelac)
library(ggdist)
library(kableExtra)
library(BSDA)
library(khroma)
```


# Read files

## Paths and Versions

```{r select_basin_mask, include=FALSE}

basinmask <- basinmask %>% 
  filter(MLR_basins == "5") %>% 
  select(-c(MLR_basins, basin_AIP))

basinmask <- basinmask %>% 
  mutate(
    basin = str_replace(basin, "_", ". "),
    basin = fct_relevel(
      basin,
      "N. Pacific",
      "S. Pacific",
      "N. Atlantic",
      "S. Atlantic",
      "Indian"
    )
  )

```

```{r define_paths, include = FALSE}

# only path_observations needs to be changed to model
path_observations <-
  paste(path_root, "/observations/", sep = "")

path_preprocessing    <-
  paste(path_observations, "preprocessing/", sep = "")


path_preprocessing_model    <-
  paste(path_root, "/model/preprocessing/", sep = "")

```


```{r define_Version_IDs_ensemble}

version_id_pattern <- "1"

# identify required version IDs

Version_IDs_1 <- list.files(path = "/nfs/kryo/work/jenmueller/emlr_cant/observations",
                            pattern = paste0("v_1", version_id_pattern))

Version_IDs_2 <- list.files(path = "/nfs/kryo/work/jenmueller/emlr_cant/observations",
                            pattern = paste0("v_2", version_id_pattern))

Version_IDs_3 <- list.files(path = "/nfs/kryo/work/jenmueller/emlr_cant/observations",
                            pattern = paste0("v_3", version_id_pattern))

Version_IDs_x <- c(Version_IDs_1, Version_IDs_2, Version_IDs_3)

version_id_pattern <- "o"

# identify required version IDs

Version_IDs_1 <- list.files(path = "/nfs/kryo/work/jenmueller/emlr_cant/observations",
                            pattern = paste0("v_1", version_id_pattern))

Version_IDs_2 <- list.files(path = "/nfs/kryo/work/jenmueller/emlr_cant/observations",
                            pattern = paste0("v_2", version_id_pattern))

Version_IDs_3 <- list.files(path = "/nfs/kryo/work/jenmueller/emlr_cant/observations",
                            pattern = paste0("v_3", version_id_pattern))

Version_IDs_o <- c(Version_IDs_1, Version_IDs_2, Version_IDs_3)

version_id_pattern <- "d"

# identify required version IDs

Version_IDs_1 <- list.files(path = "/nfs/kryo/work/jenmueller/emlr_cant/observations",
                            pattern = paste0("v_1", version_id_pattern))

Version_IDs_2 <- list.files(path = "/nfs/kryo/work/jenmueller/emlr_cant/observations",
                            pattern = paste0("v_2", version_id_pattern))

Version_IDs_3 <- list.files(path = "/nfs/kryo/work/jenmueller/emlr_cant/observations",
                            pattern = paste0("v_3", version_id_pattern))

Version_IDs_d <- c(Version_IDs_1, Version_IDs_2, Version_IDs_3)

version_id_pattern <- "g"

# identify required version IDs

Version_IDs_1 <- list.files(path = "/nfs/kryo/work/jenmueller/emlr_cant/observations",
                            pattern = paste0("v_1", version_id_pattern))

Version_IDs_2 <- list.files(path = "/nfs/kryo/work/jenmueller/emlr_cant/observations",
                            pattern = paste0("v_2", version_id_pattern))

Version_IDs_3 <- list.files(path = "/nfs/kryo/work/jenmueller/emlr_cant/observations",
                            pattern = paste0("v_3", version_id_pattern))

Version_IDs_g <- c(Version_IDs_1, Version_IDs_2, Version_IDs_3)

version_id_pattern <- "n"

# identify required version IDs

Version_IDs_1 <- list.files(path = "/nfs/kryo/work/jenmueller/emlr_cant/observations",
                            pattern = paste0("v_1", version_id_pattern))

Version_IDs_2 <- list.files(path = "/nfs/kryo/work/jenmueller/emlr_cant/observations",
                            pattern = paste0("v_2", version_id_pattern))

Version_IDs_3 <- list.files(path = "/nfs/kryo/work/jenmueller/emlr_cant/observations",
                            pattern = paste0("v_3", version_id_pattern))

Version_IDs_n <- c(Version_IDs_1, Version_IDs_2, Version_IDs_3)
rm(Version_IDs_1, Version_IDs_2, Version_IDs_3)

version_id_pattern <- "c"

# identify required version IDs

Version_IDs_1 <- list.files(path = "/nfs/kryo/work/jenmueller/emlr_cant/observations",
                            pattern = paste0("v_1", version_id_pattern))

Version_IDs_2 <- list.files(path = "/nfs/kryo/work/jenmueller/emlr_cant/observations",
                            pattern = paste0("v_2", version_id_pattern))

Version_IDs_3 <- list.files(path = "/nfs/kryo/work/jenmueller/emlr_cant/observations",
                            pattern = paste0("v_3", version_id_pattern))

Version_IDs_c <- c(Version_IDs_1, Version_IDs_2, Version_IDs_3)
rm(Version_IDs_1, Version_IDs_2, Version_IDs_3)

version_id_pattern <- "e"

# identify required version IDs

Version_IDs_1 <- list.files(path = "/nfs/kryo/work/jenmueller/emlr_cant/observations",
                            pattern = paste0("v_1", version_id_pattern))

Version_IDs_2 <- list.files(path = "/nfs/kryo/work/jenmueller/emlr_cant/observations",
                            pattern = paste0("v_2", version_id_pattern))

Version_IDs_3 <- list.files(path = "/nfs/kryo/work/jenmueller/emlr_cant/observations",
                            pattern = paste0("v_3", version_id_pattern))

Version_IDs_e <- c(Version_IDs_1, Version_IDs_2, Version_IDs_3)
rm(Version_IDs_1, Version_IDs_2, Version_IDs_3)

Version_IDs_ensemble <- c(Version_IDs_x, Version_IDs_o, Version_IDs_d, Version_IDs_g, Version_IDs_n, Version_IDs_c, Version_IDs_e)

rm(Version_IDs_x, Version_IDs_o, Version_IDs_g, Version_IDs_n, Version_IDs_c, Version_IDs_e)


```

```{r Version_IDs_standard_case}

# subset Standard case
Version_IDs <- Version_IDs_ensemble[str_detect(Version_IDs_ensemble, "103")]

```



## Parameters

```{r read_parameters_ensemble}

for (i_Version_IDs in Version_IDs_ensemble) {
  
  path_version_data     <-
    paste(path_observations,
          i_Version_IDs,
          "/data/",
          sep = "")
  
  params_local <-
    read_rds(paste(path_version_data,
                   "params_local.rds",
                   sep = ""))
  
  params_local <- bind_cols(
    Version_ID = i_Version_IDs,
    tref1 = params_local$tref1,
    tref2 = params_local$tref2,
    MLR_basins = params_local$MLR_basins
  )
  
  tref <- read_csv(paste(path_version_data,
                         "tref.csv",
                         sep = ""))
  
  params_local <- params_local %>%
    mutate(
      median_year_1 = sort(tref$median_year)[1],
      median_year_2 = sort(tref$median_year)[2],
      duration = median_year_2 - median_year_1,
      period = paste(median_year_1, "-", median_year_2)
    )
  
  if (exists("params_local_all_ensemble")) {
    params_local_all_ensemble <- bind_rows(params_local_all_ensemble, params_local)
  }
  
  if (!exists("params_local_all_ensemble")) {
    params_local_all_ensemble <- params_local
  }
  
  
}

rm(params_local,
   tref)


params_local_all_ensemble <- params_local_all_ensemble %>%
  select(Version_ID, period, MLR_basins, tref1, tref2)

params_local_all_ensemble <-
  params_local_all_ensemble %>%
  mutate(
    Version_ID_group = str_sub(Version_ID, 4, 4),
    Version_ID_group = case_when(
      Version_ID_group == "1" ~ "Bulk adjustment",
      Version_ID_group == "c" ~ "Cruise adjustment",
      Version_ID_group == "d" ~ "No adjustment",
      Version_ID_group == "g" ~ "No gap filling",
      Version_ID_group == "o" ~ "Reoccupation filter",
      Version_ID_group == "e" ~ "Surface eMLR(C*)",
      Version_ID_group == "n" ~ "C*(N)",
      TRUE ~ Version_ID_group
    )
  )

params_local_all_ensemble <-
  params_local_all_ensemble %>%
  mutate(
    MLR_basins = case_when(
      MLR_basins == "AIP" ~ "3",
      MLR_basins == "SO_AIP" ~ "3+SO",
      MLR_basins == "SO_5" ~ "5+SO",
      TRUE ~ MLR_basins
    )
  )

```

```{r filter_parameter_for_standard_case}

params_local_all <- params_local_all_ensemble %>% 
  filter(Version_ID %in% Version_IDs)

```


```{r read_example_params_local_file}


path_version_data     <-
  paste(path_observations,
        Version_IDs[1],
        "/data/",
        sep = "")

params_local <-
  read_rds(paste(path_version_data,
                 "params_local.rds",
                 sep = ""))

```


## Budgets

```{r read_budget_files_global_ensemble}

for (i_Version_IDs in Version_IDs_ensemble) {
  # i_Version_IDs <- Version_IDs[1]
  
  path_version_data     <-
    paste(path_observations,
          i_Version_IDs,
          "/data/",
          sep = "")
  
  # load and join data files
  
  dcant_budget_global <-
    read_csv(paste(path_version_data,
                   "dcant_budget_global.csv",
                   sep = ""))
  
  dcant_budget_global_mod_truth <-
    read_csv(paste(
      path_version_data,
      "dcant_budget_global_mod_truth.csv",
      sep = ""
    ))
  
  dcant_budget_global <- bind_rows(dcant_budget_global,
                                   dcant_budget_global_mod_truth)
  
  dcant_budget_global <- dcant_budget_global %>%
    mutate(Version_ID = i_Version_IDs)
  
  if (exists("dcant_budget_global_all")) {
    dcant_budget_global_all <-
      bind_rows(dcant_budget_global_all, dcant_budget_global)
  }
  
  if (!exists("dcant_budget_global_all")) {
    dcant_budget_global_all <- dcant_budget_global
  }
  
}

rm(dcant_budget_global,
   dcant_budget_global_mod_truth)
   
```


```{r read_budget_files_basins_hemisphere_ensemble}

for (i_Version_IDs in Version_IDs_ensemble) {
  # i_Version_IDs <- Version_IDs[1]
  
  # print(i_Version_IDs)
  
  path_version_data     <-
    paste(path_observations,
          i_Version_IDs,
          "/data/",
          sep = "")
  
  # load and join data files
  
  dcant_budget_basin_MLR <-
    read_csv(paste(path_version_data,
                   "dcant_budget_basin_MLR.csv",
                   sep = ""))
  
  dcant_budget_basin_MLR_mod_truth <-
    read_csv(paste(
      path_version_data,
      "dcant_budget_basin_MLR_mod_truth.csv",
      sep = ""
    ))
  
    
  dcant_budget_basin_MLR <- bind_rows(dcant_budget_basin_MLR,
                                      dcant_budget_basin_MLR_mod_truth)
  
  dcant_budget_basin_MLR <- dcant_budget_basin_MLR %>%
    mutate(Version_ID = i_Version_IDs)
  

  if (exists("dcant_budget_basin_MLR_all")) {
    dcant_budget_basin_MLR_all <-
      bind_rows(dcant_budget_basin_MLR_all, dcant_budget_basin_MLR)
  }
  
  if (!exists("dcant_budget_basin_MLR_all")) {
    dcant_budget_basin_MLR_all <- dcant_budget_basin_MLR
  }

}

rm(
  dcant_budget_basin_MLR,
  dcant_budget_basin_MLR_mod_truth
)


```

```{r join_budget_data_and_meta_data, include=FALSE}


dcant_budget_global_all <- full_join(dcant_budget_global_all,
                                     params_local_all_ensemble)


dcant_budget_basin_MLR_all <- dcant_budget_basin_MLR_all %>%
  filter(MLR_basins %in% c("5", "1")) %>% 
  select(-MLR_basins)

dcant_budget_basin_MLR_all <- full_join(dcant_budget_basin_MLR_all,
                                        params_local_all_ensemble)

dcant_budget_basin_MLR_all <- dcant_budget_basin_MLR_all %>%
  mutate(
    basin = str_replace(basin, "_", ". "),
    basin = str_replace(basin, "global", "Global"),
    basin = fct_relevel(
      basin,
      "N. Pacific",
      "S. Pacific",
      "N. Atlantic",
      "S. Atlantic",
      "Indian",
      "Global"
    )
  )


```


```{r filter_standard_inventory_depth_global}

dcant_budget_global_all <- dcant_budget_global_all %>%
  filter(estimate == "dcant", 
         method == "total") %>% 
  select(-c(estimate, method)) %>% 
  rename(dcant = value)

dcant_budget_global_all <- dcant_budget_global_all %>%
  filter(inv_depth == params_global$inventory_depth_standard)

```

```{r filter_standard_inventory_depth_basins_hemisphere}

dcant_budget_basin_MLR_all <- dcant_budget_basin_MLR_all %>%
  filter(estimate == "dcant", 
         method == "total") %>% 
  select(-c(estimate, method)) %>% 
  rename(dcant = value)

dcant_budget_basin_MLR_all <- dcant_budget_basin_MLR_all %>%
  filter(inv_depth == params_global$inventory_depth_standard)

```


```{r r distuinguish_standard_case_and_ensemble_budget, include=FALSE}


dcant_budget_global_all_ensemble <- dcant_budget_global_all %>% 
  filter(!(Version_ID %in% Version_IDs_d))

dcant_budget_global_all_no_adj <- dcant_budget_global_all %>% 
  filter(Version_ID %in% Version_IDs_d)
  
dcant_budget_global_all <- dcant_budget_global_all %>%
  filter(Version_ID %in% Version_IDs)


dcant_budget_basin_MLR_all_ensemble <- dcant_budget_basin_MLR_all %>% 
  filter(!(Version_ID %in% Version_IDs_d))

dcant_budget_basin_MLR_all_no_adj <- dcant_budget_basin_MLR_all %>% 
  filter(Version_ID %in% Version_IDs_d)

dcant_budget_basin_MLR_all <- dcant_budget_basin_MLR_all %>%
  filter(Version_ID %in% Version_IDs)


```


## Column inventories

```{r read_inventory_files_ensemble}

for (i_Version_IDs in Version_IDs_ensemble) {
  # i_Version_IDs <- Version_IDs[1]
  
  path_version_data     <-
    paste(path_observations,
          i_Version_IDs,
          "/data/",
          sep = "")
  
  # load and join data files
  
  dcant_inv <-
    read_csv(paste(path_version_data,
                   "dcant_inv.csv",
                   sep = ""))
  
  dcant_inv_mod_truth <-
    read_csv(paste(path_version_data,
                   "dcant_inv_mod_truth.csv",
                   sep = "")) %>%
    filter(method == "total") %>%
    select(-method)
  
  dcant_inv_bias <-
    read_csv(paste(path_version_data,
                   "dcant_inv_bias.csv",
                   sep = "")) %>%
    mutate(Version_ID = i_Version_IDs)
  
  dcant_inv <- bind_rows(dcant_inv,
                         dcant_inv_mod_truth) %>%
    mutate(Version_ID = i_Version_IDs)
  
  dcant_budget_lat_grid <-
    read_csv(paste(path_version_data,
                   "dcant_budget_lat_grid.csv",
                   sep = "")) %>%
    mutate(Version_ID = i_Version_IDs)
  
  dcant_budget_lon_grid <-
    read_csv(paste(path_version_data,
                   "dcant_budget_lon_grid.csv",
                   sep = "")) %>%
    mutate(Version_ID = i_Version_IDs)
  if (exists("dcant_inv_all")) {
    dcant_inv_all <- bind_rows(dcant_inv_all, dcant_inv)
  }
  
  if (!exists("dcant_inv_all")) {
    dcant_inv_all <- dcant_inv
  }
  
  if (exists("dcant_inv_bias_all")) {
    dcant_inv_bias_all <- bind_rows(dcant_inv_bias_all, dcant_inv_bias)
  }
  
  if (!exists("dcant_inv_bias_all")) {
    dcant_inv_bias_all <- dcant_inv_bias
  }
  
  if (exists("dcant_budget_lat_grid_all")) {
    dcant_budget_lat_grid_all <- bind_rows(dcant_budget_lat_grid_all, dcant_budget_lat_grid)
  }
  
  if (!exists("dcant_budget_lat_grid_all")) {
    dcant_budget_lat_grid_all <- dcant_budget_lat_grid
  }
  
  if (exists("dcant_budget_lon_grid_all")) {
    dcant_budget_lon_grid_all <- bind_rows(dcant_budget_lon_grid_all, dcant_budget_lon_grid)
  }
  
  if (!exists("dcant_budget_lon_grid_all")) {
    dcant_budget_lon_grid_all <- dcant_budget_lon_grid
  }
}

rm(dcant_inv,
   dcant_inv_bias,
   dcant_inv_mod_truth,
   dcant_budget_lat_grid,
   dcant_budget_lon_grid)

```

```{r filter_standard_inventory_depth_inventory}

dcant_inv_all <- dcant_inv_all %>%
  filter(inv_depth == params_global$inventory_depth_standard)

dcant_budget_lat_grid_all <- dcant_budget_lat_grid_all %>% 
  filter(inv_depth == params_global$inventory_depth_standard)

dcant_budget_lon_grid_all <- dcant_budget_lon_grid_all %>% 
  filter(inv_depth == params_global$inventory_depth_standard)

```

```{r r join_iventory_data_and_meta_data, include=FALSE}


dcant_inv_all <- full_join(dcant_inv_all,
                           params_local_all_ensemble)

dcant_inv_bias_all <- full_join(dcant_inv_bias_all,
                                params_local_all_ensemble)


dcant_budget_lat_grid_all <- full_join(dcant_budget_lat_grid_all,
                                       params_local_all_ensemble)

dcant_budget_lon_grid_all <- full_join(dcant_budget_lon_grid_all,
                                       params_local_all_ensemble)

```

```{r adapt_iventory_format}

dcant_budget_lat_grid_all <- dcant_budget_lat_grid_all %>%
  pivot_wider(names_from = estimate,
              values_from = value) %>%
  filter(period != "1994 - 2014",
         method == "total")

dcant_budget_lon_grid_all <- dcant_budget_lon_grid_all %>%
  pivot_wider(names_from = estimate,
              values_from = value) %>%
  filter(period != "1994 - 2014",
         method == "total")


```


```{r r distuinguish_standard_case_and_ensemble_inventories, include=FALSE}


dcant_inv_bias_all_ensemble <- dcant_inv_bias_all %>% 
  filter(!(Version_ID %in% Version_IDs_d))

dcant_inv_bias_all <- dcant_inv_bias_all %>% 
  filter(Version_ID %in% Version_IDs)


dcant_budget_lat_grid_all_ensemble <- dcant_budget_lat_grid_all %>% 
  filter(!(Version_ID %in% Version_IDs_d))

dcant_budget_lat_grid_all <- dcant_budget_lat_grid_all %>% 
  filter(Version_ID %in% Version_IDs)


dcant_budget_lon_grid_all_ensemble <- dcant_budget_lon_grid_all %>% 
  filter(!(Version_ID %in% Version_IDs_d))

dcant_budget_lon_grid_all <- dcant_budget_lon_grid_all %>% 
  filter(Version_ID %in% Version_IDs)

```

```{r write_test_file_for_donghe, eval=FALSE}

dcant_inv_all %>% 
  filter(Version_ID == "v_1103",
         data_source == "obs") %>% 
  select(lon, lat, dcant) %>% 
  write_csv(here::here("output/dcant_column_inventor_example.csv"))

```



## Sections / profiles

```{r read_zonal_section_files}

for (i_Version_IDs in Version_IDs_ensemble) {

  path_version_data     <-
  paste(path_observations,
        i_Version_IDs,
        "/data/",
        sep = "")
  
  # load and join data files
  
  dcant_zonal <-
    read_csv(paste(path_version_data,
                   "dcant_zonal.csv",
                   sep = ""))
  
  dcant_zonal_mod_truth <-
    read_csv(paste(path_version_data,
                   "dcant_zonal_mod_truth.csv",
                   sep = ""))
  
  dcant_zonal <- bind_rows(dcant_zonal,
                         dcant_zonal_mod_truth)
  
  dcant_profile <-
    read_csv(paste(path_version_data,
                   "dcant_profile.csv",
                   sep = ""))
  
  dcant_profile_mod_truth <-
    read_csv(paste(path_version_data,
                   "dcant_profile_mod_truth.csv",
                   sep = ""))
  
  
  dcant_profile_basin_MLR <-
    read_csv(paste(path_version_data,
                   "dcant_profile_basin_MLR.csv",
                   sep = ""))
  
  dcant_profile <- bind_rows(dcant_profile,
                             dcant_profile_mod_truth)
  
  dcant_budget_basin_AIP_layer <-
    read_csv(paste(path_version_data,
                   "dcant_budget_basin_AIP_layer.csv",
                   sep = ""))

  dcant_budget_basin_MLR_layer <-
    read_csv(paste(path_version_data,
                   "dcant_budget_basin_MLR_layer.csv",
                   sep = ""))
  
  dcant_zonal_bias <-
    read_csv(paste(path_version_data,
                   "dcant_zonal_bias.csv",
                   sep = ""))
  

  dcant_zonal <- dcant_zonal %>% 
    mutate(Version_ID = i_Version_IDs)
  
  dcant_profile <- dcant_profile %>% 
    mutate(Version_ID = i_Version_IDs)

  dcant_profile_basin_MLR <- dcant_profile_basin_MLR %>% 
    mutate(Version_ID = i_Version_IDs)
  
  dcant_budget_basin_AIP_layer <- dcant_budget_basin_AIP_layer %>% 
    mutate(Version_ID = i_Version_IDs)
  
  dcant_budget_basin_MLR_layer <- dcant_budget_basin_MLR_layer %>% 
    mutate(Version_ID = i_Version_IDs)
  
  dcant_zonal_bias <- dcant_zonal_bias %>% 
    mutate(Version_ID = i_Version_IDs)

  
  if (exists("dcant_zonal_all")) {
    dcant_zonal_all <- bind_rows(dcant_zonal_all, dcant_zonal)
  }
  
  if (!exists("dcant_zonal_all")) {
    dcant_zonal_all <- dcant_zonal
  }

  if (exists("dcant_profile_all")) {
    dcant_profile_all <- bind_rows(dcant_profile_all, dcant_profile)
  }
  
  if (!exists("dcant_profile_all")) {
    dcant_profile_all <- dcant_profile
  }

  if (exists("dcant_profile_basin_MLR_all")) {
    dcant_profile_basin_MLR_all <- bind_rows(dcant_profile_basin_MLR_all, dcant_profile_basin_MLR)
  }
  
  if (!exists("dcant_profile_basin_MLR_all")) {
    dcant_profile_basin_MLR_all <- dcant_profile_basin_MLR
  }

  if (exists("dcant_budget_basin_AIP_layer_all")) {
    dcant_budget_basin_AIP_layer_all <-
      bind_rows(dcant_budget_basin_AIP_layer_all,
                dcant_budget_basin_AIP_layer)
  }
  
  if (!exists("dcant_budget_basin_AIP_layer_all")) {
    dcant_budget_basin_AIP_layer_all <- dcant_budget_basin_AIP_layer
  }

  if (exists("dcant_budget_basin_MLR_layer_all")) {
    dcant_budget_basin_MLR_layer_all <-
      bind_rows(dcant_budget_basin_MLR_layer_all,
                dcant_budget_basin_MLR_layer)
  }
  
  if (!exists("dcant_budget_basin_MLR_layer_all")) {
    dcant_budget_basin_MLR_layer_all <- dcant_budget_basin_MLR_layer
  }

  if (exists("dcant_zonal_bias_all")) {
    dcant_zonal_bias_all <- bind_rows(dcant_zonal_bias_all, dcant_zonal_bias)
  }
  
  if (!exists("dcant_zonal_bias_all")) {
    dcant_zonal_bias_all <- dcant_zonal_bias
  }

}

rm(dcant_zonal, dcant_zonal_bias, dcant_zonal_mod_truth,
   dcant_budget_basin_AIP_layer, dcant_budget_basin_MLR_layer,
   dcant_profile, dcant_profile_basin_MLR)

```

```{r r join_zonal_section_data_and_meta_data, include=FALSE}

dcant_zonal_all <- full_join(dcant_zonal_all,
                             params_local_all_ensemble)

dcant_profile_all <- full_join(dcant_profile_all,
                               params_local_all_ensemble)



dcant_profile_global_all <-
  dcant_profile_basin_MLR_all %>%
  filter(MLR_basins == "1") %>%
  select(-MLR_basins)

dcant_profile_global_all <-
  full_join(dcant_profile_global_all,
            params_local_all_ensemble)

dcant_profile_basin_MLR_all <-
  dcant_profile_basin_MLR_all %>%
  filter(MLR_basins %in% c("5", "1")) %>%
  select(-MLR_basins)

dcant_profile_basin_MLR_all <-
  full_join(dcant_profile_basin_MLR_all,
            params_local_all_ensemble)


dcant_profile_basin_MLR_all <-
  dcant_profile_basin_MLR_all %>%
  mutate(
    basin = str_replace(basin, "_", ". "),
    basin = str_replace(basin, "global", "Global"),
    basin = fct_relevel(
      basin,
      "N. Pacific",
      "S. Pacific",
      "N. Atlantic",
      "S. Atlantic",
      "Indian",
      "Global"
    )
  )


dcant_budget_basin_AIP_layer_all <-
  full_join(dcant_budget_basin_AIP_layer_all,
            params_local_all_ensemble)

dcant_budget_global_layer_all <-
  dcant_budget_basin_MLR_layer_all %>%
  filter(MLR_basins == "1") %>%
  select(-MLR_basins)

dcant_budget_global_layer_all <-
  full_join(dcant_budget_global_layer_all,
            params_local_all_ensemble)

dcant_budget_basin_MLR_layer_all <-
  dcant_budget_basin_MLR_layer_all %>%
  filter(MLR_basins %in% c("5", "1")) %>%
  select(-MLR_basins)


dcant_budget_basin_MLR_layer_all <-
  full_join(dcant_budget_basin_MLR_layer_all,
            params_local_all_ensemble)


dcant_budget_basin_MLR_layer_all <-
  dcant_budget_basin_MLR_layer_all %>%
  mutate(
    basin = str_replace(basin, "_", ". "),
    basin = str_replace(basin, "global", "Global"),
    basin = fct_relevel(
      basin,
      "N. Pacific",
      "S. Pacific",
      "N. Atlantic",
      "S. Atlantic",
      "Indian",
      "Global"
    )
  )


dcant_zonal_bias_all <- full_join(dcant_zonal_bias_all,
                                  params_local_all_ensemble)


```


```{r r distuinguish_standard_case_and_ensemble_sections_and_profiles, include=FALSE}


dcant_zonal_all_ensemble <- dcant_zonal_all %>% 
  filter(!(Version_ID %in% Version_IDs_d))
dcant_zonal_all <- dcant_zonal_all %>% 
  filter(Version_ID %in% Version_IDs)


dcant_profile_all_ensemble <- dcant_profile_all %>% 
  filter(!(Version_ID %in% Version_IDs_d))
dcant_profile_all_no_adj <- dcant_profile_all %>% 
  filter(Version_ID %in% Version_IDs_d)
dcant_profile_all <- dcant_profile_all %>% 
  filter(Version_ID %in% Version_IDs)

dcant_profile_global_all_ensemble <- dcant_profile_global_all %>% 
  filter(!(Version_ID %in% Version_IDs_d))
dcant_profile_global_all_no_adj <- dcant_profile_global_all %>% 
  filter(Version_ID %in% Version_IDs_d)
dcant_profile_global_all <- dcant_profile_global_all %>% 
  filter(Version_ID %in% Version_IDs)

dcant_profile_basin_MLR_all_ensemble <- dcant_profile_basin_MLR_all %>% 
  filter(!(Version_ID %in% Version_IDs_d))
dcant_profile_basin_MLR_all_no_adj <- dcant_profile_basin_MLR_all %>% 
  filter(Version_ID %in% Version_IDs_d)
dcant_profile_basin_MLR_all <- dcant_profile_basin_MLR_all %>% 
  filter(Version_ID %in% Version_IDs)



dcant_budget_global_layer_all_ensemble <-
  dcant_budget_global_layer_all %>%
  filter(!(Version_ID %in% Version_IDs_d))
dcant_budget_global_layer_all_no_adj <-
  dcant_budget_global_layer_all %>%
  filter(Version_ID %in% Version_IDs_d)
dcant_budget_global_layer_all <-
  dcant_budget_global_layer_all %>%
  filter(Version_ID %in% Version_IDs)


dcant_budget_basin_AIP_layer_all_ensemble <-
  dcant_budget_basin_AIP_layer_all %>%
  filter(!(Version_ID %in% Version_IDs_d))
dcant_budget_basin_AIP_layer_all <-
  dcant_budget_basin_AIP_layer_all %>%
  filter(Version_ID %in% Version_IDs)

dcant_budget_basin_MLR_layer_all_ensemble <-
  dcant_budget_basin_MLR_layer_all %>%
  filter(!(Version_ID %in% Version_IDs_d))
dcant_budget_basin_MLR_layer_all_no_adj <-
  dcant_budget_basin_MLR_layer_all %>%
  filter(Version_ID %in% Version_IDs_d)
dcant_budget_basin_MLR_layer_all <-
  dcant_budget_basin_MLR_layer_all %>%
  filter(Version_ID %in% Version_IDs)


dcant_zonal_bias_all_ensemble <- dcant_zonal_bias_all %>% 
  filter(!(Version_ID %in% Version_IDs_d))
dcant_zonal_bias_all <- dcant_zonal_bias_all %>% 
  filter(Version_ID %in% Version_IDs)

```



## Observations coverage

```{r read_coverage_grid_files}


for (i_Version_IDs in Version_IDs) {
  path_version_data     <-
    paste(path_observations,
          i_Version_IDs,
          "/data/",
          sep = "")
  
  # load and join data files
  
  GLODAP_grid_era  <-
    read_csv(paste(
      path_version_data,
      "GLODAPv2.2020_clean_obs_grid_era.csv",
      sep = ""
    ))

  
  GLODAP_grid_era <- GLODAP_grid_era %>%
    mutate(Version_ID = i_Version_IDs)
  
  if (exists("GLODAP_grid_era_all")) {
    GLODAP_grid_era_all <-
      bind_rows(GLODAP_grid_era_all, GLODAP_grid_era)
  }
  
  if (!exists("GLODAP_grid_era_all")) {
    GLODAP_grid_era_all <- GLODAP_grid_era
  }
  
  
  
  GLODAP <- read_csv(paste(
    path_version_data,
    "GLODAPv2.2020_clean.csv",
    sep = ""
  ))
  
  GLODAP <- GLODAP %>%
    mutate(Version_ID = i_Version_IDs)
  
  if (exists("GLODAP_all")) {
    GLODAP_all <-
      bind_rows(GLODAP_all, GLODAP)
  }
  
  if (!exists("GLODAP_all")) {
    GLODAP_all <- GLODAP
  }
  
}

rm(GLODAP_grid_era, GLODAP)


GLODAP_grid_era_all <- full_join(GLODAP_grid_era_all,
                                 params_local_all)

GLODAP_all <- full_join(GLODAP_all,
                        params_local_all)


GLODAP_expocodes <-
  read_tsv(
    paste(
      "/nfs/kryo/work/updata/glodapv2_2021/",
      "EXPOCODES.txt",
      sep = ""
    ),
    col_names = c("cruise", "cruise_expocode")
  )

GLODAP_all <-
  left_join(GLODAP_all, GLODAP_expocodes)


```



## Atm CO2

```{r read_atm_co2}

co2_atm <-
  read_csv(paste(path_preprocessing,
                 "co2_atm.csv",
                 sep = ""))

co2_atm_reccap2 <-
  read_csv(paste(path_preprocessing,
                  "co2_atm_reccap2.csv",
                  sep = ""))

```

## Sabine total Cant

```{r Sabine_tCant}


tcant_inv <-
  read_csv(paste(path_preprocessing,
                  "S04_tcant_inv.csv", sep = ""))

tcant_inv <- tcant_inv %>% 
  filter(inv_depth == 3000) %>% 
  rename(dcant = tcant,
         dcant_pos = tcant_pos) %>% 
  mutate(tref1 = 1800,
         tref2 = 1994)

```

## GCB carbon sink

```{r read_GCB_ocean_carbon_sink}

Ocean_Sink <-
  read_csv(paste(path_preprocessing,
                  "Ocean_Sink.csv",
                  sep = ""))

Global_Carbon_Budget <-
  read_csv(paste(path_preprocessing,
                  "GCB_Global_Carbon_Budget.csv",
                  sep = ""))

```

## Periods

```{r define_period_groups}

two_decades <- unique(params_local_all_ensemble$period)[1:2]

```


# Define labels

```{r define_legend_titles}

dcant_pgc_label <- expression(Delta * C["ant"]~(PgC))
dcant_pgc_scaled_label <- expression(beta~(PgC~µatm^{-1}))

dcant_umol_label <- expression(Delta * C[ant]~(mu * mol ~ kg ^ {-1}))
ddcant_umol_label <- expression(Delta * Delta * C[ant]~(mu * mol ~ kg ^ {-1}))

dcant_layer_budget_label <- 
  expression(Delta ~ C[ant] ~ "budget per 500m depth layer (PgC)")

dcant_CI_label <- expression(Delta * C[ant]~(mol ~ m ^ {-2}))
beta_CI_label <- expression(beta~(mol ~ m ^ {-2} ~ µatm ^ {-1}))


```

# Coverage maps

```{r coverage_maps}

cruises_phosphate_gap_fill <-
  c("33MW19930704",
    "33RO20030604",
    "33RO20050111",
    "33RO19980123")

cruises_talk_gap_fill <-
  c("06AQ19980328")

cruises_talk_calc <-
  c("06MT19900123",
    "316N19920502",
    "316N19921006")

GLODAP_all_coverage <- GLODAP_all %>% 
  distinct(lat, lon, era, cruise_expocode) %>% 
  mutate(gap_filling = case_when(
    cruise_expocode %in% cruises_phosphate_gap_fill ~ "PO4 w CANYON-B",
    cruise_expocode %in% cruises_talk_gap_fill ~ "TA w CANYON-B",
    cruise_expocode %in% cruises_talk_calc ~ "TA calculated",
    cruise_expocode %in% "31DS19940126" ~ "NO3 qc flag",
    TRUE ~ "None"
  )) %>% 
  distinct(lat, lon, era, gap_filling)

coverage_map <- map +
  geom_tile(data = GLODAP_all_coverage %>% filter(gap_filling == "None"),
            aes(lon, lat),
            fill = "#BBBBBB",
            col = "#BBBBBB") +
  geom_tile(data = GLODAP_all_coverage %>% filter(gap_filling != "None"),
            aes(lon, lat,
            fill = gap_filling, col = gap_filling)) +
  facet_wrap( ~ era, ncol = 2) +
  scale_color_bright(name = "Gap-filling") +
  scale_fill_bright(name = "Gap-filling") +
  theme(axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.position = c(0.7,0.3))

coverage_map

ggsave(plot = coverage_map,
       path = here::here("output/publication"),
       filename = "FigS_observations_coverage_map.png",
       height = 4,
       width = 8)

rm(coverage_map, 
   GLODAP_all, GLODAP_all_coverage, GLODAP_expocodes,
   GLODAP_grid_era_all)


rm(cruises_phosphate_gap_fill,
   cruises_talk_gap_fill,
   cruises_talk_calc)

```

# Atm CO2

```{r atm_CO2, fig.asp=1}

co2_atm_roll <- co2_atm %>% 
  mutate(pCO2_roll = zoo::rollmean(pCO2, 10, fill = NA))

p_pco2_atm <- co2_atm_roll %>% 
  ggplot() +
  geom_point(aes(year, pCO2, col="annual")) +
  geom_path(aes(year, pCO2, col="annual")) +
  geom_point(aes(year, pCO2_roll, col="10yr roll")) +
  geom_path(aes(year, pCO2_roll, col="10yr roll"))

co2_atm_roll <- co2_atm_roll %>% 
  mutate(delta_pCO2_roll = pCO2_roll - lag(pCO2_roll,10),
         delta_pCO2 = pCO2 - lag(pCO2,10))

p_delta_pCO2_atm <- co2_atm_roll %>% 
  ggplot() +
  geom_point(aes(year, delta_pCO2, col="annual")) +
  geom_path(aes(year, delta_pCO2, col="annual")) +
  geom_point(aes(year, delta_pCO2_roll, col="10yr roll")) +
  geom_path(aes(year, delta_pCO2_roll, col="10yr roll"))

p_pco2_atm / p_delta_pCO2_atm
rm(p_pco2_atm, p_delta_pCO2_atm)

delta_pCO2_atm <-
  left_join(
    params_local_all %>%
      distinct(period, tref1, tref2),
    co2_atm_roll %>%
      select(
        tref1 = year,
        pCO2_1 = pCO2,
        pCO2_roll_1 = pCO2_roll
      )
  )

delta_pCO2_atm <-
  left_join(
    delta_pCO2_atm,
    co2_atm_roll %>%
      select(
        tref2 = year,
        pCO2_2 = pCO2,
        pCO2_roll_2 = pCO2_roll
      )
  )

delta_pCO2_atm <- delta_pCO2_atm %>% 
  mutate(delta_pCO2 = pCO2_2 - pCO2_1,
         delta_pCO2_roll = pCO2_roll_2 - pCO2_roll_1) %>% 
  select(period, delta_pCO2, delta_pCO2_roll)

delta_pCO2_atm <- delta_pCO2_atm %>%
  select(period, delta_pCO2)

delta_pCO2_atm <- 
  bind_rows(
    delta_pCO2_atm,
    tibble(period = "1800 - 1994",
           delta_pCO2 = co2_atm %>% filter(year==1994) %>% pull(pCO2) - 280)
  )

rm(co2_atm_roll)

```


# Globale scaling

- Accumulation beneath 3000m: +2%
- unmapped regions south of 65N: +1.5%
- Nordic Seas: +1%
- Arctic Ocean: +2%

```{r scaling_factor_budgets_to_global_coverage}

dcant_scaling <- 1.02*1.015*1.01*1.02


```




# Inventory maps

## Absoulte values

### dcant - absolute

```{r calculate_scaled_inventories}

dcant_inv_all <- dcant_inv_all %>%
  filter(data_source %in% c("obs"))


dcant_inv_all <- bind_rows(
  dcant_inv_all,
  tcant_inv %>% mutate(period = paste(tref1, tref2, sep = " - "))
)

dcant_inv_all <- left_join(dcant_inv_all,
                           delta_pCO2_atm)


dcant_inv_all <- dcant_inv_all %>% 
  mutate(beta = dcant / delta_pCO2,
         beta_pos = dcant_pos / delta_pCO2) %>% 
  select(-starts_with("pCO2"))

dcant_inv_all_ensemble <- dcant_inv_all

dcant_inv_all <- dcant_inv_all %>% 
  filter(Version_ID %in% Version_IDs | is.na(Version_ID))


```


```{r invetory_maps_absolute, fig.asp=1.2}

p_CI_absolute <- dcant_inv_all %>%
  filter(period %in% two_decades) %>%
  p_map_cant_inv(var = "dcant",
                 title_text = NULL) +
  facet_wrap(~ period, ncol = 1) +
  theme(axis.text.x = element_blank()) 

p_CI_absolute


```

```{r dcant_inventory_stats}

dcant_inv_stat_mean <- 
full_join(basinmask,
          dcant_inv_all) %>% 
  mutate(surf_area = earth_surf(lat, lon)) %>% 
  group_by(basin, period) %>% 
  summarise(dcant = weighted.mean(dcant, surf_area)) %>% 
  ungroup() %>% 
  filter(!is.na(dcant))
  
dcant_inv_stat_ensemble <- 
full_join(basinmask,
          dcant_inv_all_ensemble) %>% 
  mutate(surf_area = earth_surf(lat, lon)) %>% 
  group_by(basin, data_source, period, MLR_basins, Version_ID_group) %>% 
  summarise(dcant = weighted.mean(dcant, surf_area)) %>% 
  ungroup() %>% 
  filter(!is.na(dcant)) %>% 
  group_by(basin, data_source, period) %>% 
  summarise(dcant_sd = sd(dcant)*2) %>% 
  ungroup()

dcant_inv_stat <- 
full_join(dcant_inv_stat_mean,
          dcant_inv_stat_ensemble)  

rm(dcant_inv_stat_mean,
          dcant_inv_stat_ensemble)  

dcant_inv_stat %>%
  filter(period %in% two_decades) %>%
  group_by(basin) %>%
  mutate(delta_dcant = dcant - lag(dcant),
         RSS = sqrt(dcant_sd ^ 2 + lag(dcant_sd ^ 2))) %>%
  ungroup() %>%
  kable() %>%
  kable_styling() %>%
  scroll_box(height = "300px")


```



### dcant - absolute delta

```{r invetory_maps_absolute_delta, fig.asp=1.3}

p_CI_delta <-
  dcant_inv_all %>%
  filter(data_source %in% c("obs"),
         period %in% two_decades) %>%
  select(data_source, lon, lat, basin_AIP, period, dcant) %>%
  pivot_wider(names_from = period,
              values_from = dcant) %>%
  mutate(dcant_offset = `2004 - 2014` - `1994 - 2004`,
         period = "(2004 - 2014) - (1994 - 2004)") %>%
  group_by(data_source) %>%
  group_split() %>%
  # head(1) %>%
  map(
    ~ p_map_cant_inv(
      df = .x,
      var = "dcant_offset",
      title_text = NULL,
      subtitle_text = NULL,
      col = "bias"
    ) +
      facet_wrap(~ period)
  )

p_CI_absolute / p_CI_delta + 
  plot_annotation(tag_levels = 'A')

ggsave(path = here::here("output/publication"),
       filename = "Fig_dcant_column_inventory.png",
       height = 10,
       width = 8)

rm(p_CI_absolute, p_CI_delta)

```

### Ensemble SD

```{r column_inventory_standard_deviation}


dcant_inv_all_ensemble_mean <-
  dcant_inv_all_ensemble %>%
  filter(period != "1800 - 1994",
         data_source == "obs") %>%
  group_by(data_source, period, lon, lat) %>%
  summarise(dcant_sd = sd(dcant)*2) %>%
  ungroup()


dcant_inv_all_ensemble_mean %>%
  p_map_cant_inv(var = "dcant_sd",
                 breaks = c(seq(0, 8, 1), Inf),
                 title_text = NULL) +
  facet_grid(period ~ .) +
  theme(axis.text = element_blank(),
        axis.ticks = element_blank())

# ggsave(path = here::here("output/publication"),
#        filename = "FigS_dcant_column_inventory_ensemble_standard_deviation.png",
#        height = 6,
#        width = 6)

```

### Unadjusted data

```{r column_inventory_unadjusted_data}


dcant_inv_all_unadjusted <-
  dcant_inv_all_ensemble %>%
  filter(period %in% two_decades,
         data_source == "obs",
         MLR_basins == "3",
         Version_ID %in% Version_IDs |
           Version_ID %in% Version_IDs_d)


dcant_inv_all_unadjusted %>%
  p_map_cant_inv(var = "dcant",
                 title_text = NULL) +
  facet_grid(Version_ID_group ~ period)

ggsave(path = here::here("output/publication"),
       filename = "FigS_dcant_column_inventory_unadjusted_data.png",
       height = 4,
       width = 8)

```

### beta

```{r beta_CI_maps, fig.asp=1.2}

dcant_inv_all %>%
  p_map_cant_inv(var = "beta",
                 breaks = c(-Inf, seq(0, 1, 0.1), Inf),
                 title_text = NULL) +
  facet_grid(period ~ .)

ggsave(path = here::here("output/publication"),
       filename = "FigS_beta_column_inventory.png",
       height = 8,
       width = 6)

```



## Zonal means

```{r calc_zonal_mean_storage}

dcant_inv_all <- m_grid_horizontal_coarse(dcant_inv_all)

dcant_inv_all_lat_mean <- dcant_inv_all %>% 
  group_by(basin_AIP, period, lat_grid) %>% 
  summarise(beta = mean(beta, na.rm = TRUE),
            dcant = mean(dcant, na.rm = TRUE)) %>% 
  ungroup()

dcant_inv_all_ensemble <- m_grid_horizontal_coarse(dcant_inv_all_ensemble)

dcant_inv_all_ensemble_lat_mean <- dcant_inv_all_ensemble %>% 
  group_by(basin_AIP, period, lat_grid, Version_ID) %>% 
  summarise(beta_mean = mean(beta, na.rm = TRUE),
            dcant_mean = mean(dcant, na.rm = TRUE)) %>% 
  ungroup()

dcant_inv_all_ensemble_lat_mean_average <- dcant_inv_all_ensemble_lat_mean %>% 
  group_by(basin_AIP, period, lat_grid) %>% 
  summarise(beta_sd = sd(beta_mean, na.rm = TRUE),
            beta_mean = mean(beta_mean, na.rm = TRUE),
            dcant_sd = sd(dcant_mean, na.rm = TRUE),
            dcant_mean = mean(dcant_mean, na.rm = TRUE)) %>% 
  ungroup()

dcant_inv_all_lat_mean <- full_join(dcant_inv_all_lat_mean,
                                    dcant_inv_all_ensemble_lat_mean_average)


```


### dcant

```{r zonal_mean_storage_dcant}

dcant_inv_all_lat_mean %>%
  filter(period != "1800 - 1994") %>% 
  ggplot(aes(lat_grid, dcant, fill = period)) +
  geom_hline(yintercept = c(0,10)) +
  geom_vline(xintercept = c(-10,10)) +
  geom_vline(xintercept = c(-40,-30,30,40)) +
  geom_ribbon(aes(ymin = dcant - dcant_sd,
                  ymax = dcant + dcant_sd),
              alpha = 0.3) +
  geom_path(aes(col = period)) +
  geom_point(shape = 21) +
  scale_color_brewer(palette = "Dark2", name = "Mean ± SD") +
  scale_fill_brewer(palette = "Dark2", name = "Mean ± SD") +
  coord_flip() +
  facet_grid(. ~ basin_AIP) +
  labs(x = "Latitude (°N)",
       y = dcant_CI_label) +
  scale_x_continuous(breaks = seq(-75,75, 15))

dcant_inv_all_lat_mean %>%
  filter(period != "1800 - 1994") %>% 
  mutate(lat_grid = cut(lat_grid, c(-40,-30,-10,10,30,40))) %>% 
  group_by(lat_grid) %>% 
  summarise(dcant_mean = mean(dcant_mean, na_rm = TRUE)) %>% 
  ungroup()

dcant_inv_all_lat_mean %>%
  filter(period != "1800 - 1994") %>% 
  mutate(lat_grid = cut(lat_grid, c(-40,-30,-10,10,30,40))) %>% 
  group_by(lat_grid, basin_AIP) %>% 
  summarise(dcant_mean = mean(dcant_mean, na_rm = TRUE)) %>% 
  ungroup()

dcant_inv_all_lat_mean %>%
  filter(period != "1800 - 1994") %>% 
  mutate(lat_grid = cut(lat_grid, c(-90,0,90))) %>% 
  group_by(lat_grid, basin_AIP, period) %>% 
  summarise(dcant_mean = mean(dcant_mean, na_rm = TRUE)) %>% 
  ungroup()


dcant_inv_all_ensemble_lat_mean %>% 
  ggplot(aes(lat_grid, dcant_mean, fill=period, group=Version_ID)) +
  geom_hline(yintercept = 0) +
  geom_path(aes(col=period), alpha = 0.3) +
  scale_color_brewer(palette = "Dark2") +
  scale_fill_brewer(palette = "Dark2") +
  coord_flip() +
  facet_grid(. ~ basin_AIP) +
  labs(x = "Latitude (°N)",
       y = dcant_CI_label)

```


### beta

```{r zonal_mean_storage_beta}

dcant_inv_all_lat_mean %>%
  ggplot(aes(lat_grid, beta, fill = period)) +
  geom_hline(yintercept = 0) +
  geom_ribbon(aes(ymin = beta - beta_sd,
                  ymax = beta + beta_sd),
              alpha = 0.3) +
  geom_path(aes(col = period)) +
  geom_point(shape = 21) +
  scale_color_brewer(palette = "Dark2", name = "Mean ± SD") +
  scale_fill_brewer(palette = "Dark2", name = "Mean ± SD") +
  coord_flip() +
  facet_grid(. ~ basin_AIP) +
  labs(x = "Latitude (°N)",
       y = beta_CI_label) +
  scale_x_continuous(breaks = seq(-75,75, 15))

dcant_inv_all_ensemble_lat_mean %>% 
  ggplot(aes(lat_grid, beta_mean, fill=period, group=Version_ID)) +
  geom_hline(yintercept = 0) +
  geom_path(aes(col=period), alpha = 0.3) +
  scale_color_brewer(palette = "Dark2") +
  scale_fill_brewer(palette = "Dark2") +
  coord_flip() +
  facet_grid(. ~ basin_AIP) +
  labs(x = "Latitude (°N)",
       y = beta_CI_label)
```


# Zonal sections

## dcant - absolut

```{r zonal_sections}


p_dcant_zonal_absolute <-
  dcant_zonal_all %>%
  filter(
    data_source == "obs",
    period %in% two_decades,
    depth <= params_global$inventory_depth_standard
  ) %>%
  p_section_zonal_continous_depth(var = "dcant",
                                  plot_slabs = "n",
                                  title_text = NULL) +
  geom_contour(aes(lat, depth, z = dcant),
               breaks = 5,
               col = "white") +
  # geom_text_contour(
  #   aes(lat, depth, z = dcant),
  #   breaks = 5,
  #   stroke = 0.2,
  #   stroke.colour = "white",
  #   rotate = FALSE,
  #   label.placer = label_placer_n(n = 1)
  # ) +
  facet_grid(period ~ basin_AIP) +
  theme(
    axis.text.x = element_blank(),
    axis.title.x = element_blank(),
    legend.position = "top"
  ) +
  guides(fill = guide_colorsteps(
    barheight = unit(0.5, "cm"),
    barwidth = unit(7, "cm"),
    show.limits = FALSE
  ))

p_dcant_zonal_absolute


```

```{r zonal_sections_basin, eval=FALSE}

dcant_zonal_all %>%
  filter(
    data_source == "obs",
    period != "1994 - 2014",
    depth <= params_global$inventory_depth_standard
  ) %>%
  group_split(basin_AIP) %>%
  # head(1) %>%
  map(
    ~ p_section_zonal_continous_depth(
      df = .x,
      var = "dcant",
      breaks = c(-Inf, -1, 0, 1, seq(2,16,2), Inf),
      plot_slabs = "n",
      title_text = .x$basin_AIP,
      subtitle_text = NULL
    ) +
      facet_grid(period ~ .)
  )


```

## dcant - absolute delta

```{r inventory_maps_absolute_delta}

dcant_zonal_all %>%
  filter(data_source %in% c("mod", "obs"),
         period != "1994 - 2014") %>%
  select(data_source, lat, depth, basin_AIP, period, dcant) %>%
  pivot_wider(names_from = period,
              values_from = dcant) %>%
  mutate(delta_dcant = `2004 - 2014` - `1994 - 2004`) %>%
  group_by(data_source) %>%
  group_split() %>%
  # head(1) %>%
  map(
    ~ p_section_zonal_continous_depth(
      df = .x,
      var = "delta_dcant",
      plot_slabs = "n",
      subtitle_text = unique(.x$data_source),
      col = "bias"
    ) +
      facet_grid(basin_AIP ~ .)
  )

p_dcant_zonal_delta <-
  dcant_zonal_all %>%
  filter(data_source %in% c("obs"),
         period != "1994 - 2014") %>%
  select(data_source, lat, depth, basin_AIP, period, gamma_mean, dcant) %>%
  pivot_wider(names_from = period,
              values_from = dcant) %>%
  mutate(delta_dcant = `2004 - 2014` - `1994 - 2004`) %>%
  group_by(data_source) %>%
  group_split() %>%
  # head(1) %>%
  map(
    ~ p_section_zonal_continous_depth(
      df = .x,
      var = "delta_dcant",
      plot_slabs = "y",
      drop_slabs = 1,
      subtitle_text = NULL,
      title_text = NULL,
      col = "bias"
    ) +
      facet_grid("Dec. diff." ~ basin_AIP) +
      theme(
        strip.text.x = element_blank(),
        strip.background.x = element_blank(),
        legend.position = "bottom"
      ) +
      guides(fill = guide_colorsteps(
        barheight = unit(0.5, "cm"),
        barwidth = unit(10, "cm"),
        show.limits = FALSE
      ))
  )

p_dcant_zonal_absolute / p_dcant_zonal_delta + 
  plot_layout(heights = c(2,1)) +
  plot_annotation(tag_levels = 'A')

ggsave(path = here::here("output/publication"),
       filename = "Fig_dcant_zonal_mean_section.png",
       height = 6,
       width = 8)

rm(p_dcant_zonal_absolute, p_dcant_zonal_delta)
```


# Concentration profiles

## dcant, abs

### Global

```{r concentration_profiles_global}

dcant_profile_global_all %>%
  arrange(depth) %>%
  filter(period != "1994 - 2014",
         depth <= params_global$inventory_depth_standard) %>%
  group_split(data_source) %>%
  # head(1) %>%
  map(
    ~ ggplot(data = .x,
             aes(dcant,
                 depth)) +
      geom_hline(yintercept = params_global$inventory_depth_standard) +
      geom_vline(xintercept = 0) +
      geom_ribbon(
        aes(
          xmin = dcant - dcant_sd,
          xmax = dcant + dcant_sd,
          fill = period
        ),
        alpha = 0.3
      ) +
      geom_path(aes(col = period)) +
      scale_y_continuous(trans = trans_reverser("sqrt"),
                         breaks = c(0, 100, 500, seq(1500, 5000, 1000))) +
      # scale_y_reverse(breaks = c(0, 100, 500, seq(1500, 5000, 1000))) +
      coord_cartesian(expand = 0) +
      scale_color_brewer(
        palette = "Set1",
        name = "mean \u00B1 sd",
        direction = -1
      ) +
      scale_fill_brewer(
        palette = "Set1",
        name = "mean \u00B1 sd",
        direction = -1
      ) +
      labs(
        title = paste("data_source", unique(.x$data_source)),
        y = "Depth (m)",
        x = dcant_umol_label
      ) +
      facet_wrap( ~ basin, ncol = 3, dir = "v") +
      theme(legend.position = c(0.8, 0.2))
  )

mean_surface_dcant <- dcant_profile_global_all %>%
  arrange(depth) %>%
  filter(period != "1994 - 2014",
         data_source == "obs") %>% 
  filter(depth <= 50) %>%
  group_by(period) %>% 
  summarise(mean_surface_dcant = mean(dcant)) %>% 
  ungroup()

full_join(dcant_profile_global_all_ensemble,
          mean_surface_dcant) %>%
  arrange(depth) %>%
  filter(period != "1994 - 2014",
         data_source == "obs") %>%
  filter(dcant >= mean_surface_dcant / 2) %>%
  group_by(period, Version_ID) %>%
  summarise(max_depth = max(depth)) %>%
  ungroup() %>% 
  summarise(sd_max_depth = sd(max_depth)*2,
            mean_max_depth = mean(max_depth))
  


```

### basin hemisphere

```{r concentration_profiles_MLR_basins, fig.asp=0.9}

dcant_profile_basin_MLR_all %>%
  arrange(depth) %>%
  filter(period != "1994 - 2014",
         depth <= params_global$inventory_depth_standard) %>%
  group_split(data_source) %>%
  # head(1) %>%
  map(
    ~ ggplot(data = .x,
             aes(dcant,
                 depth)) +
      geom_hline(yintercept = params_global$inventory_depth_standard) +
      geom_vline(xintercept = 0) +
      geom_ribbon(
        aes(
          xmin = dcant - dcant_sd,
          xmax = dcant + dcant_sd,
          fill = period
        ),
        alpha = 0.3
      ) +
      geom_path(aes(col = period)) +
      scale_y_continuous(trans = trans_reverser("sqrt"),
                         breaks = c(0, 100, 500, seq(1500, 5000, 1000))) +
      coord_cartesian(expand = 0) +
      scale_color_brewer(palette = "Set1", name = "mean \u00B1 sd", direction = -1) +
      scale_fill_brewer(palette = "Set1", name = "mean \u00B1 sd", direction = -1) +
      labs(
        title = paste("data_source", unique(.x$data_source)),
        y = "Depth (m)",
        x = dcant_umol_label
      ) +
      facet_wrap(~ basin, ncol = 3, dir = "v") +
      theme(legend.position = c(0.8,0.2))
  )


```

## dcant, abs, ensemble

### Global

```{r concentration_profiles_global_ensemble}

dcant_profile_global_all_ensemble %>%
  arrange(depth) %>%
  filter(
    period != "1994 - 2014",
    depth <= params_global$inventory_depth_standard,
    data_source == "obs"
  ) %>%
  group_split(data_source) %>%
  map(
    ~ ggplot() +
      geom_hline(yintercept = params_global$inventory_depth_standard) +
      geom_vline(xintercept = 0) +
      geom_path(
        data = .x,
        aes(
          dcant,
          depth,
          col = period,
          group = Version_ID,
          linetype = "Ensemble member",
          size = "Ensemble member"
        ), alpha = 0.5
      ) +
      geom_path(
        data = .x %>% filter(Version_ID %in% Version_IDs),
        aes(
          dcant,
          depth,
          col = period,
          group = Version_ID,
          linetype = "Standard case",
          size = "Standard case"
        )
      ) +
      scale_size_manual(values = c(0.5, 2), name="x") +
      scale_linetype_manual(values = c(2, 1), name="x") +
      scale_y_continuous(trans = trans_reverser("sqrt"),
                         breaks = c(0, 100, 500, seq(1500, 5000, 1000))) +
      coord_cartesian(expand = 0) +
      scale_color_brewer(
        palette = "Set1",
        direction = -1
      ) +
      scale_fill_brewer(
        palette = "Set1",
        direction = -1
      ) +
      labs(
        # title = paste("data_source", unique(.x$data_source)),
        y = "Depth (m)",
        x = dcant_umol_label
      ) +
      facet_wrap( ~ basin, ncol = 3, dir = "v") +
      theme(legend.position = c(0.85, 0.3),
            legend.title = element_blank())
  )


```

### basin hemisphere

```{r concentration_profiles_MLR_basins_ensemble_individual, fig.asp=0.9}

dcant_profile_basin_MLR_all_ensemble %>%
  arrange(depth) %>%
  filter(
    period != "1994 - 2014",
    depth <= params_global$inventory_depth_standard,
    data_source == "obs"
  ) %>%
  group_split(data_source) %>%
  map(
    ~ ggplot() +
      geom_hline(yintercept = params_global$inventory_depth_standard) +
      geom_vline(xintercept = 0) +
      geom_path(
        data = .x,
        aes(
          dcant,
          depth,
          col = period,
          group = Version_ID,
          linetype = "Ensemble member",
          size = "Ensemble member",
          alpha = "Ensemble member"
        )
      ) +
      geom_path(
        data = .x %>% filter(Version_ID %in% Version_IDs),
        aes(
          dcant,
          depth,
          col = period,
          group = Version_ID,
          linetype = "Standard case",
          alpha = "Standard case",
          size = "Standard case"
        )
      ) +
      geom_path(
        data = .x %>% filter(Version_ID %in% Version_IDs),
        aes(
          dcant,
          depth,
          group = Version_ID
        )
      ) +
      scale_size_manual(values = c(0.7, 1.5), name="x") +
      scale_linetype_manual(values = c(1, 1), name="x") +
      scale_alpha_manual(values = c(0.4, 1), name="x") +
      scale_y_continuous(trans = trans_reverser("sqrt"),
                         breaks = c(0, 100, 500, seq(1500, 5000, 1000))) +
      coord_cartesian(expand = 0) +
      scale_color_brewer(
        palette = "Set1",
        direction = -1
      ) +
      scale_fill_brewer(
        palette = "Set1",
        direction = -1
      ) +
      labs(
        # title = paste("data_source", unique(.x$data_source)),
        y = "Depth (m)",
        x = dcant_umol_label
      ) +
      facet_wrap( ~ basin, ncol = 3, dir = "v") +
      theme(legend.position = "top")
  )




mean_surface_dcant <- dcant_profile_basin_MLR_all %>%
  arrange(depth) %>%
  filter(period != "1994 - 2014",
         data_source == "obs") %>% 
  filter(depth <= 50) %>%
  group_by(basin, period) %>% 
  summarise(mean_surface_dcant = mean(dcant)) %>% 
  ungroup()

full_join(dcant_profile_basin_MLR_all,
          mean_surface_dcant) %>%
  arrange(depth) %>%
  filter(period != "1994 - 2014",
         data_source == "obs") %>% 
  filter(dcant >= mean_surface_dcant/2) %>%
  group_by(period, basin, Version_ID) %>% 
  summarise(max_depth = max(depth)) %>% 
  ungroup() %>% 
  group_by(basin, period) %>% 
  summarise(sd_max_depth = sd(max_depth)*2,
            mean_max_depth = mean(max_depth)) %>% 
  ungroup()
  

full_join(dcant_profile_basin_MLR_all_ensemble,
          mean_surface_dcant) %>%
  arrange(depth) %>%
  filter(period != "1994 - 2014",
         data_source == "obs") %>% 
  filter(dcant >= mean_surface_dcant/2) %>%
  group_by(period, basin, Version_ID) %>% 
  summarise(max_depth = max(depth)) %>% 
  ungroup() %>% 
  group_by(basin, period) %>% 
  summarise(sd_max_depth = sd(max_depth)*2,
            mean_max_depth = mean(max_depth)) %>% 
  ungroup()
  


```

```{r concentration_profiles_MLR_basins_ensemble_uncertainty_ribbon, fig.asp=0.9}

dcant_profile_basin_MLR_range <- dcant_profile_basin_MLR_all_ensemble %>%
  filter(period != "1994 - 2014",
         data_source == "obs") %>%
  group_by(basin, depth, period) %>% 
  summarise(dcant_sd = sd(dcant)*2) %>%
  ungroup()

dcant_profile_basin_MLR_all_ensemble <-
full_join(dcant_profile_basin_MLR_all_ensemble %>% select(-dcant_sd),
          dcant_profile_basin_MLR_range)

p_dcant_profiles <-
  dcant_profile_basin_MLR_all_ensemble %>%
  arrange(depth) %>%
  filter(
    period != "1994 - 2014",
    depth <= params_global$inventory_depth_standard,
    data_source == "obs",
    Version_ID %in% Version_IDs
  ) %>%
  ggplot() +
  geom_vline(xintercept = 0, size = 0.1) +
  geom_hline(yintercept = 1000, size = 0.1) +
  geom_ribbon(
    aes(
      xmin = dcant - dcant_sd,
      xmax = dcant + dcant_sd,
      y = depth,
      fill = period,
      group = Version_ID
    ),
    alpha = 0.5
  ) +
  geom_path(
    aes(dcant,
        depth,
        col = period,
        group = Version_ID,)
  ) +
  scale_y_continuous(trans = trans_reverser("sqrt"),
                     breaks = c(0, 100, 500, seq(1000, 5000, 1000))) +
  coord_cartesian(expand = 0) +
  scale_color_manual(values = c("#EE7733", "#009988"), name = "Mean \u00B1 2 SD") +
  scale_fill_manual(values = c("#EE7733", "#009988"), name = "Mean \u00B1 2 SD") +
  labs(y = "Depth (m)",
       x = dcant_umol_label) +
  facet_wrap(~ basin, ncol = 3, dir = "v") +
  theme(legend.position = c(0.9, 0.1))

p_dcant_profiles

mean_surface_dcant <- dcant_profile_basin_MLR_all %>%
  arrange(depth) %>%
  filter(period != "1994 - 2014",
         data_source == "obs") %>% 
  filter(depth <= 50) %>%
  group_by(basin, period) %>% 
  summarise(mean_surface_dcant = mean(dcant)) %>% 
  ungroup()

full_join(dcant_profile_basin_MLR_all,
          mean_surface_dcant) %>%
  arrange(depth) %>%
  filter(period != "1994 - 2014",
         data_source == "obs") %>% 
  filter(dcant >= mean_surface_dcant/2) %>%
  group_by(period, basin, Version_ID) %>% 
  summarise(max_depth = max(depth)) %>% 
  ungroup() %>% 
  group_by(basin, period) %>% 
  summarise(sd_max_depth = sd(max_depth)*2,
            mean_max_depth = mean(max_depth)) %>% 
  ungroup()
  

full_join(dcant_profile_basin_MLR_all_ensemble,
          mean_surface_dcant) %>%
  arrange(depth) %>%
  filter(period != "1994 - 2014",
         data_source == "obs") %>% 
  filter(dcant >= mean_surface_dcant/2) %>%
  group_by(period, basin, Version_ID) %>% 
  summarise(max_depth = max(depth)) %>% 
  ungroup() %>% 
  group_by(basin, period) %>% 
  summarise(sd_max_depth = sd(max_depth)*2,
            mean_max_depth = mean(max_depth)) %>% 
  ungroup()
  


```

```{r concentration_profiles_MLR_basins_ensemble_basin_separation, fig.asp=0.9}


dcant_profile_basin_MLR_all_ensemble %>%
  arrange(depth) %>%
  filter(
    period != "1994 - 2014",
    depth <= params_global$inventory_depth_standard,
    data_source == "obs"
  ) %>%
  group_split(data_source) %>%
  map(
    ~ ggplot() +
      geom_hline(yintercept = params_global$inventory_depth_standard) +
      geom_vline(xintercept = 0) +
      geom_path(
        data = .x,
        aes(dcant,
            depth,
            col = MLR_basins,
            group = Version_ID),
        alpha = 0.5
      ) +
      scale_size_manual(values = c(0.5, 2), name = "x") +
      scale_linetype_manual(values = c(2, 1), name = "x") +
      scale_y_continuous(trans = trans_reverser("sqrt"),
                         breaks = c(0, 100, 500, seq(1500, 5000, 1000))) +
      coord_cartesian(expand = 0) +
      scale_color_brewer(palette = "Dark2") +
      labs(y = "Depth (m)",
           x = dcant_umol_label) +
      facet_grid(basin ~ period)
  )


```

```{r concentration_profiles_MLR_basins_ensemble_member, fig.asp=1.5}

dcant_profile_basin_MLR_all_ensemble %>%
  arrange(depth) %>%
  filter(
    # period != "1994 - 2014",
    depth <= params_global$inventory_depth_standard
    # data_source == "obs"
  ) %>%
  group_split(data_source) %>%
  # head(1) %>% 
  map(
    ~ ggplot() +
      geom_hline(yintercept = params_global$inventory_depth_standard) +
      geom_vline(xintercept = 0) +
      geom_path(
        data = .x,
        aes(
          dcant,
          depth,
          col = Version_ID_group,
          group = Version_ID
        ), alpha = 0.5
      ) +
      scale_y_continuous(trans = trans_reverser("sqrt"),
                         breaks = c(0, 100, 500, seq(1500, 5000, 1000))) +
      coord_cartesian(expand = 0) +
      scale_color_brewer(
        palette = "Dark2",
        direction = -1
      ) +
      scale_fill_brewer(
        palette = "Set1",
        direction = -1
      ) +
      labs(
        y = "Depth (m)",
        x = dcant_umol_label,
        title = unique(.x$data_source)
      ) +
      facet_grid(basin ~ period)
  )

```

```{r concentration_profiles_MLR_basins_seperate, fig.asp=1.2, eval=FALSE}

dcant_profile_basin_MLR_all %>%
  arrange(depth) %>%
  filter(period != "1994 - 2014",
         depth <= params_global$inventory_depth_standard) %>%
  group_split(data_source, basin) %>%
  # head(1) %>%
  map(
    ~ ggplot(data = .x,
             aes(dcant,
                 depth)) +
      geom_hline(yintercept = params_global$inventory_depth_standard) +
      geom_vline(xintercept = 0) +
      geom_ribbon(
        aes(
          xmin = dcant - dcant_sd,
          xmax = dcant + dcant_sd,
          fill = period
        ),
        alpha = 0.3
      ) +
      geom_path(aes(col = period)) +
      scale_y_continuous(trans = trans_reverser("sqrt"),
                         breaks = c(0, 100, 500, seq(1500, 5000, 1000))) +
      coord_cartesian(expand = 0) +
      scale_color_brewer(palette = "Set1", name = "mean \u00B1 sd", direction = -1) +
      scale_fill_brewer(palette = "Set1", name = "mean \u00B1 sd", direction = -1) +
      labs(
        title = paste("data_source", unique(.x$data_source),
                      "|", unique(.x$basin)),
        y = "Depth (m)",
        x = dcant_umol_label
      ) +
      # facet_wrap(~ basin, ncol = 3, dir = "v") +
      theme(legend.position = c(0.8,0.2))
  )


```

## dcant - absolute delta


```{r concentration_profiles_MLR_basins_offset}

delta <- dcant_profile_basin_MLR_all %>%
  arrange(depth) %>%
  filter(period != "1994 - 2014") %>%
  select(data_source, depth, basin, period, dcant) %>%
  pivot_wider(names_from = period,
              values_from = dcant) %>%
  mutate(delta_dcant = `2004 - 2014` - `1994 - 2004`) %>%
  select(-c(`2004 - 2014`, `1994 - 2004`))

delta_sd <- dcant_profile_basin_MLR_all %>%
  arrange(depth) %>%
  filter(period != "1994 - 2014") %>%
  select(data_source, depth, basin, period, dcant_sd) %>% 
  pivot_wider(names_from = period,
              values_from = dcant_sd) %>%
  mutate(delta_dcant_sd = sqrt(`2004 - 2014`^2 + `1994 - 2004`^2)) %>% 
  select(-c(`2004 - 2014`, `1994 - 2004`))

dcant_profile_basin_MLR_all_delta <- full_join(delta, delta_sd)
rm(delta, delta_sd)



dcant_profile_basin_MLR_all_delta %>%
  group_split(data_source) %>%
  # head(3) %>%
  map(
    ~ ggplot(data = .x,
             aes(delta_dcant,
                 depth)) +
      geom_hline(yintercept = params_global$inventory_depth_standard) +
      geom_vline(xintercept = 0) +
      geom_ribbon(
        aes(
          xmin = delta_dcant - delta_dcant_sd,
          xmax = delta_dcant + delta_dcant_sd
        ),
        alpha = 0.3
      ) +
      geom_path() +
      scale_y_continuous(trans = trans_reverser("sqrt"),
                         breaks = c(0, 100, 500, seq(1500, 5000, 1000))) +
      coord_cartesian(expand = 0) +
      scale_color_brewer(palette = "Set1", name = "mean \u00B1 sd") +
      scale_fill_brewer(palette = "Set1", name = "mean \u00B1 sd") +
      labs(
        title = paste("data_source", unique(.x$data_source)),
        y = "Depth (m)",
        x = ddcant_umol_label
      ) +
      facet_wrap(~ basin, ncol = 3)
  )

```


# Budgets


```{r scale_dcant_budgets_to_global_coverage}

dcant_budget_global_all_ensemble <- dcant_budget_global_all_ensemble %>% 
  mutate(dcant = dcant * dcant_scaling)

dcant_budget_global_all <- dcant_budget_global_all %>% 
  mutate(dcant = dcant * dcant_scaling)

dcant_budget_global_all_no_adj <- dcant_budget_global_all_no_adj %>% 
  mutate(dcant = dcant * dcant_scaling)

dcant_budget_basin_MLR_all_ensemble <- dcant_budget_basin_MLR_all_ensemble %>% 
  mutate(dcant = if_else(basin == "Global",
                         dcant * dcant_scaling,
                         dcant))

dcant_budget_basin_MLR_all <- dcant_budget_basin_MLR_all %>% 
  mutate(dcant = if_else(basin == "Global",
                         dcant * dcant_scaling,
                         dcant))

dcant_budget_basin_MLR_all_no_adj <- dcant_budget_basin_MLR_all_no_adj %>% 
  mutate(dcant = if_else(basin == "Global",
                         dcant * dcant_scaling,
                         dcant))

```


```{r dcant_budget_stats}


dcant_budget_ensemble_stat <-
  bind_rows(
    dcant_budget_basin_MLR_all_ensemble
  ) %>%
  filter(data_source == "obs",
         period != "1994 - 2014") %>%
  group_by(period, basin) %>%
  summarise(
    median = median(dcant),
    sd = sd(dcant),
    n = n()
  ) %>%
  ungroup() 


dcant_budget_ensemble_stat <-
  full_join(
    dcant_budget_ensemble_stat,
    dcant_budget_basin_MLR_all_ensemble %>%
        filter(Version_ID %in% Version_IDs,
               data_source == "obs",
               period != "1994 - 2014") %>%
        select(period,
               basin,
               std_case = dcant)
  )

dcant_budget_ensemble_significance <- dcant_budget_ensemble_stat %>% 
  pivot_longer(c(median,std_case),
               names_to = "estimate",
               values_to = "dcant") %>%
  group_by(estimate, basin) %>%
  mutate(
    delta_dcant = dcant - lag(dcant),
    delta_dcant_uncert = sqrt(2 * sd ^ 2 + lag(2 * sd ^ 2)),
    error_prop_ratio = abs(delta_dcant_uncert / delta_dcant),
    ttest_p = tsum.test(
      mean.x = dcant,
      s.x = sd,
      n.x = n,
      mean.y = lag(dcant),
      s.y = lag(sd),
      n.y = lag(n)
    )$p.value
  ) %>%
  ungroup() %>% 
  drop_na()
  
dcant_budget_ensemble_stat_significance <-
  full_join(
    dcant_budget_ensemble_stat %>%
      select(-n) %>%
      pivot_wider(
        names_from = period,
        values_from = median:std_case,
        names_sep = " "
      ),
    dcant_budget_ensemble_significance %>%
      select(basin, estimate, delta_dcant, delta_dcant_uncert, ttest_p) %>%
      pivot_wider(names_from = estimate,
                  values_from = delta_dcant:ttest_p) %>%
      rename(delta_dcant_uncert = delta_dcant_uncert_std_case) %>%
      select(-delta_dcant_uncert_median)
  )


dcant_budget_ensemble_stat_significance %>% 
  kable() %>%
  kable_styling() %>%
  scroll_box(height = "300px")

dcant_budget_ensemble_significance %>% 
  ggplot(aes(error_prop_ratio, ttest_p, col = basin)) +
  geom_vline(xintercept = 1) +
  geom_hline(yintercept = 0.05) +
  geom_point() +
  scale_y_log10() +
  scale_color_brewer(palette = "Dark2") +
  facet_grid(. ~ estimate)

```


```{r budgets_basins_hemisphere_tcant_for_scatterplot}

# estimate area scaling factor to achieve identical coverage

tcant_inv <-
  inner_join(tcant_inv, basinmask)

dcant_inv_all <-
  inner_join(dcant_inv_all, basinmask)

area_scaling <- 
bind_rows(
  tcant_inv %>% distinct(lat, lon, basin) %>%
    mutate(source = "SO4"),
  dcant_inv_all %>% distinct(lat, lon, basin) %>%
    mutate(source = "M22")
)


map +
  geom_tile(data = area_scaling,
            aes(lon, lat, fill = basin)) +
  facet_wrap( ~ source)

area_scaling <- area_scaling %>% 
  mutate(area = earth_surf(lat, lon)) %>% 
  group_by(basin, source) %>% 
  summarise(area_total = sum(area)) %>% 
  ungroup() %>% 
  pivot_wider(values_from = area_total,
              names_from = source) %>% 
  mutate(scaling_factor = M22 / SO4)


tcant_budget_basin_MLR <-
  tcant_inv %>%
  mutate(method = "layer",
         data_source = "obs") %>% 
  group_by(basin) %>%
  nest() %>% 
  mutate(budget = map(.x = data, ~m_dcant_budget(.x))) %>% 
  select(-data) %>%
  unnest(budget)

tcant_budget_basin_MLR <-
  full_join(tcant_budget_basin_MLR,
            area_scaling %>% select(basin, scaling_factor)) %>%
  mutate(value = value * scaling_factor) %>%
  select(-scaling_factor)



tcant_budget_basin_MLR <-
  left_join(tcant_budget_basin_MLR %>%
              mutate(period = "1800 - 1994"),
            delta_pCO2_atm)


tcant_budget_basin_MLR <- tcant_budget_basin_MLR %>% 
  filter(estimate == "dcant") %>% 
  select(-estimate) %>% 
  rename(dcant = value)

tcant_budget_basin_MLR <- tcant_budget_basin_MLR %>% 
  mutate(beta_1994 = dcant / delta_pCO2) %>% 
  select(basin, beta_1994)

tcant_budget_basin_MLR <-
  bind_rows(tcant_budget_basin_MLR,
            tibble(basin = "Global", beta_1994 = 118 / 78.3))




```


## Scatterplots

### Global


```{r dcant_budget_global_ensemble}

bind_rows(dcant_budget_global_all_no_adj,
          dcant_budget_global_all_ensemble) %>%
  ggplot(aes(period, dcant, col = Version_ID_group)) +
  geom_jitter() +
  scale_color_brewer(palette = "Dark2") +
  facet_grid(. ~ data_source)

dcant_budget_global_all_ensemble_bias <- 
dcant_budget_global_all_ensemble %>%
  filter(data_source != "obs") %>% 
  pivot_wider(names_from = data_source,
              values_from = dcant) %>% 
  mutate(dcant_bias = mod - mod_truth,
         dcant_bias_rel = 100*(mod - mod_truth)/mod_truth)

dcant_budget_global_all_ensemble_bias %>% 
  ggplot(aes(period, dcant_bias, col = MLR_basins)) +
  geom_hline(yintercept = 0) +
  geom_jitter(width = 0.2) +
  scale_color_brewer(palette = "Dark2")

dcant_budget_global_all_ensemble_bias %>% 
  ggplot(aes(period, dcant_bias_rel, col = MLR_basins)) +
  geom_hline(yintercept = 0) +
  geom_jitter(width = 0.2) +
  scale_color_brewer(palette = "Dark2")

dcant_budget_global_all_ensemble_bias %>% 
  group_by(period) %>% 
  summarise(dcant_bias_rel = mean(dcant_bias_rel)) %>% 
  ungroup()

delta_dcant_budget_global_all_ensemble <- 
dcant_budget_global_all_ensemble %>%
  filter(data_source != "obs",
         period != "1994 - 2014") %>% 
  select(data_source, MLR_basins, Version_ID_group, tref1, dcant) %>% 
  pivot_wider(names_from = tref1,
              values_from = dcant) %>% 
  mutate(delta_dcant = `2004` - `1994`)

delta_dcant_budget_global_all_ensemble %>% 
  ggplot(aes(data_source, delta_dcant, col = MLR_basins)) +
  geom_hline(yintercept = 0) +
  geom_jitter(width = 0.2) +
  scale_color_brewer(palette = "Dark2")

delta_dcant_budget_global_all_ensemble_bias <- 
delta_dcant_budget_global_all_ensemble %>%
  select(data_source, MLR_basins, Version_ID_group, delta_dcant) %>% 
  pivot_wider(names_from = data_source,
              values_from = delta_dcant) %>% 
  mutate(delta_dcant_bias = mod - mod_truth,
         delta_dcant_bias_rel = 100*(mod - mod_truth)/mod_truth)


delta_dcant_budget_global_all_ensemble_bias %>% 
  summarise(delta_dcant_bias = mean(delta_dcant_bias),
            delta_dcant_bias_rel = mean(delta_dcant_bias_rel))

delta_dcant_budget_global_all_ensemble_bias %>% 
  group_by(MLR_basins) %>% 
  summarise(delta_dcant_bias = mean(delta_dcant_bias),
            delta_dcant_bias_rel = mean(delta_dcant_bias_rel)) %>% 
  ungroup()



delta_dcant_budget_global_all_ensemble_bias %>% 
  ggplot(aes("Decade difference",delta_dcant_bias, col = MLR_basins)) +
  geom_hline(yintercept = 0) +
  geom_jitter(width = 0.2) +
  scale_color_brewer(palette = "Dark2") +
  theme(axis.title.x = element_blank())

delta_dcant_budget_global_all_ensemble_bias %>% 
  ggplot(aes("Decade difference",delta_dcant_bias_rel, col = MLR_basins)) +
  geom_hline(yintercept = 0) +
  geom_jitter(width = 0.2) +
  scale_color_brewer(palette = "Dark2") +
  theme(axis.title.x = element_blank())
  


dcant_budget_global_all_ensemble %>%
  filter(data_source == "obs",
         period != "1994 - 2014",
         !(Version_ID %in% Version_IDs)) %>%
  ggplot(aes(period, dcant)) +
  scale_fill_manual(values = c("grey50", "red", "white")) +
  geom_point(
    data = dcant_budget_global_all_no_adj %>%
      filter(data_source == "obs",
             period != "1994 - 2014"),
    aes(fill = "Unadjusted data"),
    alpha = .7,
    shape = 21,
    position = position_dodge2(width = 0.3)
  ) +
  geom_point(
    aes(fill = "Ensemble member"),
    alpha = .5,
    shape = 21,
    position = position_dodge2(width = 0.3)
  ) +
  geom_linerange(
    data = dcant_budget_ensemble_stat %>%
      filter(basin == "Global"),
    aes(
      x = period,
      y = std_case,
      ymin = std_case - sd,
      ymax = std_case + sd
    ),
    col = "red"
  ) +
  geom_point(
    data = dcant_budget_ensemble_stat %>%
      filter(basin == "Global"),
    aes(x = period,
        y = std_case,
        fill = "Standard case"),
    size = 2,
    shape = 21
  ) +
  scale_y_continuous(name = dcant_pgc_label, breaks = seq(0, 100, 2)) +
  theme(legend.title = element_blank(),
        axis.title.x = element_blank(),
        legend.position = c(0.65,0.85),
        legend.background = element_rect(colour = "grey"))

dcant_budget_global_all_ensemble %>%
  mutate(ensemble_role = case_when(Version_ID %in% Version_IDs ~ "Standard case",
                                   TRUE ~ "others")) %>%
  filter(data_source == "obs",
         period != "1994 - 2014") %>%
  ggplot(aes(period, dcant)) +
  scale_fill_brewer(palette = "Dark2", name = "ensemble group") +
  scale_color_manual(values = c("black", "red", "grey"),
                     name = "Ensemble member") +
  geom_boxplot(
    width = .1,
    outlier.shape = NA,
    fill = "grey",
    alpha = 0.7,
    position = position_nudge(x = 0.3)
  ) +
  geom_point(
    data = dcant_budget_global_all_no_adj %>%
      mutate(ensemble_role = "unadjusted") %>%
      filter(data_source == "obs",
             period != "1994 - 2014"),
    aes(col = ensemble_role),
    size = 2,
    alpha = .7,
    shape = 21,
    position = position_dodge2(width = 0.3)
  ) +
  geom_point(
    aes(fill = Version_ID_group,
        col = ensemble_role),
    size = 2,
    alpha = .5,
    shape = 21,
    position = position_dodge2(width = 0.3)
  ) +
  scale_y_continuous(name = dcant_pgc_label, breaks = seq(0, 100, 2))



dcant_budget_global_all_ensemble %>%
  mutate(ensemble_role = if_else(Version_ID %in% Version_IDs,
                                 "Standard case",
                                 "others")) %>%
  filter(data_source == "obs",
         period != "1994 - 2014") %>%
  ggplot(aes(period, dcant)) +
  scale_fill_brewer(palette = "Dark2") +
  scale_color_manual(values = c("grey", "red"),
                     name = "Ensemble member") +
  geom_boxplot(
    width = .1,
    outlier.shape = NA,
    fill = "grey",
    alpha = 0.7,
    position = position_nudge(x = 0.3)
  ) +
  geom_point(
    aes(group = Version_ID_group,
        fill = MLR_basins,
        col = ensemble_role),
    size = 1.3,
    alpha = .7,
    shape = 21,
    position = position_dodge2(width = 0.3)
  ) +
  stat_summary(
    fun.data = "mean_sdl",
    fun.args = list(mult = 2),
    position = position_nudge(x = -0.3),
    col = "grey"
  ) +
  stat_summary(
    fun.data = "mean_sdl",
    fun.args = list(mult = 1),
    position = position_nudge(x = -0.3)
  ) +
  scale_y_continuous(name = dcant_pgc_label, breaks = seq(0, 100, 2))

```

```{r beta_budget_global}

beta_budget_global_all_ensemble <-
  full_join(dcant_budget_global_all_ensemble,
            delta_pCO2_atm) %>%
  mutate(beta = dcant / delta_pCO2)
  
  
beta_budget_global_all_ensemble %>%   
  mutate(ensemble_role = case_when(Version_ID %in% Version_IDs ~ "Standard case",
                                   TRUE ~ "others")) %>%
  filter(data_source == "obs",
         period != "1994 - 2014") %>%
  ggplot(aes(period, beta)) +
  scale_fill_brewer(palette = "Dark2", name = "ensemble group") +
  scale_color_manual(values = c("black", "red", "grey"),
                     name = "Ensemble member") +
  geom_boxplot(
    width = .1,
    outlier.shape = NA,
    fill = "grey",
    alpha = 0.7,
    position = position_nudge(x = 0.3)
  ) +
  geom_point(
    aes(fill = Version_ID_group,
        col = ensemble_role),
    size = 2,
    alpha = .5,
    shape = 21,
    position = position_dodge2(width = 0.3)
  ) +
  scale_y_continuous(name = dcant_pgc_scaled_label)

```


### basin hemisphere

```{r dcant_budget_basin_hemisphere_ensemble, fig.asp=1}

dcant_budget_basin_MLR_all_ensemble %>%
  ggplot(aes(period, dcant, col = Version_ID_group)) +
  geom_jitter(alpha = 0.5) +
  scale_color_brewer(palette = "Dark2") +
  facet_grid(basin ~ data_source, scales = "free_y")

tcant_budget_basin_MLR <- expand_grid(
  tcant_budget_basin_MLR,
  delta_pCO2_atm %>% filter(period %in% two_decades)
)

tcant_budget_basin_MLR <- tcant_budget_basin_MLR %>% 
  mutate(dcant = beta_1994 * delta_pCO2)

tcant_budget_basin_MLR <- tcant_budget_basin_MLR %>%
  mutate(
    basin = fct_relevel(
      basin,
      "N. Pacific",
      "S. Pacific",
      "N. Atlantic",
      "S. Atlantic",
      "Indian",
      "Global"
    )
  )

dcant_budget_basin_MLR_all_ensemble %>%
  filter(data_source == "obs",
         period != "1994 - 2014",
         !(Version_ID %in% Version_IDs)) %>%
  ggplot(aes(period, dcant)) +
  geom_errorbar(
    data = tcant_budget_basin_MLR,
    aes(x = period,
        ymax = dcant, ymin = dcant,
        col = "Scaled 1994\nestimate"),
    width = 0.5,
    linetype = 2,
    position = position_nudge(x = 0.1)
  ) +
  geom_jitter(
    data = dcant_budget_basin_MLR_all_no_adj %>%
      filter(data_source == "obs",
             period != "1994 - 2014"),
    aes(fill = "Unadjusted data",
        alpha = "Unadjusted data"),
    shape = 21,
    position = position_jitter(width = 0.1, height = 0)
  ) +
  geom_point(
    aes(fill = "Ensemble member",
        alpha = "Ensemble member"),
    shape = 21,
    position = position_jitter(width = 0.1, height = 0)
  ) +
  geom_crossbar(
    data = dcant_budget_ensemble_stat,
    aes(
      x = period,
      y = std_case,
      ymin = std_case - 2*sd,
      ymax = std_case + 2*sd,
      linetype = "Ensemble SD"
    ),
    width = 0.1,
    fill = "#AA3377",
    alpha = 0.2,
    position = position_nudge(x = 0.2)
  ) +
  geom_crossbar(
    data = dcant_budget_ensemble_stat,
    aes(
      x = period,
      y = std_case,
      ymin = std_case - sd,
      ymax = std_case + sd,
      alpha = "Ensemble SD",
    ),
    width = 0.1,
    fill = "#AA3377",
    alpha = 0.4,
    position = position_nudge(x = 0.2)
  ) +
  geom_point(
    data = dcant_budget_ensemble_stat,
    aes(x = period,
        y = std_case,
        fill = "Standard case",
        alpha = "Standard case"),
    size = 2,
    shape = 21,
    position = position_nudge(x = 0.2)
  ) +
  scale_fill_manual(name = "group", values = c("#BB5566", "white", "#BBBBBB")) +
  scale_color_manual(values = c("grey50"), label = expression(Scaled~C[ant]~1994)) +
  scale_linetype(name = "X") +
  scale_alpha_manual(name = "group", values = c(0.5,1,0.5)) +
  scale_shape_manual(values = 95) +
  scale_y_continuous(name = dcant_pgc_label) +
  guides(
    fill = guide_legend(order = 1),
    linetype = guide_legend(order = 2),
    alpha = guide_legend(order = 1)
  ) +
  facet_wrap(~ basin, ncol = 3, dir = "v", scales = "free_y") +
  theme(legend.title = element_blank(),
        axis.title.x = element_blank())


ggsave(path = here::here("output/publication"),
       filename = "Fig_dcant_budgets_ensemble_member.png",
       height = 6,
       width = 8)



dcant_budget_basin_MLR_all_ensemble %>%
  mutate(ensemble_role = if_else(Version_ID %in% Version_IDs,
                                 "Standard case",
                                 "others")) %>%
  filter(data_source == "obs",
         period != "1994 - 2014") %>%
  ggplot(aes(period, dcant)) +
  scale_fill_brewer(palette = "Dark2", name = "ensemble group") +
  scale_color_manual(values = c("grey", "black", "red"),
                     name = "Ensemble member") +
  geom_boxplot(
    width = .1,
    outlier.shape = NA,
    fill = "grey",
    alpha = 0.7,
    position = position_nudge(x = 0.3)
  ) +
  geom_point(
    data = dcant_budget_basin_MLR_all_no_adj %>%
      mutate(ensemble_role = "no adjustment") %>%
      filter(data_source == "obs",
         period != "1994 - 2014"),
    aes(fill = Version_ID_group,
        col = ensemble_role),
    size = 1.3,
    alpha = .7,
    shape = 21,
    position = position_dodge2(width = 0.3)
  ) +
  geom_point(
    aes(fill = Version_ID_group,
        col = ensemble_role),
    size = 1.3,
    alpha = .7,
    shape = 21,
    position = position_dodge2(width = 0.3)
  ) +
  scale_y_continuous(name = dcant_pgc_label) +
  facet_wrap(~ basin, ncol = 3, scales = "free_y")


dcant_budget_basin_MLR_all_ensemble %>%
   mutate(ensemble_role = if_else(Version_ID %in% Version_IDs,
                                 "Standard case",
                                 "others")) %>%
  filter(data_source == "obs",
         period != "1994 - 2014") %>%
  ggplot(aes(period, dcant)) +
  scale_fill_brewer(palette = "Dark2") +
  scale_color_manual(values = c("grey", "red"),
                     name = "Ensemble member") +
  geom_boxplot(
    width = .1,
    outlier.shape = NA,
    fill = "grey",
    alpha = 0.7,
    position = position_nudge(x = 0.3)
  ) +
  geom_point(
    aes(fill = MLR_basins,
        col = ensemble_role),
    size = 1.3,
    alpha = .7,
    shape = 21,
    position = position_dodge2(width = 0.3)
  ) +
  stat_summary(
    fun.data = "mean_sdl",
    fun.args = list(mult = 2),
    position = position_nudge(x = -0.3),
    col = "grey"
  ) +
  stat_summary(
    fun.data = "mean_sdl",
    fun.args = list(mult = 1),
    position = position_nudge(x = -0.3)
  ) +
  scale_y_continuous(name = dcant_pgc_label) +
  facet_wrap(~ basin, ncol = 3, scales = "free_y")

dcant_budget_basin_MLR_all_ensemble_summary <- dcant_budget_basin_MLR_all_ensemble %>% 
  group_by(data_source, basin, period) %>% 
  summarise(dcant_mean = mean(dcant),
            dcant_sd = sd(dcant)*2) %>% 
  ungroup()

dcant_budget_global_all_ensemble_summary <-
  dcant_budget_basin_MLR_all_ensemble %>%
  filter(period != "1994 - 2014") %>%
  group_by(data_source, Version_ID, tref1, tref2, period) %>%
  summarise(dcant = sum(dcant)) %>%
  ungroup() %>%
  group_by(data_source, tref1, tref2, period) %>%
  summarise(dcant_mean = mean(dcant),
            dcant_sd = sd(dcant)*2) %>%
  ungroup() %>%
  filter(data_source == "obs")

```


```{r beta_budget_basin_hemisphere_ensemble, fig.asp=1}

beta_budget_basin_MLR_all_no_adj <-
  full_join(dcant_budget_basin_MLR_all_no_adj,
            delta_pCO2_atm) %>%
  mutate(beta = dcant / delta_pCO2)

beta_budget_basin_MLR_all_ensemble <-
  full_join(dcant_budget_basin_MLR_all_ensemble,
            delta_pCO2_atm) %>%
  mutate(beta = dcant / delta_pCO2)

beta_budget_basin_MLR_all_ensemble %>% 
  mutate(ensemble_role = if_else(Version_ID %in% Version_IDs,
                                 "Standard case",
                                 "others")) %>%
  filter(data_source == "obs",
         period != "1994 - 2014") %>%
  ggplot(aes(period, beta)) +
  scale_fill_brewer(palette = "Dark2", name = "ensemble group") +
  scale_color_manual(values = c("grey", "black", "red"),
                     name = "Ensemble member") +
  geom_boxplot(
    width = .1,
    outlier.shape = NA,
    fill = "grey",
    alpha = 0.7,
    position = position_nudge(x = 0.3)
  ) +
  geom_point(
    aes(fill = Version_ID_group,
        col = ensemble_role),
    size = 1.3,
    alpha = .7,
    shape = 21,
    position = position_dodge2(width = 0.3)
  ) +
  scale_y_continuous(name = dcant_pgc_scaled_label)  +
  facet_wrap(~ basin, ncol = 3, scales = "free_y")


```

```{r beta_budget_stats}

beta_budget_ensemble_stat_KS <-
  beta_budget_basin_MLR_all_ensemble %>% 
  filter(data_source == "obs",
         period != "1994 - 2014") %>%
  select(basin, period, dcant, beta, MLR_basins, Version_ID_group) %>% 
  pivot_longer(c(dcant, beta),
               values_to = "value",
               names_to = "estimate") %>% 
  pivot_wider(names_from = period,
              values_from = value)

beta_budget_ensemble_stat_KS %>%
  group_by(basin, estimate) %>%
  summarise(
    ks_p = ks.test(`2004 - 2014`, `1994 - 2004`)$p.value,
    t_p = t.test(`2004 - 2014`, `1994 - 2004`)$p.value
  ) %>%
  ungroup() %>% 
  mutate(ratio_p = ks_p / t_p)


beta_budget_ensemble_stat <-
  beta_budget_basin_MLR_all_ensemble %>% 
  filter(data_source == "obs",
         period != "1994 - 2014") %>%
  select(basin, period, dcant, beta) %>% 
  pivot_longer(c(dcant, beta),
               values_to = "value",
               names_to = "estimate") %>% 
  group_by(period, basin, estimate) %>%
  summarise(
    # mean = mean(beta),
    median = median(value),
    sd = sd(value),
    n = n()
  ) %>%
  ungroup() 


beta_budget_ensemble_stat <-
  full_join(
    beta_budget_ensemble_stat,
    beta_budget_basin_MLR_all_ensemble %>%
      filter(
        Version_ID %in% Version_IDs,
        data_source == "obs",
        period != "1994 - 2014"
      ) %>%
      select(period,
             basin,
             dcant,
             beta) %>% 
        pivot_longer(c(dcant, beta),
               values_to = "std_case",
               names_to = "estimate")
  )


beta_budget_ensemble_significance <- beta_budget_ensemble_stat %>% 
  pivot_longer(c(median,std_case),
               names_to = "case",
               values_to = "value") %>%
  group_by(estimate, basin, case) %>%
  mutate(
    delta = value - lag(value),
    RSS = sqrt(2 * sd ^ 2 + lag(2 * sd ^ 2)),
    RSS_delta_ratio = abs(delta) / RSS,
    ttest_p = tsum.test(
      mean.x = value,
      s.x = sd,
      n.x = n,
      mean.y = lag(value),
      s.y = lag(sd),
      n.y = lag(n)
    )$p.value
  ) %>%
  ungroup() %>% 
  drop_na()
  

beta_budget_ensemble_stat_significance <-
  full_join(
    beta_budget_ensemble_stat %>%
      select(-n) %>%
      pivot_wider(
        names_from = period,
        values_from = median:std_case,
        names_sep = " "
      ),
    beta_budget_ensemble_significance %>%
      select(basin, estimate, case, delta, RSS, ttest_p) %>%
      pivot_wider(names_from = case,
                  values_from = c(delta, ttest_p))
  )

beta_budget_ensemble_stat_significance <-
  beta_budget_ensemble_stat_significance %>% 
  mutate(across(where(is.numeric), signif, 2))

beta_budget_ensemble_stat_significance %>% 
  kable() %>%
  kable_styling() %>%
  scroll_box(height = "300px")

beta_budget_ensemble_stat_significance %>% 
  ggplot(aes(abs(delta_std_case) / RSS, ttest_p_std_case, col = basin)) +
  geom_vline(xintercept = 1) +
  geom_hline(yintercept = 0.05) +
  geom_point() +
  scale_y_log10() +
  scale_color_brewer(palette = "Dark2") +
  facet_grid(. ~ estimate)

beta_budget_ensemble_stat_significance %>% 
  ggplot(aes(abs(delta_median) / RSS, ttest_p_median, col = basin)) +
  geom_vline(xintercept = 1) +
  geom_hline(yintercept = 0.05) +
  geom_point() +
  scale_y_log10() +
  scale_color_brewer(palette = "Dark2") +
  facet_grid(. ~ estimate)


beta_budget_ensemble_stat_significance %>%
  mutate(
    `1994 - 2004` = paste(`std_case 1994 - 2004`, `sd 1994 - 2004`, sep = " ± "),
    `2004 - 2014` = paste(`std_case 2004 - 2014`, `sd 2004 - 2014`, sep = " ± "),
    `Deacadal change` = paste0(delta_std_case, " ± ", RSS, " ", if_else(abs(delta_std_case) > RSS, "*", ""))
  ) %>%
  select(Region = basin,
         Esimate = estimate,
         `1994 - 2004`,
         `2004 - 2014`,
         `Deacadal change`) %>%
  write_csv(here::here("output/publication/Table_budget_stats.csv"))


```

```{r beta_ensemble_scatter_plot}


beta_budget_basin_MLR_all_ensemble %>%
  filter(data_source == "obs",
         period != "1994 - 2014",
         !(Version_ID %in% Version_IDs)) %>%
  ggplot(aes(period, beta)) +
  geom_errorbar(
    data = tcant_budget_basin_MLR %>% 
      rename(beta = beta_1994),
    aes(x = period,
        ymax = beta, ymin = beta,
        col = "Scaled 1994\nestimate"),
    width = 0.5,
    linetype = 2,
    position = position_nudge(x = 0.1)
  ) +
  geom_jitter(
    data = beta_budget_basin_MLR_all_no_adj %>%
      filter(data_source == "obs",
             period != "1994 - 2014"),
    aes(fill = "Unadjusted data",
        alpha = "Unadjusted data"),
    shape = 21,
    position = position_jitter(width = 0.1, height = 0)
  ) +
  geom_point(
    aes(fill = "Ensemble member",
        alpha = "Ensemble member"),
    shape = 21,
    position = position_jitter(width = 0.1, height = 0)
  ) +
  geom_crossbar(
    data = beta_budget_ensemble_stat %>% 
      filter(estimate == "beta"),
    aes(
      x = period,
      y = std_case,
      ymin = std_case - 2*sd,
      ymax = std_case + 2*sd,
      linetype = "Ensemble SD"
    ),
    width = 0.1,
    fill = "#AA3377",
    alpha = 0.2,
    position = position_nudge(x = 0.2)
  ) +
  geom_crossbar(
    data = beta_budget_ensemble_stat %>% 
      filter(estimate == "beta"),
    aes(
      x = period,
      y = std_case,
      ymin = std_case - sd,
      ymax = std_case + sd,
      alpha = "Ensemble SD",
    ),
    width = 0.1,
    fill = "#AA3377",
    alpha = 0.4,
    position = position_nudge(x = 0.2)
  ) +
  geom_point(
    data = beta_budget_ensemble_stat %>% 
      filter(estimate == "beta"),
    aes(x = period,
        y = std_case,
        fill = "Standard case",
        alpha = "Standard case"),
    size = 2,
    shape = 21,
    position = position_nudge(x = 0.2)
  ) +
  scale_fill_manual(name = "group", values = c("#BB5566", "white", "#BBBBBB")) +
  scale_color_manual(values = c("grey50"), label = expression(Scaled~C[ant]~1994)) +
  scale_linetype(name = "X") +
  scale_alpha_manual(name = "group", values = c(0.5,1,0.5)) +
  scale_shape_manual(values = 95) +
  scale_y_continuous(name = dcant_pgc_scaled_label) +
  guides(
    fill = guide_legend(order = 1),
    linetype = guide_legend(order = 2),
    alpha = guide_legend(order = 1)
  ) +
  facet_wrap(~ basin, ncol = 3, dir = "v", scales = "free_y") +
  theme(legend.title = element_blank(),
        axis.title.x = element_blank())


ggsave(path = here::here("output/publication"),
       filename = "FigS_beta_budgets_ensemble_member.png",
       height = 6,
       width = 8)

```



## Flow chart

```{r dcant_budgets_basins_hemisphere_flow_chart, fig.asp=1.2}

dcant_budget_basin_MLR_all <- 
  dcant_budget_basin_MLR_all %>% 
  filter(basin != "Global")

dcant_budget_basin_MLR_all <- left_join(dcant_budget_basin_MLR_all,
                           co2_atm %>% rename(tref1 = year,
                                              pCO21 = pCO2))

dcant_budget_basin_MLR_all <- left_join(dcant_budget_basin_MLR_all,
                           co2_atm %>% rename(tref2 = year,
                                              pCO22 = pCO2))


dcant_budget_basin_MLR_all_plot <- dcant_budget_basin_MLR_all %>%
  filter(period != "1994 - 2014",
         data_source == "obs")

```

```{r budgets_basins_hemisphere_tcant}
tcant_budget_basin_MLR <-
  tcant_inv %>%
  mutate(method = "layer",
         data_source = "obs") %>% 
  group_by(basin) %>%
  nest() %>% 
  mutate(budget = map(.x = data, ~m_dcant_budget(.x))) %>% 
  select(-data) %>%
  unnest(budget)

tcant_budget_basin_MLR <-
  full_join(tcant_budget_basin_MLR,
            area_scaling %>% select(basin, scaling_factor)) %>%
  mutate(value = value * scaling_factor) %>%
  select(-scaling_factor)


tcant_budget_basin_MLR <- tcant_budget_basin_MLR %>% 
  mutate(pCO21 = 281,
         tref1 = 1800,
         tref2 = 1994)

tcant_budget_basin_MLR <- left_join(tcant_budget_basin_MLR,
                                    co2_atm %>% rename(tref2 = year,
                                                       pCO22 = pCO2))

tcant_budget_basin_MLR <- tcant_budget_basin_MLR %>% 
  mutate(period = paste(tref1, tref2, sep = " - ")) %>% 
  filter(estimate == "dcant") %>% 
  select(-estimate) %>% 
  rename(dcant = value)

dcant_budget_basin_MLR_all_plot <- bind_rows(
  dcant_budget_basin_MLR_all_plot,
  tcant_budget_basin_MLR)

dcant_budget_basin_MLR_all_plot <-
  left_join(dcant_budget_basin_MLR_all_plot,
            dcant_budget_basin_MLR_all_ensemble_summary)


```

### Absolute

```{r budgets_basins_hemisphere_alluvial_order_budget, fig.asp=0.9}

g1 <- dcant_budget_basin_MLR_all_plot %>%
  filter(period != "1800 - 1994") %>% 
  ggplot(aes(
    y = dcant,
    x = period,
    alluvium = basin,
    fill  = basin,
    stratum = basin
  )) +
  stat_alluvium(decreasing = FALSE) +
  stat_stratum(decreasing = FALSE) +
  stat_stratum(geom = "text",
               decreasing = FALSE,
               aes(label = paste(
                 round(after_stat(max-min),1)
                 # 100*round(after_stat(prop), 2), "%"
                 ))) +
  ggrepel::geom_label_repel(
    data = dcant_budget_basin_MLR_all_plot %>% filter(period == "2004 - 2014"),
    stat = "stratum",
    size = 4,
    nudge_x = .5,
    point.padding = 3,
    aes(fill = basin, label = basin),
    decreasing = FALSE
  )+
  scale_fill_brewer(palette = "Paired", guide = "none") +
  scale_y_continuous(limits = c(0, 32), expand = c(0, 0)) +
  labs(y = dcant_pgc_label) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        axis.title.x = element_blank()) +
  theme_classic()


newdat <- tibble(layer_data(g1))

change <- 
  newdat %>% 
  select(x, alluvium, count) %>% 
  pivot_wider(names_from = x,
              values_from = count) %>% 
  mutate(dcant_change = round(100*(`2` - `1`) / `1`)) %>% 
  select(alluvium, dcant_change)

coord <- newdat %>%
  filter(x == 2) %>% 
  select(x, y, alluvium)

new_layer <- full_join(
  change,
  coord
)

new_layer <- new_layer %>% 
  mutate(dcant_change = as.character(dcant_change),
         dcant_change = if_else(str_detect(dcant_change, "-"),
                                dcant_change,
                                paste0("+", dcant_change)),
         dcant_change = paste(dcant_change, "%"))

g1 +
  geom_text(data = new_layer,
            aes(
              x = x - 0.3,
              y = y,
              label = dcant_change
            ),
            inherit.aes = FALSE)


```


```{r budgets_basins_hemisphere_alluvial_order_basin, fig.asp=0.9}

g2 <- dcant_budget_basin_MLR_all_plot %>%
    filter(period != "1800 - 1994") %>%
  ggplot(aes(
    y = dcant,
    x = period,
    alluvium = basin,
    fill  = basin,
    stratum = basin,
    label = basin
  )) +
  geom_alluvium() +
  geom_stratum() +
  stat_stratum(geom = "text",
               aes(label = paste(
                 round(after_stat(count),1)
                 # 100*round(after_stat(prop), 2), "%"
                 ))) +
  ggrepel::geom_label_repel(
    data = dcant_budget_basin_MLR_all_plot %>% filter(period == "2004 - 2014"),
    stat = "stratum",
    size = 4,
    nudge_x = .5,
    point.padding = 3,
    aes(fill = basin)
  )+
  scale_fill_brewer(palette = "Paired", guide = "none") +
  scale_color_brewer(palette = "Paired", guide = "none") +
  scale_y_continuous(limits = c(0, 33), expand = c(0, 0)) +
  guides(y = "none") +
  labs(title = dcant_pgc_label) +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        plot.title = element_text(hjust = 0.5))


newdat <- tibble(layer_data(g2))

change_basin <- 
  newdat %>% 
  select(x, alluvium, count) %>% 
  pivot_wider(names_from = x,
              values_from = count) %>% 
  mutate(dcant_change = round(100*(`2` - `1`) / `1`)) %>% 
  select(alluvium, dcant_change)

coord_basin <- newdat %>%
  filter(x == 2) %>% 
  select(x, y, alluvium)

new_layer_basin <- full_join(
  change_basin,
  coord_basin
)

new_layer_basin <- new_layer_basin %>% 
  mutate(dcant_change = as.character(dcant_change),
         dcant_change = if_else(str_detect(dcant_change, "-"),
                                dcant_change,
                                paste0("+", dcant_change)),
         dcant_change = paste(dcant_change, "%"))

new_layer_total <- 
  newdat %>% 
  select(x, alluvium, count) %>% 
  group_by(x) %>% 
  summarise(dcant_change = sum(count)) %>% 
  ungroup()

new_layer_total <- new_layer_total %>% 
  mutate(y = dcant_change,
         dcant_change = as.character(round(dcant_change,1)),
         dcant_change = paste("global:",dcant_change))

g2 +
  geom_text(data = new_layer_basin,
            aes(
              x = x - 0.3,
              y = y,
              label = dcant_change
            ),
            inherit.aes = FALSE) +
  geom_label(data = new_layer_total,
            aes(
              x = x,
              y = y + 1,
              label = dcant_change
            ),
            inherit.aes = FALSE)


```

### Scaled

```{r scale_dcant_budget_to_atm_pCO2_growth}


dcant_budget_basin_MLR_all_plot <- left_join(dcant_budget_basin_MLR_all_plot,
                           co2_atm %>% rename(tref1 = year,
                                              pCO21 = pCO2))

dcant_budget_basin_MLR_all_plot <- left_join(dcant_budget_basin_MLR_all_plot,
                           co2_atm %>% rename(tref2 = year,
                                              pCO22 = pCO2))

dcant_budget_basin_MLR_all_plot <- dcant_budget_basin_MLR_all_plot %>% 
  mutate(delta_pCO2 = pCO22 - pCO21,
         beta = dcant / delta_pCO2,
         dcant_sd_scaled = dcant_sd / delta_pCO2) %>% 
  select(-starts_with("pCO2"))


dcant_budget_global_all_ensemble_summary <- left_join(dcant_budget_global_all_ensemble_summary,
                           co2_atm %>% rename(tref1 = year,
                                              pCO21 = pCO2))

dcant_budget_global_all_ensemble_summary <- left_join(dcant_budget_global_all_ensemble_summary,
                           co2_atm %>% rename(tref2 = year,
                                              pCO22 = pCO2))

dcant_budget_global_all_ensemble_summary <- dcant_budget_global_all_ensemble_summary %>% 
  mutate(delta_pCO2 = pCO22 - pCO21,
         beta = dcant_mean / delta_pCO2,
         dcant_sd_scaled = dcant_sd / delta_pCO2) %>% 
  select(-starts_with("pCO2"))


```


```{r budgets_basins_hemisphere_alluvial_order_basin_scaled, fig.asp=0.9}

g2 <- dcant_budget_basin_MLR_all_plot %>%
  filter(period != "1800 - 1994") %>% 
  ggplot(aes(
    y = beta,
    x = period,
    alluvium = basin,
    fill  = basin,
    stratum = basin,
    label = basin
  )) +
  geom_alluvium() +
  geom_stratum() +
  stat_stratum(geom = "text",
               aes(label = paste(
                 round(after_stat(count),2)
                 # 100*round(after_stat(prop), 2), "%"
                 ))) +
  ggrepel::geom_label_repel(
    data = dcant_budget_basin_MLR_all_plot %>% filter(period == "2004 - 2014"),
    stat = "stratum",
    size = 4,
    nudge_x = .5,
    point.padding = 3,
    aes(fill = basin)
  )+
  scale_fill_brewer(palette = "Paired", guide = "none") +
  scale_color_brewer(palette = "Paired", guide = "none") +
  # scale_y_continuous(limits = c(0, 33), expand = c(0, 0)) +
  guides(y = "none") +
  labs(title = dcant_pgc_scaled_label) +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        plot.title = element_text(hjust = 0.5))


newdat <- tibble(layer_data(g2))

change_basin <- 
  newdat %>% 
  select(x, alluvium, count) %>% 
  pivot_wider(names_from = x,
              values_from = count) %>% 
  mutate(dcant_change = round(100*(`2` - `1`) / `1`)) %>% 
  select(alluvium, dcant_change)

coord_basin <- newdat %>%
  filter(x == 2) %>% 
  select(x, y, alluvium)

new_layer_basin <- full_join(
  change_basin,
  coord_basin
)

new_layer_basin <- new_layer_basin %>% 
  mutate(dcant_change = as.character(dcant_change),
         dcant_change = if_else(str_detect(dcant_change, "-"),
                                dcant_change,
                                paste0("+", dcant_change)),
         dcant_change = paste(dcant_change, "%"))

new_layer_total <- 
  newdat %>% 
  select(x, alluvium, count) %>% 
  group_by(x) %>% 
  summarise(dcant_change = sum(count)) %>% 
  ungroup()

new_layer_total <- new_layer_total %>% 
  mutate(y = dcant_change,
         dcant_change = as.character(round(dcant_change,2)),
         dcant_change = paste("global:",dcant_change))

g2 +
  geom_text(data = new_layer_basin,
            aes(
              x = x - 0.3,
              y = y,
              label = dcant_change
            ),
            inherit.aes = FALSE) +
  geom_label(data = new_layer_total,
            aes(
              x = x,
              y = y + 0.05,
              label = dcant_change
            ),
            inherit.aes = FALSE)


```

```{r budgets_basins_hemisphere_alluvial_order_basin_scaled_incl_sabine}

g2 <- dcant_budget_basin_MLR_all_plot %>%
  ggplot(aes(
    y = beta,
    x = period,
    alluvium = basin,
    fill  = basin,
    stratum = basin,
    label = basin
  )) +
  geom_alluvium() +
  geom_stratum() +
  stat_stratum(geom = "text",
               aes(label = paste(
                 round(after_stat(count),2)
                 # 100*round(after_stat(prop), 2), "%"
                 ))) +
  ggrepel::geom_label_repel(
    data = dcant_budget_basin_MLR_all_plot %>% filter(period == "2004 - 2014"),
    stat = "stratum",
    size = 4,
    nudge_x = .5,
    point.padding = 3,
    aes(fill = basin)
  )+
  scale_fill_brewer(palette = "Paired", guide = "none") +
  scale_color_brewer(palette = "Paired", guide = "none") +
  scale_y_continuous(limits = c(0, 1.7), expand = c(0, 0)) +
  guides(y = "none") +
  labs(title = dcant_pgc_scaled_label) +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        plot.title = element_text(hjust = 0.5))


newdat <- tibble(layer_data(g2))

change_basin <- 
  newdat %>% 
  select(x, alluvium, count) %>% 
  group_by(alluvium) %>% 
  arrange(x) %>% 
  mutate(dcant_change = round(100*(count - lag(count)) / lag(count))) %>% 
  ungroup()

coord_basin <- newdat %>%
  select(x, y, alluvium)

new_layer_basin <- left_join(
  change_basin %>% drop_na(),
  coord_basin
)

new_layer_basin <- new_layer_basin %>% 
  mutate(dcant_change = as.character(dcant_change),
         dcant_change = if_else(str_detect(dcant_change, "-"),
                                dcant_change,
                                paste0("+", dcant_change)),
         dcant_change = paste(dcant_change, "%"))

new_layer_total <- 
  newdat %>% 
  select(x, alluvium, count) %>% 
  group_by(x) %>% 
  summarise(dcant_change = sum(count)) %>% 
  ungroup()

new_layer_total <- new_layer_total %>% 
  mutate(y = dcant_change,
         dcant_change = as.character(round(dcant_change,2)),
         dcant_change = paste("global:",dcant_change))

g2 +
  geom_text(data = new_layer_basin,
            aes(
              x = x - 0.3,
              y = y,
              label = dcant_change
            ),
            inherit.aes = FALSE) +
  geom_label(data = new_layer_total,
            aes(
              x = x,
              y = y + 0.1,
              label = dcant_change
            ),
            inherit.aes = FALSE)


```


```{r budgets_basins_hemisphere_alluvial_order_basin_scaled_incl_sabine_uncertainty, fig.asp=0.9}

g2 <- dcant_budget_basin_MLR_all_plot %>%
  ggplot(aes(
    y = beta,
    x = period,
    alluvium = basin,
    fill  = basin,
    stratum = basin,
    label = basin
  )) +
  geom_alluvium() +
  geom_stratum() +
  ggrepel::geom_label_repel(
    data = dcant_budget_basin_MLR_all_plot %>% filter(period == "2004 - 2014"),
    stat = "stratum",
    size = 4,
    nudge_x = .5,
    point.padding = 3,
    aes(fill = basin)
  )+
  scale_fill_brewer(palette = "Paired", guide = "none") +
  scale_color_brewer(palette = "Paired", guide = "none") +
  scale_y_continuous(limits = c(0, 1.6), expand = c(0, 0)) +
  guides(y = "none") +
  labs(title = dcant_pgc_scaled_label) +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        plot.title = element_text(hjust = 0.5))


newdat <- tibble(layer_data(g2))

# construct budget labels

budget_basin <- 
  newdat %>% 
  select(x, y, alluvium, count)

budget_layer_basin <- budget_basin %>% 
  mutate(dcant = as.character(round(count,2)))

# construct uncertainty labels

uncertainty_basin <- 
  dcant_budget_basin_MLR_all_plot %>% 
  mutate(x = fct_recode(period,
                        "2" = "1994 - 2004",
                        "3" = "2004 - 2014")) %>% 
  select(x, alluvium = basin, dcant_sd_scaled) %>% 
  drop_na() %>% 
  arrange(x, alluvium)
  

coord_basin <- newdat %>%
  select(x, y, alluvium) %>% 
  filter(x != 1)

uncertainty_layer_basin <- bind_cols(
  coord_basin,
  uncertainty_basin %>% select(dcant_sd_scaled),
)

# construct change labels

change_basin <- 
  newdat %>% 
  select(x, alluvium, count) %>% 
  group_by(alluvium) %>% 
  arrange(x) %>% 
  mutate(dcant_change_abs = count - lag(count),
         dcant_change = round(100*(dcant_change_abs) / lag(count))) %>% 
  ungroup()

coord_basin <- newdat %>%
  select(x, y, alluvium)

new_layer_basin <- left_join(
  change_basin %>% drop_na(),
  coord_basin
)

new_layer_basin <- new_layer_basin %>% 
  mutate(dcant_change = as.character(dcant_change),
         dcant_change = if_else(str_detect(dcant_change, "-"),
                                dcant_change,
                                paste0("+", dcant_change)),
         dcant_change = paste0(dcant_change, "%"))

# construct global budget labels

new_layer_total <- 
  newdat %>% 
  select(x, alluvium, count) %>% 
  group_by(x) %>% 
  summarise(dcant_change = sum(count)) %>% 
  ungroup()

dcant_sd_scaled <- round(c(
  0.24,
  dcant_budget_global_all_ensemble_summary %>%
    pull(dcant_sd_scaled)
), 2)

new_layer_total <- bind_cols(new_layer_total, dcant_sd_scaled = dcant_sd_scaled)

new_layer_total <- new_layer_total %>% 
  mutate(y = dcant_change,
         dcant_sd_scaled_rel = round(100 * dcant_sd_scaled/dcant_change),
         dcant_change = as.character(round(dcant_change,2)),
         dcant_sd_scaled = round(dcant_sd_scaled,1),
         dcant_change = paste0(dcant_change, "\n(±", dcant_sd_scaled, ")"))

# basin change + uncertainty

budget_layer_basin <- full_join(budget_layer_basin,
                                uncertainty_layer_basin)

budget_layer_basin <- 
  budget_layer_basin %>% 
  mutate(dcant_sd_scaled_rel = 100*dcant_sd_scaled/count,
         dcant_sd_scaled_rel = as.character(round(dcant_sd_scaled_rel)),
         dcant_sd_scaled_numeric = dcant_sd_scaled,
         dcant_sd_scaled = round(dcant_sd_scaled, 2),
         dcant_sd_scaled = paste0("(±", dcant_sd_scaled, ")"),
         dcant_label = if_else(dcant_sd_scaled != "(±NA)",
                               paste0(dcant, "\n", dcant_sd_scaled),
                               dcant))


# uncertainty changes

uncertainty_changes <- budget_layer_basin %>% 
  select(x, alluvium, dcant_sd_scaled = dcant_sd_scaled_numeric) %>% 
  group_by(alluvium) %>% 
  mutate(dcant_change_uncert = sqrt(dcant_sd_scaled^2 + lag(dcant_sd_scaled)^2)) %>% 
  ungroup()


new_layer_basin <- left_join(new_layer_basin, uncertainty_changes) %>% 
  mutate(dcant_change_uncert_rel = 100*dcant_change_uncert/abs((count + lag(count))/2),
         dcant_change_label = if_else(!is.na(dcant_change_uncert),
                                      paste0(dcant_change, "\n(±", round(dcant_change_uncert_rel), "%)"),
                                      dcant_change))


g2 +
  geom_text(data = budget_layer_basin,
            aes(
              x = x,
              y = y,
              label = dcant_label
            ),
            size = 3,
            inherit.aes = FALSE) +
  geom_text(data = new_layer_basin,
            aes(
              x = x - 0.3,
              y = y,
              label = dcant_change_label
            ),
            size = 4,
            inherit.aes = FALSE)
  # geom_label(data = new_layer_total,
  #           aes(
  #             x = x,
  #             y = y + 0.13,
  #             label = dcant_change
  #           ),
  #           size = 4,
  #           inherit.aes = FALSE)



# ggsave(path = here::here("output/publication"),
#        filename = "Fig_budget_beta_basin_hemisphere.png",
#        height = 6,
#        width = 8)



```



## Depth layer

### Global

```{r depth_layer_budget_global_standard_case}

dcant_budget_change <- dcant_budget_global_layer_all %>%
  filter(estimate == "dcant",
         period != "1994 - 2014",
         inv_depth <= 3000,
         data_source == "obs") %>%
  rename(dcant = value) %>%
  select(-c(tref1, tref2, Version_ID)) %>%
  pivot_wider(names_from = period,
              values_from = dcant) %>%
  mutate(sign = if_else(`2004 - 2014` - `1994 - 2004` > 0,
                        "increase",
                        "decrease"))

dcant_budget_layer <- dcant_budget_global_layer_all %>%
  filter(estimate == "dcant",
         period != "1994 - 2014",
         inv_depth <= 3400,
         data_source == "obs") %>%
  rename(dcant = value) %>%
  group_by(basin, period, data_source) %>% 
  mutate(dcant = if_else(is.na(lead(dcant)), 888, dcant),
         dcant = na_if(dcant, 888)) %>%
  fill(dcant) %>% 
  ungroup()

dcant_budget_layer %>%
  ggplot() +
  geom_hline(yintercept = 0) +
  geom_rect(
    data = dcant_budget_change,
    aes(
      xmin = inv_depth - 250,
      xmax = inv_depth + 250,
      ymin = `1994 - 2004`,
      ymax = `2004 - 2014`,
      fill = sign
    ),
    alpha = 0.4
  ) +
  geom_step(aes(inv_depth - 250, dcant, col = period), direction = "vh",
            size = 1) +
  coord_flip() +
  scale_x_reverse(breaks = seq(0, 3000, 500)) +
  scale_color_brewer(palette = "Set1", direction = -1, name = "period") +
  scale_fill_brewer(palette = "Set1", direction = -1, name = "") +
  facet_wrap(~ basin, ncol = 3, dir = "v") +
  labs(y = dcant_layer_budget_label,
       x = "Depth (m)") +
      theme(legend.position = c(0.8,0.2))

```


```{r depth_layer_budget_global_cumulative}

dcant_budget_change <- dcant_budget_global_layer_all %>%
  filter(estimate == "dcant",
         period != "1994 - 2014",
         inv_depth <= 3000,
         data_source == "obs") %>%
  rename(dcant = value) %>%
  arrange(inv_depth) %>% 
  group_by(data_source, basin, period) %>% 
  mutate(dcant_cum = cumsum(dcant)) %>% 
  ungroup() %>%
  select(-c(tref2, Version_ID, dcant)) %>%
  pivot_wider(names_from = period,
              values_from = dcant_cum) %>%
  mutate(sign = if_else(`2004 - 2014` - `1994 - 2004` > 0,
                        "increase",
                        "decrease"))

dcant_budget_layer <- dcant_budget_global_layer_all %>%
  filter(estimate == "dcant",
         period != "1994 - 2014",
         inv_depth <= 3400,
         data_source == "obs") %>%
  rename(dcant = value) %>%
  arrange(inv_depth) %>% 
  group_by(data_source, basin, period) %>% 
  mutate(dcant_cum = cumsum(dcant)) %>% 
  ungroup() %>%
  group_by(basin, period, data_source) %>% 
  mutate(dcant_cum = if_else(is.na(lead(dcant_cum)), 888, dcant_cum),
         dcant_cum = na_if(dcant_cum, 888)) %>%
  fill(dcant_cum) %>% 
  ungroup()



dcant_budget_layer %>%
  ggplot() +
  geom_hline(yintercept = 0) +
  geom_rect(
    data = dcant_budget_change,
    aes(
      xmin = inv_depth - 250,
      xmax = inv_depth + 250,
      ymin = `1994 - 2004`,
      ymax = `2004 - 2014`,
      fill = sign
    ),
    alpha = 0.3
  ) +
  geom_step(aes(inv_depth - 250, dcant_cum, col = period), direction = "vh",
            size = 1) +
  coord_flip() +
  scale_x_reverse(breaks = seq(0, 3000, 500)) +
  scale_color_brewer(palette = "Set1",
                     direction = -1,
                     name = "Decade") +
  scale_fill_brewer(palette = "Set1",
                    direction = -1,
                    name = "Decadal change") +
  
  facet_wrap( ~ basin, ncol = 3, dir = "v") +
  labs(y = dcant_layer_budget_label,
       x = "Depth (m)",
       title = "Cumulative layer inventory change") +
      theme(legend.position = c(0.8,0.2))

```

### 5 basins


```{r depth_layer_budget_basin_MLR_standard_case, fig.asp=0.9}

dcant_budget_change <- dcant_budget_basin_MLR_layer_all %>%
  filter(estimate == "dcant",
         period != "1994 - 2014",
         inv_depth <= 3000,
         data_source == "obs") %>%
  rename(dcant = value) %>%
  select(-c(tref1, tref2, Version_ID)) %>%
  pivot_wider(names_from = period,
              values_from = dcant) %>%
  mutate(sign = if_else(`2004 - 2014` - `1994 - 2004` > 0,
                        "increase",
                        "decrease"))

dcant_budget_layer <- dcant_budget_basin_MLR_layer_all %>%
  filter(estimate == "dcant",
         period != "1994 - 2014",
         inv_depth <= 3400,
         data_source == "obs") %>%
  rename(dcant = value) %>%
  group_by(basin, period, data_source) %>% 
  mutate(dcant = if_else(is.na(lead(dcant)), 888, dcant),
         dcant = na_if(dcant, 888)) %>%
  fill(dcant) %>% 
  ungroup()

dcant_budget_layer %>%
  ggplot() +
  geom_hline(yintercept = 0) +
  geom_rect(
    data = dcant_budget_change,
    aes(
      xmin = inv_depth - 250,
      xmax = inv_depth + 250,
      ymin = `1994 - 2004`,
      ymax = `2004 - 2014`,
      fill = sign
    ),
    alpha = 0.4
  ) +
  geom_step(aes(inv_depth - 250, dcant, col = period), direction = "vh",
            size = 1) +
  coord_flip() +
  scale_x_reverse(breaks = seq(0, 3000, 500)) +
  scale_color_brewer(palette = "Set1", direction = -1, name = "period") +
  scale_fill_brewer(palette = "Set1", direction = -1, name = "") +
  facet_wrap(~ basin, ncol = 3, dir = "v") +
  labs(y = dcant_layer_budget_label,
       x = "Depth (m)") +
      theme(legend.position = c(0.8,0.2))


```

```{r depth_layer_budget_basin_MLR_ensemble, fig.asp=0.9}

dcant_budget_range <- dcant_budget_basin_MLR_layer_all_ensemble %>%
  filter(estimate == "dcant",
         period != "1994 - 2014",
         inv_depth <= 3000,
         data_source == "obs") %>%
  rename(dcant = value) %>%
  select(-c(tref1, tref2, Version_ID)) %>%
  group_by(basin, inv_depth, period) %>% 
  summarise(dcant_sd = sd(dcant)*2) %>%
  ungroup()

dcant_budget_layer <-
  full_join(dcant_budget_range,
            dcant_budget_layer)

p_dcant_budget_depth_layer <- 
dcant_budget_layer %>%
  ggplot() +
  geom_hline(yintercept = 0, size = 0.1) +
  geom_vline(xintercept = 1000, size = 0.1) +
  geom_rect(
    aes(
      xmin = inv_depth - 250,
      xmax = inv_depth + 250,
      ymin = dcant - dcant_sd,
      ymax = dcant + dcant_sd,
      fill = period
    ),
    alpha = 0.4
  ) +
  geom_step(aes(inv_depth - 250, dcant, col = period), direction = "vh",
            size = 1) +
  coord_flip() +
  scale_x_reverse(breaks = seq(0, 3000, 500), limits = c(3000, 0)) +
  scale_color_manual(values = c("#EE7733", "#009988"), name = "Mean \u00B1 2 SD") +
  scale_fill_manual(values = c("#EE7733", "#009988"), name = "Mean \u00B1 2 SD") +
  labs(y = dcant_layer_budget_label,
       x = "Depth (m)") +
  facet_wrap(~ basin, ncol = 3, dir = "v", scales = "free_x") +
  theme(legend.position = c(0.9, 0.1))

p_dcant_budget_depth_layer

p_dcant_profiles + p_dcant_budget_depth_layer +
  plot_layout(ncol = 1) +
  plot_annotation(tag_levels = 'A')

ggsave(path = here::here("output/publication"),
       filename = "Fig_dcant_profiles_and_depth_layer_budget.png",
       height = 12,
       width = 8)

```

```{r dcant_layer_budget_stats}

dcant_budget_basin_MLR_layer_all_ensemble_stat <-
dcant_budget_basin_MLR_layer_all_ensemble %>%
  filter(estimate == "dcant",
         data_source == "obs",
         inv_depth < 3000,
         period %in% two_decades) %>% 
  group_by(basin,
           period,
           inv_depth) %>%
  summarise(dcant_sd = sd(value) * 2) %>%
  ungroup()

dcant_layer_budget_stat <-
  full_join(
    dcant_budget_basin_MLR_layer_all %>%
      filter(
        estimate == "dcant",
        data_source == "obs",
        inv_depth < 3000,
        period %in% two_decades
      ) %>% 
      select(basin, period, inv_depth, dcant = value),
    dcant_budget_basin_MLR_layer_all_ensemble_stat
  )  

rm(dcant_budget_basin_MLR_layer_all_ensemble_stat)  

dcant_layer_budget_stat %>%
  filter(period %in% two_decades) %>%
  arrange(period) %>% 
  group_by(basin, inv_depth) %>%
  mutate(delta_dcant = dcant - lag(dcant),
         RSS = sqrt(dcant_sd ^ 2 + lag(dcant_sd ^ 2))) %>%
  ungroup() %>%
  drop_na() %>% 
  filter(abs(delta_dcant) >= RSS) %>% 
  select(basin, inv_depth, delta_dcant, RSS) %>% 
  kable() %>%
  kable_styling() %>%
  scroll_box(height = "300px")


```






```{r depth_layer_budget_basin_MLR_cumulative, fig.asp=0.9}

dcant_budget_change <- dcant_budget_basin_MLR_layer_all %>%
  filter(estimate == "dcant",
         period != "1994 - 2014",
         inv_depth <= 3000,
         data_source == "obs") %>%
  rename(dcant = value) %>%
  arrange(inv_depth) %>% 
  group_by(data_source, basin, period) %>% 
  mutate(dcant_cum = cumsum(dcant)) %>% 
  ungroup() %>%
  select(-c(tref2, Version_ID, dcant)) %>%
  pivot_wider(names_from = period,
              values_from = dcant_cum) %>%
  mutate(sign = if_else(`2004 - 2014` - `1994 - 2004` > 0,
                        "increase",
                        "decrease"))

dcant_budget_layer <- dcant_budget_basin_MLR_layer_all %>%
  filter(estimate == "dcant",
         period != "1994 - 2014",
         inv_depth <= 3400,
         data_source == "obs") %>%
  rename(dcant = value) %>%
  arrange(inv_depth) %>% 
  group_by(data_source, basin, period) %>% 
  mutate(dcant_cum = cumsum(dcant)) %>% 
  ungroup() %>%
  group_by(basin, period, data_source) %>% 
  mutate(dcant_cum = if_else(is.na(lead(dcant_cum)), 888, dcant_cum),
         dcant_cum = na_if(dcant_cum, 888)) %>%
  fill(dcant_cum) %>% 
  ungroup()



dcant_budget_layer %>%
  ggplot() +
  geom_hline(yintercept = 0) +
  geom_rect(
    data = dcant_budget_change,
    aes(
      xmin = inv_depth - 250,
      xmax = inv_depth + 250,
      ymin = `1994 - 2004`,
      ymax = `2004 - 2014`,
      fill = sign
    ),
    alpha = 0.3
  ) +
  geom_step(aes(inv_depth - 250, dcant_cum, col = period), direction = "vh",
            size = 1) +
  coord_flip() +
  scale_x_reverse(breaks = seq(0, 3000, 500)) +
  scale_color_brewer(palette = "Set1",
                     direction = -1,
                     name = "Decade") +
  scale_fill_brewer(palette = "Set1",
                    direction = -1,
                    name = "Decadal change") +
  
  facet_wrap( ~ basin, ncol = 3, dir = "v") +
  labs(y = dcant_layer_budget_label,
       x = "Depth (m)",
       title = "Cumulative layer inventory change") +
      theme(legend.position = c(0.8,0.2))

```

# Time series

## eMLR only

```{r dcant_budget_time_series_member_connections}

dcant_budget_global_all_ensemble %>% 
  filter(data_source == "obs",
         period != "1994 - 2014") %>% 
  ggplot(aes(tref2, dcant, group = interaction(MLR_basins, Version_ID_group),
             col=Version_ID_group)) +
  geom_path() +
  geom_point()

dcant_budget_global_all_ensemble %>% 
  filter(data_source == "obs") %>% 
  select(MLR_basins, Version_ID_group, period, dcant) %>% 
  pivot_wider(names_from = period,
              values_from = dcant) %>% 
  ggplot(aes(`1994 - 2004`, `2004 - 2014`,
             col=MLR_basins)) +
  coord_equal() +
  geom_point() +
  facet_wrap(~ Version_ID_group)

dcant_budget_global_all_ensemble %>% 
  filter(data_source == "obs") %>% 
  select(MLR_basins, Version_ID_group, period, dcant) %>% 
  pivot_wider(names_from = period,
              values_from = dcant) %>% 
  ggplot(aes(`1994 - 2004`, `2004 - 2014`,
             col=Version_ID_group)) +
  coord_equal() +
  geom_point() +
  facet_wrap(~ MLR_basins)

dcant_budget_global_all_ensemble %>% 
  filter(data_source == "obs") %>% 
  select(MLR_basins, Version_ID_group, period, dcant) %>% 
  pivot_wider(names_from = period,
              values_from = dcant) %>% 
  ggplot(aes(`1994 - 2004`, `1994 - 2014`,
             col=Version_ID_group)) +
  coord_equal() +
  geom_point()

dcant_budget_global_all_ensemble %>% 
  filter(data_source == "obs") %>% 
  select(MLR_basins, Version_ID_group, period, dcant) %>% 
  pivot_wider(names_from = period,
              values_from = dcant) %>% 
  ggplot(aes(`1994 - 2004` + `2004 - 2014`, `1994 - 2014`,
             col=Version_ID_group)) +
  geom_abline(intercept = 0, slope = 1) +
  coord_equal() +
  scale_x_continuous(breaks = seq(0,100,1)) +
  scale_y_continuous(breaks = seq(0,100,1)) +
  geom_point()

```


```{r mean_tcant_over_time, fig.asp=0.6}

dcant_budget_global_ts <- dcant_budget_global_all %>% 
  filter(data_source == "obs",
         period  %in% two_decades) %>% 
  select(year = tref2, dcant_mean = dcant)


dcant_budget_global_all_ensemble_summary <-
  dcant_budget_basin_MLR_all_ensemble %>%
  filter(period %in% c("1994 - 2004", "1994 - 2014"),
         data_source == "obs",
         basin == "Global") %>%
  group_by(data_source, tref2, period) %>%
  summarise(#dcant_mean = mean(dcant),
            dcant_sd = sd(dcant)*2) %>%
  ungroup()

dcant_budget_global_ts <- left_join(dcant_budget_global_ts,
                                    dcant_budget_global_all_ensemble_summary %>% 
                                      select(year = tref2, dcant_sd))


tcant_S04 <- bind_cols(year = 1994, dcant_mean = 118, dcant_sd = 19)

tcant_ts <- full_join(dcant_budget_global_ts, tcant_S04)

tcant_ts <- left_join(tcant_ts, co2_atm)

co2_atm_pi <- bind_cols(pCO2 = 280, dcant_mean = 0, year = 1800, dcant_sd = NA)

tcant_ts <- full_join(tcant_ts, co2_atm_pi)


tcant_ts <- tcant_ts %>%
  arrange(year) %>%
  mutate(
    tcant = cumsum(dcant_mean),
    tcant_sd = sqrt(dcant_sd ^ 2 + nth(dcant_sd,2) ^ 2)
  ) %>%
  mutate(
    tcant_sd = case_when(
      year == 1800 ~ 0,
      year == 1994 ~ dcant_sd,
      TRUE ~ tcant_sd
    ),
    dcant_sd_int = dcant_sd,
    dcant_sd = case_when(
      year == 1994 ~ 0,
      TRUE ~ dcant_sd
    )
  )

beta <- 1.57
co2_atm_pi_value <- 283
atm_co2_col <- "#009988"
tcant_col <- "black"

p_tcant_year <- tcant_ts %>%
  ggplot(aes(year, tcant)) +
  geom_line(data = co2_atm_reccap2 %>% filter(year > 1790),
            aes(year, (pCO2 - co2_atm_pi_value) * beta),
            col = atm_co2_col) +
  geom_linerange(aes(
    ymin = tcant - dcant_sd_int,
    ymax = tcant + dcant_sd_int,
    col = "Estimate\n±\ninterval\nuncertainty"
  )) +
  geom_point(fill = "white", shape = 21, aes(col = "Estimate\n±\ninterval\nuncertainty")) +
  # geom_text(aes(label = year), nudge_x = -13, nudge_y = 6) +
  scale_y_continuous(name = expression(Total ~ oceanic ~ C[ant] ~ (PgC)),
                     sec.axis = sec_axis( ~ (. / beta + co2_atm_pi_value),
                                          name = expression(Atm. ~ pCO[2] ~ (µatm)))) +
  scale_x_continuous(name = "Year", breaks = seq(1800, 2000, 50)) +
  scale_color_manual(values = tcant_col) +
  theme(
    axis.title.y.right = element_text(color = atm_co2_col),
    axis.text.y.right = element_text(color = atm_co2_col),
    axis.ticks.y.right = element_line(color = atm_co2_col), 
    legend.background = element_rect(fill = "transparent"),
    legend.position = c(0.85, 0.2),
    legend.title = element_blank()
  )

p_tcant_year

```

```{r mean_tcant_over_atm_co2, fig.asp=1}

p_tcant_atm_co2 <- tcant_ts %>%
  ggplot(aes(pCO2, tcant)) +
  geom_ribbon(aes(
    ymin = tcant - tcant_sd,
    ymax = tcant + tcant_sd,
    fill = "1800 - 2014"
  ),
  alpha = 0.5) +
  geom_ribbon(aes(
    ymin = tcant - dcant_sd,
    ymax = tcant + dcant_sd,
    fill = "1994 - 2014"
  ),
  alpha = 0.5) +
  geom_line() +
  geom_point(shape = 21, fill = "white") +
  scale_x_continuous(breaks = seq(280, 400, 30)) +
  scale_fill_manual(values = c("grey60", "grey30"), name = "Cumulative\nuncertainty") +
  scale_color_manual(values = "black", name = "") +
  geom_text(aes(label = year), nudge_x = -6, nudge_y = 6) +
  labs(x = expression(Atmospheric ~ pCO[2] ~ (µatm)),
       y = expression(Total ~ oceanic ~ C[ant] ~ (PgC))) +
  theme(
    legend.background = element_rect(fill = "transparent"),
    legend.position = c(0.85, 0.25),
    axis.title.x = element_text(color = atm_co2_col),
    axis.text.x = element_text(color = atm_co2_col),
    axis.ticks.x = element_line(color = atm_co2_col)
  )

p_tcant_year / p_tcant_atm_co2 + 
  plot_annotation(tag_levels = 'A')

ggsave(path = here::here("output/publication"),
       filename = "FigS_dcant_budget_global_vs_atm_pCO2.png",
       height = 6,
       width = 7)

# p_tcant_year_trans / p_tcant_atm_co2
# ggsave(path = here::here("output/publication"),
#        filename = "Fig_global_dcant_budget_vs_atm_pCO2_trans.png",
#        height = 6,
#        width = 7)

```

```{r beta_factors}

tcant_ts %>% 
  mutate(beta = dcant_mean / (pCO2-lag(pCO2)))

```



## incl fluxes

```{r exclude_Watson_from_GCB}

Ocean_Sink <- Ocean_Sink %>%
  filter(product != "Watson")


```


```{r GCB_carbon_sink_cum_1994_2007_reference}

Ocean_Sink_cum_1994 <-
  Ocean_Sink %>%
  filter(year >= 1994, year <= 2007) %>%
  mutate(fgco2_glob = if_else(year == 1994, 0, GtC_yr),
         fgco2_glob = fgco2_glob) %>% 
  arrange(year) %>%
  group_by(product, type) %>%
  mutate(fgco2_glob_cum = cumsum(fgco2_glob)) %>%
  ungroup()

Ocean_Sink_cum_1994 <-
  left_join(Ocean_Sink_cum_1994,
            co2_atm) 

Ocean_Sink_cum_1994 %>%
  ggplot(aes(pCO2, fgco2_glob_cum, col = product)) +
  geom_line() +
  geom_point(shape = 21, fill = "white") +
  theme(legend.position = "bottom") +
  facet_grid(.~ type)


Ocean_Sink_cum_1994 <- Ocean_Sink_cum_1994 %>% 
  mutate(fgco2_glob_cum_total = fgco2_glob_cum + 118) %>%
  select(year, pCO2, product, fgco2_glob_cum, fgco2_glob_cum_total, type)

Ocean_Sink_cum_1994 <- Ocean_Sink_cum_1994 %>% 
  mutate(type = case_when(
    type == "data_products" ~ "Observation-based\nsurface flux\nproducts",
    TRUE ~ "Global Ocean\nBiogeochemical Models\n(GOBM)"
  ))

Ocean_Sink_cum_1994 %>% 
  filter(year == 2007) %>% 
  group_by(type) %>% 
  summarise(dcant_sd = sd(fgco2_glob_cum)*2) %>% 
  ungroup()


```

```{r GCB_carbon_sink_cum_1994}

Ocean_Sink_cum_1994 <-
  Ocean_Sink %>%
  filter(year >= 1994, year <= 2014) %>%
  mutate(fgco2_glob = if_else(year == 1994, 0, GtC_yr),
         fgco2_glob = fgco2_glob) %>% 
  arrange(year) %>%
  group_by(product, type) %>%
  mutate(fgco2_glob_cum = cumsum(fgco2_glob)) %>%
  ungroup()

Ocean_Sink_cum_1994 <-
  left_join(Ocean_Sink_cum_1994,
            co2_atm) 

Ocean_Sink_cum_1994 %>%
  ggplot(aes(pCO2, fgco2_glob_cum, col = product)) +
  geom_line() +
  geom_point(shape = 21, fill = "white") +
  theme(legend.position = "bottom") +
  facet_grid(.~ type)


Ocean_Sink_cum_1994 <- Ocean_Sink_cum_1994 %>% 
  mutate(fgco2_glob_cum_total = fgco2_glob_cum + 118) %>%
  select(year, pCO2, product, fgco2_glob_cum, fgco2_glob_cum_total, type)

Ocean_Sink_cum_1994 <- Ocean_Sink_cum_1994 %>% 
  mutate(type = case_when(
    type == "data_products" ~ "Observation-based\nsurface flux\nproducts",
    TRUE ~ "Global Ocean\nBiogeochemical Models\n(GOBM)"
  ))

```

```{r GCB_carbon_sink_cum_2004}

tcant_2004 <- tcant_ts %>% 
  filter(year == 2004) %>% 
  pull(tcant)

Ocean_Sink_cum_2004 <-
  Ocean_Sink %>%
  filter(year >= 2004, year <= 2014) %>%
  mutate(fgco2_glob = if_else(year == 2004, 0, GtC_yr)) %>% 
  arrange(year) %>%
  group_by(product, type) %>%
  mutate(fgco2_glob_cum = cumsum(fgco2_glob)) %>%
  ungroup()

Ocean_Sink_cum_2004 <-
  left_join(Ocean_Sink_cum_2004,
            co2_atm) 

Ocean_Sink_cum_2004 %>%
  ggplot(aes(pCO2, fgco2_glob_cum, col = product)) +
  geom_line() +
  geom_point(shape = 21, fill = "white") +
  theme(legend.position = "bottom") +
  facet_grid(.~ type)


Ocean_Sink_cum_2004 <- Ocean_Sink_cum_2004 %>% 
  mutate(fgco2_glob_cum_total = fgco2_glob_cum + tcant_2004) %>% 
  select(year, pCO2, product, fgco2_glob_cum, fgco2_glob_cum_total, type)

Ocean_Sink_cum_2004 <- Ocean_Sink_cum_2004 %>% 
  mutate(type = case_when(
    type == "data_products" ~ "Observation-based\nsurface flux\nproducts",
    TRUE ~ "Global Ocean\nBiogeochemical Models\n(GOBM)"
  ))

```



```{r mean_tcant_over_atm_co2_incl_fluxes, fig.asp=0.6}

tcant_ts_zoom <- tcant_ts %>%
  filter(year != 1800)

tcant_min = tcant_ts_zoom %>% pull(tcant) %>% min()
tcant_max =
  tcant_ts_zoom %>% pull(tcant) %>% max() +
  tcant_ts_zoom %>% pull(dcant_sd) %>% max() + 1


p_tcant_ts_zoom <-
  tcant_ts_zoom %>%
  ggplot(aes(pCO2, tcant)) +
  geom_ribbon(
    aes(ymin = tcant - dcant_sd,
        ymax = tcant + dcant_sd),
    alpha = 0.2,
    fill = "#BB5566"
  ) +
  geom_ribbon(
    aes(
      ymin = tcant - dcant_sd / 2,
      ymax = tcant + dcant_sd / 2
    ),
    alpha = 0.3,
    fill = "#BB5566"
  ) +
  geom_line(data = Ocean_Sink_cum_1994,
            aes(pCO2, fgco2_glob_cum_total, group = product, col = type)) +
  geom_point(
    data = Ocean_Sink_cum_1994,
    aes(pCO2, fgco2_glob_cum_total, group = product, col = type),
    size = 0.3
  ) +
  geom_point(
    data = Ocean_Sink_cum_1994 %>% filter(year %in% c(2004, 2014)),
    aes(
      pCO2,
      fgco2_glob_cum_total,
      group = product,
      col = type
    ),
    fill = "white",
    shape = 21
  ) +
  geom_line(aes(col = "eMLR(C*)")) +
  geom_point(aes(col = "eMLR(C*)"),
             shape = 21,
             fill = "white") +
  geom_text(aes(label = year), nudge_x = -3, nudge_y = 3) +
  scale_color_highcontrast(name = "Data source", reverse = TRUE) +
  scale_fill_highcontrast(name = "Data source", reverse = TRUE) +
  scale_y_continuous(limits = c(tcant_min, tcant_max)) +
  labs(x = expression(Atmospheric ~ pCO[2] ~ (µatm)),
       y = expression(Total ~ oceanic ~ carbon ~ accumulation ~ since ~ 1800 ~ (PgC))) +
  guides(colour = guide_legend(order = 1),
         fill = "none") +
  theme_classic() +
  theme(
    legend.background = element_rect(fill = "white"),
    legend.position = c(0.2, 0.8),
    legend.title = element_blank(),
    legend.box.just = "top",
    legend.box = "horizontal",
    legend.key.size = unit(2.5, 'lines'),
    panel.grid.major.y = element_line(colour = "black",
                                      size = 0.1)
  )

p_tcant_ts_zoom


```

```{r mean_tcant_over_atm_co2_incl_fluxes_boxplot, fig.asp=0.6}

dcant_type_box <-
  bind_rows(
    dcant_budget_global_all_ensemble %>%
      filter(data_source == "obs") %>%
      select(period, dcant) %>%
      mutate(type = "eMLR(C*)",
             dcant = dcant + 118,
             dcant = if_else(period == "2004 - 2014",
                             dcant + tcant_2004 - 118,
                             dcant)),
    Ocean_Sink_cum_1994 %>%
      filter(year %in% c(2004, 2014)) %>%
      mutate(period = if_else(year == 2004,
                              "1994 - 2004",
                              "1994 - 2014")) %>%
      select(period, dcant = fgco2_glob_cum_total, type),
    Ocean_Sink_cum_2004 %>%
      filter(year %in% c(2014)) %>%
      mutate(period = if_else(year == 2014,
                              "2004 - 2014",
                              "other")) %>%
      select(period, dcant = fgco2_glob_cum_total, type)
  )

dcant_type_box_stat <- dcant_type_box %>% 
  group_by(period, type) %>% 
  summarise(dcant_mean = mean(dcant),
            dcant_sd = sd(dcant)) %>% 
  ungroup()

dcant_type_box_stat <-
left_join(
  dcant_type_box_stat,
  dcant_budget_global_all %>%
    filter(data_source == "obs") %>%
    mutate(
      dcant = dcant + 118,
      dcant = if_else(period == "2004 - 2014",
                      dcant + tcant_2004 - 118,
                      dcant)
    ) %>%
    select(period, dcant_st_case = dcant)
)

dcant_type_box_stat <- dcant_type_box_stat %>% 
  mutate(dcant_mean = if_else(type == "eMLR(C*)",
                              dcant_st_case,
                              dcant_mean)) %>% 
  select(-dcant_st_case)

p_tcant_box <-
dcant_type_box %>%
  filter(period == "1994 - 2014") %>%
  ggplot(aes(period, dcant)) +
 geom_crossbar(
    data = dcant_type_box_stat %>%
      filter(period == "1994 - 2014"),
    position = position_dodge(width = 1),
    aes(
      x = period,
      y = dcant_mean,
      ymin = dcant_mean - dcant_sd,
      ymax = dcant_mean + dcant_sd,
      col = type,
      fill = type
    ), width = 0.7, alpha = 0.4
  ) +
  geom_crossbar(
    data = dcant_type_box_stat %>%
      filter(period == "1994 - 2014"),
    position = position_dodge(width = 1),
    aes(
      x = period,
      y = dcant_mean,
      ymin = dcant_mean - dcant_sd*2,
      ymax = dcant_mean + dcant_sd*2,
      col = type,
      fill = type
    ), width = 0.7, alpha = 0.2
  ) +
  geom_point(aes(fill = type),
              position = position_jitterdodge(
                dodge.width = 1,
                jitter.width = 0.1),
              shape = 21,
              alpha = 0.5) +
  scale_fill_highcontrast(
    reverse = TRUE,
    name = "Data source",
    guide = "none"
  ) +
  scale_color_highcontrast(
    reverse = TRUE,
    name = "Data source",
    guide = "none"
  ) +
  scale_y_continuous(limits = c(tcant_min, tcant_max)) +
  labs(x = "20yr period") +
  theme_classic() +
  theme(
    axis.line.y.left = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank(),
    axis.title.y = element_blank(),
    panel.grid.major.y = element_line(colour = "black",
                                      size = 0.1)
  )

p_tcant_box_10 <-
dcant_type_box %>%
  filter(period != "1994 - 2014") %>%
  ggplot(aes(period, dcant)) +
  geom_crossbar(
    data = dcant_type_box_stat %>%
      filter(period != "1994 - 2014"),
    position = position_dodge(width = 1),
    aes(
      x = period,
      y = dcant_mean,
      ymin = dcant_mean - dcant_sd,
      ymax = dcant_mean + dcant_sd,
      col = type,
      fill = type
    ), width = 0.7, alpha = 0.4
  ) +
  geom_crossbar(
    data = dcant_type_box_stat %>%
      filter(period != "1994 - 2014"),
    position = position_dodge(width = 1),
    aes(
      x = period,
      y = dcant_mean,
      ymin = dcant_mean - dcant_sd*2,
      ymax = dcant_mean + dcant_sd*2,
      col = type,
      fill = type
    ), width = 0.7, alpha = 0.2
  ) +
  geom_point(aes(fill = type),
              position = position_jitterdodge(
                dodge.width = 1,
                jitter.width = 0.1),
              shape = 21,
              alpha = 0.5) +
  scale_fill_highcontrast(
    reverse = TRUE,
    name = "Data source",
    guide = "none"
  ) +
  scale_color_highcontrast(
    reverse = TRUE,
    name = "Data source",
    guide = "none"
  ) +
  scale_y_continuous(limits = c(tcant_min, tcant_max)) +
  labs(x = "10yr periods") +
  theme_classic() +
  theme(
    axis.line.y.left = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank(),
    axis.title.y = element_blank(),
    panel.grid.major.y = element_line(colour = "black",
                                      size = 0.1)
  )

p_tcant_ts_zoom + p_tcant_box + p_tcant_box_10 +
  plot_layout(ncol = 3, widths = c(6,1,2)) + 
  plot_annotation(tag_levels = 'A')

ggsave(path = here::here("output/publication"),
       filename = "Fig_dcant_budget_global_vs_GCB_ocean_sink.png",
       height = 6,
       width = 9)

dcant_type_significance <- dcant_type_box_stat %>%
  mutate(dcant_mean = dcant_mean - 118,
         dcant_mean = if_else(period == "2004 - 2014",
                         dcant_mean - (tcant_2004 - 118),
                         dcant_mean),
         dcant_sd = dcant_sd * 2) %>%
  group_by(period) %>%
  mutate(
    dcant_diff = dcant_mean - first(dcant_mean),
    dcant_diff_rel = 100 * dcant_diff / first(dcant_mean),
    dcant_diff_sd = sqrt(dcant_sd ^ 2 + first(dcant_sd) ^ 2),
    dcant_diff_sd_comparison = dcant_diff_sd - abs(dcant_diff)
  ) %>%
  ungroup()

dcant_type_significance %>% 
  kable() %>%
  kable_styling() %>%
  scroll_box(height = "300px")


```

# Revelle changes

```{r revelle_changes}

delta_revelle <- co2_atm %>%
  mutate(revelle = seacarb::buffer(24,
                                   pCO2,
                                   2300 * 1e-6)$BetaD,
         DIC = seacarb::carb(24,
                                   pCO2,
                                   2300 * 1e-6)$DIC,
         delta_DIC = (1/pCO2) * DIC * (1/revelle) *1e6,
         delta_DIC_rel = delta_DIC / mean(delta_DIC),
         delta_DIC_rel_cum = delta_DIC_rel - first(delta_DIC_rel),
         delta_year = year - first(year))
  
  
delta_revelle %>% 
  ggplot(aes(delta_year,delta_DIC_rel_cum)) +
  geom_smooth(method = "lm", aes(col="lm"), se = FALSE) +
  geom_path() +
  geom_point()

min(delta_revelle$delta_DIC_rel_cum / max(delta_revelle$delta_year))

```



# Emission removal

```{r removal_relative_to_emissions}

GCB_Cant_emissions <- Global_Carbon_Budget %>%
  mutate(year = cut(year, c(1994, 2004, 2014), c("2004", "2014")),
         year = as.numeric(as.character(year))) %>%
  drop_na() %>%
  filter(estimate %in% c(
    "fossil emissions excluding carbonation",
    "land-use change emissions"
  )) %>%
  group_by(year) %>%
  summarise(cant_emissions = sum(GtC_yr)) %>%
  ungroup()

left_join(GCB_Cant_emissions,
          tcant_ts_zoom) %>%
  mutate(
    dcant_per_emission = 100 * dcant_mean / cant_emissions,
    dcant_per_emission_sd = 100 * dcant_sd / cant_emissions
  ) %>%
  kable() %>%
  kable_styling() %>%
  scroll_box(height = "300px")

```



#### Map test color palettes

```{r inventory_maps_absolute_test_color_scales, fig.asp=0.4, eval=FALSE}

breaks <- c(-Inf, seq(0, 16, 2), Inf)

legend_title <- expression(atop(Delta * C["ant"],
                                (mol ~ m ^ {
                                  -2
                                })))

breaks_n <- length(breaks) - 1

dcant_inv_all_color_test <- dcant_inv_all %>%
  filter(data_source %in% c("obs"),
         period == "2004 - 2014") %>%
  mutate(dcant_int = cut(dcant,
                         breaks,
                         right = FALSE))

scico_continous_palettes <- c(
  "acton",
  "bamako",
  "batlow",
  "bilbao",
  "buda",
  "davos",
  "devon",
  "grayC",
  "hawaii",
  "imola",
  "lajolla",
  "lapaz",
  "nuuk",
  "oslo",
  "tokyo",
  "turku"
)

p_test_scico <- function(df, i_palette) {
  p_reg <- map +
    geom_raster(data = df,
                aes(lon, lat, fill = dcant_int)) +
    scale_fill_scico_d(
      palette = i_palette,
      drop = FALSE,
      name = legend_title,
      guide = "none"
    ) +
    labs(title = i_palette) +
    theme(axis.text = element_blank(),
          axis.ticks = element_blank())
  
  p_rev <- map +
    geom_raster(data = df,
              aes(lon, lat, fill = dcant_int)) +
    scale_fill_scico_d(
      palette = i_palette,
      drop = FALSE,
      name = legend_title,
      direction = -1,
      guide = "none"
    ) +
    labs(title = paste(i_palette, "rev")) +
    theme(axis.text = element_blank(),
          axis.ticks = element_blank())
  
  p_comb <- p_reg / p_rev
  
  return(p_comb)
}


all_plots_scico <- scico_continous_palettes %>% 
  # head(1) %>% 
  map(~p_test_scico(df = dcant_inv_all_color_test,
                      i_palette = .x))

viridis_continous_palettes <- c(
  "viridis",
  "magma",
  "inferno",
  "plasma"
)

p_test_viridis <- function(df, i_palette) {
  p_reg <- map +
    geom_raster(data = df,
                aes(lon, lat, fill = dcant_int)) +
    scale_fill_viridis_d(
      option = i_palette,
      drop = FALSE,
      name = legend_title,
      guide = "none"
    ) +
    labs(title = i_palette) +
    theme(axis.text = element_blank(),
          axis.ticks = element_blank())
  
  p_rev <- map +
    geom_raster(data = df,
              aes(lon, lat, fill = dcant_int)) +
    scale_fill_viridis_d(
      option = i_palette,
      drop = FALSE,
      name = legend_title,
      direction = -1,
      guide = "none"
    ) +
    labs(title = paste(i_palette, "rev")) +
    theme(axis.text = element_blank(),
          axis.ticks = element_blank())
  
  p_comb <- p_reg / p_rev
  
  return(p_comb)
}

all_plots_viridis <- viridis_continous_palettes %>% 
  # head(1) %>% 
  map(~p_test_viridis(df = dcant_inv_all_color_test,
                      i_palette = .x))



library(colorspace)

colorspace_continous_palettes <- c(
  # "Purple - Blue",
  # "Red - Purple",
  # "Blue - Yellow",
  # "Heat",
  # "Heat 2",
  "Rocket"
  # "Mako",
  # "Dark",
  # "Mint",
  # "Mint",
  # "BluGrn",
  # "Teal",
  # "Sunset",
  # "SunsetDark",
  # "ag_Sunset",
  # "YlOrRd",
  # "YlGnBu",
  # "RdPu"
)

p_test_colorspace <- function(df, i_palette) {
  
  i_palette <<- i_palette
  
  p_reg <- map +
    geom_raster(data = df,
                aes(lon, lat, fill = dcant_int)) +
    scale_fill_discrete_sequential(
      palette = i_palette,
      drop = FALSE,
      name = legend_title,
      guide = "none"
    ) +
    labs(title = i_palette) +
    theme(axis.text = element_blank(),
          axis.ticks = element_blank())
  
  p_rev <- map +
    geom_raster(data = df,
                aes(lon, lat, fill = dcant_int)) +
    scale_fill_discrete_sequential(
      palette = i_palette,
      drop = FALSE,
      name = legend_title,
      rev = FALSE,
      guide = "none"
    ) +
    labs(title = paste(i_palette, "rev")) +
    theme(axis.text = element_blank(),
          axis.ticks = element_blank())

  p_comb <- p_reg / p_rev
  
  return(p_comb)
  rm(i_palette)
  
}

all_plots_colorspace <- colorspace_continous_palettes %>%
  # head(2) %>%
  map(~p_test_colorspace(df = dcant_inv_all_color_test,
                           i_palette = .x))

all_plots_colorspace

all_plots <- c(all_plots_colorspace, all_plots_viridis, all_plots_scico)

pdf(here::here("output/publication/test_color_scales.pdf"),
    width = 4, height = 4)
all_plots
dev.off()

```


