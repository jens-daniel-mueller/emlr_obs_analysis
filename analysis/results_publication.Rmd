---
title: "Results publication"
author: "Jens Daniel Müller"
date:  "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  workflowr::wflow_html:
    number_sections: true
    toc_depth: 3
    toc_float:
      collapsed: false
editor_options:
  chunk_output_type: console
---

```{r parent, child = "/nfs/kryo/work/jenmueller/emlr_cant/utilities/setup.Rmd"}
# this chunk runs the code stored in setup.Rmd
# if required, please refer to instructions given here:
# https://jdblischak.github.io/workflowr/articles/wflow-07-common-code.html
```

# Libraries


```{r load_libraries_specific, include = FALSE}
library(patchwork)
library(ggalluvial)
library(marelac)
library(ggdist)
library(kableExtra)
library(BSDA)
library(khroma)
library(ggh4x)
library(ggpattern)
library(colorspace)
```


# Read files

## Integration depth

```{r id, eval=FALSE}

params_global$inventory_depth_standard <- 1000

```


## Paths and Versions

```{r select_basin_mask, include=FALSE}

basinmask <- basinmask %>% 
  filter(MLR_basins == "5") %>% 
  select(-c(MLR_basins, basin_AIP))

basinmask <- basinmask %>% 
  mutate(
    basin = str_replace(basin, "_", ". "),
    basin = fct_relevel(
      basin,
      "N. Pacific",
      "S. Pacific",
      "N. Atlantic",
      "S. Atlantic",
      "Indian"
    )
  )

```

```{r define_paths, include = FALSE}

# only path_observations needs to be changed to model
path_observations <-
  paste(path_root, "/observations/", sep = "")

path_preprocessing    <-
  paste(path_observations, "preprocessing/", sep = "")


path_preprocessing_model    <-
  paste(path_root, "/model/preprocessing/", sep = "")

```


```{r define_Version_IDs_ensemble}

### cases included in uncertainty budget

# standard case

version_id_pattern <- "1"

Version_IDs_1 <- list.files(path = "/nfs/kryo/work/jenmueller/emlr_cant/observations",
                            pattern = paste0("v_1", version_id_pattern))

Version_IDs_2 <- list.files(path = "/nfs/kryo/work/jenmueller/emlr_cant/observations",
                            pattern = paste0("v_2", version_id_pattern))

Version_IDs_3 <- list.files(path = "/nfs/kryo/work/jenmueller/emlr_cant/observations",
                            pattern = paste0("v_3", version_id_pattern))

Version_IDs_s <- c(Version_IDs_1, Version_IDs_2, Version_IDs_3)
rm(Version_IDs_1, Version_IDs_2, Version_IDs_3)

# cruise-by-cruise adjustments

version_id_pattern <- "c"

Version_IDs_1 <- list.files(path = "/nfs/kryo/work/jenmueller/emlr_cant/observations",
                            pattern = paste0("v_1", version_id_pattern))

Version_IDs_2 <- list.files(path = "/nfs/kryo/work/jenmueller/emlr_cant/observations",
                            pattern = paste0("v_2", version_id_pattern))

Version_IDs_3 <- list.files(path = "/nfs/kryo/work/jenmueller/emlr_cant/observations",
                            pattern = paste0("v_3", version_id_pattern))

Version_IDs_c <- c(Version_IDs_1, Version_IDs_2, Version_IDs_3)
rm(Version_IDs_1, Version_IDs_2, Version_IDs_3)

# gap-filling uncertainty

version_id_pattern <- "g"

Version_IDs_1 <- list.files(path = "/nfs/kryo/work/jenmueller/emlr_cant/observations",
                            pattern = paste0("v_1", version_id_pattern))

Version_IDs_2 <- list.files(path = "/nfs/kryo/work/jenmueller/emlr_cant/observations",
                            pattern = paste0("v_2", version_id_pattern))

Version_IDs_3 <- list.files(path = "/nfs/kryo/work/jenmueller/emlr_cant/observations",
                            pattern = paste0("v_3", version_id_pattern))

Version_IDs_g <- c(Version_IDs_1, Version_IDs_2, Version_IDs_3)
rm(Version_IDs_1, Version_IDs_2, Version_IDs_3)

# C* from N and TA

version_id_pattern <- "n"

Version_IDs_1 <- list.files(path = "/nfs/kryo/work/jenmueller/emlr_cant/observations",
                            pattern = paste0("v_1", version_id_pattern))

Version_IDs_2 <- list.files(path = "/nfs/kryo/work/jenmueller/emlr_cant/observations",
                            pattern = paste0("v_2", version_id_pattern))

Version_IDs_3 <- list.files(path = "/nfs/kryo/work/jenmueller/emlr_cant/observations",
                            pattern = paste0("v_3", version_id_pattern))

Version_IDs_n <- c(Version_IDs_1, Version_IDs_2, Version_IDs_3)
rm(Version_IDs_1, Version_IDs_2, Version_IDs_3)

# Surface with eMLR(C*)

version_id_pattern <- "e"

Version_IDs_1 <- list.files(path = "/nfs/kryo/work/jenmueller/emlr_cant/observations",
                            pattern = paste0("v_1", version_id_pattern))

Version_IDs_2 <- list.files(path = "/nfs/kryo/work/jenmueller/emlr_cant/observations",
                            pattern = paste0("v_2", version_id_pattern))

Version_IDs_3 <- list.files(path = "/nfs/kryo/work/jenmueller/emlr_cant/observations",
                            pattern = paste0("v_3", version_id_pattern))

Version_IDs_e <- c(Version_IDs_1, Version_IDs_2, Version_IDs_3)
rm(Version_IDs_1, Version_IDs_2, Version_IDs_3)

# Surface with eMLR(C*)

version_id_pattern <- "w"

Version_IDs_1 <- list.files(path = "/nfs/kryo/work/jenmueller/emlr_cant/observations",
                            pattern = paste0("v_1", version_id_pattern))

Version_IDs_2 <- list.files(path = "/nfs/kryo/work/jenmueller/emlr_cant/observations",
                            pattern = paste0("v_2", version_id_pattern))

Version_IDs_3 <- list.files(path = "/nfs/kryo/work/jenmueller/emlr_cant/observations",
                            pattern = paste0("v_3", version_id_pattern))

Version_IDs_w <- c(Version_IDs_1, Version_IDs_2, Version_IDs_3)
rm(Version_IDs_1, Version_IDs_2, Version_IDs_3)

# BGC predictor choice


### cases considered as sensitivity tests but not in uncertainty budget

# no data adjustments

version_id_pattern <- "d"

Version_IDs_1 <- list.files(path = "/nfs/kryo/work/jenmueller/emlr_cant/observations",
                            pattern = paste0("v_1", version_id_pattern))

Version_IDs_2 <- list.files(path = "/nfs/kryo/work/jenmueller/emlr_cant/observations",
                            pattern = paste0("v_2", version_id_pattern))

Version_IDs_3 <- list.files(path = "/nfs/kryo/work/jenmueller/emlr_cant/observations",
                            pattern = paste0("v_3", version_id_pattern))

Version_IDs_d <- c(Version_IDs_1, Version_IDs_2, Version_IDs_3)

# reoccupation filter

version_id_pattern <- "o"

Version_IDs_1 <- list.files(path = "/nfs/kryo/work/jenmueller/emlr_cant/observations",
                            pattern = paste0("v_1", version_id_pattern))

Version_IDs_2 <- list.files(path = "/nfs/kryo/work/jenmueller/emlr_cant/observations",
                            pattern = paste0("v_2", version_id_pattern))

Version_IDs_3 <- list.files(path = "/nfs/kryo/work/jenmueller/emlr_cant/observations",
                            pattern = paste0("v_3", version_id_pattern))

Version_IDs_o <- c(Version_IDs_1, Version_IDs_2, Version_IDs_3)

# C* from TA

version_id_pattern <- "a"

Version_IDs_1 <- list.files(path = "/nfs/kryo/work/jenmueller/emlr_cant/observations",
                            pattern = paste0("v_1", version_id_pattern))

Version_IDs_2 <- list.files(path = "/nfs/kryo/work/jenmueller/emlr_cant/observations",
                            pattern = paste0("v_2", version_id_pattern))

Version_IDs_3 <- list.files(path = "/nfs/kryo/work/jenmueller/emlr_cant/observations",
                            pattern = paste0("v_3", version_id_pattern))

Version_IDs_a <- c(Version_IDs_1, Version_IDs_2, Version_IDs_3)
rm(Version_IDs_1, Version_IDs_2, Version_IDs_3)

# MLR target


Version_IDs_ensemble <- c(
  Version_IDs_s, Version_IDs_c, Version_IDs_g, Version_IDs_n, Version_IDs_e, Version_IDs_w,
  Version_IDs_d, Version_IDs_o, Version_IDs_a
  )

Version_IDs_ensemble_uncertainty <- c(
  Version_IDs_s, Version_IDs_c, Version_IDs_g, Version_IDs_n, Version_IDs_e, Version_IDs_w
  )

Version_IDs_ensemble_sensitivity <- c(
  Version_IDs_s, Version_IDs_d, Version_IDs_o, Version_IDs_a
  )


rm(
  Version_IDs_s,
  Version_IDs_c,
  Version_IDs_g,
  Version_IDs_n,
  Version_IDs_e,
  Version_IDs_w,
  Version_IDs_d,
  Version_IDs_o,
  Version_IDs_a
)

```

```{r Version_IDs_standard_case}

# subset Standard case
Version_IDs <- Version_IDs_ensemble[str_detect(Version_IDs_ensemble, "103")]

```



## Parameters

```{r read_parameters_ensemble}

for (i_Version_IDs in Version_IDs_ensemble) {
  
  path_version_data     <-
    paste(path_observations,
          i_Version_IDs,
          "/data/",
          sep = "")
  
  params_local <-
    read_rds(paste(path_version_data,
                   "params_local.rds",
                   sep = ""))
  
  params_local <- bind_cols(
    Version_ID = i_Version_IDs,
    tref1 = params_local$tref1,
    tref2 = params_local$tref2,
    MLR_basins = params_local$MLR_basins
  )
  
  tref <- read_csv(paste(path_version_data,
                         "tref.csv",
                         sep = ""))
  
  params_local <- params_local %>%
    mutate(
      median_year_1 = sort(tref$median_year)[1],
      median_year_2 = sort(tref$median_year)[2],
      duration = median_year_2 - median_year_1,
      period = paste(median_year_1, "-", median_year_2)
    )
  
  if (exists("params_local_all_ensemble")) {
    params_local_all_ensemble <- bind_rows(params_local_all_ensemble, params_local)
  }
  
  if (!exists("params_local_all_ensemble")) {
    params_local_all_ensemble <- params_local
  }
  
  
}

rm(params_local,
   tref)


params_local_all_ensemble <- params_local_all_ensemble %>%
  select(Version_ID, period, MLR_basins, tref1, tref2)

params_local_all_ensemble <-
  params_local_all_ensemble %>%
  mutate(
    Version_ID_group = str_sub(Version_ID, 4, 4),
    Version_ID_group = case_when(
      Version_ID_group == "1" ~ "Standard case",
      Version_ID_group == "c" ~ "Cruise adjustment",
      Version_ID_group == "g" ~ "Gap filling",
      Version_ID_group == "n" ~ "C* with NO3,TA",
      Version_ID_group == "e" ~ "Surface eMLR(C*)",
      Version_ID_group == "w" ~ "WOA18 predictors",
      Version_ID_group == "d" ~ "No data adjustments",
      Version_ID_group == "o" ~ "Reoccupation filter",
      Version_ID_group == "a" ~ "C* with PO4 only",
      TRUE ~ Version_ID_group
    )
  )

params_local_all_ensemble <-
  params_local_all_ensemble %>%
  mutate(
    MLR_basins = case_when(
      MLR_basins == "AIP" ~ "3",
      MLR_basins == "SO_AIP" ~ "3+SO",
      MLR_basins == "SO_5" ~ "5+SO",
      TRUE ~ MLR_basins
    )
  )

```

```{r filter_parameter_for_standard_case}

params_local_all <- params_local_all_ensemble %>% 
  filter(Version_ID %in% Version_IDs)

```


```{r read_example_params_local_file}


path_version_data     <-
  paste(path_observations,
        Version_IDs[1],
        "/data/",
        sep = "")

params_local <-
  read_rds(paste(path_version_data,
                 "params_local.rds",
                 sep = ""))

```


## eMLR stats

```{r read_eMLR_stats}

for (i_Version_IDs in Version_IDs) {
  # i_Version_IDs <- Version_IDs[1]
  
  path_version_data     <-
    paste(path_observations,
          i_Version_IDs,
          "/data/",
          sep = "")
  
  # load and join data files
  
  # Model performance: RMSE, n_predictors, VIF
  GLODAP_glanced <-
    read_csv(paste(path_version_data,
                   "lm_model_metrics.csv",
                   sep = ""))
  
  GLODAP_glanced <- GLODAP_glanced %>%
    mutate(Version_ID = i_Version_IDs)
  
  if (exists("GLODAP_glanced_all")) {
    GLODAP_glanced_all <-
      bind_rows(GLODAP_glanced_all, GLODAP_glanced)
  }
  
  if (!exists("GLODAP_glanced_all")) {
    GLODAP_glanced_all <- GLODAP_glanced
  }
  
  # The chosen models
  lm_best_target <-
    read_csv(paste(path_version_data,
                   "lm_best_target.csv",
                   sep = ""))
  
  lm_best_target <- lm_best_target %>%
    mutate(Version_ID = i_Version_IDs)
  
  if (exists("lm_best_target_all")) {
    lm_best_target_all <-
      bind_rows(lm_best_target_all, lm_best_target)
  }
  
  if (!exists("lm_best_target_all")) {
    lm_best_target_all <- lm_best_target
  }
  
  lm_best_predictor_counts <-
    read_csv(paste(path_version_data,
                   "lm_best_predictor_counts.csv",
                   sep = ""))
  
  lm_best_predictor_counts <- lm_best_predictor_counts %>%
    mutate(Version_ID = i_Version_IDs)
  
  if (exists("lm_best_predictor_counts_all")) {
    lm_best_predictor_counts_all <-
      bind_rows(lm_best_predictor_counts_all, lm_best_predictor_counts)
  }
  
  if (!exists("lm_best_predictor_counts_all")) {
    lm_best_predictor_counts_all <- lm_best_predictor_counts
  }
  
  lat_residual <-
    read_csv(paste(path_version_data,
                   "lm_lat_residual.csv",
                   sep = ""))
  
  lat_residual <- lat_residual %>%
    mutate(Version_ID = i_Version_IDs)
  
  if (exists("lat_residual_all")) {
    lat_residual_all <-
      bind_rows(lat_residual_all, lat_residual)
  }
  
  if (!exists("lat_residual_all")) {
    lat_residual_all <- lat_residual
  }
  
  lat_residual_offset <-
    read_csv(paste(path_version_data,
                   "lm_lat_residual_offset.csv",
                   sep = ""))
  
  lat_residual_offset <- lat_residual_offset %>%
    mutate(Version_ID = i_Version_IDs)
  
  if (exists("lat_residual_offset_all")) {
    lat_residual_offset_all <-
      bind_rows(lat_residual_offset_all, lat_residual_offset)
  }
  
  if (!exists("lat_residual_offset_all")) {
    lat_residual_offset_all <- lat_residual_offset
  }
  
  
  spatial_residual <-
    read_csv(paste(path_version_data,
                   "lm_spatial_residual.csv",
                   sep = ""))
  
  spatial_residual <- spatial_residual %>%
    mutate(Version_ID = i_Version_IDs)
  
  if (exists("spatial_residual_all")) {
    spatial_residual_all <-
      bind_rows(spatial_residual_all, spatial_residual)
  }
  
  if (!exists("spatial_residual_all")) {
    spatial_residual_all <- spatial_residual
  }
  
  spatial_residual_offset <-
    read_csv(paste(path_version_data,
                   "lm_spatial_residual_offset.csv",
                   sep = ""))
  
  spatial_residual_offset <- spatial_residual_offset %>%
    mutate(Version_ID = i_Version_IDs)
  
  if (exists("spatial_residual_offset_all")) {
    spatial_residual_offset_all <-
      bind_rows(spatial_residual_offset_all, spatial_residual_offset)
  }
  
  if (!exists("spatial_residual_offset_all")) {
    spatial_residual_offset_all <- spatial_residual_offset
  }
  
  

  
}

rm(GLODAP_glanced,
   lat_residual,
   lat_residual_offset,
   spatial_residual,
   spatial_residual_offset,
   lm_best_predictor_counts,
   lm_best_target)
   
```


```{r join_MLR_stats_and_meta_data, include=FALSE}


GLODAP_glanced_all <- full_join(GLODAP_glanced_all,
                                params_local_all_ensemble)

# GLODAP_glanced_all %>% distinct(basin)

lm_best_predictor_counts_all <-
  full_join(lm_best_predictor_counts_all,
            params_local_all_ensemble)

lm_best_target_all <- full_join(lm_best_target_all,
                                params_local_all_ensemble)

lat_residual_all <- full_join(lat_residual_all,
                              params_local_all_ensemble)

lat_residual_offset_all <- full_join(lat_residual_offset_all,
                                     params_local_all_ensemble)

spatial_residual_all <- full_join(spatial_residual_all,
                              params_local_all_ensemble)

spatial_residual_offset_all <- full_join(spatial_residual_offset_all,
                                     params_local_all_ensemble)

```


```{r r distuinguish_standard_case_and_ensemble_MLR_stats, include=FALSE, eval=FALSE}


GLODAP_glanced_all_ensemble <- GLODAP_glanced_all %>% 
  filter(Version_ID %in% Version_IDs_ensemble_uncertainty)

GLODAP_glanced_all <- GLODAP_glanced_all %>%
  filter(Version_ID %in% Version_IDs)


lm_best_predictor_counts_all_ensemble <- lm_best_predictor_counts_all %>% 
  filter(Version_ID %in% Version_IDs_ensemble_uncertainty)

lm_best_predictor_counts_all <- lm_best_predictor_counts_all %>%
  filter(Version_ID %in% Version_IDs)


lm_best_target_all_ensemble <- lm_best_target_all %>% 
  filter(Version_ID %in% Version_IDs_ensemble_uncertainty)

lm_best_target_all <- lm_best_target_all %>%
  filter(Version_ID %in% Version_IDs)


lat_residual_all_ensemble <- lat_residual_all %>% 
  filter(Version_ID %in% Version_IDs_ensemble_uncertainty)

lat_residual_all <- lat_residual_all %>%
  filter(Version_ID %in% Version_IDs)


lat_residual_offset_all_ensemble <- lat_residual_offset_all %>% 
  filter(Version_ID %in% Version_IDs_ensemble_uncertainty)

lat_residual_offset_all <- lat_residual_offset_all %>%
  filter(Version_ID %in% Version_IDs)

```



## Inventories

```{r read_budget_files_global_ensemble, eval=FALSE}

for (i_Version_IDs in Version_IDs_ensemble) {
  # i_Version_IDs <- Version_IDs[1]
  
  path_version_data     <-
    paste(path_observations,
          i_Version_IDs,
          "/data/",
          sep = "")
  
  # load and join data files
  
  dcant_budget_global <-
    read_csv(paste(path_version_data,
                   "dcant_budget_global.csv",
                   sep = ""))
  
  dcant_budget_global_mod_truth <-
    read_csv(paste(
      path_version_data,
      "dcant_budget_global_mod_truth.csv",
      sep = ""
    ))
  
  dcant_budget_global <- bind_rows(dcant_budget_global,
                                   dcant_budget_global_mod_truth)
  
  dcant_budget_global <- dcant_budget_global %>%
    mutate(Version_ID = i_Version_IDs)
  
  if (exists("dcant_budget_global_all")) {
    dcant_budget_global_all <-
      bind_rows(dcant_budget_global_all, dcant_budget_global)
  }
  
  if (!exists("dcant_budget_global_all")) {
    dcant_budget_global_all <- dcant_budget_global
  }
  
}

rm(dcant_budget_global,
   dcant_budget_global_mod_truth)
   
```


```{r read_budget_files_basins_hemisphere_ensemble}

for (i_Version_IDs in Version_IDs_ensemble) {
  # i_Version_IDs <- Version_IDs[1]

  path_version_data     <-
    paste(path_observations,
          i_Version_IDs,
          "/data/",
          sep = "")
  
  # load and join data files
  
  dcant_budget_basin_MLR <-
    read_csv(paste(path_version_data,
                   "dcant_budget_basin_MLR.csv",
                   sep = ""))
  
  dcant_budget_basin_MLR_mod_truth <-
    read_csv(paste(
      path_version_data,
      "dcant_budget_basin_MLR_mod_truth.csv",
      sep = ""
    ))
  
    
  dcant_budget_basin_MLR <- bind_rows(dcant_budget_basin_MLR,
                                      dcant_budget_basin_MLR_mod_truth)
  
  dcant_budget_basin_MLR <- dcant_budget_basin_MLR %>%
    mutate(Version_ID = i_Version_IDs)
  

  if (exists("dcant_budget_basin_MLR_all")) {
    dcant_budget_basin_MLR_all <-
      bind_rows(dcant_budget_basin_MLR_all, dcant_budget_basin_MLR)
  }
  
  if (!exists("dcant_budget_basin_MLR_all")) {
    dcant_budget_basin_MLR_all <- dcant_budget_basin_MLR
  }
  
  
  dcant_budget_basin_MLR_bias_decomposition <-
    read_csv(
      paste(
        path_version_data,
        "dcant_budget_basin_MLR_bias_decomposition.csv",
        sep = ""
      )
    )
  
  
  dcant_budget_basin_MLR_bias_decomposition <-
    dcant_budget_basin_MLR_bias_decomposition %>%
    mutate(Version_ID = i_Version_IDs)
  
  
  if (exists("dcant_budget_basin_MLR_bias_all_decomposition")) {
    dcant_budget_basin_MLR_bias_all_decomposition <-
      bind_rows(
        dcant_budget_basin_MLR_bias_all_decomposition,
        dcant_budget_basin_MLR_bias_decomposition
      )
  }
  
  if (!exists("dcant_budget_basin_MLR_bias_all_decomposition")) {
    dcant_budget_basin_MLR_bias_all_decomposition <-
      dcant_budget_basin_MLR_bias_decomposition
  }

}

rm(
  dcant_budget_basin_MLR,
  dcant_budget_basin_MLR_mod_truth,
  dcant_budget_basin_MLR_bias_decomposition
)


```

```{r join_budget_data_and_meta_data, include=FALSE}


# dcant_budget_global_all <- full_join(dcant_budget_global_all,
#                                      params_local_all_ensemble)


dcant_budget_basin_MLR_all <- dcant_budget_basin_MLR_all %>%
  filter(MLR_basins %in% c("5", "1")) %>% 
  select(-MLR_basins)

dcant_budget_basin_MLR_all <- full_join(dcant_budget_basin_MLR_all,
                                        params_local_all_ensemble)

dcant_budget_basin_MLR_all <- dcant_budget_basin_MLR_all %>%
  mutate(
    basin = str_replace(basin, "_", ". "),
    basin = str_replace(basin, "global", "Global"),
    basin = fct_relevel(
      basin,
      "Global",
      "Indian",
      "N. Pacific",
      "S. Pacific",
      "N. Atlantic",
      "S. Atlantic"
    )
  )

dcant_budget_basin_MLR_bias_all_decomposition <-
  full_join(dcant_budget_basin_MLR_bias_all_decomposition,
            params_local_all_ensemble)

dcant_budget_basin_MLR_bias_all_decomposition <- 
  dcant_budget_basin_MLR_bias_all_decomposition %>%
  mutate(
    basin = str_replace(basin, "_", ". "),
    # basin = str_replace(basin, "global", "Global"),
    basin = fct_relevel(
      basin,
      "N. Pacific",
      "S. Pacific",
      "N. Atlantic",
      "S. Atlantic",
      "Indian"
    )
  )


```


```{r filter_standard_inventory_depth_global, eval=FALSE}

dcant_budget_global_all <- dcant_budget_global_all %>%
  filter(estimate == "dcant", 
         method == "total") %>% 
  select(-c(estimate, method)) %>% 
  rename(dcant = value)

dcant_budget_global_all <- dcant_budget_global_all %>%
  filter(inv_depth == params_global$inventory_depth_standard)

```

```{r filter_standard_inventory_depth_basins_hemisphere}

dcant_budget_basin_MLR_all <- dcant_budget_basin_MLR_all %>%
  filter(estimate == "dcant", 
         method == "total") %>% 
  select(-c(estimate, method)) %>% 
  rename(dcant = value)

dcant_budget_basin_MLR_all_1000 <- dcant_budget_basin_MLR_all %>%
  filter(inv_depth == 1000)

dcant_budget_basin_MLR_all <- dcant_budget_basin_MLR_all %>%
  filter(inv_depth == params_global$inventory_depth_standard)

dcant_budget_basin_MLR_bias_all_decomposition <- 
  dcant_budget_basin_MLR_bias_all_decomposition %>%
  filter(inv_depth == params_global$inventory_depth_standard)

```


```{r r distuinguish_standard_case_and_ensemble_budget, include=FALSE}

# dcant_budget_global_all_ensemble <- dcant_budget_global_all %>% 
#   filter(Version_ID %in% Version_IDs_ensemble_uncertainty)
# 
# dcant_budget_global_all_sensitivity <- dcant_budget_global_all %>% 
#   filter(Version_ID %in% Version_IDs_ensemble_sensitivity)
#   
# dcant_budget_global_all <- dcant_budget_global_all %>%
#   filter(Version_ID %in% Version_IDs)


dcant_budget_basin_MLR_all_ensemble <- dcant_budget_basin_MLR_all %>% 
  filter(Version_ID %in% Version_IDs_ensemble_uncertainty)
dcant_budget_basin_MLR_all_sensitivity <- dcant_budget_basin_MLR_all %>% 
  filter(Version_ID %in% Version_IDs_ensemble_sensitivity)
dcant_budget_basin_MLR_all <- dcant_budget_basin_MLR_all %>%
  filter(Version_ID %in% Version_IDs)

dcant_budget_basin_MLR_bias_all_decomposition_ensemble <- dcant_budget_basin_MLR_bias_all_decomposition %>% 
  filter(Version_ID %in% Version_IDs_ensemble_uncertainty)
dcant_budget_basin_MLR_bias_all_decomposition_sensitivity <- dcant_budget_basin_MLR_bias_all_decomposition %>% 
  filter(Version_ID %in% Version_IDs_ensemble_sensitivity)
dcant_budget_basin_MLR_bias_all_decomposition <- dcant_budget_basin_MLR_bias_all_decomposition %>%
  filter(Version_ID %in% Version_IDs)


```


## Column inventories

```{r read_inventory_files_ensemble}

for (i_Version_IDs in Version_IDs_ensemble) {
  # i_Version_IDs <- Version_IDs_ensemble[19]
  
  path_version_data     <-
    paste(path_observations,
          i_Version_IDs,
          "/data/",
          sep = "")
  
  # load and join data files
  
  dcant_inv <-
    read_csv(paste(path_version_data,
                   "dcant_inv.csv",
                   sep = ""))
  
  p_map_cant_inv(dcant_inv %>% filter(data_source == "obs"))
  
  
  dcant_inv_mod_truth <-
    read_csv(paste(path_version_data,
                   "dcant_inv_mod_truth.csv",
                   sep = "")) %>%
    filter(method == "total") %>%
    select(-method)
  
  dcant_inv_bias <-
    read_csv(paste(path_version_data,
                   "dcant_inv_bias.csv",
                   sep = "")) %>%
    mutate(Version_ID = i_Version_IDs)
  
  dcant_inv <- bind_rows(dcant_inv,
                         dcant_inv_mod_truth) %>%
    mutate(Version_ID = i_Version_IDs)
  
  dcant_budget_lat_grid <-
    read_csv(paste(path_version_data,
                   "dcant_budget_lat_grid.csv",
                   sep = "")) %>%
    mutate(Version_ID = i_Version_IDs)
  
  dcant_budget_lon_grid <-
    read_csv(paste(path_version_data,
                   "dcant_budget_lon_grid.csv",
                   sep = "")) %>%
    mutate(Version_ID = i_Version_IDs)
  if (exists("dcant_inv_all")) {
    dcant_inv_all <- bind_rows(dcant_inv_all, dcant_inv)
  }
  
  if (!exists("dcant_inv_all")) {
    dcant_inv_all <- dcant_inv
  }
  
  if (exists("dcant_inv_bias_all")) {
    dcant_inv_bias_all <- bind_rows(dcant_inv_bias_all, dcant_inv_bias)
  }
  
  if (!exists("dcant_inv_bias_all")) {
    dcant_inv_bias_all <- dcant_inv_bias
  }
  
  if (exists("dcant_budget_lat_grid_all")) {
    dcant_budget_lat_grid_all <- bind_rows(dcant_budget_lat_grid_all, dcant_budget_lat_grid)
  }
  
  if (!exists("dcant_budget_lat_grid_all")) {
    dcant_budget_lat_grid_all <- dcant_budget_lat_grid
  }
  
  if (exists("dcant_budget_lon_grid_all")) {
    dcant_budget_lon_grid_all <- bind_rows(dcant_budget_lon_grid_all, dcant_budget_lon_grid)
  }
  
  if (!exists("dcant_budget_lon_grid_all")) {
    dcant_budget_lon_grid_all <- dcant_budget_lon_grid
  }
}

rm(dcant_inv,
   dcant_inv_bias,
   dcant_inv_mod_truth,
   dcant_budget_lat_grid,
   dcant_budget_lon_grid)

```

```{r filter_standard_inventory_depth_inventory}

dcant_inv_all <- dcant_inv_all %>%
  filter(inv_depth == params_global$inventory_depth_standard)

dcant_budget_lat_grid_all <- dcant_budget_lat_grid_all %>% 
  filter(inv_depth == params_global$inventory_depth_standard)

dcant_budget_lon_grid_all <- dcant_budget_lon_grid_all %>% 
  filter(inv_depth == params_global$inventory_depth_standard)

```

```{r r join_iventory_data_and_meta_data, include=FALSE}


dcant_inv_all <- full_join(dcant_inv_all,
                           params_local_all_ensemble)

dcant_inv_bias_all <- full_join(dcant_inv_bias_all,
                                params_local_all_ensemble)


dcant_budget_lat_grid_all <- full_join(dcant_budget_lat_grid_all,
                                       params_local_all_ensemble)

dcant_budget_lon_grid_all <- full_join(dcant_budget_lon_grid_all,
                                       params_local_all_ensemble)

```

```{r adapt_iventory_format}

dcant_budget_lat_grid_all <- dcant_budget_lat_grid_all %>%
  pivot_wider(names_from = estimate,
              values_from = value) %>%
  filter(period != "1994 - 2014",
         method == "total")

dcant_budget_lon_grid_all <- dcant_budget_lon_grid_all %>%
  pivot_wider(names_from = estimate,
              values_from = value) %>%
  filter(period != "1994 - 2014",
         method == "total")


```


```{r r distuinguish_standard_case_and_ensemble_inventories, include=FALSE}


# dcant_inv_all_sensitivity <- dcant_inv_all %>% 
#   filter(Version_ID %in% Version_IDs_ensemble_sensitivity)
# dcant_inv_all_ensemble <- dcant_inv_all %>% 
#   filter(Version_ID %in% Version_IDs_ensemble_uncertainty)
# dcant_inv_all <- dcant_inv_all %>% 
#   filter(Version_ID %in% Version_IDs)

dcant_inv_bias_all_ensemble <- dcant_inv_bias_all %>% 
  filter(Version_ID %in% Version_IDs_ensemble_uncertainty)
dcant_inv_bias_all <- dcant_inv_bias_all %>% 
  filter(Version_ID %in% Version_IDs)


dcant_budget_lat_grid_all_ensemble <- dcant_budget_lat_grid_all %>% 
  filter(Version_ID %in% Version_IDs_ensemble_uncertainty)
dcant_budget_lat_grid_all <- dcant_budget_lat_grid_all %>% 
  filter(Version_ID %in% Version_IDs)


dcant_budget_lon_grid_all_ensemble <- dcant_budget_lon_grid_all %>% 
  filter(Version_ID %in% Version_IDs_ensemble_uncertainty)
dcant_budget_lon_grid_all <- dcant_budget_lon_grid_all %>% 
  filter(Version_ID %in% Version_IDs)

```

```{r write_test_file_for_donghe, eval=FALSE}

dcant_inv_all %>% 
  filter(Version_ID == "v_1103",
         data_source == "obs") %>% 
  select(lon, lat, dcant) %>% 
  write_csv(here::here("output/dcant_column_inventor_example.csv"))

```



## Sections / profiles

```{r read_zonal_section_files}

for (i_Version_IDs in Version_IDs_ensemble) {

  path_version_data     <-
  paste(path_observations,
        i_Version_IDs,
        "/data/",
        sep = "")
  
  # load and join data files
  
  dcant_zonal <-
    read_csv(paste(path_version_data,
                   "dcant_zonal.csv",
                   sep = ""))
  
  dcant_zonal_mod_truth <-
    read_csv(paste(path_version_data,
                   "dcant_zonal_mod_truth.csv",
                   sep = ""))
  
  dcant_zonal <- bind_rows(dcant_zonal,
                           dcant_zonal_mod_truth)
  
  dcant_global_section <-
    read_csv(paste(path_version_data,
                   "dcant_global_section.csv",
                   sep = ""))
  
  # dcant_profile <-
  #   read_csv(paste(path_version_data,
  #                  "dcant_profile.csv",
  #                  sep = ""))
  # 
  # dcant_profile_mod_truth <-
  #   read_csv(paste(path_version_data,
  #                  "dcant_profile_mod_truth.csv",
  #                  sep = ""))
  # 
  # dcant_profile <- bind_rows(dcant_profile,
  #                            dcant_profile_mod_truth)
  
  
  dcant_profile_basin_MLR <-
    read_csv(paste(path_version_data,
                   "dcant_profile_basin_MLR.csv",
                   sep = ""))
  
  
  dcant_profile_basin_MLR_mod_truth <-
    read_csv(paste(
      path_version_data,
      "dcant_profile_basin_MLR_mod_truth.csv",
      sep = ""
    ))

  dcant_profile_basin_MLR <- bind_rows(dcant_profile_basin_MLR,
                                       dcant_profile_basin_MLR_mod_truth)
  
  
  # dcant_budget_basin_AIP_layer <-
  #   read_csv(paste(path_version_data,
  #                  "dcant_budget_basin_AIP_layer.csv",
  #                  sep = ""))

  dcant_budget_basin_MLR_layer <-
    read_csv(paste(path_version_data,
                   "dcant_budget_basin_MLR_layer.csv",
                   
                   sep = ""))
  
  dcant_budget_basin_MLR_layer_mod_truth <-
    read_csv(paste(
      path_version_data,
      "dcant_budget_basin_MLR_layer_mod_truth.csv",
      sep = ""
    ))
  
  dcant_budget_basin_MLR_layer <-
    bind_rows(dcant_budget_basin_MLR_layer,
              dcant_budget_basin_MLR_layer_mod_truth)
  
  dcant_zonal_bias <-
    read_csv(paste(path_version_data,
                   "dcant_zonal_bias.csv",
                   sep = ""))
  
  dcant_penetration_depth_all_lat_mean <-
    read_csv(paste0(path_version_data,
                   "dcant_penetration_depth_all_lat_mean.csv"))
  

  dcant_zonal <- dcant_zonal %>% 
    mutate(Version_ID = i_Version_IDs)

  dcant_global_section <- dcant_global_section %>% 
    mutate(Version_ID = i_Version_IDs)
  
  # dcant_profile <- dcant_profile %>% 
  #   mutate(Version_ID = i_Version_IDs)

  dcant_profile_basin_MLR <- dcant_profile_basin_MLR %>% 
    mutate(Version_ID = i_Version_IDs)
  
  # dcant_budget_basin_AIP_layer <- dcant_budget_basin_AIP_layer %>% 
  #   mutate(Version_ID = i_Version_IDs)
  
  dcant_budget_basin_MLR_layer <- dcant_budget_basin_MLR_layer %>% 
    mutate(Version_ID = i_Version_IDs)
  
  dcant_zonal_bias <- dcant_zonal_bias %>% 
    mutate(Version_ID = i_Version_IDs)
  
  dcant_penetration_depth_all_lat_mean <-
    dcant_penetration_depth_all_lat_mean %>%
    mutate(Version_ID = i_Version_IDs)
  
  
  if (exists("dcant_zonal_all")) {
    dcant_zonal_all <- bind_rows(dcant_zonal_all, dcant_zonal)
  }
  
  if (!exists("dcant_zonal_all")) {
    dcant_zonal_all <- dcant_zonal
  }

  
  if (exists("dcant_global_section_all")) {
    dcant_global_section_all <- bind_rows(dcant_global_section_all, dcant_global_section)
  }
  
  if (!exists("dcant_global_section_all")) {
    dcant_global_section_all <- dcant_global_section
  }

  # if (exists("dcant_profile_all")) {
  #   dcant_profile_all <- bind_rows(dcant_profile_all, dcant_profile)
  # }
  # 
  # if (!exists("dcant_profile_all")) {
  #   dcant_profile_all <- dcant_profile
  # }

  if (exists("dcant_profile_basin_MLR_all")) {
    dcant_profile_basin_MLR_all <- bind_rows(dcant_profile_basin_MLR_all, dcant_profile_basin_MLR)
  }
  
  if (!exists("dcant_profile_basin_MLR_all")) {
    dcant_profile_basin_MLR_all <- dcant_profile_basin_MLR
  }

  # if (exists("dcant_budget_basin_AIP_layer_all")) {
  #   dcant_budget_basin_AIP_layer_all <-
  #     bind_rows(dcant_budget_basin_AIP_layer_all,
  #               dcant_budget_basin_AIP_layer)
  # }
  # 
  # if (!exists("dcant_budget_basin_AIP_layer_all")) {
  #   dcant_budget_basin_AIP_layer_all <- dcant_budget_basin_AIP_layer
  # }

  if (exists("dcant_budget_basin_MLR_layer_all")) {
    dcant_budget_basin_MLR_layer_all <-
      bind_rows(dcant_budget_basin_MLR_layer_all,
                dcant_budget_basin_MLR_layer)
  }
  
  if (!exists("dcant_budget_basin_MLR_layer_all")) {
    dcant_budget_basin_MLR_layer_all <- dcant_budget_basin_MLR_layer
  }

  if (exists("dcant_zonal_bias_all")) {
    dcant_zonal_bias_all <- bind_rows(dcant_zonal_bias_all, dcant_zonal_bias)
  }
  
  if (!exists("dcant_zonal_bias_all")) {
    dcant_zonal_bias_all <- dcant_zonal_bias
  }

  if (exists("dcant_penetration_depth_all_lat_mean_all")) {
    dcant_penetration_depth_all_lat_mean_all <-
      bind_rows(
        dcant_penetration_depth_all_lat_mean_all,
        dcant_penetration_depth_all_lat_mean
      )
  }
  
  if (!exists("dcant_penetration_depth_all_lat_mean_all")) {
    dcant_penetration_depth_all_lat_mean_all <-
      dcant_penetration_depth_all_lat_mean
  }

}

rm(dcant_zonal, dcant_global_section, dcant_zonal_bias, dcant_zonal_mod_truth,
   dcant_budget_basin_MLR_layer,
   dcant_profile_basin_MLR, dcant_penetration_depth_all_lat_mean)

```

```{r r join_zonal_section_data_and_meta_data, include=FALSE}

dcant_zonal_all <- full_join(dcant_zonal_all,
                             params_local_all_ensemble)

dcant_global_section_all <- full_join(dcant_global_section_all,
                             params_local_all_ensemble)

# dcant_profile_all <- full_join(dcant_profile_all,
#                                params_local_all_ensemble)
# 
# dcant_profile_global_all <-
#   dcant_profile_basin_MLR_all %>%
#   filter(MLR_basins == "1") %>%
#   select(-MLR_basins)
# 
# dcant_profile_global_all <-
#   full_join(dcant_profile_global_all,
#             params_local_all_ensemble)

dcant_profile_basin_MLR_all <-
  dcant_profile_basin_MLR_all %>%
  filter(MLR_basins %in% c("5", "1")) %>%
  select(-MLR_basins)

dcant_profile_basin_MLR_all <-
  full_join(dcant_profile_basin_MLR_all,
            params_local_all_ensemble)

dcant_penetration_depth_all_lat_mean_all <-
  full_join(dcant_penetration_depth_all_lat_mean_all,
            params_local_all_ensemble)


dcant_profile_basin_MLR_all <-
  dcant_profile_basin_MLR_all %>%
  mutate(
    basin = str_replace(basin, "_", ". "),
    basin = str_replace(basin, "global", "Global"),
    basin = fct_relevel(
      basin,
      "Global",
      "Indian",
      "N. Pacific",
      "S. Pacific",
      "N. Atlantic",
      "S. Atlantic"
    )
  )


# dcant_budget_basin_AIP_layer_all <-
#   full_join(dcant_budget_basin_AIP_layer_all,
#             params_local_all_ensemble)

# dcant_budget_global_layer_all <-
#   dcant_budget_basin_MLR_layer_all %>%
#   filter(MLR_basins == "1") %>%
#   select(-MLR_basins)
# 
# dcant_budget_global_layer_all <-
#   full_join(dcant_budget_global_layer_all,
#             params_local_all_ensemble)

dcant_budget_basin_MLR_layer_all <-
  dcant_budget_basin_MLR_layer_all %>%
  filter(MLR_basins %in% c("5", "1")) %>%
  select(-MLR_basins)


dcant_budget_basin_MLR_layer_all <-
  full_join(dcant_budget_basin_MLR_layer_all,
            params_local_all_ensemble)


dcant_budget_basin_MLR_layer_all <-
  dcant_budget_basin_MLR_layer_all %>%
  mutate(
    basin = str_replace(basin, "_", ". "),
    basin = str_replace(basin, "global", "Global"),
    basin = fct_relevel(
      basin,
      "Global",
      "Indian",
      "N. Pacific",
      "S. Pacific",
      "N. Atlantic",
      "S. Atlantic"
    )
  )


dcant_zonal_bias_all <- full_join(dcant_zonal_bias_all,
                                  params_local_all_ensemble)


```


```{r r distuinguish_standard_case_and_ensemble_sections_and_profiles, include=FALSE}


dcant_zonal_all_ensemble <- dcant_zonal_all %>% 
  filter(Version_ID %in% Version_IDs_ensemble_uncertainty)
dcant_zonal_all <- dcant_zonal_all %>% 
  filter(Version_ID %in% Version_IDs)

dcant_global_section_all_ensemble <- dcant_global_section_all %>% 
  filter(Version_ID %in% Version_IDs_ensemble_uncertainty)
dcant_global_section_all <- dcant_global_section_all %>% 
  filter(Version_ID %in% Version_IDs)


# dcant_profile_all_ensemble <- dcant_profile_all %>% 
#   filter(Version_ID %in% Version_IDs_ensemble_uncertainty)
# dcant_profile_all_sensitivity <- dcant_profile_all %>% 
#   filter(Version_ID %in% Version_IDs_ensemble_sensitivity)
# dcant_profile_all <- dcant_profile_all %>% 
#   filter(Version_ID %in% Version_IDs)

# dcant_profile_global_all_ensemble <- dcant_profile_global_all %>% 
#   filter(Version_ID %in% Version_IDs_ensemble_uncertainty)
# dcant_profile_global_all_sensitivity <- dcant_profile_global_all %>% 
#   filter(Version_ID %in% Version_IDs_ensemble_sensitivity)
# dcant_profile_global_all <- dcant_profile_global_all %>% 
#   filter(Version_ID %in% Version_IDs)

dcant_profile_basin_MLR_all_ensemble <- dcant_profile_basin_MLR_all %>% 
  filter(Version_ID %in% Version_IDs_ensemble_uncertainty)
dcant_profile_basin_MLR_all_sensitivity <- dcant_profile_basin_MLR_all %>% 
  filter(Version_ID %in% Version_IDs_ensemble_sensitivity)
dcant_profile_basin_MLR_all <- dcant_profile_basin_MLR_all %>% 
  filter(Version_ID %in% Version_IDs)



# dcant_budget_global_layer_all_ensemble <-
#   dcant_budget_global_layer_all %>%
#   filter(Version_ID %in% Version_IDs_ensemble_uncertainty)
# dcant_budget_global_layer_all_sensitivity <-
#   dcant_budget_global_layer_all %>%
#   filter(Version_ID %in% Version_IDs_ensemble_sensitivity)
# dcant_budget_global_layer_all <-
#   dcant_budget_global_layer_all %>%
#   filter(Version_ID %in% Version_IDs)


# dcant_budget_basin_AIP_layer_all_ensemble <-
#   dcant_budget_basin_AIP_layer_all %>%
#   filter(Version_ID %in% Version_IDs_ensemble_uncertainty)
# dcant_budget_basin_AIP_layer_all <-
#   dcant_budget_basin_AIP_layer_all %>%
#   filter(Version_ID %in% Version_IDs)

dcant_budget_basin_MLR_layer_all_ensemble <-
  dcant_budget_basin_MLR_layer_all %>%
  filter(Version_ID %in% Version_IDs_ensemble_uncertainty)
dcant_budget_basin_MLR_layer_all_sensitivity <-
  dcant_budget_basin_MLR_layer_all %>%
  filter(Version_ID %in% Version_IDs_ensemble_sensitivity)
dcant_budget_basin_MLR_layer_all <-
  dcant_budget_basin_MLR_layer_all %>%
  filter(Version_ID %in% Version_IDs)


dcant_zonal_bias_all_ensemble <- dcant_zonal_bias_all %>% 
  filter(Version_ID %in% Version_IDs_ensemble_uncertainty)
dcant_zonal_bias_all <- dcant_zonal_bias_all %>% 
  filter(Version_ID %in% Version_IDs)

dcant_penetration_depth_all_lat_mean_all_ensemble <-
  dcant_penetration_depth_all_lat_mean_all %>%
  filter(Version_ID %in% Version_IDs_ensemble_uncertainty)
dcant_penetration_depth_all_lat_mean_all <-
  dcant_penetration_depth_all_lat_mean_all %>%
  filter(Version_ID %in% Version_IDs)

```



## Observations coverage

```{r read_coverage_grid_files}


for (i_Version_IDs in Version_IDs) {
  path_version_data     <-
    paste(path_observations,
          i_Version_IDs,
          "/data/",
          sep = "")
  
  # load and join data files
  
  GLODAP_grid_era  <-
    read_csv(paste(
      path_version_data,
      "GLODAPv2.2020_clean_obs_grid_era.csv",
      sep = ""
    ))

  
  GLODAP_grid_era <- GLODAP_grid_era %>%
    mutate(Version_ID = i_Version_IDs)
  
  if (exists("GLODAP_grid_era_all")) {
    GLODAP_grid_era_all <-
      bind_rows(GLODAP_grid_era_all, GLODAP_grid_era)
  }
  
  if (!exists("GLODAP_grid_era_all")) {
    GLODAP_grid_era_all <- GLODAP_grid_era
  }
  
  
  
  GLODAP <- read_csv(paste(
    path_version_data,
    "GLODAPv2.2020_clean.csv",
    sep = ""
  ))
  
  GLODAP <- GLODAP %>%
    mutate(Version_ID = i_Version_IDs)
  
  if (exists("GLODAP_all")) {
    GLODAP_all <-
      bind_rows(GLODAP_all, GLODAP)
  }
  
  if (!exists("GLODAP_all")) {
    GLODAP_all <- GLODAP
  }
  
}

rm(GLODAP_grid_era, GLODAP)


GLODAP_grid_era_all <- full_join(GLODAP_grid_era_all,
                                 params_local_all)

GLODAP_all <- full_join(GLODAP_all,
                        params_local_all)


GLODAP_expocodes <-
  read_tsv(
    paste(
      "/nfs/kryo/work/updata/glodapv2_2021/",
      "EXPOCODES.txt",
      sep = ""
    ),
    col_names = c("cruise", "cruise_expocode")
  )

GLODAP_all <-
  left_join(GLODAP_all, GLODAP_expocodes)


```



## Atm CO2

```{r read_atm_co2}

co2_atm <-
  read_csv(paste(path_preprocessing,
                 "co2_atm.csv",
                 sep = ""))

co2_atm_reccap2 <-
  read_csv(paste(path_preprocessing,
                  "co2_atm_reccap2.csv",
                  sep = ""))

```

## Sabine total Cant

```{r Sabine_tCant}


tcant_inv <-
  read_csv(paste(path_preprocessing,
                  "S04_tcant_inv.csv", sep = ""))

tcant_inv <- tcant_inv %>% 
  filter(inv_depth == 3000) %>% 
  rename(dcant = tcant,
         dcant_pos = tcant_pos) %>% 
  mutate(tref1 = 1800,
         tref2 = 1994)

```

## GCB carbon sink

```{r read_GCB_ocean_carbon_sink}

Ocean_Sink <-
  read_csv(paste(path_preprocessing,
                  "Ocean_Sink.csv",
                  sep = ""))

Global_Carbon_Budget <-
  read_csv(paste(path_preprocessing,
                  "GCB_Global_Carbon_Budget.csv",
                  sep = ""))

```

## Periods

```{r define_period_groups}

two_decades <- unique(params_local_all_ensemble$period)[1:2]

```


# Define labels

```{r define_legend_titles}

dcant_pgc_label <- expression(Delta * C["ant"]~(PgC))
dcant_bias_pgc_label <- expression(Delta * C["ant"]~ bias ~(PgC))
delta_dcant_bias_pgc_label <- expression(Delta * Delta * C["ant"]~bias~(PgC))
dcant_pgc_scaled_label <- expression(beta~(mol~m^{-2}~µatm^{-1}))

dcant_umol_label <- expression(Delta * C[ant]~(mu * mol ~ kg ^ {-1}))
ddcant_umol_label <- expression(Delta * Delta * C[ant]~(mu * mol ~ kg ^ {-1}))

dcant_layer_budget_label <- 
  expression(Delta ~ C[ant] ~ "budget per 500m depth layer (PgC)")

dcant_CI_label <- expression(Delta * C[ant]~(mol ~ m ^ {-2}))
delta_dcant_CI_label <- expression(Delta * Delta * C[ant]~(mol ~ m ^ {-2}))
beta_CI_label <- expression(atop(beta,
                                 (mol ~ m ^ {-2} ~ µatm ^ {-1})))


```

# Additive uncertainty

```{r additive_uncertainty_calculation_function}

MLR_basins_reference <- unique(params_local_all$MLR_basins)

MLR_basins_sensitivity <- unique(params_local_all_ensemble$MLR_basins)
MLR_basins_sensitivity <- MLR_basins_sensitivity[!MLR_basins_sensitivity %in% MLR_basins_reference]

additive_uncertainty <- function(df){

df_regional <-
  df %>% 
  pivot_wider(names_from = MLR_basins,
              values_from = dcant) %>% 
  pivot_longer(all_of(MLR_basins_sensitivity),
               names_to = "MLR_basins",
               values_to = "dcant") %>% 
  mutate(delta_dcant = dcant - !!sym(MLR_basins_reference)) %>% 
  select(-c(all_of(MLR_basins_reference), MLR_basins, dcant))


df_regional_stat <-
  df_regional %>% 
  group_by(across(-delta_dcant)) %>%
  summarise(sd = mean(abs(delta_dcant))) %>%
  ungroup() %>%
  filter(Version_ID_group == unique(params_local_all$Version_ID_group)) %>%
  select(-Version_ID_group)

Version_ID_group_uncertainty <-
  df %>% distinct(Version_ID_group) %>% pull
Version_ID_group_uncertainty <-
  Version_ID_group_uncertainty[Version_ID_group_uncertainty != unique(params_local_all$Version_ID_group)]

df_configuration <-
  df %>% 
  pivot_wider(names_from = Version_ID_group,
              values_from = dcant) %>%
  pivot_longer(
    all_of(Version_ID_group_uncertainty),
    names_to = "Version_ID_group",
    values_to = "dcant"
  ) %>% 
  mutate(delta_dcant = !!sym(unique(params_local_all$Version_ID_group)) - dcant)


df_configuration <-
  df_configuration %>%
  filter(MLR_basins == unique(params_local_all$MLR_basins)) %>%
  rename(sd = delta_dcant) %>% 
  select(-c(MLR_basins, dcant, unique(params_local_all$Version_ID_group)))

df_factorial <-
  bind_rows(
    df_regional_stat %>%
      mutate(Version_ID_group = "Regional clustering"),
    df_configuration
  )

df_factorial_stat <-
  df_factorial %>% 
  select(-Version_ID_group) %>% 
  group_by(across(-sd)) %>% 
  summarise(sd = sqrt(sum(sd^2))) %>% 
  ungroup()

df_stat <-
  full_join(
    df_factorial_stat,
    df %>%
      filter(
        Version_ID_group %in% unique(params_local_all$Version_ID_group),
        MLR_basins == MLR_basins_reference
      ) %>%
      rename(std_case = dcant) %>%
      select(-c(MLR_basins, Version_ID_group))
  )

df_stat <- df_stat %>%
  mutate(signif = if_else(abs(std_case) >= sd * sd_factor,
                          1,
                          0))

df_stat_delta <-
  df_stat %>%
  select(-signif) %>% 
  arrange(period) %>%
  group_by(across(-c(period, sd, std_case))) %>%
  mutate(delta_dcant = std_case - lag(std_case),
         sd = sd_factor * sd,
         RSS = sqrt(sd^ 2 + lag(sd ^ 2)),
         signif = if_else(abs(delta_dcant) >= RSS,
                          1,
                          0)) %>%
  ungroup() %>%
  drop_na()


df_out <- list(df_stat, df_factorial, df_stat_delta)

return(df_out)

}


```


# Coverage maps

```{r coverage_maps}

cruises_phosphate_gap_fill <-
  c("33MW19930704",
    "33RO20030604",
    "33RO20050111",
    "33RO19980123")

cruises_talk_gap_fill <-
  c("06AQ19980328")

cruises_talk_calc <-
  c("06MT19900123",
    "316N19920502",
    "316N19921006")

GLODAP_all_coverage <- GLODAP_all %>% 
  distinct(lat, lon, era, cruise_expocode) %>% 
  mutate(gap_filling = case_when(
    cruise_expocode %in% cruises_phosphate_gap_fill ~ "Phosphate from CANYON-B",
    cruise_expocode %in% cruises_talk_gap_fill ~ "TA from CANYON-B",
    cruise_expocode %in% cruises_talk_calc ~ "TA calculated from other variables",
    cruise_expocode %in% "31DS19940126" ~ "Nitrate qc-flag not met",
    TRUE ~ "All quality criteria fulfilled"
  )) %>% 
  distinct(lat, lon, era, gap_filling)

colour("bright")(7)

coverage_map <- map +
  geom_tile(data = GLODAP_all_coverage,
            aes(lon, lat)) +
  facet_wrap( ~ era, ncol = 1) +
  scale_color_okabeito() +
  scale_fill_okabeito() +
  theme(axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.position = c(0.7,0.3),
        legend.title = element_blank())

coverage_map

ggsave(plot = coverage_map,
       path = here::here("output/presentation"),
       filename = "Fig_observations_coverage_map.png",
       height = 6,
       width = 4)


GLODAP_all_coverage <- GLODAP_all %>% 
  filter(between(depth, 250, 750)) %>% 
  group_by(lat, lon, era) %>%
  summarise(tco2 = mean(tco2, na.rm = TRUE)) %>% 
  ungroup()

coverage_map <- map +
  geom_tile(data = GLODAP_all_coverage,
            aes(lon, lat, fill = tco2, col = tco2,
                height = 2, width = 2)) +
  facet_wrap( ~ era, ncol = 1) +
  scale_fill_viridis_c(name = expression(
    atop(DIC~at~"500m",(µmol~kg^{-1})))) +
  scale_color_viridis_c(guide = "none") +
  labs(title = "Observations",
       subtitle = "Decadal coverage") +
  theme(axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.position = "bottom")

coverage_map

ggsave(plot = coverage_map,
       path = here::here("output/presentation"),
       filename = "Fig_observations_coverage_map_dic.png",
       height = 7,
       width = 4)

rm(coverage_map, 
   GLODAP_all, GLODAP_all_coverage, GLODAP_expocodes,
   GLODAP_grid_era_all)

rm(cruises_phosphate_gap_fill,
   cruises_talk_gap_fill,
   cruises_talk_calc)

```

# Atm CO2

```{r atm_CO2, fig.asp=1}

co2_atm_roll <- co2_atm %>% 
  mutate(pCO2_roll = zoo::rollmean(pCO2, 10, fill = NA))

p_pco2_atm <- co2_atm_roll %>% 
  ggplot() +
  geom_point(aes(year, pCO2, col="annual")) +
  geom_path(aes(year, pCO2, col="annual")) +
  geom_point(aes(year, pCO2_roll, col="10yr roll")) +
  geom_path(aes(year, pCO2_roll, col="10yr roll"))

co2_atm_roll <- co2_atm_roll %>% 
  mutate(delta_pCO2_roll = pCO2_roll - lag(pCO2_roll,10),
         delta_pCO2 = pCO2 - lag(pCO2,10))

p_delta_pCO2_atm <- co2_atm_roll %>% 
  ggplot() +
  geom_point(aes(year, delta_pCO2, col="annual")) +
  geom_path(aes(year, delta_pCO2, col="annual")) +
  geom_point(aes(year, delta_pCO2_roll, col="10yr roll")) +
  geom_path(aes(year, delta_pCO2_roll, col="10yr roll"))

p_pco2_atm / p_delta_pCO2_atm
rm(p_pco2_atm, p_delta_pCO2_atm)

delta_pCO2_atm <-
  left_join(
    params_local_all %>%
      distinct(period, tref1, tref2),
    co2_atm_roll %>%
      select(
        tref1 = year,
        pCO2_1 = pCO2,
        pCO2_roll_1 = pCO2_roll
      )
  )

delta_pCO2_atm <-
  left_join(
    delta_pCO2_atm,
    co2_atm_roll %>%
      select(
        tref2 = year,
        pCO2_2 = pCO2,
        pCO2_roll_2 = pCO2_roll
      )
  )

delta_pCO2_atm <- delta_pCO2_atm %>% 
  mutate(delta_pCO2 = pCO2_2 - pCO2_1,
         delta_pCO2_roll = pCO2_roll_2 - pCO2_roll_1) %>% 
  select(period, delta_pCO2, delta_pCO2_roll)

delta_pCO2_atm <- delta_pCO2_atm %>%
  select(period, delta_pCO2)

delta_pCO2_atm <- 
  bind_rows(
    delta_pCO2_atm,
    tibble(period = "1800 - 1994",
           delta_pCO2 = co2_atm %>% filter(year==1994) %>% pull(pCO2) - 280)
  )

rm(co2_atm_roll)

```


# Globale scaling

- storage beneath 3000m: +2%
- unmapped regions south of 65N: +1.5%
- Nordic Seas: +1%
- Arctic Ocean: +2%

```{r scaling_factor_budgets_to_global_coverage}

dcant_scaling <- 1.02*1.015*1.01*1.02
dcant_scaling_uncertainty <- 0.5

```

# Uncertainty factor

```{r define_uncertainty_factor}

sd_factor <- 2

```


# eMLR stats

## Predictor selection

```{r predictors}

lm_best_predictor_counts_all %>% 
  filter(period %in% two_decades,
         data_source == "obs") %>% 
  pivot_longer(aou:temp,
               names_to = "predictor",
               values_to = "count") %>% 
  # mutate(count = as.factor(count)) %>% 
  group_by(predictor, count, period, Version_ID_group) %>% 
  summarise(n = n()) %>% 
  ungroup() %>% 
  ggplot(aes(x = count, y = n)) +
  scale_color_manual(values = c("#EE7733", "#009988"), name = "Decade") +
  scale_fill_manual(values = c("#EE7733", "#009988"), name = "Decade") +
  geom_path(aes(col = period)) +
    geom_point(aes(fill = period), shape = 21) +
  coord_flip() +
  scale_x_continuous(breaks = seq(0,10,2),
                     limits = c(0,10),
                     name = "Presence among 10 best models") +
  labs(y = "Counts across density slabs, regional clusters and basins") +
  facet_wrap(~predictor)

```

## Residual distribution

```{r residual_latitude}

spatial_residual_all %>%
  filter(gamma_slab %in% params_local$plot_slabs[2],
         data_source == "obs",
         period %in% two_decades) %>%
  p_map_dcant_slab(
    var = ".resid_mean",
    col = "divergent",
    title_text = "Residual distribution"
    ) +
  facet_grid(era ~ period) +
  theme_dark()


spatial_residual_offset_all %>%
  filter(
    gamma_slab %in% params_local$plot_slabs[1],
    data_source == "obs",
    period %in% two_decades
  ) %>%
  p_map_dcant_slab(var = ".resid_mean_offset",
                   col = "divergent",
                   title_text = "Residual offset distribution (era 2 - era 1)") +
  facet_grid(. ~ period) +
  theme_dark()


lat_residual_all %>%
  filter(data_source == "obs",
         period %in% two_decades) %>%
  ggplot(aes(
    .resid_mean,
    lat_grid,
    col = era,
    group = interaction(basin, era, gamma_slab, Version_ID)
  )) +
  geom_vline(xintercept = 0) +
  # geom_point() +
  geom_path(alpha = 0.5) +
  facet_grid(. ~ period)

lat_residual_all %>%
  filter(data_source == "obs",
         period %in% two_decades) %>%
  select(-c(Version_ID, tref1, tref2)) %>% 
  mutate(sampling_period = if_else(period == "2004 - 2014" & 
                                     era == "2000-2009",
                                   "first",
                                   "second"),
         sampling_period = if_else(period == "1994 - 2004" & 
                                     era == "1989-1999",
                                   "first",
                                   sampling_period)) %>% 
  select(-era) %>% 
  pivot_wider(names_from = sampling_period,
              values_from = .resid_mean) %>% 
  ggplot(aes(first, second)) +
  geom_vline(xintercept = 0) +
  geom_hline(yintercept = 0) +
  geom_bin2d(binwidth = 1) +
  geom_abline(slope = 1, col = "red") +
  geom_smooth(method = "lm") +
  scale_fill_viridis_c(trans = "log10") +
  coord_fixed(ylim = c(-15, 15),
              xlim = c(-15, 15)) +
  labs(
    y = "First sampling period\nmean MLR residual in 5° latitude bin (µmol/kg)",
    x = "Second sampling period\nmean MLR residual in 5° latitude bin (µmol/kg)"
    ) +
  facet_wrap(~period)

lat_residual_all %>%
  filter(data_source == "obs",
         period %in% two_decades) %>%
  select(-c(Version_ID, tref1, tref2)) %>% 
  mutate(sampling_period = if_else(period == "2004 - 2014" & 
                                     era == "2000-2009",
                                   "first",
                                   "second"),
         sampling_period = if_else(period == "1994 - 2004" & 
                                     era == "1989-1999",
                                   "first",
                                   sampling_period)) %>% 
  select(-era) %>% 
  pivot_wider(names_from = sampling_period,
              values_from = .resid_mean) %>% 
  nest_by(period) %>%
  mutate(mod = list(lm(second ~ first, data = data))) %>%
  summarize(broom::tidy(mod))

lat_residual_all %>%
  filter(data_source == "obs",
         period %in% two_decades) %>%
  select(-c(Version_ID, tref1, tref2)) %>% 
  mutate(sampling_period = if_else(period == "2004 - 2014" & 
                                     era == "2000-2009",
                                   "first",
                                   "second"),
         sampling_period = if_else(period == "1994 - 2004" & 
                                     era == "1989-1999",
                                   "first",
                                   sampling_period)) %>% 
  select(-era) %>% 
  pivot_wider(names_from = sampling_period,
              values_from = .resid_mean) %>% 
  drop_na() %>% 
  group_by(period) %>%
  summarize(correlation = cor(first, second))


lat_residual_all_mean <- lat_residual_all %>%
  filter(data_source == "obs",
         period %in% two_decades) %>% 
  group_by(period, era, lat_grid) %>% 
  summarise(residual_mean = mean(abs(.resid_mean)),
            residual_sd = sd(.resid_mean),
            residual_iqr = IQR(.resid_mean)) %>% 
  ungroup()

lat_residual_offset_all_mean <- lat_residual_offset_all %>%
  filter(data_source == "obs",
         period %in% two_decades) %>% 
  group_by(period, lat_grid) %>% 
  summarise(residual_mean = mean(abs(.resid_mean_offset)),
            residual_sd = sd(.resid_mean_offset),
            residual_iqr = IQR(.resid_mean)) %>% 
  ungroup()

p_residual_lat <- 
ggplot() +
  geom_vline(xintercept = 0) +
  geom_ribbon(
    data = lat_residual_all_mean,
    aes(
      xmin = residual_mean - residual_iqr,
      xmax = residual_mean + residual_iqr,
      y = lat_grid,
      fill = era
    ),
    alpha = 0.3
  ) +
  geom_path(data = lat_residual_all_mean,
            aes(residual_mean,
                lat_grid,
                col = era)) +
  scale_fill_highcontrast() +
  scale_color_highcontrast() +
  coord_cartesian(xlim = c(-3,7)) +
  facet_grid(. ~ period)


p_residual_lat_offset <- 
ggplot() +
  geom_vline(xintercept = 0) +
  geom_ribbon(
    data = lat_residual_offset_all_mean,
    aes(
      xmin = residual_mean - residual_iqr,
      xmax = residual_mean + residual_iqr,
      y = lat_grid
    ),
    alpha = 0.3
  ) +
  geom_path(data = lat_residual_offset_all_mean,
            aes(residual_mean,
                lat_grid)) +
  coord_cartesian(xlim = c(-3,7)) +
  facet_grid(. ~ period)

p_residual_lat / p_residual_lat_offset
rm(p_residual_lat, p_residual_lat_offset)


p_residual_lat <-
ggplot() +
  geom_vline(xintercept = 0) +
  geom_path(data = lat_residual_all %>% 
              filter(data_source == "obs",
                     period %in% two_decades,
                     gamma_slab %in% params_local$plot_slabs[2]),
            aes(.resid_mean,
                lat_grid,
                col = era)) +
  scale_fill_highcontrast() +
  scale_color_highcontrast() +
  coord_cartesian(xlim = c(-3,7)) +
  facet_grid(basin ~ period)

p_residual_lat_offset <-
ggplot() +
  geom_vline(xintercept = 0) +
  geom_path(data = lat_residual_offset_all %>% 
              filter(data_source == "obs",
                     period %in% two_decades,
                     gamma_slab %in% params_local$plot_slabs[2]),
            aes(.resid_mean_offset,
                lat_grid)) +
  scale_fill_highcontrast() +
  scale_color_highcontrast() +
  coord_cartesian(xlim = c(-3,7)) +
  facet_grid(basin ~ period)


p_residual_lat / p_residual_lat_offset
rm(p_residual_lat, p_residual_lat_offset)

lat_residual_offset_all %>% 
  ggplot(aes(.resid_mean, .resid_mean_offset)) +
  geom_bin_2d() +
  scale_fill_viridis_c(trans = "log10")

lat_residual_offset_all %>%
  pivot_longer(starts_with(".resid"),
               names_to = "type",
               values_to = "residual") %>%
  ggplot(aes(residual, fill = type, col = type)) +
  coord_cartesian(xlim = c(-5,5)) +
  geom_density(alpha = 0.5)


left_join(lm_best_target_all,
          GLODAP_glanced_all) %>% 
  summarise(mean_rmse = mean(rmse, na.rm = TRUE),
            sd_rmse = sd(rmse, na.rm = TRUE))


```




# Column inventories


```{r calculate_beta_inventories}

dcant_inv_all <- bind_rows(
  dcant_inv_all,
  tcant_inv %>% mutate(period = paste(tref1, tref2, sep = " - "),
                       data_source = "obs")
)


dcant_inv_all <- left_join(dcant_inv_all,
                           delta_pCO2_atm)


dcant_inv_all <- dcant_inv_all %>% 
  mutate(beta = dcant / delta_pCO2,
         beta_pos = dcant_pos / delta_pCO2) %>% 
  select(-starts_with("pCO2"))

dcant_inv_all_ensemble <- dcant_inv_all %>% 
  filter(Version_ID %in% Version_IDs_ensemble_uncertainty)

dcant_inv_all_sensitivity <- dcant_inv_all %>% 
  filter(Version_ID %in% Version_IDs_ensemble_sensitivity)

dcant_inv_all <- dcant_inv_all %>% 
  filter(Version_ID %in% Version_IDs | is.na(Version_ID))

```


## Sensitivity cases

```{r column_inventory_additive_uncertainty_sensitivity_cases}


dcant_inv_all_ensemble_sensitivity <-
  dcant_inv_all_sensitivity %>%
  filter(period %in% two_decades,
         data_source != "mod_truth") %>%
  select(lon, lat, period, data_source, MLR_basins, Version_ID_group, dcant)

# dcant_inv_all_ensemble_sensitivity <- 
#   m_grid_horizontal_coarse(dcant_inv_all_ensemble_sensitivity)
# 
# dcant_inv_all_ensemble_sensitivity <-
#   dcant_inv_all_ensemble_sensitivity %>% 
#   group_by(lat, lon, data_source, period, MLR_basins, Version_ID_group) %>% 
#   summarise(dcant = mean(dcant),
#             n = n()) %>% 
#   ungroup() %>% 
#   filter(n == 25) %>%
#   rename(lon = lon_grid,
#          lat = lat_grid)

dcant_inv_sensitivity <- additive_uncertainty(dcant_inv_all_ensemble_sensitivity)

delta_dcant_inv_sensitivity <- dcant_inv_sensitivity[[3]]
dcant_inv_sensitivity_contributions <- dcant_inv_sensitivity[[2]]
dcant_inv_sensitivity <- dcant_inv_sensitivity[[1]]


dcant_inv_sensitivity %>%
  mutate(
    data_source = case_when(
      data_source == "mod" ~ "Synthetic data",
      data_source == "obs" ~ "Observations"
    )
  ) %>%
  p_map_cant_inv(var = "sd",
                 breaks = c(seq(0, 16, 2), Inf),
                 title_text = NULL) +
  facet_grid(period ~ data_source) +
  theme(axis.text = element_blank(),
        axis.ticks = element_blank())


dcant_inv_sensitivity_contributions %>%
  filter(data_source == "obs",
         Version_ID_group != "Regional clustering") %>% 
  mutate(
    data_source = case_when(
      data_source == "mod" ~ "Synthetic data",
      data_source == "obs" ~ "Observations"
    )
  ) %>%
  rename(dcant_diff = sd) %>% 
  p_map_cant_inv(var = "dcant_diff",
                 col = "bias",
                 breaks = c(-Inf, seq(-2,2,1), Inf),
                 title_text = NULL) +
  facet_grid(Version_ID_group ~ period) +
  theme(axis.text = element_blank(),
        axis.ticks = element_blank())


ggsave(path = here::here("output/publication"),
       filename = "FigS_dcant_column_inventory_uncertainty_sensitivity_cases.png",
       height = 5,
       width = 8)

```


## Uncertainty cases

```{r column_inventory_additive_uncertainty_fine_grid}


dcant_inv_all_ensemble_uncertainty <-
  dcant_inv_all_ensemble %>%
  filter(period %in% two_decades,
         data_source != "mod_truth") %>%
  select(lon, lat, period, data_source, MLR_basins, Version_ID_group, dcant)

# dcant_inv_all_ensemble_uncertainty <- 
#   m_grid_horizontal_coarse(dcant_inv_all_ensemble_uncertainty)
# 
# dcant_inv_all_ensemble_uncertainty <-
#   dcant_inv_all_ensemble_uncertainty %>% 
#   group_by(lat_grid, lon_grid, data_source, period, MLR_basins, Version_ID_group) %>% 
#   summarise(dcant = mean(dcant),
#             n = n()) %>% 
#   ungroup() %>% 
#   filter(n == 25) %>% 
#   rename(lon = lon_grid,
#          lat = lat_grid)

dcant_inv_uncertainty <- additive_uncertainty(dcant_inv_all_ensemble_uncertainty)

delta_dcant_inv_uncertainty <- dcant_inv_uncertainty[[3]]
dcant_inv_uncertainty_contributions <- dcant_inv_uncertainty[[2]]
dcant_inv_uncertainty <- dcant_inv_uncertainty[[1]]


dcant_inv_uncertainty %>%
  mutate(
    data_source = case_when(
      data_source == "mod" ~ "Synthetic data",
      data_source == "obs" ~ "Observations"
    ),
    sd = sd*sd_factor
  ) %>%
  p_map_cant_inv(var = "sd",
                 breaks = c(seq(0, 16, 2), Inf),
                 title_text = NULL) +
  facet_grid(period ~ data_source) +
  theme(axis.text = element_blank(),
        axis.ticks = element_blank())

ggsave(path = here::here("output/publication"),
       filename = "FigS_dcant_column_inventory_uncertainty.png",
       height = 4,
       width = 7)

dcant_inv_uncertainty_contributions %>%
  filter(data_source == "obs") %>% 
  mutate(
    data_source = case_when(
      data_source == "mod" ~ "Synthetic data",
      data_source == "obs" ~ "Observations"
    )
  ) %>%
  rename(dcant_diff_uncertainty = sd) %>% 
  p_map_cant_inv(var = "dcant_diff_uncertainty",
                 col = "bias",
                 breaks = c(-Inf, seq(-2,2,1), Inf),
                 title_text = NULL) +
  facet_grid(Version_ID_group ~ period) +
  theme(axis.text = element_blank(),
        axis.ticks = element_blank())

ggsave(path = here::here("output/publication"),
       filename = "FigS_dcant_column_inventory_uncertainty_contributions.png",
       height = 8,
       width = 8)


```

```{r column_inventory_additive_uncertainty_coarse_grid}


dcant_inv_all_ensemble_uncertainty <-
  dcant_inv_all_ensemble %>%
  filter(period %in% two_decades,
         data_source != "mod_truth") %>%
  select(lon, lat, period, data_source, MLR_basins, Version_ID_group, dcant)

dcant_inv_all_ensemble_uncertainty <- 
  m_grid_horizontal_coarse(dcant_inv_all_ensemble_uncertainty)

dcant_inv_all_ensemble_uncertainty <-
  dcant_inv_all_ensemble_uncertainty %>% 
  group_by(lat_grid, lon_grid, data_source, period, MLR_basins, Version_ID_group) %>% 
  summarise(dcant = mean(dcant),
            n = n()) %>% 
  ungroup() %>% 
  filter(n == 25) %>% 
  rename(lon = lon_grid,
         lat = lat_grid)

dcant_inv_uncertainty <- additive_uncertainty(dcant_inv_all_ensemble_uncertainty)

delta_dcant_inv_uncertainty <- dcant_inv_uncertainty[[3]]
dcant_inv_uncertainty_contributions <- dcant_inv_uncertainty[[2]]
dcant_inv_uncertainty <- dcant_inv_uncertainty[[1]]


dcant_inv_uncertainty %>%
  mutate(
    data_source = case_when(
      data_source == "mod" ~ "Synthetic data",
      data_source == "obs" ~ "Observations"
    )
  ) %>%
  p_map_cant_inv(var = "sd",
                 breaks = c(seq(0, 8, 1), Inf),
                 title_text = NULL) +
  facet_grid(period ~ data_source) +
  theme(axis.text = element_blank(),
        axis.ticks = element_blank())


delta_dcant_inv_uncertainty %>% 
  p_map_cant_inv(var = "delta_dcant",
                 col = "bias",
                 title_text = NULL) +
  facet_grid(data_source ~ .) +
  theme(axis.text = element_blank(),
        axis.ticks = element_blank())

delta_dcant_inv_uncertainty %>% 
  p_map_cant_inv(var = "RSS",
                 breaks = c(seq(0, 8, 1), Inf),
                 title_text = NULL) +
  facet_grid(data_source ~ .) +
  theme(axis.text = element_blank(),
        axis.ticks = element_blank())

delta_dcant_inv_uncertainty %>% 
  filter(signif == 1) %>% 
  p_map_cant_inv(var = "delta_dcant",
                 col = "bias",
                 title_text = NULL) +
  facet_grid(data_source ~ .) +
  theme(axis.text = element_blank(),
        axis.ticks = element_blank())

```


```{r column_inventory_standard_deviation, eval=FALSE}


dcant_inv_all_ensemble_sd <-
  dcant_inv_all_ensemble %>%
  filter(period %in% two_decades,
         data_source != "mod_truth") %>%
  group_by(data_source, period, lon, lat) %>%
  summarise(dcant_sd = sd(dcant) * sd_factor) %>%
  ungroup()


dcant_inv_all_ensemble_sd %>%
  mutate(
    data_source = case_when(
      data_source == "mod" ~ "Synthetic data",
      data_source == "obs" ~ "Observations"
    )
  ) %>%
  p_map_cant_inv(var = "dcant_sd",
                 breaks = c(seq(0, 8, 1), Inf),
                 title_text = NULL) +
  facet_grid(period ~ data_source) +
  theme(axis.text = element_blank(),
        axis.ticks = element_blank())

delta_dcant_inv_all_ensemble_RSS <-
  dcant_inv_all_ensemble_sd %>%
  arrange(period) %>%
  group_by(data_source, lat, lon) %>%
  mutate(RSS = sqrt(dcant_sd ^ 2 + lag(dcant_sd ^ 2))) %>%
  ungroup() %>%
  drop_na()  

delta_dcant_inv_all_ensemble_RSS %>% 
  p_map_cant_inv(var = "RSS",
                 breaks = c(seq(0, 8, 1), Inf),
                 title_text = NULL) +
  facet_grid(data_source ~ .) +
  theme(axis.text = element_blank(),
        axis.ticks = element_blank())

delta_dcant_inv_all_ensemble_sd <-
  dcant_inv_all_ensemble %>%
  filter(period %in% two_decades,
         data_source != "mod_truth") %>%
  arrange(period) %>%
  group_by(MLR_basins, Version_ID_group, data_source, lat, lon) %>%
  mutate(delta_dcant = dcant - lag(dcant)) %>%
  ungroup()

delta_dcant_inv_all_ensemble_sd <-
  delta_dcant_inv_all_ensemble_sd %>%
  filter(!is.na(delta_dcant)) %>%
  group_by(data_source, lon, lat) %>%
  summarise(delta_dcant_sd = sd(delta_dcant) * sd_factor,
            delta_dcant = mean(delta_dcant)) %>%
  ungroup()


delta_dcant_inv_all_ensemble_sd %>% 
  p_map_cant_inv(var = "delta_dcant_sd",
                 breaks = c(seq(0, 8, 1), Inf),
                 title_text = NULL) +
  facet_grid(data_source ~ .) +
  theme(axis.text = element_blank(),
        axis.ticks = element_blank())

```



```{r inventory_maps_absolute_dcant_vs_SD, eval=FALSE}

dcant_inv_all_uncertainty <-
  full_join(
    dcant_inv_all %>%
      select(data_source, lon, lat, period, dcant),
    dcant_inv_all_ensemble_sd %>% select(data_source, lon, lat, period, dcant_sd)
  )

dcant_inv_all_uncertainty <-dcant_inv_all_uncertainty %>% 
  filter(period %in%two_decades,
         data_source %in% c("mod", "obs"))

dcant_inv_all_uncertainty <-
  m_grid_horizontal_coarse(dcant_inv_all_uncertainty)

dcant_inv_all_uncertainty <-
  dcant_inv_all_uncertainty %>%
  group_by(lat_grid, lon_grid, data_source, period) %>% 
  summarise(dcant = mean(dcant),
            dcant_sd = mean(dcant_sd),
            n = n()) %>% 
  ungroup() %>% 
  filter(n == 25) %>% 
  rename(lon = lon_grid,
         lat = lat_grid) %>% 
  mutate(dcant_sign = abs(dcant) - dcant_sd)

dcant_inv_all_uncertainty %>% 
  mutate(dcant = abs(dcant)) %>% 
  p_map_cant_inv(
    var = "dcant",
    title_text = NULL,
    subtitle_text = NULL,
    col = "bias"
  ) +
  facet_grid(data_source~period)

dcant_inv_all_uncertainty %>% 
  p_map_cant_inv(
    var = "dcant_sd",
    title_text = NULL,
    subtitle_text = NULL,
    col = "bias"
  ) +
  facet_grid(data_source~period)

dcant_inv_all_uncertainty %>% 
  p_map_cant_inv(
    var = "dcant_sign",
    title_text = NULL,
    subtitle_text = NULL,
    col = "bias"
  ) +
  facet_grid(data_source~period)


map +
  geom_point(
    data = dcant_inv_all_uncertainty %>%
      filter(signif == 0),
    aes(lon, lat),
    shape = 20,
    size = 0.1
  ) +
  facet_grid(data_source ~ period)


```


## dCant - absolute

```{r inventory_maps_absolute_obs, fig.asp=1.2}


p_CI_absolute <- dcant_inv_all %>%
  filter(period %in% two_decades,
         data_source %in% c("obs")) %>%
  p_map_cant_inv(var = "dcant",
                 title_text = NULL) +
  facet_wrap(~ period, ncol = 1) +
  theme(axis.text.x = element_blank()) +
  geom_point(
    data = dcant_inv_uncertainty %>%
      filter(signif == 0,
             data_source == "obs"),
    aes(lon, lat),
    shape = 20,
    size = 0.1,
    col = "grey"
  )

p_CI_absolute +
  theme(axis.text = element_blank(),
        axis.ticks = element_blank())


ggsave(path = here::here("output/presentation"),
       filename = "Fig_dcant_column_inventory.png",
       height = 5,
       width = 6)

```

```{r inventory_maps_absolute_mod_x, fig.asp=1.2, eval=FALSE}


p_CI_absolute_mod <- dcant_inv_all %>%
  filter(period %in% two_decades,
         data_source %in% c("mod")) %>%
  p_map_cant_inv(var = "dcant",
                 title_text = NULL) +
  facet_wrap(~ period, ncol = 1) +
  theme(axis.text.x = element_blank()) +
  geom_point(
    data = dcant_inv_uncertainty %>%
      filter(signif == 0,
             data_source == "mod"),
    aes(lon, lat),
    shape = 20,
    size = 0.1,
    col = "grey"
  )

p_CI_absolute_mod +
  theme(axis.text = element_blank(),
        axis.ticks = element_blank())


# ggsave(path = here::here("output/presentation"),
#        filename = "Fig_dcant_column_inventory.png",
#        height = 5,
#        width = 6)

```

## Inventory stats

### Basin

```{r dcant_inventory_stats_basin}

dcant_inv_stat_mean <-
  full_join(basinmask,
            dcant_inv_all) %>%
  mutate(surf_area = earth_surf(lat, lon)) %>%
  group_by(basin, period, data_source) %>%
  summarise(dcant = weighted.mean(dcant, surf_area)) %>%
  ungroup() %>%
  filter(!is.na(dcant))

dcant_inv_stat_ensemble <-
  full_join(basinmask,
            dcant_inv_all_ensemble) %>%
  mutate(surf_area = earth_surf(lat, lon)) %>%
  group_by(basin, data_source, period, MLR_basins, Version_ID_group) %>%
  summarise(dcant = weighted.mean(dcant, surf_area)) %>%
  ungroup() %>%
  filter(!is.na(dcant)) %>%
  group_by(basin, data_source, period) %>%
  summarise(dcant_sd = sd(dcant) * 2) %>%
  ungroup()

dcant_inv_stat <-
  full_join(dcant_inv_stat_mean,
            dcant_inv_stat_ensemble)

rm(dcant_inv_stat_mean,
   dcant_inv_stat_ensemble)

dcant_inv_stat %>%
  filter(period %in% two_decades) %>%
  group_by(data_source, basin) %>%
  mutate(delta_dcant = dcant - lag(dcant),
         RSS = sqrt(dcant_sd ^ 2 + lag(dcant_sd ^ 2))) %>%
  ungroup() %>%
  kable() %>%
  kable_styling() %>%
  scroll_box(height = "300px")

```

### Gyres

```{r dcant_inventory_stats_gyres}

dcant_inv_stat_mean <-
  full_join(basinmask,
            dcant_inv_all) %>%
  mutate(surf_area = earth_surf(lat, lon),
         lat_grid = cut(lat, c(-50, -20, 20, 50))) %>%
  group_by(basin, period, data_source, lat_grid) %>%
  summarise(dcant = weighted.mean(dcant, surf_area)) %>%
  ungroup() %>%
  filter(!is.na(dcant),
         !is.na(lat_grid),
         lat_grid != "(-20,20]")
  
dcant_inv_stat_ensemble <-
  full_join(basinmask,
            dcant_inv_all_ensemble) %>%
  mutate(surf_area = earth_surf(lat, lon),
         lat_grid = cut(lat, c(-50, -20, 20, 50))) %>%
  group_by(basin, data_source, period, MLR_basins, Version_ID_group, lat_grid) %>%
  summarise(dcant = weighted.mean(dcant, surf_area)) %>%
  ungroup() %>%
  filter(!is.na(dcant),
         !is.na(lat_grid),
         lat_grid != "(-20,20]") %>%
  group_by(basin, data_source, period, lat_grid) %>%
  summarise(dcant_sd = sd(dcant) * 2) %>%
  ungroup()

dcant_inv_stat <-
  full_join(dcant_inv_stat_mean,
            dcant_inv_stat_ensemble)

dcant_inv_stat %>%
  filter(period %in% two_decades) %>%
  group_by(data_source, basin, lat_grid) %>%
  mutate(delta_dcant = dcant - lag(dcant),
         RSS = sqrt(dcant_sd ^ 2 + lag(dcant_sd ^ 2))) %>%
  ungroup() %>%
  kable() %>%
  kable_styling() %>%
  scroll_box(height = "300px")

rm(dcant_inv_stat, dcant_inv_stat_mean, dcant_inv_stat_ensemble)

```


```{r inventory_maps_absolute_delta_RSS, eval=FALSE}

delta_dcant_inv_all <-
  dcant_inv_all %>%
  filter(data_source %in% c("obs", "mod"),
         period %in% two_decades) %>%
  select(data_source, lon, lat, basin_AIP, period, dcant) %>%
  pivot_wider(names_from = period,
              values_from = dcant) %>%
  mutate(dcant_offset = `2004 - 2014` - `1994 - 2004`,
         period = "(2004 - 2014) - (1994 - 2004)")


delta_dcant_inv_all_uncertainty <-
  full_join(
    delta_dcant_inv_all %>% select(data_source, lon, lat, dcant_offset),
    delta_dcant_inv_all_ensemble_RSS %>% select(data_source, lon, lat, RSS)
  )

delta_dcant_inv_all_uncertainty <-
  m_grid_horizontal_coarse(delta_dcant_inv_all_uncertainty)

delta_dcant_inv_all_uncertainty <-
  delta_dcant_inv_all_uncertainty %>%
  group_by(lat_grid, lon_grid, data_source) %>% 
  summarise(dcant_offset = mean(dcant_offset),
            RSS = mean(RSS),
            n = n()) %>% 
  ungroup() %>% 
  filter(n == 25) %>% 
  rename(lon = lon_grid,
         lat = lat_grid) %>% 
  mutate(dcant_offset_sign = abs(dcant_offset) - RSS)

delta_dcant_inv_all_uncertainty %>% 
  mutate(dcant_offset = abs(dcant_offset)) %>% 
  p_map_cant_inv(
    var = "dcant_offset",
    title_text = NULL,
    subtitle_text = NULL,
    col = "bias"
  ) +
  facet_grid(data_source~.)

delta_dcant_inv_all_uncertainty %>% 
  p_map_cant_inv(
    var = "RSS",
    title_text = NULL,
    subtitle_text = NULL,
    col = "bias"
  ) +
  facet_grid(data_source~.)

delta_dcant_inv_all_uncertainty %>% 
  p_map_cant_inv(
    var = "dcant_offset_sign",
    title_text = NULL,
    subtitle_text = NULL,
    col = "bias"
  ) +
  facet_grid(data_source~.)


map +
  geom_point(
    data = delta_dcant_inv_all_uncertainty %>%
      filter(signif == 0),
    aes(lon, lat),
    shape = 20,
    size = 0.1,
    col = "black"
  ) + 
  facet_wrap(~data_source)


```


```{r inventory_maps_delta_dcant_mod_bias, fig.asp=1.3}

p_CI_absolute_mod_delta <- dcant_inv_all %>%
  filter(period %in% two_decades,
         data_source != "obs") %>%
  mutate(
    data_source = case_when(
      data_source == "mod" ~ "Reconstruction",
      data_source == "mod_truth" ~ "Model truth"
    )
  ) %>%
  p_map_cant_inv(var = "dcant",
                 title_text = NULL) +
  facet_grid(period ~ data_source) +
  theme(axis.text.x = element_blank()) +
  geom_point(
    data = dcant_inv_uncertainty %>%
      filter(signif == 0,
             data_source == "mod") %>%
      mutate(data_source = case_when(data_source == "mod" ~ "Reconstruction")),
    aes(lon, lat),
    shape = 20,
    size = 0.1,
    col = "grey"
  )



p_CI_bias_delta <-
  dcant_inv_all %>%
  filter(period %in% two_decades,
         data_source != "obs") %>%
  select(data_source, lon, lat, basin_AIP, period, dcant) %>%
  pivot_wider(names_from = period,
              values_from = dcant) %>%
  mutate(dcant_offset = `2004 - 2014` - `1994 - 2004`,
         period = "Decadal offset") %>%
  mutate(
    data_source = case_when(
      data_source == "mod" ~ "Reconstruction",
      data_source == "mod_truth" ~ "Model truth"
    )
  ) %>%
  p_map_cant_inv(
    var = "dcant_offset",
    title_text = NULL,
    subtitle_text = NULL,
    col = "bias"
  ) +
  facet_grid(period ~ data_source) +
  geom_point(
    data = delta_dcant_inv_uncertainty %>%
      filter(signif == 0,
             data_source == "mod") %>%
      mutate(
        data_source = case_when(data_source == "mod" ~ "Reconstruction"),
        period = "Decadal offset"
      ),
    
    aes(lon, lat),
    shape = 20,
    size = 0.1,
    col = "black"
  )

p_CI_absolute_mod_delta / p_CI_bias_delta + 
  plot_annotation(tag_levels = 'A')

ggsave(path = here::here("output/publication"),
       filename = "FigS_delta_dcant_column_inventory_synthetic_data.png",
       height = 7,
       width = 8)

rm(p_CI_absolute_mod_delta, p_CI_bias_delta)

p_CI_bias_delta_delta <-
  dcant_inv_all %>%
  filter(period %in% two_decades,
         data_source != "obs") %>%
  select(data_source, lon, lat, basin_AIP, period, dcant) %>%
  pivot_wider(names_from = period,
              values_from = dcant) %>%
  mutate(dcant_offset = `2004 - 2014` - `1994 - 2004`,
         period = "Decadal offset") %>%
  select(lon, lat, data_source, dcant_offset) %>% 
  pivot_wider(names_from = data_source,
              values_from = dcant_offset) %>% 
  mutate(delta_dcant_bias = mod - mod_truth) %>% 
  p_map_cant_inv(
    var = "delta_dcant_bias",
    title_text = NULL,
    subtitle_text = NULL,
    col = "bias"
  )
# theme(strip.text.x = element_blank(),
#       strip.background.x = element_blank())

p_CI_bias_delta_delta

rm(p_CI_bias_delta_delta)

```


## dCant - delta


```{r inventory_maps_absolute_delta, fig.asp=1.3}

delta_dcant_inv_all <-
  dcant_inv_all %>%
  filter(data_source %in% c("obs", "mod"),
         period %in% two_decades) %>%
  select(data_source, lon, lat, basin_AIP, period, dcant) %>%
  pivot_wider(names_from = period,
              values_from = dcant) %>%
  mutate(dcant_offset = `2004 - 2014` - `1994 - 2004`,
         period = "(2004 - 2014) - (1994 - 2004)")

p_CI_delta <-
  delta_dcant_inv_all %>%
  filter(data_source == "obs") %>%
  p_map_cant_inv(
    var = "dcant_offset",
    title_text = NULL,
    subtitle_text = NULL,
    col = "bias"
  ) +
  geom_point(
    data = delta_dcant_inv_uncertainty %>%
      filter(signif == 0,
             data_source == "obs") %>% 
      mutate(period = "(2004 - 2014) - (1994 - 2004)"),
    aes(lon, lat),
    shape = 20,
    size = 0.1,
    col = "black"
  ) +
  facet_wrap(~ period)

p_CI_absolute / p_CI_delta + 
  plot_annotation(tag_levels = 'A')

ggsave(path = here::here("output/publication"),
       filename = "Fig_dcant_column_inventory.png",
       height = 10,
       width = 8)

p_CI_delta +
  theme(axis.text = element_blank(),
        axis.ticks = element_blank())

ggsave(path = here::here("output/presentation"),
       filename = "Fig_dcant_column_inventory_delta.png",
       height = 3.2,
       width = 6)

rm(p_CI_absolute, p_CI_delta)

```

## Bias

```{r inventory_maps_absolute_mod, fig.asp=1.2}

p_CI_absolute_mod <- dcant_inv_all %>%
  filter(period %in% two_decades,
         data_source != "obs") %>%
  mutate(
    data_source = case_when(
      data_source == "mod" ~ "Reconstruction",
      data_source == "mod_truth" ~ "Model truth"
    )
  ) %>%
  p_map_cant_inv(var = "dcant",
                 title_text = NULL) +
  facet_grid(data_source ~ period) +
  theme(axis.text.x = element_blank()) +
  geom_point(
    data = dcant_inv_uncertainty %>%
      filter(signif == 0,
             data_source == "mod") %>%
      mutate(
        data_source = case_when(
          data_source == "mod" ~ "Reconstruction"
        )
      ),
    aes(lon, lat),
    shape = 20,
    size = 0.1,
    col = "grey"
  )

p_CI_absolute_mod

```


```{r invetory_maps_absolute_mod_bias, fig.asp=1.3}

p_CI_bias <-
  dcant_inv_all %>%
  filter(period %in% two_decades,
         data_source != "obs") %>%
  select(data_source, lon, lat, basin_AIP, period, dcant) %>%
  pivot_wider(names_from = data_source,
              values_from = dcant) %>%
  mutate(dcant_bias = mod - mod_truth,
         data_source = "Reconstruction bias") %>%
  p_map_cant_inv(
    var = "dcant_bias",
    title_text = NULL,
    subtitle_text = NULL,
    col = "bias"
  ) +
  facet_grid(data_source ~ period) +
  theme(strip.text.x = element_blank(),
        strip.background.x = element_blank())

p_CI_absolute_mod / p_CI_bias + 
  plot_annotation(tag_levels = 'A')

ggsave(path = here::here("output/publication"),
       filename = "FigS_dcant_column_inventory_synthetic_data.png",
       height = 7,
       width = 8)

rm(p_CI_absolute_mod, p_CI_bias)

```

```{r inventory_maps_absolute_mod_bias_decade, fig.asp=1.3}

p_CI_bias_decade <-
  dcant_inv_all %>%
  filter(period %in% two_decades,
         data_source != "obs") %>%
  select(data_source, lon, lat, basin_AIP, period, dcant) %>%
  pivot_wider(names_from = data_source,
              values_from = dcant) %>%
  mutate(dcant_bias = mod - mod_truth,
         data_source = "Reconstruction bias") %>%
  arrange(period) %>% 
  group_by(lon, lat) %>% 
  summarise(delta_dcant_bias = dcant_bias - lag(dcant_bias)) %>% 
  ungroup() %>% 
  drop_na() %>% 
  p_map_cant_inv(
    var = "delta_dcant_bias",
    title_text = NULL,
    subtitle_text = NULL,
    col = "bias"
  ) +
  theme(strip.text.x = element_blank(),
        strip.background.x = element_blank())

p_CI_bias_decade

ggsave(path = here::here("output/publication"),
       filename = "FigS_delta_dcant_column_inventory_synthetic_data_bias.png",
       height = 3.5,
       width = 5)

rm(p_CI_bias_decade)

```

## Density distributions

```{r dcant_column_inventory_density_distribution}

bind_rows(
  dcant_inv_all %>%
    filter(period %in% two_decades) %>%
    mutate(
      data_source = case_when(
        data_source == "mod" ~ "Reconstruction",
        data_source == "obs" ~ "Observations",
        data_source == "mod_truth" ~ "Model truth"
      )
    ) %>%
    select(data_source, dcant, period),
  dcant_inv_bias_all %>%
    filter(period %in% two_decades) %>%
    mutate(data_source = "Reconstruction bias") %>%
    select(data_source, dcant = dcant_pos_bias, period)
) %>%
  ggplot(aes(dcant, col = data_source)) +
  scale_color_brewer(palette = "Dark2") +
  scale_fill_brewer(palette = "Dark2") +
  geom_vline(xintercept = 0) +
  geom_density(alpha = 0.3) +
  coord_cartesian(xlim = c(-2, 18)) +
  facet_grid(period ~ .) +
  labs(x = dcant_CI_label) +
  theme(legend.title = element_blank())

# ggsave(path = here::here("output/publication"),
#        filename = "FigS_dcant_column_inventory_density_distribution.png",
#        height = 4,
#        width = 7)

```



```{r delta_dcant_column_inventory_density_distribution}

bind_rows(
  dcant_inv_all %>%
    filter(period %in% two_decades) %>%
    select(data_source, lon, lat, period, dcant) %>%
    pivot_wider(names_from = period,
                values_from = dcant) %>%
    mutate(dcant_offset = `2004 - 2014` - `1994 - 2004`,
           period = "(2004 - 2014) - (1994 - 2004)")  %>%
    mutate(
      data_source = case_when(
        data_source == "mod" ~ "Reconstruction",
        data_source == "obs" ~ "Observations",
        data_source == "mod_truth" ~ "Model truth"
      )
    ) %>%
    select(data_source, dcant_offset, period),
  dcant_inv_bias_all %>%
    filter(period %in% two_decades) %>%
    select(lon, lat, period, dcant_bias) %>%
    pivot_wider(names_from = period,
                values_from = dcant_bias) %>%
    mutate(dcant_offset = `2004 - 2014` - `1994 - 2004`,
           period = "(2004 - 2014) - (1994 - 2004)")  %>%
    mutate(data_source = "Reconstruction bias") %>%
    select(data_source, dcant_offset, period)
) %>%
  ggplot(aes(dcant_offset, col = data_source)) +
  scale_color_brewer(palette = "Dark2") +
  scale_fill_brewer(palette = "Dark2") +
  geom_vline(xintercept = 0) +
  geom_density(alpha = 0.3) +
  coord_cartesian(xlim = c(-10, 10)) +
  labs(x = delta_dcant_CI_label) +
  theme(legend.title = element_blank())

# ggsave(
#   path = here::here("output/publication"),
#   filename = "FigS_delta_dcant_column_inventory_density_distribution.png",
#   height = 3,
#   width = 7
# )

```



## Unadjusted data

```{r column_inventory_unadjusted_data, eval=FALSE}

dcant_inv_all_unadjusted <-
  dcant_inv_all_ensemble %>%
  filter(period %in% two_decades,
         data_source == "obs",
         MLR_basins == "3",
         Version_ID %in% Version_IDs |
           Version_ID %in% Version_IDs_d)

p_CI_unadjusted <- 
dcant_inv_all_unadjusted %>%
  p_map_cant_inv(var = "dcant",
                 title_text = NULL) +
  facet_grid(Version_ID_group ~ period)

p_CI_unadjusted_bias <-
  dcant_inv_all_unadjusted %>%
  select(Version_ID_group, lon, lat, basin_AIP, period, dcant) %>%
  pivot_wider(names_from = Version_ID_group,
              values_from = dcant) %>%
  mutate(dcant_offset = `Bulk adjustment` - `No adjustment`,
         data_source = "Adjustment impact") %>%
  p_map_cant_inv(
    var = "dcant_offset",
    title_text = NULL,
    subtitle_text = NULL,
    col = "bias",
    legend_title = 
  ) +
  facet_grid(data_source ~ period) +
  theme(strip.text.x = element_blank(),
        strip.background.x = element_blank())

p_CI_unadjusted / p_CI_unadjusted_bias + 
  plot_annotation(tag_levels = 'A')

ggsave(path = here::here("output/publication"),
       filename = "FigS_dcant_column_inventory_unadjusted_data.png",
       height = 7,
       width = 8)

rm(p_CI_unadjusted, p_CI_unadjusted_bias)

```

## Beta

```{r beta_CI_maps, fig.asp=1.2}

dcant_inv_all %>%
  filter(data_source %in% c("obs")) %>% 
  p_map_cant_inv(var = "beta",
                 breaks = c(-Inf, seq(0, 1, 0.1), Inf),
                 title_text = NULL,
                 legend_title = beta_CI_label) +
  facet_grid(period ~ .)

ggsave(path = here::here("output/publication"),
       filename = "FigS_beta_column_inventory.png",
       height = 8,
       width = 6)

```



## Zonal means

```{r calc_zonal_mean_storage}

dcant_inv_all <- m_grid_horizontal_coarse(dcant_inv_all)

dcant_inv_all_lat_mean <- dcant_inv_all %>% 
  group_by(basin_AIP, period, lat_grid, data_source) %>% 
  summarise(beta = mean(beta, na.rm = TRUE),
            dcant = mean(dcant, na.rm = TRUE)) %>% 
  ungroup()

dcant_inv_all_ensemble <- m_grid_horizontal_coarse(dcant_inv_all_ensemble)

dcant_inv_all_ensemble_lat_mean <- dcant_inv_all_ensemble %>% 
  group_by(basin_AIP, period, lat_grid, Version_ID, data_source) %>% 
  summarise(beta_mean = mean(beta, na.rm = TRUE),
            dcant_mean = mean(dcant, na.rm = TRUE)) %>% 
  ungroup()

dcant_inv_all_ensemble_lat_mean_average <- dcant_inv_all_ensemble_lat_mean %>% 
  group_by(basin_AIP, period, lat_grid, data_source) %>% 
  summarise(beta_sd = sd(beta_mean, na.rm = TRUE),
            beta_mean = mean(beta_mean, na.rm = TRUE),
            dcant_sd = sd(dcant_mean, na.rm = TRUE),
            dcant_mean = mean(dcant_mean, na.rm = TRUE)) %>% 
  ungroup()

dcant_inv_all_lat_mean <- full_join(dcant_inv_all_lat_mean,
                                    dcant_inv_all_ensemble_lat_mean_average)


```


### dcant

```{r zonal_mean_storage_dcant}

dcant_inv_all_lat_mean %>%
  filter(period != "1800 - 1994") %>% 
  ggplot(aes(lat_grid, dcant, fill = period)) +
  geom_hline(yintercept = c(0,10)) +
  geom_vline(xintercept = c(-10,10)) +
  geom_vline(xintercept = c(-40,-30,30,40)) +
  geom_ribbon(aes(ymin = dcant - dcant_sd,
                  ymax = dcant + dcant_sd),
              alpha = 0.3) +
  geom_path(aes(col = period)) +
  geom_point(shape = 21) +
  scale_color_brewer(palette = "Dark2", name = "Mean ± SD") +
  scale_fill_brewer(palette = "Dark2", name = "Mean ± SD") +
  coord_flip() +
  facet_grid(data_source ~ basin_AIP) +
  labs(x = "Latitude (°N)",
       y = dcant_CI_label) +
  scale_x_continuous(breaks = seq(-75,75, 15))

dcant_inv_all_lat_mean %>%
  filter(period != "1800 - 1994") %>% 
  mutate(lat_grid = cut(lat_grid, c(-40,-30,-10,10,30,40))) %>% 
  group_by(lat_grid, data_source) %>% 
  summarise(dcant_mean = mean(dcant_mean, na_rm = TRUE)) %>% 
  ungroup()

dcant_inv_all_lat_mean %>%
  filter(period != "1800 - 1994") %>% 
  mutate(lat_grid = cut(lat_grid, c(-40,-30,-10,10,30,40))) %>% 
  group_by(lat_grid, basin_AIP, data_source) %>% 
  summarise(dcant_mean = mean(dcant_mean, na_rm = TRUE)) %>% 
  ungroup()

dcant_inv_all_lat_mean %>%
  filter(period != "1800 - 1994") %>% 
  mutate(lat_grid = cut(lat_grid, c(-90,0,90))) %>% 
  group_by(lat_grid, basin_AIP, period, data_source) %>% 
  summarise(dcant_mean = mean(dcant_mean, na_rm = TRUE)) %>% 
  ungroup()

dcant_inv_all_lat_mean %>%
  filter(period != "1800 - 1994") %>% 
  mutate(lat_grid = cut(lat_grid, c(-50,-20,20,50))) %>% 
  group_by(lat_grid, basin_AIP, period, data_source) %>% 
  summarise(dcant_mean = mean(dcant_mean, na_rm = TRUE)) %>% 
  ungroup() %>% 
  filter(data_source == "obs") %>% 
  arrange(basin_AIP)


dcant_inv_all_ensemble_lat_mean %>% 
  ggplot(aes(lat_grid, dcant_mean, fill=period, group=Version_ID)) +
  geom_hline(yintercept = 0) +
  geom_path(aes(col=period), alpha = 0.3) +
  scale_color_brewer(palette = "Dark2") +
  scale_fill_brewer(palette = "Dark2") +
  coord_flip() +
  facet_grid(data_source ~ basin_AIP) +
  labs(x = "Latitude (°N)",
       y = dcant_CI_label)

```


### beta

```{r zonal_mean_storage_beta}

dcant_inv_all_lat_mean %>%
  ggplot(aes(lat_grid, beta, fill = period)) +
  geom_hline(yintercept = 0) +
  geom_ribbon(aes(ymin = beta - beta_sd,
                  ymax = beta + beta_sd),
              alpha = 0.3) +
  geom_path(aes(col = period)) +
  geom_point(shape = 21) +
  scale_color_brewer(palette = "Dark2", name = "Mean ± SD") +
  scale_fill_brewer(palette = "Dark2", name = "Mean ± SD") +
  coord_flip() +
  facet_grid(data_source ~ basin_AIP) +
  labs(x = "Latitude (°N)",
       y = beta_CI_label) +
  scale_x_continuous(breaks = seq(-75,75, 15))

dcant_inv_all_ensemble_lat_mean %>% 
  ggplot(aes(lat_grid, beta_mean, fill=period, group=Version_ID)) +
  geom_hline(yintercept = 0) +
  geom_path(aes(col=period), alpha = 0.3) +
  scale_color_brewer(palette = "Dark2") +
  scale_fill_brewer(palette = "Dark2") +
  coord_flip() +
  facet_grid(data_source ~ basin_AIP) +
  labs(x = "Latitude (°N)",
       y = beta_CI_label)
```


# Global section

## Ensemble uncertainty

```{r global_section_absolute_delta_RSS_additive_uncertainty}

delta_dcant_global_section_all <-
  dcant_global_section_all %>%
  filter(data_source %in% c("obs", "mod"),
         period %in% two_decades) %>%
  select(data_source, dist, depth, period, dcant) %>%
  drop_na() %>% 
  pivot_wider(names_from = period,
              values_from = dcant) %>%
  mutate(dcant_offset = `2004 - 2014` - `1994 - 2004`,
         period = "(2004 - 2014) - (1994 - 2004)")

dcant_global_section_all_uncertainty <-
  dcant_global_section_all_ensemble %>%
  filter(data_source %in% c("obs", "mod"),
         period %in% two_decades) %>%
  select(dist,
         depth,
         period,
         data_source,
         MLR_basins,
         Version_ID_group,
         dcant) %>%
  mutate(dist_grid = as.numeric(as.character(cut(
    dist, seq(0, 50, 2), seq(1, 49, 2)
  ))),
  depth_grid = as.numeric(as.character(cut(
    depth,
    c(seq(0, 500, 100), seq(1000, 10000, 500)),
    c(seq(50, 450, 100), seq(750, 10000, 500)),
    right = FALSE
  )))) %>%
    group_by(dist_grid, depth_grid, data_source, period, MLR_basins, Version_ID_group) %>% 
  summarise(dcant = mean(dcant),
            n = n()) %>% 
  ungroup() %>% 
  rename(dist = dist_grid,
         depth = depth_grid)

# df <- dcant_global_section_all_uncertainty

dcant_global_section_all_uncertainty <-
  additive_uncertainty(dcant_global_section_all_uncertainty)

delta_dcant_global_section_all_uncertainty <- dcant_global_section_all_uncertainty[[3]]
dcant_global_section_all_uncertainty_contributions <- dcant_global_section_all_uncertainty[[2]]
dcant_global_section_all_uncertainty <- dcant_global_section_all_uncertainty[[1]]

dcant_global_section_all_uncertainty <-
  dcant_global_section_all_uncertainty %>%
  mutate(band = "dummy")


dcant_global_section_all_uncertainty  %>% 
  filter(data_source == "obs",
         period == "1994 - 2004") %>% 
  p_section_global(
    var = "std_case",
    plot_slabs = "n",
    title_text = NULL,
    subtitle_text = NULL,
    col = "div"
  )

dcant_global_section_all_uncertainty  %>% 
  filter(data_source == "obs",
         period == "1994 - 2004") %>% 
  p_section_global(
    var = "sd",
    plot_slabs = "n",
    title_text = NULL,
    subtitle_text = NULL,
    col = "div"
  )

# dcant_global_section_all_uncertainty  %>%
#   filter(data_source == "obs",
#          period == "1994 - 2004") %>%
#   rename(delta_dcant = dcant_sign) %>%
#   p_section_global(
#     var = "delta_dcant",
#     plot_slabs = "n",
#     title_text = NULL,
#     subtitle_text = NULL,
#     col = "div"
#   )

ggplot() +
  geom_point(
    data = dcant_global_section_all_uncertainty %>%
      filter(signif == 0),
    aes(dist, depth),
    shape = 4
  ) +
  facet_grid(data_source~period) +
  scale_y_reverse()

delta_dcant_global_section_all_uncertainty <-
  delta_dcant_global_section_all_uncertainty %>%
  mutate(band = "dummy")

delta_dcant_global_section_all_uncertainty  %>% 
  filter(data_source == "obs") %>% 
  p_section_global(
    var = "delta_dcant",
    plot_slabs = "n",
    title_text = NULL,
    subtitle_text = NULL,
    col = "div"
  )

delta_dcant_global_section_all_uncertainty  %>% 
  filter(data_source == "obs") %>% 
  select(-delta_dcant) %>% 
  rename(delta_dcant = RSS) %>% 
  p_section_global(
    var = "delta_dcant",
    plot_slabs = "n",
    title_text = NULL,
    subtitle_text = NULL,
    col = "div"
  )

ggplot() +
  geom_point(
    data = delta_dcant_global_section_all_uncertainty %>%
      filter(signif == 0),
    aes(dist, depth),
    shape = 4
  ) +
  scale_y_reverse() +
  facet_grid(data_source~.)

# delta_dcant_global_section_all_uncertainty <-
#   delta_dcant_global_section_all_uncertainty %>%
#   filter(signif == 0)

```

```{r global_section_absolute_delta_RSS, eval=FALSE}

delta_dcant_global_section_all <-
  dcant_global_section_all %>%
  filter(data_source %in% c("obs", "mod"),
         period %in% two_decades) %>%
  select(data_source, dist, depth, period, dcant) %>%
  drop_na() %>% 
  pivot_wider(names_from = period,
              values_from = dcant) %>%
  mutate(dcant_offset = `2004 - 2014` - `1994 - 2004`,
         period = "(2004 - 2014) - (1994 - 2004)")

dcant_global_section_all_ensemble_sd <-
  dcant_global_section_all_ensemble %>%
  filter(period %in% two_decades,
         data_source != "mod_truth") %>%
  group_by(data_source, period, dist, depth) %>%
  summarise(dcant_sd = sd(dcant) * sd_factor) %>%
  ungroup()


dcant_global_section_all_uncertainty <-
  left_join(
    dcant_global_section_all %>% select(data_source, period, dist, depth, dcant),
    dcant_global_section_all_ensemble_sd %>% select(data_source, period, dist, depth, dcant_sd)
  )

dcant_global_section_all_uncertainty <-
  dcant_global_section_all_uncertainty %>%
  mutate(dist_grid = as.numeric(as.character(cut(
    dist, seq(0, 50, 2), seq(1, 49, 2)
  ))),
  depth_grid = as.numeric(as.character(cut(
    depth,
    c(seq(0, 500, 100), seq(1000, 10000, 500)),
    c(seq(50, 450, 100), seq(750, 10000, 500)),
    right = FALSE
  ))))


dcant_global_section_all_uncertainty <-
  dcant_global_section_all_uncertainty %>%
  group_by(dist_grid, period, depth_grid, data_source) %>% 
  summarise(dcant = mean(dcant),
            dcant_sd = mean(dcant_sd),
            n = n()) %>% 
  ungroup() %>% 
  rename(dist = dist_grid,
         depth = depth_grid) %>%
  mutate(dcant_sign = abs(dcant) - dcant_sd,
         band = "dummy")


dcant_global_section_all_uncertainty  %>% 
  filter(data_source == "obs",
         period == "1994 - 2004") %>% 
  p_section_global(
    var = "dcant",
    plot_slabs = "n",
    title_text = NULL,
    subtitle_text = NULL,
    col = "div"
  )

dcant_global_section_all_uncertainty  %>% 
  filter(data_source == "obs",
         period == "1994 - 2004") %>% 
  p_section_global(
    var = "dcant_sd",
    plot_slabs = "n",
    title_text = NULL,
    subtitle_text = NULL,
    col = "div"
  )

dcant_global_section_all_uncertainty  %>%
  filter(data_source == "obs",
         period == "1994 - 2004") %>%
  rename(delta_dcant = dcant_sign) %>%
  p_section_global(
    var = "delta_dcant",
    plot_slabs = "n",
    title_text = NULL,
    subtitle_text = NULL,
    col = "div"
  )

ggplot() +
  geom_point(
    data = dcant_global_section_all_uncertainty %>%
      filter(signif == 0),
    aes(dist, depth),
    shape = 4
  ) +
  facet_grid(data_source~period) +
  scale_y_reverse()

dcant_global_section_all_uncertainty <-
  dcant_global_section_all_uncertainty %>%
  filter(signif == 0)


delta_dcant_global_section_all_ensemble_RSS <-
  dcant_global_section_all_ensemble_sd %>%
  arrange(period) %>%
  group_by(data_source, dist, depth) %>%
  mutate(RSS = sqrt(dcant_sd ^ 2 + lag(dcant_sd ^ 2))) %>%
  ungroup() %>%
  drop_na()

delta_dcant_global_section_all_uncertainty <-
  left_join(
    delta_dcant_global_section_all %>% select(data_source, dist, depth, dcant_offset),
    delta_dcant_global_section_all_ensemble_RSS %>% select(data_source, dist, depth, RSS)
  )

delta_dcant_global_section_all_uncertainty <-
  delta_dcant_global_section_all_uncertainty %>%
  mutate(dist_grid = as.numeric(as.character(cut(
    dist, seq(0, 50, 2), seq(1, 49, 2)
  ))),
  depth_grid = as.numeric(as.character(cut(
    depth,
    c(seq(0, 500, 100), seq(1000, 10000, 500)),
    c(seq(50, 450, 100), seq(750, 10000, 500)),
    right = FALSE
  ))))

delta_dcant_global_section_all_uncertainty <-
  delta_dcant_global_section_all_uncertainty %>%
  group_by(dist_grid, depth_grid, data_source) %>% 
  summarise(dcant_offset = mean(dcant_offset),
            RSS = mean(RSS),
            n = n()) %>% 
  ungroup() %>% 
  rename(dist = dist_grid,
         depth = depth_grid) %>%
  mutate(dcant_offset_sign = abs(dcant_offset) - RSS,
         band = "dummy")


delta_dcant_global_section_all_uncertainty  %>% 
  mutate(dcant_offset = dcant_offset) %>% 
  filter(data_source == "obs") %>% 
  rename(delta_dcant = dcant_offset) %>% 
  p_section_global(
    var = "delta_dcant",
    plot_slabs = "n",
    title_text = NULL,
    subtitle_text = NULL,
    col = "div"
  )

delta_dcant_global_section_all_uncertainty  %>% 
  filter(data_source == "obs") %>% 
  rename(delta_dcant = RSS) %>% 
  p_section_global(
    var = "delta_dcant",
    plot_slabs = "n",
    title_text = NULL,
    subtitle_text = NULL,
    col = "div"
  )

delta_dcant_global_section_all_uncertainty  %>%
  filter(data_source == "obs") %>%
  rename(delta_dcant = dcant_offset_sign) %>%
  p_section_global(
    var = "delta_dcant",
    plot_slabs = "n",
    title_text = NULL,
    subtitle_text = NULL,
    col = "div"
  )

ggplot() +
  geom_point(
    data = delta_dcant_global_section_all_uncertainty %>%
      filter(signif == 0),
    aes(dist, depth),
    shape = 4
  ) +
  scale_y_reverse() +
  facet_grid(data_source~.)

delta_dcant_global_section_all_uncertainty <-
  delta_dcant_global_section_all_uncertainty %>%
  filter(signif == 0)

```


## Observations

```{r global_sections_obs, fig.asp=1}

p_dcant_global_section_dec1 <-
  dcant_global_section_all %>%
  filter(data_source == "obs",
         period %in% "1994 - 2004") %>%
  p_section_global(var = "dcant",
                   title_text = "1994 - 2004",
                   df_uncertainty = dcant_global_section_all_uncertainty %>% 
                     filter(period %in% "1994 - 2004",
                            data_source == "obs",
                            signif == 0),
                   col_uncertainty = "grey",
                   subtitle_text = NULL,
                   plot_slabs = "n",
                   contour_level = 5) +
  theme(
    axis.title.x = element_blank(),
    axis.text.x.bottom = element_blank()
  )


p_dcant_global_section_dec2 <-
  dcant_global_section_all %>%
  filter(data_source == "obs",
         period %in% "2004 - 2014") %>%
  p_section_global(
    var = "dcant",
    title_text = NULL,
    subtitle_text = NULL,
    plot_slabs = "n",
    contour_level = 5,
    df_uncertainty = dcant_global_section_all_uncertainty %>%
      filter(period %in% "2004 - 2014",
             data_source == "obs",
             signif == 0),
    col_uncertainty = "grey"
  ) &
  theme(legend.position = "none")

p_dcant_global_section_offset <-
  dcant_global_section_all %>%
  filter(data_source == "obs",
         period %in% two_decades) %>%
  arrange(depth, dist) %>%
  select(depth, dist, dcant, period, gamma_mean) %>%
  drop_na() %>%
  pivot_wider(names_from = period,
              values_from = dcant) %>%
  mutate(delta_dcant = `2004 - 2014` - `1994 - 2004`) %>%
  p_section_global(
    var = "delta_dcant",
    df_uncertainty = delta_dcant_global_section_all_uncertainty %>%
      filter(data_source == "obs",
             signif == 0),
    plot_slabs = "y",
    col = "div",
    title_text = NULL,
    subtitle_text = NULL
  )



wrap_plots(
  p_dcant_global_section_dec1,
  p_dcant_global_section_dec2 &
    theme(axis.title.x = element_blank(),
          axis.text.x = element_blank()),
  p_dcant_global_section_offset &
    theme(axis.title.x.top = element_blank(),
          axis.text.x.top = element_blank()),
  ncol = 1
)


ggsave(path = here::here("output/publication"),
       filename = "Fig_dcant_global_section.png",
       height = 10,
       width = 8)

ggsave(path = here::here("output/presentation"),
       filename = "Fig_dcant_global_section.png",
       height = 9,
       width = 10)

rm(p_dcant_global_section_dec1, p_dcant_global_section_dec2,
   p_dcant_global_section_offset)

```

## Synthetic data

```{r global_sections_mod, fig.asp=1}

p_dcant_global_section_dec1 <-
  dcant_global_section_all %>%
  filter(data_source == "mod",
         period %in% "1994 - 2004") %>%
  p_section_global(var = "dcant",
                   title_text = "1994 - 2004",
                   df_uncertainty = dcant_global_section_all_uncertainty %>% 
                     filter(period %in% "1994 - 2004",
                            data_source == "mod",
                            signif == 0),
                   col_uncertainty = "grey",
                   subtitle_text = NULL,
                   plot_slabs = "n",
                   contour_level = 5) +
  theme(
    axis.title.x = element_blank(),
    axis.text.x.bottom = element_blank()
  )


p_dcant_global_section_dec2 <-
  dcant_global_section_all %>%
  filter(data_source == "mod",
         period %in% "2004 - 2014") %>%
  p_section_global(
    var = "dcant",
    title_text = NULL,
    subtitle_text = NULL,
    plot_slabs = "n",
    contour_level = 5,
    df_uncertainty = dcant_global_section_all_uncertainty %>%
      filter(period %in% "2004 - 2014",
                            data_source == "mod",
                            signif == 0),
    col_uncertainty = "grey"
  ) &
  theme(
    legend.position = "none"
  )

p_dcant_global_section_offset <-
  dcant_global_section_all %>%
  filter(data_source == "mod",
         period %in% two_decades) %>%
  arrange(depth, dist) %>%
  select(depth, dist, dcant, period, gamma_mean) %>%
  drop_na() %>%
  group_by(depth, dist) %>% 
  mutate(gamma_mean = mean(gamma_mean)) %>% 
  ungroup() %>% 
  pivot_wider(names_from = period,
              values_from = dcant) %>%
  mutate(delta_dcant = `2004 - 2014` - `1994 - 2004`) %>%
  p_section_global(
    var = "delta_dcant",
    df_uncertainty = delta_dcant_global_section_all_uncertainty %>%
      filter(data_source == "mod",
                            signif == 0),
    col = "div",
    plot_slabs = "y",
    title_text = NULL,
    subtitle_text = NULL
  )



wrap_plots(
  p_dcant_global_section_dec1,
  p_dcant_global_section_dec2 &
    theme(axis.title.x = element_blank(),
          axis.text.x = element_blank()),
  p_dcant_global_section_offset &
    theme(axis.title.x.top = element_blank(),
          axis.text.x.top = element_blank()),
  ncol = 1
)


ggsave(path = here::here("output/publication"),
       filename = "FigS_dcant_global_section_synthetic_data.png",
       height = 10,
       width = 8)

rm(p_dcant_global_section_dec1, p_dcant_global_section_dec2,
   p_dcant_global_section_offset)

```


# Zonal sections

## dcant - absolut

```{r zonal_sections}


p_dcant_zonal_absolute <-
  dcant_zonal_all %>%
  filter(
    data_source == "obs",
    period %in% two_decades,
    depth <= params_global$inventory_depth_standard
  ) %>%
  p_section_zonal_continous_depth(var = "dcant",
                                  plot_slabs = "n",
                                  title_text = NULL) +
  geom_contour(aes(lat, depth, z = dcant),
               breaks = 5,
               col = "white") +
  # geom_text_contour(
  #   aes(lat, depth, z = dcant),
  #   breaks = 5,
  #   stroke = 0.2,
  #   stroke.colour = "white",
  #   rotate = FALSE,
  #   label.placer = label_placer_n(n = 1)
  # ) +
  facet_grid(period ~ basin_AIP) +
  theme(
    axis.text.x = element_blank(),
    axis.title.x = element_blank(),
    legend.position = "top"
  ) +
  guides(fill = guide_colorsteps(
    barheight = unit(0.5, "cm"),
    barwidth = unit(7, "cm"),
    show.limits = FALSE
  ))

p_dcant_zonal_absolute


```

```{r zonal_sections_basin, eval=FALSE}

dcant_zonal_all %>%
  filter(
    data_source == "obs",
    period != "1994 - 2014",
    depth <= params_global$inventory_depth_standard
  ) %>%
  group_split(basin_AIP) %>%
  # head(1) %>%
  map(
    ~ p_section_zonal_continous_depth(
      df = .x,
      var = "dcant",
      breaks = c(-Inf, -1, 0, 1, seq(2,16,2), Inf),
      plot_slabs = "n",
      title_text = .x$basin_AIP,
      subtitle_text = NULL
    ) +
      facet_grid(period ~ .)
  )


```

## dcant - absolute delta

```{r inventory_maps_absolute_delta_zonal}

dcant_zonal_all %>%
  filter(data_source %in% c("mod", "obs"),
         period != "1994 - 2014") %>%
  select(data_source, lat, depth, basin_AIP, period, dcant) %>%
  pivot_wider(names_from = period,
              values_from = dcant) %>%
  mutate(delta_dcant = `2004 - 2014` - `1994 - 2004`) %>%
  group_by(data_source) %>%
  group_split() %>%
  # head(1) %>%
  map(
    ~ p_section_zonal_continous_depth(
      df = .x,
      var = "delta_dcant",
      plot_slabs = "n",
      subtitle_text = unique(.x$data_source),
      col = "bias"
    ) +
      facet_grid(basin_AIP ~ .)
  )

p_dcant_zonal_delta <-
  dcant_zonal_all %>%
  filter(data_source %in% c("obs"),
         period != "1994 - 2014") %>%
  select(data_source, lat, depth, basin_AIP, period, gamma_mean, dcant) %>%
  pivot_wider(names_from = period,
              values_from = dcant) %>%
  mutate(delta_dcant = `2004 - 2014` - `1994 - 2004`) %>%
  group_by(data_source) %>%
  group_split() %>%
  # head(1) %>%
  map(
    ~ p_section_zonal_continous_depth(
      df = .x,
      var = "delta_dcant",
      plot_slabs = "y",
      drop_slabs = 1,
      subtitle_text = NULL,
      title_text = NULL,
      col = "bias"
    ) +
      facet_grid("Dec. diff." ~ basin_AIP) +
      theme(
        strip.text.x = element_blank(),
        strip.background.x = element_blank(),
        legend.position = "bottom"
      ) +
      guides(fill = guide_colorsteps(
        barheight = unit(0.5, "cm"),
        barwidth = unit(10, "cm"),
        show.limits = FALSE
      ))
  )

p_dcant_zonal_absolute / p_dcant_zonal_delta + 
  plot_layout(heights = c(2,1)) +
  plot_annotation(tag_levels = 'A')

ggsave(path = here::here("output/publication"),
       filename = "FigS_dcant_zonal_mean_section.png",
       height = 6,
       width = 8)

rm(p_dcant_zonal_absolute, p_dcant_zonal_delta)
```

## Bias


```{r zonal_sections_mod}

p_dcant_zonal_absolute_mod <-
  dcant_zonal_all %>%
  filter(
    data_source != "obs",
    period %in% two_decades,
    depth <= params_global$inventory_depth_standard
  ) %>%
    mutate(data_source = case_when(
    data_source == "mod" ~ "Reconstruction",
    data_source == "mod_truth" ~ "Model truth"
  )) %>%  
  p_section_zonal_continous_depth(var = "dcant",
                                  plot_slabs = "n",
                                  title_text = NULL) +
  geom_contour(aes(lat, depth, z = dcant),
               breaks = 5,
               col = "white") +
  facet_nested(data_source+period ~ basin_AIP) +
  theme(
    axis.text.x = element_blank(),
    axis.title.x = element_blank(),
    legend.position = "top"
  ) +
  guides(fill = guide_colorsteps(
    barheight = unit(0.5, "cm"),
    barwidth = unit(7, "cm"),
    show.limits = FALSE
  ))

p_dcant_zonal_absolute_mod


```


```{r inventory_maps_absolute_bias}

p_dcant_zonal_bias <-
  dcant_zonal_all %>%
  filter(data_source != "obs",
         period %in% two_decades) %>%
  select(data_source, lat, depth, basin_AIP, period, dcant) %>%
  pivot_wider(names_from = data_source,
              values_from = dcant) %>%
  mutate(dcant_bias = mod - mod_truth) %>%
  p_section_zonal_continous_depth(
    var = "dcant_bias",
    plot_slabs = "n",
    drop_slabs = 1,
    subtitle_text = NULL,
    title_text = NULL,
    col = "bias"
  ) +
  facet_grid(period ~ basin_AIP) +
  theme(
    strip.text.x = element_blank(),
    strip.background.x = element_blank(),
    legend.position = "bottom"
  ) +
  guides(fill = guide_colorsteps(
    barheight = unit(0.5, "cm"),
    barwidth = unit(10, "cm"),
    show.limits = FALSE
  ))

p_dcant_zonal_absolute_mod / p_dcant_zonal_bias + 
  plot_layout(heights = c(2,1)) +
  plot_annotation(tag_levels = 'A')


ggsave(
  path = here::here("output/publication"),
  filename = "FigS_dcant_zonal_mean_section_synthetic_data.png",
  height = 9,
  width = 8
)

rm(p_dcant_zonal_absolute_mod, 
   p_dcant_zonal_bias)

```


# Penetration depth

```{r penetration_depth, fig.asp=1}

dcant_penetration_depth_all_lat_mean_all_ensemble %>%
  filter(dcant_lim == 5,
         period %in% two_decades,
         data_source != "obs") %>%
  mutate(
    data_source = case_when(
      data_source == "mod" ~ "Reconstruction\nensemble",
      data_source == "mod_truth" ~ "Model truth"
    ),
    data_source = fct_reorder(data_source, desc(data_source))
  ) %>%
  ggplot(aes(
    lat,
    depth_mean,
    group = interaction(MLR_basins, Version_ID_group, data_source)
  )) +
  geom_path(aes(col = data_source)) +
  geom_path(
    data = dcant_penetration_depth_all_lat_mean_all %>%
      filter(dcant_lim == 5,
             period %in% two_decades,
             data_source == "mod") %>%
      mutate(
        data_source = case_when(data_source == "mod" ~ "Standard case"),
        data_source = fct_reorder(data_source, desc(data_source))
      ),
    aes(lat,
        depth_mean,
        col = data_source)
  ) +
  scale_colour_manual(values = c("red", "grey", "black")) +
  labs(y = "Depth (m)",
       x = "Latitude (°N)") +
  theme(legend.title = element_blank()) +
  scale_y_reverse() +
  facet_grid(basin_AIP ~ period, scales = "free_x") +
  coord_cartesian(ylim = c(1500,0))

ggsave(
  path = here::here("output/publication"),
  filename = "FigS_dcant_penetration_depth_synthetic_data.png",
  height = 9,
  width = 8
)


dcant_penetration_depth_all_lat_mean_all_ensemble %>%
  filter(dcant_lim == 5,
         period %in% two_decades,
         data_source == "mod") %>%
  mutate(
    data_source = case_when(
      data_source == "mod" ~ "Reconstruction\nensemble",
      data_source == "mod_truth" ~ "Model truth"
    ),
    data_source = fct_reorder(data_source, desc(data_source))
  ) %>%
  ggplot(aes(
    lat,
    depth_mean,
    group = interaction(MLR_basins, Version_ID_group, data_source)
  )) +
  geom_path(aes(col = MLR_basins)) +
  geom_path(
    data = dcant_penetration_depth_all_lat_mean_all_ensemble %>%
      filter(
        dcant_lim == 5,
        period %in% two_decades,
        data_source == "mod_truth"
      ),
    aes(
      lat,
      depth_mean,
      group = interaction(MLR_basins, Version_ID_group, data_source)
    ),
    col = "black"
  ) +
  scale_color_vibrant() +
  labs(y = "Depth (m)",
       x = "Latitude (°N)") +
  theme(legend.title = element_blank()) +
  scale_y_reverse() +
  facet_grid(basin_AIP ~ period, scales = "free_x") +
  coord_cartesian(ylim = c(1500, 0))

ggsave(
  path = here::here("output/publication"),
  filename = "FigS_dcant_penetration_depth_synthetic_data_MLR_basins.png",
  height = 9,
  width = 8
)


dcant_penetration_depth_all_lat_mean_all_ensemble %>%
  filter(dcant_lim == 5,
         period %in% two_decades,
         data_source != "mod_truth") %>%
  mutate(
    data_source = case_when(
      data_source == "mod" ~ "Synthetic data",
      data_source == "obs" ~ "Observations"
    ),
    data_source = fct_reorder(data_source, desc(data_source))
  ) %>%
  ggplot(aes(
    lat,
    depth_mean,
    group = interaction(MLR_basins, Version_ID_group, data_source)
  )) +
  geom_path(aes(col = data_source)) +
  scale_colour_highcontrast() +
  labs(y = "Depth (m)",
       x = "Latitude (°N)") +
  theme(legend.title = element_blank()) +
  scale_y_reverse() +
  facet_grid(basin_AIP ~ period, scales = "free_x") +
  coord_cartesian(ylim = c(1500,0))

ggsave(
  path = here::here("output/publication"),
  filename = "FigS_dcant_penetration_depth_synthetic_data_vs_observations.png",
  height = 9,
  width = 8
)

dcant_penetration_depth_all_lat_mean_all_ensemble %>%
  filter(dcant_lim == 5,
         period %in% two_decades,
         data_source == "obs") %>%
  mutate(
    data_source = case_when(
      data_source == "obs" ~ "Observations"
    ),
    data_source = fct_reorder(data_source, desc(data_source))
  ) %>%
  ggplot(aes(
    lat,
    depth_mean,
    group = interaction(MLR_basins, Version_ID_group, data_source)
  )) +
  geom_path(aes(col = MLR_basins)) +
  scale_color_vibrant() +
  labs(y = "Depth (m)",
       x = "Latitude (°N)") +
  theme(legend.title = element_blank()) +
  scale_y_reverse() +
  facet_grid(basin_AIP ~ period, scales = "free_x") +
  coord_cartesian(ylim = c(1500,0))


```


# Concentration profiles

## dCant, absolute

### Standard case

```{r concentration_profiles_MLR_basins, fig.asp=0.9}

dcant_profile_basin_MLR_all %>%
  arrange(depth) %>%
  filter(period != "1994 - 2014",
         depth <= params_global$inventory_depth_standard) %>%
  group_split(data_source) %>%
  # head(1) %>%
  map(
    ~ ggplot(data = .x,
             aes(dcant,
                 depth)) +
      geom_hline(yintercept = params_global$inventory_depth_standard) +
      geom_vline(xintercept = 0) +
      geom_ribbon(
        aes(
          xmin = dcant - dcant_sd,
          xmax = dcant + dcant_sd,
          fill = period
        ),
        alpha = 0.3
      ) +
      geom_path(aes(col = period)) +
      scale_y_continuous(trans = trans_reverser("sqrt"),
                         breaks = c(0, 100, 500, seq(1500, 5000, 1000))) +
      coord_cartesian(expand = 0) +
      scale_color_brewer(
        palette = "Set1",
        name = "mean \u00B1 regional SD",
        direction = -1
      ) +
      scale_fill_brewer(
        palette = "Set1",
        name = "mean \u00B1 regional SD",
        direction = -1
      ) +
      labs(
        title = paste("data_source", unique(.x$data_source)),
        y = "Depth (m)",
        x = dcant_umol_label
      ) +
      facet_wrap( ~ basin, ncol = 3, dir = "v") +
      theme(legend.position = c(0.8, 0.2))
  )


```

### Ensemble members

```{r concentration_profiles_MLR_basins_ensemble_individual, fig.asp=0.9}

dcant_profile_basin_MLR_all_ensemble %>%
  arrange(depth) %>%
  filter(
    period != "1994 - 2014",
    depth <= params_global$inventory_depth_standard,
    data_source == "obs"
  ) %>%
  group_split(data_source) %>%
  map(
    ~ ggplot() +
      geom_hline(yintercept = params_global$inventory_depth_standard) +
      geom_vline(xintercept = 0) +
      geom_path(
        data = .x,
        aes(
          dcant,
          depth,
          col = period,
          group = Version_ID,
          linetype = "Ensemble member",
          size = "Ensemble member",
          alpha = "Ensemble member"
        )
      ) +
      geom_path(
        data = .x %>% filter(Version_ID %in% Version_IDs),
        aes(
          dcant,
          depth,
          col = period,
          group = Version_ID,
          linetype = "Standard case",
          alpha = "Standard case",
          size = "Standard case"
        )
      ) +
      geom_path(
        data = .x %>% filter(Version_ID %in% Version_IDs),
        aes(
          dcant,
          depth,
          group = Version_ID
        )
      ) +
      scale_size_manual(values = c(0.7, 1.5), name=" ") +
      scale_linetype_manual(values = c(1, 1), name=" ") +
      scale_alpha_manual(values = c(0.4, 1), name=" ") +
      scale_y_continuous(trans = trans_reverser("sqrt"),
                         breaks = c(0, 100, 500, seq(1500, 5000, 1000))) +
      coord_cartesian(expand = 0) +
      scale_color_brewer(
        palette = "Set1",
        direction = -1
      ) +
      scale_fill_brewer(
        palette = "Set1",
        direction = -1
      ) +
      labs(
        # title = paste("data_source", unique(.x$data_source)),
        y = "Depth (m)",
        x = dcant_umol_label
      ) +
      facet_wrap( ~ basin, ncol = 3, dir = "v") +
      theme(legend.position = "top")
  )



```

### Surface dCant

```{r surface_dcant}

mean_surface_dcant <- dcant_profile_basin_MLR_all %>%
  arrange(depth) %>%
  filter(depth <= 50) %>%
  group_by(basin, period, data_source) %>% 
  summarise(mean_surface_dcant = mean(dcant)) %>% 
  ungroup()

full_join(dcant_profile_basin_MLR_all_ensemble %>%
            filter(depth <= 50),
          mean_surface_dcant) %>%
  group_by(basin, period, data_source) %>%
  summarise(
    mean_surface_dcant = mean(mean_surface_dcant, na.rm = TRUE),
    sd_surface_dcant = sd(dcant) * sd_factor
  ) %>%
  ungroup() %>%
  kable() %>%
  kable_styling() %>%
  scroll_box(height = "300px")

```

### Penetration depth

```{r penetration_depth_profiles}

full_join(dcant_profile_basin_MLR_all_ensemble,
          mean_surface_dcant) %>%
  arrange(depth) %>%
  filter(dcant >= mean_surface_dcant / 2) %>%
  group_by(period, basin, Version_ID, data_source) %>%
  summarise(max_depth = max(depth)) %>%
  ungroup() %>%
  group_by(basin, period, data_source) %>%
  summarise(sd_max_depth = sd(max_depth) * 2,
            mean_max_depth = mean(max_depth)) %>%
  ungroup() %>%
  kable() %>%
  kable_styling() %>%
  scroll_box(height = "300px")

rm(mean_surface_dcant)
```

### Uncertainty range

```{r concentration_profiles_MLR_basins_ensemble_uncertainty_ribbon_additive, fig.asp=0.9}

# dcant_profile_basin_MLR_all_ensemble %>% distinct(data_source)

dcant_profile_basin_MLR_all_uncertainty <- dcant_profile_basin_MLR_all_ensemble %>%
  select(-c(dcant_sd, Version_ID, tref1, tref2)) %>% 
  filter(period %in% two_decades)

dcant_profile_basin_MLR_all_uncertainty <- additive_uncertainty(dcant_profile_basin_MLR_all_uncertainty)

delta_dcant_profile_basin_MLR_all_uncertainty <- dcant_profile_basin_MLR_all_uncertainty[[3]]
dcant_profile_basin_MLR_all_uncertainty_contributions <- dcant_profile_basin_MLR_all_uncertainty[[2]]
dcant_profile_basin_MLR_all_uncertainty <- dcant_profile_basin_MLR_all_uncertainty[[1]]


p_dcant_profiles <-
  dcant_profile_basin_MLR_all_uncertainty %>%
  arrange(depth) %>%
  filter(
    depth <= params_global$inventory_depth_standard,
    data_source == "obs"
  ) %>%
  ggplot() +
  geom_vline(xintercept = 0, size = 0.1) +
  geom_ribbon(
    aes(
      xmin = std_case - sd*sd_factor,
      xmax = std_case + sd*sd_factor,
      y = depth,
      fill = period
    ),
    alpha = 0.5
  ) +
  geom_path(
    aes(std_case,
        depth,
        col = period)
  ) +
  scale_y_reverse(breaks = seq(0,3000,500))+
  # scale_y_continuous(
  #   trans = trans_reverser("sqrt"),
  #   breaks = c(0, 100, 500, seq(1000, 5000, 1000)))+
  coord_cartesian(expand = 0, xlim = c(-2,14)) +
  scale_color_manual(values = c("#EE7733", "#009988"), name = "Mean \u00B1 2σ") +
  scale_fill_manual(values = c("#EE7733", "#009988"), name = "Mean \u00B1 2σ") +
  labs(y = "Depth (m)",
       x = dcant_umol_label) +
  facet_wrap(~ basin, ncol = 3, dir = "v") +
  theme(legend.position = c(0.9, 0.1))

p_dcant_profiles

```

```{r concentration_profiles_MLR_basins_ensemble_uncertainty_ribbon, fig.asp=0.9, eval=FALSE}

dcant_profile_basin_MLR_range <- dcant_profile_basin_MLR_all_ensemble %>%
  group_by(basin, depth, period, data_source) %>% 
  summarise(dcant_sd = sd(dcant)*sd_factor) %>%
  ungroup()

dcant_profile_basin_MLR_all_ensemble <-
full_join(dcant_profile_basin_MLR_all_ensemble %>% select(-dcant_sd),
          dcant_profile_basin_MLR_range)

p_dcant_profiles <-
  dcant_profile_basin_MLR_all_ensemble %>%
  arrange(depth) %>%
  filter(
    period != "1994 - 2014",
    depth <= params_global$inventory_depth_standard,
    data_source == "obs",
    Version_ID %in% Version_IDs
  ) %>%
  ggplot() +
  geom_vline(xintercept = 0, size = 0.1) +
  geom_hline(yintercept = 1000, size = 0.1) +
  geom_ribbon(
    aes(
      xmin = dcant - dcant_sd,
      xmax = dcant + dcant_sd,
      y = depth,
      fill = period,
      group = Version_ID
    ),
    alpha = 0.5
  ) +
  geom_path(
    aes(dcant,
        depth,
        col = period,
        group = Version_ID,)
  ) +
  scale_y_continuous(trans = trans_reverser("sqrt"),
                     breaks = c(0, 100, 500, seq(1000, 5000, 1000))) +
  coord_cartesian(expand = 0) +
  scale_color_manual(values = c("#EE7733", "#009988"), name = "Mean \u00B1 2σ") +
  scale_fill_manual(values = c("#EE7733", "#009988"), name = "Mean \u00B1 2σ") +
  labs(y = "Depth (m)",
       x = dcant_umol_label) +
  facet_wrap(~ basin, ncol = 3, dir = "v") +
  theme(legend.position = c(0.9, 0.1))

p_dcant_profiles

```

```{r concentration_profiles_MLR_basins_ensemble_uncertainty_ribbon_mod, fig.asp=0.9}

p_dcant_profiles_mod <-
  dcant_profile_basin_MLR_all_uncertainty %>%
  arrange(depth) %>%
  filter(
    depth <= params_global$inventory_depth_standard,
    data_source != "obs"
  ) %>%
    mutate(data_source = case_when(
    data_source == "mod" ~ "Reconstruction",
    data_source == "mod_truth" ~ "Model truth"
  )) %>%  
  ggplot() +
  geom_vline(xintercept = 0, size = 0.1) +
  # geom_hline(yintercept = 1000, size = 0.1) +
  geom_ribbon(
    aes(
      xmin = std_case - sd*sd_factor,
      xmax = std_case + sd*sd_factor,
      y = depth,
      fill = data_source
    ),
    alpha = 0.5
  ) +
  geom_path(
    aes(std_case,
        depth,
        col = data_source)
  ) +
  scale_y_reverse(breaks = seq(0,3000,500)) +
  # scale_y_continuous(trans = trans_reverser("sqrt"),
  #                    breaks = c(0, 100, 500, seq(1000, 5000, 1000))) +
  coord_cartesian(expand = 0, xlim = c(-2,14)) +
  scale_color_manual(values = c("#009988", "#EE7733"), name = "Mean \u00B1 2σ") +
  scale_fill_manual(values = c("#009988", "#EE7733"), name = "Mean \u00B1 2σ") +
  labs(y = "Depth (m)",
       x = dcant_umol_label) +
  facet_grid(period ~ basin) +
  theme(legend.position = "top")

p_dcant_profiles_mod

```




```{r concentration_profiles_MLR_basins_ensemble_basin_separation, fig.asp=0.9}


dcant_profile_basin_MLR_all_ensemble %>%
  arrange(depth) %>%
  filter(
    period != "1994 - 2014",
    depth <= params_global$inventory_depth_standard,
    data_source == "obs"
  ) %>%
  group_split(data_source) %>%
  map(
    ~ ggplot() +
      geom_hline(yintercept = params_global$inventory_depth_standard) +
      geom_vline(xintercept = 0) +
      geom_path(
        data = .x,
        aes(dcant,
            depth,
            col = MLR_basins,
            group = Version_ID)
      ) +
      scale_size_manual(values = c(0.5, 2), name = "x") +
      scale_linetype_manual(values = c(2, 1), name = "x") +
      scale_y_continuous(trans = trans_reverser("sqrt"),
                         breaks = c(0, 100, 500, seq(1500, 5000, 1000))) +
      coord_cartesian(expand = 0) +
      scale_color_brewer(palette = "Dark2", name = "regional\nclustering") +
      labs(y = "Depth (m)",
           x = dcant_umol_label) +
      facet_grid(basin ~ period)
  )


```

```{r concentration_profiles_MLR_basins_ensemble_member, fig.asp=1.5}

dcant_profile_basin_MLR_all_ensemble %>%
  arrange(depth) %>%
  filter(
    period != "1994 - 2014",
    depth <= params_global$inventory_depth_standard,
    data_source != "mod_truth"
  ) %>%
  group_split(data_source) %>%
  # head(1) %>%
  map(
    ~ ggplot() +
      geom_hline(yintercept = params_global$inventory_depth_standard) +
      geom_vline(xintercept = 0) +
      geom_path(
        data = .x,
        aes(
          dcant,
          depth,
          col = Version_ID_group,
          group = Version_ID
        )) +
      scale_y_continuous(trans = trans_reverser("sqrt"),
                         breaks = c(0, 100, 500, seq(1500, 5000, 1000))) +
      coord_cartesian(expand = 0) +
      scale_color_brewer(
        palette = "Dark2",
        name = "configuration"
      ) +
      labs(
        y = "Depth (m)",
        x = dcant_umol_label,
        title = paste("data_source", unique(.x$data_source))
      ) +
      facet_grid(basin ~ period)
  )

```

```{r concentration_profiles_data_adjustments, fig.asp=1.5}

bind_rows(
  dcant_profile_basin_MLR_all_ensemble %>%
    filter(
      period %in% two_decades,
      depth <= params_global$inventory_depth_standard,
      data_source == "obs",
      Version_ID_group == "Standard case"
    ),
  dcant_profile_basin_MLR_all_sensitivity %>%
    filter(
      period %in% two_decades,
      depth <= params_global$inventory_depth_standard,
      data_source == "obs",
      Version_ID_group == "No data adjustments"
    )
) %>%
  group_by(depth,
           period,
           basin,
           Version_ID_group) %>% 
  summarise(dcant_sd = sd(dcant),
            dcant = mean(dcant)) %>% 
  ungroup() %>% 
  filter(basin == "N. Pacific" & period == "2004 - 2014" |
         basin == "Indian" & period == "1994 - 2004") %>%
  ggplot() +
  geom_hline(yintercept = params_global$inventory_depth_standard) +
  geom_vline(xintercept = 0) +
  geom_ribbon(
    aes(
      xmin = dcant - dcant_sd,
      xmax = dcant + dcant_sd,
      y = depth,
      fill = Version_ID_group
    ),
    alpha = 0.5
  )+
  geom_path(aes(dcant,
                depth,
                col = Version_ID_group,
                group = Version_ID_group)) +
  scale_y_continuous(trans = trans_reverser("sqrt"),
                     breaks = c(0, 100, 500, seq(1500, 5000, 1000))) +
  coord_cartesian(expand = FALSE, xlim = c(-1,13)) +
  scale_color_manual(values = colour("high contrast", names = FALSE)(3)[c(1,3)],
                     name = "Mean \u00B1 1σ") +
  scale_fill_manual(values = colour("high contrast", names = FALSE)(3)[c(1,3)],
                    name = "Mean \u00B1 1σ") +
  labs(y = "Depth (m)",
       x = dcant_umol_label) +
  facet_nested_wrap(~ basin + period) +
  theme(legend.position = c(0.85,0.15))


ggsave(path = here::here("output/publication"),
       filename = "FigS_dcant_profiles_data_adjustments.png",
       height = 6,
       width = 8)
```

## dCant - delta


```{r concentration_profiles_MLR_basins_offset}

delta_dcant_profile_basin_MLR_all_uncertainty %>%
  group_split(data_source) %>%
  # head(3) %>%
  map(
    ~ ggplot(data = .x,
             aes(delta_dcant,
                 depth)) +
      geom_hline(yintercept = params_global$inventory_depth_standard) +
      geom_vline(xintercept = 0) +
      geom_ribbon(
        aes(
          xmin = delta_dcant - RSS,
          xmax = delta_dcant + RSS
        ),
        alpha = 0.3
      ) +
      geom_path() +
      scale_y_continuous(trans = trans_reverser("sqrt"),
                         breaks = c(0, 100, 500, seq(1500, 5000, 1000))) +
      coord_cartesian(expand = 0) +
      scale_color_brewer(palette = "Set1", name = "mean \u00B1 sd") +
      scale_fill_brewer(palette = "Set1", name = "mean \u00B1 sd") +
      labs(
        title = paste("data_source", unique(.x$data_source)),
        y = "Depth (m)",
        x = ddcant_umol_label
      ) +
      facet_wrap(~ basin, ncol = 3)
  )

```


# Inventories


```{r dcant_budget_stats_ensemble_SD, eval=FALSE}

# dcant_budget_basin_MLR_all_ensemble %>% distinct(Version_ID_group)

dcant_budget_ensemble_stat <-
  dcant_budget_basin_MLR_all_ensemble %>% 
  filter(period != "1994 - 2014",
         data_source != "mod_truth") %>%
  group_by(period, basin, data_source) %>%
  summarise(
    median = median(dcant),
    sd = sd(dcant),
    n = n()
  ) %>%
  ungroup() 


dcant_budget_ensemble_stat <-
  full_join(
    dcant_budget_ensemble_stat,
    dcant_budget_basin_MLR_all_ensemble %>%
      filter(
        Version_ID %in% Version_IDs,
        period != "1994 - 2014",
        data_source != "mod_truth"
      ) %>%
      select(period,
             basin,
             data_source,
             std_case = dcant)
  )

dcant_budget_ensemble_significance <- dcant_budget_ensemble_stat %>% 
  pivot_longer(c(median,std_case),
               names_to = "estimate",
               values_to = "dcant") %>%
  group_by(estimate, basin, data_source) %>%
  mutate(
    delta_dcant = dcant - lag(dcant),
    delta_dcant_uncert = sqrt(sd_factor * sd ^ 2 + lag(sd_factor * sd ^ 2)),
    error_prop_ratio = abs(delta_dcant_uncert / delta_dcant),
    ttest_p = tsum.test(
      mean.x = dcant,
      s.x = sd,
      n.x = n,
      mean.y = lag(dcant),
      s.y = lag(sd),
      n.y = lag(n)
    )$p.value
  ) %>%
  ungroup() %>% 
  drop_na()
  
dcant_budget_ensemble_stat_significance <-
  full_join(
    dcant_budget_ensemble_stat %>%
      select(-n) %>%
      pivot_wider(
        names_from = period,
        values_from = median:std_case,
        names_sep = " "
      ),
    dcant_budget_ensemble_significance %>%
      select(basin, estimate, delta_dcant, delta_dcant_uncert, ttest_p, data_source) %>%
      pivot_wider(names_from = estimate,
                  values_from = delta_dcant:ttest_p) %>%
      rename(delta_dcant_uncert = delta_dcant_uncert_std_case) %>%
      select(-delta_dcant_uncert_median)
  )


dcant_budget_ensemble_stat_significance %>% 
  kable() %>%
  kable_styling() %>%
  scroll_box(height = "300px")

dcant_budget_ensemble_significance %>% 
  ggplot(aes(error_prop_ratio, ttest_p, col = basin)) +
  geom_vline(xintercept = 1) +
  geom_hline(yintercept = 0.05) +
  geom_point() +
  scale_y_log10() +
  scale_color_brewer(palette = "Dark2") +
  facet_grid(data_source ~ estimate)

```

```{r dcant_budget_stats_basin_SD_plus_sensitivity_cases}

dcant_budget_basin_MLR_all_uncertainty <-
  dcant_budget_basin_MLR_all_ensemble %>%
  filter(data_source != "mod_truth",
         period != "1994 - 2014") %>%
  select(-c(inv_depth, Version_ID, tref1, tref2))

dcant_budget_basin_MLR_all_uncertainty <- additive_uncertainty(dcant_budget_basin_MLR_all_uncertainty)

delta_dcant_budget_basin_MLR_all_uncertainty <- dcant_budget_basin_MLR_all_uncertainty[[3]]
dcant_budget_basin_MLR_all_uncertainty_contributions <- dcant_budget_basin_MLR_all_uncertainty[[2]]
dcant_budget_basin_MLR_all_uncertainty <- dcant_budget_basin_MLR_all_uncertainty[[1]]



```



```{r scale_dcant_inventories_and_uncertainties_to_global_coverage}

# inventory scaling

dcant_budget_basin_MLR_all_ensemble <-
  dcant_budget_basin_MLR_all_ensemble %>%
  mutate(dcant = if_else(basin == "Global",
                         dcant * dcant_scaling,
                         dcant))

dcant_budget_basin_MLR_all <- dcant_budget_basin_MLR_all %>%
  mutate(dcant = if_else(basin == "Global",
                         dcant * dcant_scaling,
                         dcant))

dcant_budget_basin_MLR_all_sensitivity <-
  dcant_budget_basin_MLR_all_sensitivity %>%
  mutate(dcant = if_else(basin == "Global",
                         dcant * dcant_scaling,
                         dcant))

# uncertainty scaling

scaling_uncertainty <-
  dcant_budget_basin_MLR_all_uncertainty %>%
  select(-c(sd, signif)) %>%
  filter(basin == "Global") %>%
  mutate(
    sd = std_case * (dcant_scaling - 1) * dcant_scaling_uncertainty,
    Version_ID_group = "scaling uncertainty"
  ) %>%
  select(-std_case)


dcant_budget_basin_MLR_all_uncertainty <-
  dcant_budget_basin_MLR_all_uncertainty %>%
  mutate(
    sd = if_else(basin == "Global",
                 sqrt(
                   sd ^ 2 +
                     (std_case * (dcant_scaling - 1) * dcant_scaling_uncertainty) ^
                     2
                 ),
                 sd),
    std_case = if_else(basin == "Global",
                       std_case * dcant_scaling,
                       std_case)
  )


dcant_budget_basin_MLR_all_uncertainty_contributions <-
  bind_rows(dcant_budget_basin_MLR_all_uncertainty_contributions,
            scaling_uncertainty)


delta_dcant_budget_basin_MLR_all_uncertainty <-
  delta_dcant_budget_basin_MLR_all_uncertainty %>%
  mutate(
    RSS = if_else(basin == "Global",
                  RSS * dcant_scaling,
                  RSS),
    delta_dcant = if_else(basin == "Global",
                          delta_dcant * dcant_scaling,
                          delta_dcant),
  )


```

```{r dcant_inventory_uncertainty_components}


dcant_budget_basin_MLR_all_uncertainty_contributions %>%
  filter(data_source == "obs") %>%
  mutate(
    basin = fct_relevel(
      basin,
      "Global",
      "N. Pacific",
      "N. Atlantic",
      "Indian",
      "S. Pacific",
      "S. Atlantic"
    )
  ) %>%
  ggplot(aes("x", abs(sd), fill = Version_ID_group)) +
  geom_hline(yintercept = 0, col = "grey10") +
  geom_col(position = position_dodge(preserve = "single"),
           col = "grey10") +
  scale_fill_bright(name = "eMLR(C*)\nconfiguration\ncomponent") +
  labs(y = expression(Delta*Cant~inventory~offset~from~standard~case~(PgC))) +
  theme(
    axis.title.x = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank()
  ) +
  guides(pattern = guide_legend(override.aes = list(fill = "white")),
         fill = guide_legend(override.aes = list(pattern = "none"))) +
  # expand_limits(y = c(0,2.2)) +
  # scale_y_continuous(expand = c(0,0)) +
  facet_nested_wrap( ~ basin + period, ncol = 6)



ggsave(path = here::here("output/publication"),
       filename = "FigS_dcant_inventory_additive_uncertainty_combined_contributions.png",
       height = 6,
       width = 8) 

```



```{r budgets_basins_hemisphere_tcant_for_scatterplot}

# estimate area scaling factor to achieve identical coverage

tcant_inv <-
  inner_join(tcant_inv, basinmask)

dcant_inv_all <-
  inner_join(dcant_inv_all, basinmask)

area_scaling <-
  bind_rows(
    tcant_inv %>% distinct(lat, lon, basin) %>%
      mutate(source = "SO4"),
    dcant_inv_all %>% distinct(lat, lon, basin) %>%
      mutate(source = "M22")
  )


map +
  geom_tile(data = area_scaling,
            aes(lon, lat, fill = basin)) +
  facet_wrap( ~ source)

area_scaling <- area_scaling %>% 
  mutate(area = earth_surf(lat, lon)) %>% 
  group_by(basin, source) %>% 
  summarise(area_total = sum(area)) %>% 
  ungroup() %>% 
  pivot_wider(values_from = area_total,
              names_from = source) %>% 
  mutate(scaling_factor = M22 / SO4)


tcant_budget_basin_MLR <-
  tcant_inv %>%
  mutate(method = "layer",
         data_source = "obs") %>% 
  group_by(basin) %>%
  nest() %>% 
  mutate(budget = map(.x = data, ~m_dcant_budget(.x))) %>% 
  select(-data) %>%
  unnest(budget)

tcant_budget_basin_MLR <-
  full_join(tcant_budget_basin_MLR,
            area_scaling %>% select(basin, scaling_factor)) %>%
  mutate(value = value * scaling_factor) %>%
  select(-scaling_factor)



tcant_budget_basin_MLR <-
  left_join(tcant_budget_basin_MLR %>%
              mutate(period = "1800 - 1994"),
            delta_pCO2_atm)


tcant_budget_basin_MLR <- tcant_budget_basin_MLR %>% 
  filter(estimate == "dcant") %>% 
  select(-estimate) %>% 
  rename(dcant = value)

tcant_budget_basin_MLR <- tcant_budget_basin_MLR %>% 
  mutate(beta_1994 = dcant / delta_pCO2) %>% 
  select(basin, beta_1994)

tcant_budget_basin_MLR <-
  bind_rows(tcant_budget_basin_MLR,
            tibble(basin = "Global", beta_1994 = 118 / 78.3))




```


## Scatterplots

### Ensemble uncertainty

```{r dcant_budget_basin_hemisphere_ensemble_uncertainty, fig.asp=1}

dcant_budget_basin_MLR_all_ensemble %>%
  ggplot(aes(period, dcant, col = Version_ID_group)) +
  geom_jitter(alpha = 0.5) +
  scale_color_brewer(palette = "Dark2") +
  facet_grid(basin ~ data_source, scales = "free_y")


tcant_budget_basin_MLR <- expand_grid(
  tcant_budget_basin_MLR,
  delta_pCO2_atm %>% filter(period %in% two_decades)
)

tcant_budget_basin_MLR <- tcant_budget_basin_MLR %>% 
  mutate(dcant = beta_1994 * delta_pCO2)

tcant_budget_basin_MLR <- tcant_budget_basin_MLR %>%
  mutate(
    basin = fct_relevel(
      basin,
      "Global",
      "Indian",
      "N. Pacific",
      "S. Pacific",
      "N. Atlantic",
      "S. Atlantic"
    )
  )
# 
# dcant_budget_basin_MLR_all_ensemble %>%
#   filter(data_source == "obs",
#          period != "1994 - 2014",
#          !(Version_ID %in% Version_IDs)) %>%
#   ggplot(aes(period, dcant)) +
#   geom_errorbar(
#     data = tcant_budget_basin_MLR,
#     aes(x = period,
#         ymax = dcant, ymin = dcant,
#         col = "Scaled 1994\nestimate"),
#     width = 0.8,
#     size = 1,
#     linetype = 1,
#     position = position_nudge(x = 0.05)
#   ) +
#   geom_jitter(
#     data = dcant_budget_basin_MLR_all_sensitivity %>%
#       filter(data_source == "obs",
#              period != "1994 - 2014"),
#     aes(fill = "Unadjusted data",
#         alpha = "Unadjusted data"),
#     shape = 21,
#     position = position_jitter(width = 0.1, height = 0)
#   ) +
#   geom_point(
#     aes(fill = "Ensemble member",
#         alpha = "Ensemble member"),
#     shape = 21,
#     position = position_jitter(width = 0.1, height = 0)
#   ) +
#   geom_crossbar(
#     data = dcant_budget_ensemble_stat %>% filter(data_source == "obs"),
#     aes(
#       x = period,
#       y = std_case,
#       ymin = std_case - 2*sd,
#       ymax = std_case + 2*sd,
#       linetype = "Ensemble SD"
#     ),
#     width = 0.1,
#     fill = "#AA3377",
#     alpha = 0.2,
#     position = position_nudge(x = 0.2)
#   ) +
#   geom_crossbar(
#     data = dcant_budget_ensemble_stat %>% filter(data_source == "obs"),
#     aes(
#       x = period,
#       y = std_case,
#       ymin = std_case - sd,
#       ymax = std_case + sd,
#       alpha = "Ensemble SD",
#     ),
#     width = 0.1,
#     fill = "#AA3377",
#     alpha = 0.4,
#     position = position_nudge(x = 0.2)
#   ) +
#   geom_point(
#     data = dcant_budget_ensemble_stat %>% filter(data_source == "obs"),
#     aes(x = period,
#         y = std_case,
#         fill = "Standard case",
#         alpha = "Standard case"),
#     size = 2,
#     shape = 21,
#     position = position_nudge(x = 0.2)
#   ) +
#   scale_fill_manual(name = "group", values = c("#BB5566", "white", "#DDAA33")) +
#   scale_color_manual(values = c("grey50"), label = expression(Scaled~C[ant]~1994)) +
#   scale_linetype(name = "X") +
#   scale_alpha_manual(name = "group", values = c(0.7,1,0.7)) +
#   scale_shape_manual(values = 95) +
#   scale_y_continuous(name = dcant_pgc_label) +
#   guides(
#     fill = guide_legend(order = 1),
#     linetype = guide_legend(order = 2),
#     alpha = guide_legend(order = 1)
#   ) +
#   facet_wrap(~ basin, ncol = 3, dir = "v", scales = "free_y") +
#   theme(legend.title = element_blank(),
#         axis.title.x = element_blank())
# 
# 
# ggsave(path = here::here("output/publication"),
#        filename = "Fig_dcant_inventory_ensemble_uncertainty.png",
#        height = 6,
#        width = 8)

dcant_budget_basin_MLR_all_ensemble %>%
  filter(data_source == "obs",
         period != "1994 - 2014") %>%
  mutate(ensemble_role = "Uncertainty cases") %>% 
  ggplot(aes(period, dcant)) +
  scale_fill_muted(name = "ensemble group") +
  scale_color_manual(values = c("grey", "black", "red"),
                     name = "Ensemble member") +
  geom_boxplot(
    width = .1,
    outlier.shape = NA,
    fill = "grey",
    alpha = 0.7,
    position = position_nudge(x = 0.3)
  ) +
  geom_point(
    data = dcant_budget_basin_MLR_all_sensitivity %>%
      mutate(ensemble_role = "Sensitivity cases") %>%
      filter(data_source == "obs",
         period != "1994 - 2014"),
    aes(fill = Version_ID_group,
        col = ensemble_role),
    size = 1.3,
    alpha = .7,
    shape = 21,
    position = position_dodge2(width = 0.3)
  ) +
  geom_point(
    aes(fill = Version_ID_group,
        col = ensemble_role),
    size = 1.3,
    alpha = .7,
    shape = 21,
    position = position_dodge2(width = 0.3)
  ) +
  scale_y_continuous(name = dcant_pgc_label) +
  facet_wrap(~ basin, ncol = 3, scales = "free_y")

# dcant_budget_basin_MLR_all_ensemble_summary <- dcant_budget_basin_MLR_all_ensemble %>% 
#   group_by(data_source, basin, period) %>% 
#   summarise(dcant_mean = mean(dcant),
#             dcant_sd = sd(dcant)*sd_factor) %>% 
#   ungroup()
# 
# dcant_budget_global_all_ensemble_summary <-
#   dcant_budget_basin_MLR_all_ensemble %>%
#   filter(period != "1994 - 2014") %>%
#   group_by(data_source, Version_ID, tref1, tref2, period) %>%
#   summarise(dcant = sum(dcant)) %>%
#   ungroup() %>%
#   group_by(data_source, tref1, tref2, period) %>%
#   summarise(dcant_mean = mean(dcant),
#             dcant_sd = sd(dcant)*sd_factor) %>%
#   ungroup() %>%
#   filter(data_source == "obs")

```

### Additive uncertainty

```{r dcant_budget_basin_hemisphere_additive_uncertainty, fig.asp=1}

dcant_budget_basin_MLR_all_ensemble %>%
  filter(data_source == "obs",
         period != "1994 - 2014",
         !(Version_ID %in% Version_IDs),
         MLR_basins == unique(params_local_all$MLR_basins)) %>%
  ggplot(aes(period, dcant)) +
  geom_errorbar(
    data = tcant_budget_basin_MLR,
    aes(x = period,
        ymax = dcant, ymin = dcant,
        col = "Scaled 1994\nestimate"),
    width = 0.8,
    size = 1,
    linetype = 1,
    position = position_nudge(x = 0.05)
  ) +
  geom_jitter(
    data = dcant_budget_basin_MLR_all_ensemble %>%
      filter(data_source == "obs",
             period != "1994 - 2014",
             Version_ID_group == unique(params_local_all$Version_ID_group)),
    aes(fill = "Regional clustering",
        alpha = "Regional clustering"),
    shape = 21,
    position = position_jitter(width = 0.1, height = 0)
  ) +
  geom_point(
    aes(fill = "Configuration changes",
        alpha = "Configuration changes"),
    shape = 21,
    position = position_jitter(width = 0.1, height = 0)
  ) +
  geom_crossbar(
    data = dcant_budget_basin_MLR_all_uncertainty %>% filter(data_source == "obs"),
    aes(
      x = period,
      y = std_case,
      ymin = std_case - 2*sd,
      ymax = std_case + 2*sd,
      linetype = "Combined uncertainty"
    ),
    width = 0.1,
    fill = "#BBBBBB",
    alpha = 0.2,
    position = position_nudge(x = 0.2)
  ) +
  geom_crossbar(
    data = dcant_budget_basin_MLR_all_uncertainty %>% filter(data_source == "obs"),
    aes(
      x = period,
      y = std_case,
      ymin = std_case - sd,
      ymax = std_case + sd,
      alpha = "Combined uncertainty",
    ),
    width = 0.1,
    fill = "#BBBBBB",
    alpha = 0.4,
    position = position_nudge(x = 0.2)
  ) +
  geom_point(
    data = dcant_budget_basin_MLR_all_uncertainty %>% filter(data_source == "obs"),
    aes(x = period,
        y = std_case,
        fill = "Standard case",
        alpha = "Standard case"),
    size = 2,
    shape = 21,
    position = position_nudge(x = 0.2)
  ) +
  scale_fill_manual(name = "group", values = c("#BB5566", "#004488", "white")) +
  scale_color_manual(values = c("grey50"), label = expression(Scaled~C[ant]~1994)) +
  scale_linetype(name = "X") +
  scale_alpha_manual(name = "group", values = c(0.7,0.7,1)) +
  scale_shape_manual(values = 95) +
  scale_y_continuous(name = dcant_pgc_label) +
  guides(
    fill = guide_legend(order = 1),
    linetype = guide_legend(order = 2),
    alpha = guide_legend(order = 1)
  ) +
  facet_wrap(~ basin, ncol = 3, dir = "v", scales = "free_y") +
  theme(legend.title = element_blank(),
        axis.title.x = element_blank())


ggsave(path = here::here("output/publication"),
       filename = "Fig_dcant_inventory_additive_uncertainty.png",
       height = 6,
       width = 8)

```

### Beta

```{r beta_budget_basin_hemisphere_ensemble, fig.asp=1}

# determine scaling factor from dcant -> beta inventories
# including scaling for: delta pCO2 atm, basin area, PgC -> molC

beta_scaling <-
  bind_rows(
    area_scaling,
    area_scaling %>%
      summarise(M22 = sum(M22) * dcant_scaling) %>%
      mutate(basin = "Global")
  ) %>% 
  select(basin, area = M22)


beta_scaling <- 
  full_join(delta_pCO2_atm,
            beta_scaling,
            by = character())

beta_scaling <- beta_scaling %>% 
  mutate(scaling_factor = 1e15 / 12 / delta_pCO2 / area) %>% 
  select(period, basin, scaling_factor, area)

beta_scaling <- beta_scaling %>%
  mutate(
    basin = fct_relevel(
      basin,
      "Global",
      "Indian",
      "N. Pacific",
      "S. Pacific",
      "N. Atlantic",
      "S. Atlantic"
    )
  )

beta_budget_basin_MLR_all_sensitivity <-
  left_join(dcant_budget_basin_MLR_all_sensitivity,
            beta_scaling) %>%
  mutate(beta = dcant * scaling_factor) %>% 
  select(-scaling_factor)

beta_budget_basin_MLR_all_ensemble <-
  left_join(dcant_budget_basin_MLR_all_ensemble,
            beta_scaling) %>%
  mutate(beta = dcant * scaling_factor) %>% 
  select(-scaling_factor)


tcant_budget_basin_MLR <-
  left_join(tcant_budget_basin_MLR,
            beta_scaling) %>%
  mutate(beta_1994 = beta_1994 * 1e15 / 12 / area) %>% 
  select(-c(area,scaling_factor))

beta_budget_basin_MLR_all_uncertainty <- 
  left_join(dcant_budget_basin_MLR_all_uncertainty,
            beta_scaling) %>% 
  mutate(
    sd = sd * scaling_factor,
    std_case = std_case * scaling_factor
    ) %>% 
  select(-scaling_factor)

beta_budget_basin_MLR_all_uncertainty_contributions <- 
  left_join(dcant_budget_basin_MLR_all_uncertainty_contributions,
            beta_scaling) %>% 
  mutate(
    sd = sd * scaling_factor
    ) %>% 
  select(-scaling_factor)


```

```{r beta_budget_stats}

# beta_budget_ensemble_stat <-
#   beta_budget_basin_MLR_all_ensemble %>% 
#   filter(period != "1994 - 2014",
#          data_source != "mod_truth") %>%
#   select(basin, period, dcant, beta, data_source) %>% 
#   pivot_longer(c(dcant, beta),
#                values_to = "value",
#                names_to = "estimate") %>% 
#   group_by(period, basin, estimate, data_source) %>%
#   summarise(
#     median = median(value),
#     sd = sd(value),
#     n = n()
#   ) %>%
#   ungroup() 
# 
# 
# beta_budget_ensemble_stat <-
#   full_join(
#     beta_budget_ensemble_stat,
#     beta_budget_basin_MLR_all_ensemble %>%
#       filter(
#         Version_ID %in% Version_IDs,
#         period != "1994 - 2014"
#       ) %>%
#       select(period,
#              basin,
#              data_source,
#              dcant,
#              beta) %>% 
#         pivot_longer(c(dcant, beta),
#                values_to = "std_case",
#                names_to = "estimate")
#   )


dcant_beta_basin_MLR_all_uncertainty <-
  bind_rows(
    dcant_budget_basin_MLR_all_uncertainty %>% mutate(estimate = "dcant"),
    beta_budget_basin_MLR_all_uncertainty %>% mutate(estimate = "beta")
  ) %>%
  select(-c(area, signif))
  

dcant_beta_basin_MLR_all_uncertainty_significance <- 
  dcant_beta_basin_MLR_all_uncertainty %>% 
  arrange(period) %>% 
  group_by(estimate, basin, data_source) %>%
  mutate(
    delta = std_case - lag(std_case),
    RSS = sqrt(sd_factor * sd ^ 2 + lag(sd_factor * sd ^ 2)),
    RSS_delta_ratio = abs(delta) / RSS
    # ttest_p = tsum.test(
    #   mean.x = std_case,
    #   s.x = sd,
    #   n.x = n,
    #   mean.y = lag(std_case),
    #   s.y = lag(sd),
    #   n.y = lag(n)
    # )$p.value
  ) %>%
  ungroup() %>% 
  filter(!is.na(delta))
  

dcant_beta_basin_MLR_all_uncertainty_significance <-
  full_join(
    dcant_beta_basin_MLR_all_uncertainty %>%
      pivot_wider(
        names_from = period,
        values_from = c(sd, std_case),
        names_sep = " "
      ),
    dcant_beta_basin_MLR_all_uncertainty_significance %>% 
      select(-c(sd, std_case))
  )

dcant_beta_basin_MLR_all_uncertainty_significance <-
  dcant_beta_basin_MLR_all_uncertainty_significance %>% 
  mutate(across(where(is.numeric), signif, 2))

dcant_beta_basin_MLR_all_uncertainty_significance %>% 
  kable() %>%
  kable_styling() %>%
  scroll_box(height = "300px")

# dcant_beta_budget_ensemble_stat_significance %>% 
#   ggplot(aes(abs(delta) / RSS, ttest_p, 
#              col = basin, shape = uncertainty)) +
#   geom_vline(xintercept = 1) +
#   geom_hline(yintercept = 0.05) +
#   geom_point() +
#   scale_y_log10() +
#   scale_color_brewer(palette = "Dark2") +
#   facet_grid(data_source ~ estimate)

dcant_beta_basin_MLR_all_uncertainty_significance_table <-
dcant_beta_basin_MLR_all_uncertainty_significance %>%
  filter(data_source == "obs") %>% 
  select(-data_source) %>% 
  mutate(
    `1994 - 2004` = paste(`std_case 1994 - 2004`, `sd 1994 - 2004`, sep = " ± "),
    `2004 - 2014` = paste(`std_case 2004 - 2014`, `sd 2004 - 2014`, sep = " ± "),
    `Deacadal change` = paste0(delta, " ± ", RSS, if_else(abs(delta) > RSS, " *",""))
  ) %>%
  select(Region = basin,
         Estimate = estimate,
         # Uncertainty = uncertainty,
         `1994 - 2004`,
         `2004 - 2014`,
         `Deacadal change`) %>%
  arrange(Region) 

dcant_beta_basin_MLR_all_uncertainty_significance_table %>% 
  # filter(Uncertainty == "additive") %>% 
  # select(-Uncertainty) %>% 
  write_csv(here::here("output/publication/Table_budget_stats.csv"))


```

```{r beta_budget_basin_hemisphere_beta_uncertainty, eval=FALSE}


beta_budget_basin_MLR_all_ensemble %>%
  filter(data_source == "obs",
         period != "1994 - 2014",
         !(Version_ID %in% Version_IDs)) %>%
    mutate(
    basin = fct_relevel(
      basin,
      "Global",
      "Indian",
      "S. Pacific",
      "S. Atlantic",
      "N. Pacific",
      "N. Atlantic"
    )
  ) %>%
  ggplot(aes(period, beta)) +
  geom_errorbar(
    data = tcant_budget_basin_MLR %>% 
      rename(beta = beta_1994),
    aes(x = period,
        ymax = beta, ymin = beta,
        col = "Scaled 1994\nestimate"),
    width = 0.8,
    size = 1,
    linetype = 1,
    position = position_nudge(x = 0.05)
  ) +
  geom_jitter(
    data = beta_budget_basin_MLR_all_sensitivity %>%
      filter(data_source == "obs",
             period != "1994 - 2014"),
    aes(fill = "Sensitivity cases",
        alpha = "Sensitivity cases"),
    shape = 21,
    position = position_jitter(width = 0.1, height = 0)
  ) +
  geom_point(
    aes(fill = "Ensemble member",
        alpha = "Ensemble member"),
    shape = 21,
    position = position_jitter(width = 0.1, height = 0)
  ) +
  geom_crossbar(
    data = beta_budget_basin_MLR_all_uncertainty %>%
      filter(data_source == "obs"),
    aes(
      x = period,
      y = std_case,
      ymin = std_case - 2*sd,
      ymax = std_case + 2*sd,
      linetype = "Ensemble SD"
    ),
    width = 0.1,
    fill = "#AA3377",
    alpha = 0.2,
    position = position_nudge(x = 0.2)
  ) +
  geom_crossbar(
    data = beta_budget_basin_MLR_all_uncertainty %>%
      filter(data_source == "obs"),
    aes(
      x = period,
      y = std_case,
      ymin = std_case - sd,
      ymax = std_case + sd,
      alpha = "Ensemble SD",
    ),
    width = 0.1,
    fill = "#AA3377",
    alpha = 0.4,
    position = position_nudge(x = 0.2)
  ) +
  geom_point(
    data = beta_budget_basin_MLR_all_uncertainty %>%
      filter(data_source == "obs"),
    aes(x = period,
        y = std_case,
        fill = "Standard case",
        alpha = "Standard case"),
    size = 2,
    shape = 21,
    position = position_nudge(x = 0.2)
  ) +
  scale_fill_manual(name = "group", values = c("#BB5566", "white", "#BBBBBB")) +
  scale_color_manual(values = c("grey50"), label = expression(Scaled~C[ant]~1994)) +
  scale_linetype(name = "X") +
  scale_alpha_manual(name = "group", values = c(0.5,1,0.5)) +
  scale_shape_manual(values = 95) +
  scale_y_continuous(name = dcant_pgc_scaled_label) +
  guides(
    fill = guide_legend(order = 1),
    linetype = guide_legend(order = 2),
    alpha = guide_legend(order = 1)
  ) +
  facet_wrap(~ basin, dir = "v", ncol = 3) +
  theme(legend.title = element_blank(),
        axis.title.x = element_blank())


ggsave(path = here::here("output/publication"),
       filename = "FigS_beta_budgets_ensemble_member.png",
       height = 6,
       width = 8)

```

```{r beta_dcant_budget_basin_hemisphere_additive_uncertainty, fig.asp=1}
# 
# beta_budget_basin_MLR_all_uncertainty <- 
#   beta_budget_basin_MLR_all_uncertainty %>% 
#     mutate(
#     basin = fct_relevel(
#       basin,
#       "Global",
#       "Indian",
#       "N. Pacific",
#       "S. Pacific",
#       "N. Atlantic",
#       "S. Atlantic"
#     )
#   )
# 
# beta_budget_basin_MLR_all_ensemble <- 
#   beta_budget_basin_MLR_all_ensemble %>% 
#     mutate(
#     basin = fct_relevel(
#       basin,
#       "Global",
#       "Indian",
#       "N. Pacific",
#       "S. Pacific",
#       "N. Atlantic",
#       "S. Atlantic"
#     )
#   )

beta_budget_basin_MLR_all_ensemble %>%
  filter(
    data_source == "obs",
    period != "1994 - 2014",
    !(Version_ID %in% Version_IDs),
    MLR_basins == unique(params_local_all$MLR_basins)
  ) %>%
  ggplot(aes(period, beta)) +
  geom_errorbar(
    data = tcant_budget_basin_MLR %>%
      rename(beta = beta_1994),
    aes(x = period,
        ymax = beta, ymin = beta,
        col = "Scaled 1994\nestimate"),
    width = 0.8,
    size = 1,
    linetype = 1,
    position = position_nudge(x = 0.05)
  ) +
  geom_jitter(
    data = beta_budget_basin_MLR_all_ensemble %>%
      filter(data_source == "obs",
             period != "1994 - 2014",
             Version_ID_group == unique(params_local_all$Version_ID_group)),
    aes(fill = "Regional clustering",
        alpha = "Regional clustering"),
    shape = 21,
    position = position_jitter(width = 0.1, height = 0)
  ) +
  geom_point(
    aes(fill = "Configuration changes",
        alpha = "Configuration changes"),
    shape = 21,
    position = position_jitter(width = 0.1, height = 0)
  ) +
  geom_crossbar(
    data = beta_budget_basin_MLR_all_uncertainty %>% filter(data_source == "obs"),
    aes(
      x = period,
      y = std_case,
      ymin = std_case - 2*sd,
      ymax = std_case + 2*sd,
      linetype = "Combined uncertainty"
    ),
    width = 0.1,
    fill = "#BBBBBB",
    alpha = 0.2,
    position = position_nudge(x = 0.2)
  ) +
  geom_crossbar(
    data = beta_budget_basin_MLR_all_uncertainty %>% filter(data_source == "obs"),
    aes(
      x = period,
      y = std_case,
      ymin = std_case - sd,
      ymax = std_case + sd,
      alpha = "Combined uncertainty",
    ),
    width = 0.1,
    fill = "#BBBBBB",
    alpha = 0.4,
    position = position_nudge(x = 0.2)
  ) +
  geom_point(
    data = beta_budget_basin_MLR_all_uncertainty %>% filter(data_source == "obs"),
    aes(x = period,
        y = std_case,
        fill = "Standard case",
        alpha = "Standard case"),
    size = 2,
    shape = 21,
    position = position_nudge(x = 0.2)
  ) +
  scale_fill_manual(name = "group", values = c("#BB5566", "#004488", "white")) +
  scale_color_manual(values = c("grey50"), label = expression(Scaled~C[ant]~1994)) +
  scale_linetype(name = "X") +
  scale_alpha_manual(name = "group", values = c(0.7,0.7,1)) +
  scale_shape_manual(values = 95) +
  scale_y_continuous(name = dcant_pgc_label) +
  guides(
    fill = guide_legend(order = 1),
    linetype = guide_legend(order = 2),
    alpha = guide_legend(order = 1)
  ) +
  facet_wrap(~ basin, ncol = 3, dir = "v") +
  theme(legend.title = element_blank(),
        axis.title.x = element_blank())


ggsave(path = here::here("output/publication"),
       filename = "Fig_beta_inventory_additive_uncertainty.png",
       height = 6,
       width = 8)

```

### Biases

```{r budget_biases_additive, fig.asp=1.2}


dcant_budget_basin_MLR_all_bias <-
  dcant_budget_basin_MLR_all_ensemble %>%
  filter(data_source %in% c("mod", "mod_truth")) %>%
  pivot_wider(names_from = data_source,
              values_from = dcant) %>%
  mutate(dcant_bias = mod - mod_truth,
         dcant_bias_rel = 100 * dcant_bias / mod_truth) %>%
  filter(period %in% two_decades)


dcant_budget_basin_MLR_all_bias <-
  dcant_budget_basin_MLR_all_bias %>%
  select(basin, period, MLR_basins, Version_ID_group, dcant = dcant_bias)

dcant_budget_basin_MLR_all_bias_uncertainty <-
  additive_uncertainty(dcant_budget_basin_MLR_all_bias)

delta_dcant_budget_basin_MLR_all_bias_uncertainty <-
  dcant_budget_basin_MLR_all_bias_uncertainty[[3]]
dcant_budget_basin_MLR_all_bias_uncertainty_contributions <-
  dcant_budget_basin_MLR_all_bias_uncertainty[[2]]
dcant_budget_basin_MLR_all_bias_uncertainty <-
  dcant_budget_basin_MLR_all_bias_uncertainty[[1]]

ggplot() +
  geom_hline(yintercept = 0) +
  geom_crossbar(
    data = delta_dcant_budget_basin_MLR_all_bias_uncertainty,
    aes(
      x = period,
      y = std_case,
      ymin = std_case - RSS,
      ymax = std_case + RSS,
      linetype = "Combined uncertainty"
    ),
    width = 0.1,
    fill = "#BBBBBB",
    alpha = 0.2
  ) +
  geom_crossbar(
    data = delta_dcant_budget_basin_MLR_all_bias_uncertainty,
    aes(
      x = period,
      y = std_case,
      ymin = std_case - 0.5*RSS,
      ymax = std_case + 0.5*RSS,
      alpha = "Combined uncertainty",
    ),
    width = 0.1,
    fill = "#BBBBBB",
    alpha = 0.4
  ) +
  geom_point(
    data = delta_dcant_budget_basin_MLR_all_bias_uncertainty,
    aes(x = period,
        y = std_case,
        fill = "Standard case",
        alpha = "Standard case"),
    size = 2,
    shape = 21
  ) +
  scale_fill_manual(name = "group", values = c("white")) +
  scale_linetype(name = "X") +
  scale_alpha_manual(name = "group", values = c(0.7,0.7,1)) +
  scale_shape_manual(values = 95) +
  scale_y_continuous(name = dcant_bias_pgc_label) +
  guides(
    fill = guide_legend(order = 1),
    linetype = guide_legend(order = 2),
    alpha = guide_legend(order = 1)
  ) +
  facet_wrap(~ basin, ncol = 3, dir = "v", scales = "free_y") +
  theme(legend.title = element_blank(),
        axis.title.x = element_blank())


ggsave(path = here::here("output/publication"),
       filename = "FigS_delta_dcant_bias_inventories.png",
       height = 6,
       width = 8)




```

```{r budget_biases, fig.asp=1.2, eval=FALSE}


dcant_budget_basin_MLR_all_ensemble_bias <- 
dcant_budget_basin_MLR_all_ensemble %>%
  filter(data_source %in% c("mod", "mod_truth")) %>% 
  pivot_wider(names_from = data_source,
              values_from = dcant) %>% 
  mutate(dcant_bias = mod - mod_truth,
         dcant_bias_rel = 100 * dcant_bias / mod_truth)

dcant_budget_basin_MLR_all_ensemble_bias <- 
dcant_budget_basin_MLR_all_ensemble_bias %>%
  mutate(ensemble_role = if_else(Version_ID %in% Version_IDs,
                                 "Standard case",
                                 "others"))

dcant_budget_basin_MLR_all_ensemble_bias %>%
  ggplot(aes(period, dcant_bias)) +
  geom_hline(yintercept = 0) +
  geom_point(
    aes(fill = Version_ID_group,
        col = ensemble_role),
    size = 1.3,
    alpha = .7,
    shape = 21,
    position = position_dodge2(width = 0.3)
  ) +
  stat_summary(
    fun.data = "mean_sdl",
    fun.args = list(mult = 2),
    position = position_nudge(x = -0.3),
    col = "grey"
  ) +
  stat_summary(
    fun.data = "mean_sdl",
    fun.args = list(mult = 1),
    position = position_nudge(x = -0.3),
    size = 0.1
  ) +
  scale_fill_brewer(palette = "Dark2") +
    scale_color_manual(values = c("transparent", "black"),
                     name = "Ensemble member") +
  facet_grid(basin ~ .)


dcant_budget_bias_ensemble_stat <-
  dcant_budget_basin_MLR_all_ensemble_bias %>%
  filter(period != "1994 - 2014") %>%
  group_by(period, basin) %>%
  summarise(
    median = median(dcant_bias),
    sd = sd(dcant_bias),
    n = n()
  ) %>%
  ungroup() 


dcant_budget_bias_ensemble_stat <-
  full_join(
    dcant_budget_bias_ensemble_stat,
    dcant_budget_basin_MLR_all_ensemble_bias %>%
        filter(Version_ID %in% Version_IDs,
               period != "1994 - 2014") %>%
        select(period,
               basin,
               std_case = dcant_bias)
  )




dcant_budget_basin_MLR_all_ensemble_bias %>%
  filter(period != "1994 - 2014") %>%
  ggplot(aes(period, dcant_bias)) +
  geom_hline(yintercept = 0) +
  geom_point(
    aes(fill = "Ensemble member",
        alpha = "Ensemble member"),
    shape = 21,
    position = position_jitter(width = 0.1, height = 0)
  ) +
  geom_crossbar(
    data = dcant_budget_bias_ensemble_stat,
    aes(
      x = period,
      y = std_case,
      ymin = std_case - 2 * sd,
      ymax = std_case + 2 * sd,
      linetype = "Ensemble SD"
    ),
    width = 0.1,
    fill = "#AA3377",
    alpha = 0.2,
    position = position_nudge(x = 0.2)
  ) +
  geom_crossbar(
    data = dcant_budget_bias_ensemble_stat,
    aes(
      x = period,
      y = std_case,
      ymin = std_case - sd,
      ymax = std_case + sd,
      alpha = "Ensemble SD",
    ),
    width = 0.1,
    fill = "#AA3377",
    alpha = 0.4,
    position = position_nudge(x = 0.2)
  ) +
  geom_point(
    data = dcant_budget_bias_ensemble_stat,
    aes(
      x = period,
      y = std_case,
      fill = "Standard case",
      alpha = "Standard case"
    ),
    size = 2,
    shape = 21,
    position = position_nudge(x = 0.2)
  )+
  scale_fill_manual(name = "group", values = c("#BB5566", "white", "#BBBBBB")) +
  scale_linetype(name = "X") +
  scale_alpha_manual(name = "group", values = c(0.5,1,0.5)) +
  scale_shape_manual(values = 95) +
  scale_y_continuous(name = dcant_bias_pgc_label) +
  guides(
    fill = guide_legend(order = 1),
    linetype = guide_legend(order = 2),
    alpha = guide_legend(order = 1)
  ) +
  facet_wrap(~ basin, ncol = 3, dir = "v", scales = "free_y") +
  theme(legend.title = element_blank(),
        axis.title.x = element_blank())

ggsave(path = here::here("output/publication"),
       filename = "FigS_dcant_bias_budgets_ensemble_member.png",
       height = 6,
       width = 8)



dcant_budget_basin_MLR_all_ensemble_bias %>% 
  ggplot(aes(period, dcant_bias_rel, col = Version_ID_group)) +
  geom_hline(yintercept = 0) +
  geom_jitter(alpha = 0.5) +
  scale_color_brewer(palette = "Dark2") +
  facet_grid(basin ~ MLR_basins)


delta_dcant_budget_basin_MLR_all_ensemble <-
dcant_budget_basin_MLR_all_ensemble_bias %>%
  filter(period %in% two_decades) %>%
  select(basin, period, MLR_basins, Version_ID_group, mod, mod_truth, Version_ID) %>%
  pivot_longer(cols = mod:mod_truth,
               names_to = "data_source",
               values_to = "dcant") %>%
  group_by(basin, MLR_basins, Version_ID_group, data_source) %>%
  arrange(period) %>%
  mutate(delta_dcant = dcant - lag(dcant)) %>%
  ungroup() %>%
  drop_na() %>%
  select(-dcant) 

delta_dcant_budget_basin_MLR_all_ensemble_bias <- 
  delta_dcant_budget_basin_MLR_all_ensemble %>%
  pivot_wider(names_from = data_source,
              values_from = delta_dcant) %>%
  mutate(delta_dcant_bias = mod - mod_truth,
         delta_dcant_bias_rel = 100 * delta_dcant_bias / mod_truth)

delta_dcant_budget_basin_MLR_all_ensemble %>% 
  ggplot(aes(data_source, delta_dcant, col = Version_ID_group)) +
  geom_hline(yintercept = 0) +
  geom_jitter(alpha = 0.5) +
  scale_color_brewer(palette = "Dark2") +
  facet_grid(basin ~ MLR_basins)

delta_dcant_budget_basin_MLR_all_ensemble_bias %>% 
  ggplot(aes(period, delta_dcant_bias, col = Version_ID_group)) +
  geom_hline(yintercept = 0) +
  geom_jitter(alpha = 0.5) +
  scale_color_brewer(palette = "Dark2") +
  facet_grid(basin ~ MLR_basins)
  

delta_dcant_budget_bias_ensemble_stat <-
  delta_dcant_budget_basin_MLR_all_ensemble_bias %>%
  group_by(basin) %>%
  summarise(
    median = median(delta_dcant_bias),
    sd = sd(delta_dcant_bias),
    n = n()
  ) %>%
  ungroup() 


delta_dcant_budget_bias_ensemble_stat <-
  full_join(
    delta_dcant_budget_bias_ensemble_stat,
    delta_dcant_budget_basin_MLR_all_ensemble_bias %>%
        filter(Version_ID %in% Version_IDs,
               period != "1994 - 2014") %>%
        select(period,
               basin,
               std_case = delta_dcant_bias)
  )



delta_dcant_budget_bias_ensemble_stat_RSS <-
  dcant_budget_bias_ensemble_stat %>% 
  arrange(period) %>% 
  group_by(basin) %>% 
  mutate(delta_std_case = std_case - lag(std_case),
         RSS = sqrt(sd^2 + lag(sd)^2)) %>% 
  ungroup() %>% 
  drop_na()
  



delta_dcant_budget_basin_MLR_all_ensemble_bias %>%
  ggplot(aes(period, delta_dcant_bias)) +
  geom_hline(yintercept = 0) +
  geom_point(
    aes(fill = "Ensemble member",
        alpha = "Ensemble member"),
    shape = 21,
    position = position_jitter(width = 0.1, height = 0)
  ) +
  # geom_crossbar(
  #   data = delta_dcant_budget_bias_ensemble_stat,
  #   aes(
  #     x = period,
  #     y = std_case,
  #     ymin = std_case - 2 * sd,
  #     ymax = std_case + 2 * sd,
  #     linetype = "Ensemble SD"
  #   ),
  #   width = 0.1,
  #   fill = "#AA3377",
  #   alpha = 0.2,
  #   position = position_nudge(x = 0.2)
  # ) +
  # geom_crossbar(
  #   data = delta_dcant_budget_bias_ensemble_stat,
  #   aes(
  #     x = period,
  #     y = std_case,
  #     ymin = std_case - sd,
  #     ymax = std_case + sd,
  #     alpha = "Ensemble SD",
  #   ),
  #   width = 0.1,
  #   fill = "#AA3377",
  #   alpha = 0.4,
  #   position = position_nudge(x = 0.2)
  # ) +
  geom_crossbar(
    data = delta_dcant_budget_bias_ensemble_stat_RSS,
    aes(
      x = period,
      y = delta_std_case,
      ymin = delta_std_case - 2 * RSS,
      ymax = delta_std_case + 2 * RSS,
      linetype = "RSS"
    ),
    width = 0.1,
    fill = "#AA3377",
    alpha = 0.2,
    position = position_nudge(x = 0.2)
  ) +
  geom_crossbar(
    data = delta_dcant_budget_bias_ensemble_stat_RSS,
    aes(
      x = period,
      y = delta_std_case,
      ymin = delta_std_case - RSS,
      ymax = delta_std_case + RSS,
      alpha = "RSS",
    ),
    width = 0.1,
    fill = "#AA3377",
    alpha = 0.4,
    position = position_nudge(x = 0.2)
  ) +
  geom_point(
    data = delta_dcant_budget_bias_ensemble_stat,
    aes(
      x = period,
      y = std_case,
      fill = "Standard case",
      alpha = "Standard case"
    ),
    size = 2,
    shape = 21,
    position = position_nudge(x = 0.2)
  )+
  scale_fill_manual(name = "group", values = c("#BB5566", "white", "#BBBBBB")) +
  scale_linetype(name = "X") +
  scale_alpha_manual(name = "group", values = c(0.5,1,0.5)) +
  scale_shape_manual(values = 95) +
  scale_y_continuous(name = delta_dcant_bias_pgc_label) +
  guides(
    fill = guide_legend(order = 1),
    linetype = guide_legend(order = 2),
    alpha = guide_legend(order = 1)
  ) +
  facet_wrap(~ basin, ncol = 3, dir = "v", scales = "free_y") +
  theme(legend.title = element_blank(),
        axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(), 
        panel.grid.major.x = element_blank())

ggsave(path = here::here("output/publication"),
       filename = "FigS_delta_dcant_bias_budgets_ensemble_member.png",
       height = 6,
       width = 6)

```

## Flow chart

```{r dcant_budgets_basins_hemisphere_flow_chart, fig.asp=1.2, eval=FALSE}

dcant_budget_basin_MLR_all <- 
  dcant_budget_basin_MLR_all %>% 
  filter(basin != "Global")

dcant_budget_basin_MLR_all <- left_join(dcant_budget_basin_MLR_all,
                           co2_atm %>% rename(tref1 = year,
                                              pCO21 = pCO2))

dcant_budget_basin_MLR_all <- left_join(dcant_budget_basin_MLR_all,
                           co2_atm %>% rename(tref2 = year,
                                              pCO22 = pCO2))


dcant_budget_basin_MLR_all_plot <- dcant_budget_basin_MLR_all %>%
  filter(period != "1994 - 2014",
         data_source == "obs")

```

```{r budgets_basins_hemisphere_tcant, eval=FALSE}
tcant_budget_basin_MLR <-
  tcant_inv %>%
  mutate(method = "layer",
         data_source = "obs") %>% 
  group_by(basin) %>%
  nest() %>% 
  mutate(budget = map(.x = data, ~m_dcant_budget(.x))) %>% 
  select(-data) %>%
  unnest(budget)

tcant_budget_basin_MLR <-
  full_join(tcant_budget_basin_MLR,
            area_scaling %>% select(basin, scaling_factor)) %>%
  mutate(value = value * scaling_factor) %>%
  select(-scaling_factor)


tcant_budget_basin_MLR <- tcant_budget_basin_MLR %>% 
  mutate(pCO21 = 281,
         tref1 = 1800,
         tref2 = 1994)

tcant_budget_basin_MLR <- left_join(tcant_budget_basin_MLR,
                                    co2_atm %>% rename(tref2 = year,
                                                       pCO22 = pCO2))

tcant_budget_basin_MLR <- tcant_budget_basin_MLR %>% 
  mutate(period = paste(tref1, tref2, sep = " - ")) %>% 
  filter(estimate == "dcant") %>% 
  select(-estimate) %>% 
  rename(dcant = value)

dcant_budget_basin_MLR_all_plot <- bind_rows(
  dcant_budget_basin_MLR_all_plot,
  tcant_budget_basin_MLR)

dcant_budget_basin_MLR_all_plot <-
  left_join(dcant_budget_basin_MLR_all_plot,
            dcant_budget_basin_MLR_all_ensemble_summary)


```

### Absolute

```{r budgets_basins_hemisphere_alluvial_order_budget, fig.asp=0.9, eval=FALSE}

g1 <- dcant_budget_basin_MLR_all_plot %>%
  filter(period != "1800 - 1994") %>% 
  ggplot(aes(
    y = dcant,
    x = period,
    alluvium = basin,
    fill  = basin,
    stratum = basin
  )) +
  stat_alluvium(decreasing = FALSE) +
  stat_stratum(decreasing = FALSE) +
  stat_stratum(geom = "text",
               decreasing = FALSE,
               aes(label = paste(
                 round(after_stat(max-min),1)
                 # 100*round(after_stat(prop), 2), "%"
                 ))) +
  ggrepel::geom_label_repel(
    data = dcant_budget_basin_MLR_all_plot %>% filter(period == "2004 - 2014"),
    stat = "stratum",
    size = 4,
    nudge_x = .5,
    point.padding = 3,
    aes(fill = basin, label = basin),
    decreasing = FALSE
  )+
  scale_fill_brewer(palette = "Paired", guide = "none") +
  scale_y_continuous(limits = c(0, 32), expand = c(0, 0)) +
  labs(y = dcant_pgc_label) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        axis.title.x = element_blank()) +
  theme_classic()


newdat <- tibble(layer_data(g1))

change <- 
  newdat %>% 
  select(x, alluvium, count) %>% 
  pivot_wider(names_from = x,
              values_from = count) %>% 
  mutate(dcant_change = round(100*(`2` - `1`) / `1`)) %>% 
  select(alluvium, dcant_change)

coord <- newdat %>%
  filter(x == 2) %>% 
  select(x, y, alluvium)

new_layer <- full_join(
  change,
  coord
)

new_layer <- new_layer %>% 
  mutate(dcant_change = as.character(dcant_change),
         dcant_change = if_else(str_detect(dcant_change, "-"),
                                dcant_change,
                                paste0("+", dcant_change)),
         dcant_change = paste(dcant_change, "%"))

g1 +
  geom_text(data = new_layer,
            aes(
              x = x - 0.3,
              y = y,
              label = dcant_change
            ),
            inherit.aes = FALSE)


```


```{r budgets_basins_hemisphere_alluvial_order_basin, fig.asp=0.9, eval=FALSE}

g2 <- dcant_budget_basin_MLR_all_plot %>%
    filter(period != "1800 - 1994") %>%
  ggplot(aes(
    y = dcant,
    x = period,
    alluvium = basin,
    fill  = basin,
    stratum = basin,
    label = basin
  )) +
  geom_alluvium() +
  geom_stratum() +
  stat_stratum(geom = "text",
               aes(label = paste(
                 round(after_stat(count),1)
                 # 100*round(after_stat(prop), 2), "%"
                 ))) +
  ggrepel::geom_label_repel(
    data = dcant_budget_basin_MLR_all_plot %>% filter(period == "2004 - 2014"),
    stat = "stratum",
    size = 4,
    nudge_x = .5,
    point.padding = 3,
    aes(fill = basin)
  )+
  scale_fill_brewer(palette = "Paired", guide = "none") +
  scale_color_brewer(palette = "Paired", guide = "none") +
  scale_y_continuous(limits = c(0, 33), expand = c(0, 0)) +
  guides(y = "none") +
  labs(title = dcant_pgc_label) +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        plot.title = element_text(hjust = 0.5))


newdat <- tibble(layer_data(g2))

change_basin <- 
  newdat %>% 
  select(x, alluvium, count) %>% 
  pivot_wider(names_from = x,
              values_from = count) %>% 
  mutate(dcant_change = round(100*(`2` - `1`) / `1`)) %>% 
  select(alluvium, dcant_change)

coord_basin <- newdat %>%
  filter(x == 2) %>% 
  select(x, y, alluvium)

new_layer_basin <- full_join(
  change_basin,
  coord_basin
)

new_layer_basin <- new_layer_basin %>% 
  mutate(dcant_change = as.character(dcant_change),
         dcant_change = if_else(str_detect(dcant_change, "-"),
                                dcant_change,
                                paste0("+", dcant_change)),
         dcant_change = paste(dcant_change, "%"))

new_layer_total <- 
  newdat %>% 
  select(x, alluvium, count) %>% 
  group_by(x) %>% 
  summarise(dcant_change = sum(count)) %>% 
  ungroup()

new_layer_total <- new_layer_total %>% 
  mutate(y = dcant_change,
         dcant_change = as.character(round(dcant_change,1)),
         dcant_change = paste("global:",dcant_change))

g2 +
  geom_text(data = new_layer_basin,
            aes(
              x = x - 0.3,
              y = y,
              label = dcant_change
            ),
            inherit.aes = FALSE) +
  geom_label(data = new_layer_total,
            aes(
              x = x,
              y = y + 1,
              label = dcant_change
            ),
            inherit.aes = FALSE)


```

### Scaled

```{r scale_dcant_budget_to_atm_pCO2_growth, eval=FALSE}


dcant_budget_basin_MLR_all_plot <- left_join(dcant_budget_basin_MLR_all_plot,
                           co2_atm %>% rename(tref1 = year,
                                              pCO21 = pCO2))

dcant_budget_basin_MLR_all_plot <- left_join(dcant_budget_basin_MLR_all_plot,
                           co2_atm %>% rename(tref2 = year,
                                              pCO22 = pCO2))

dcant_budget_basin_MLR_all_plot <- dcant_budget_basin_MLR_all_plot %>% 
  mutate(delta_pCO2 = pCO22 - pCO21,
         beta = dcant / delta_pCO2,
         dcant_sd_scaled = dcant_sd / delta_pCO2) %>% 
  select(-starts_with("pCO2"))


dcant_budget_global_all_ensemble_summary <- left_join(dcant_budget_global_all_ensemble_summary,
                           co2_atm %>% rename(tref1 = year,
                                              pCO21 = pCO2))

dcant_budget_global_all_ensemble_summary <- left_join(dcant_budget_global_all_ensemble_summary,
                           co2_atm %>% rename(tref2 = year,
                                              pCO22 = pCO2))

dcant_budget_global_all_ensemble_summary <- dcant_budget_global_all_ensemble_summary %>% 
  mutate(delta_pCO2 = pCO22 - pCO21,
         beta = dcant_mean / delta_pCO2,
         dcant_sd_scaled = dcant_sd / delta_pCO2) %>% 
  select(-starts_with("pCO2"))


```


```{r budgets_basins_hemisphere_alluvial_order_basin_scaled, fig.asp=0.9, eval=FALSE}

g2 <- dcant_budget_basin_MLR_all_plot %>%
  filter(period != "1800 - 1994") %>% 
  ggplot(aes(
    y = beta,
    x = period,
    alluvium = basin,
    fill  = basin,
    stratum = basin,
    label = basin
  )) +
  geom_alluvium() +
  geom_stratum() +
  stat_stratum(geom = "text",
               aes(label = paste(
                 round(after_stat(count),2)
                 # 100*round(after_stat(prop), 2), "%"
                 ))) +
  ggrepel::geom_label_repel(
    data = dcant_budget_basin_MLR_all_plot %>% filter(period == "2004 - 2014"),
    stat = "stratum",
    size = 4,
    nudge_x = .5,
    point.padding = 3,
    aes(fill = basin)
  )+
  scale_fill_brewer(palette = "Paired", guide = "none") +
  scale_color_brewer(palette = "Paired", guide = "none") +
  # scale_y_continuous(limits = c(0, 33), expand = c(0, 0)) +
  guides(y = "none") +
  labs(title = dcant_pgc_scaled_label) +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        plot.title = element_text(hjust = 0.5))


newdat <- tibble(layer_data(g2))

change_basin <- 
  newdat %>% 
  select(x, alluvium, count) %>% 
  pivot_wider(names_from = x,
              values_from = count) %>% 
  mutate(dcant_change = round(100*(`2` - `1`) / `1`)) %>% 
  select(alluvium, dcant_change)

coord_basin <- newdat %>%
  filter(x == 2) %>% 
  select(x, y, alluvium)

new_layer_basin <- full_join(
  change_basin,
  coord_basin
)

new_layer_basin <- new_layer_basin %>% 
  mutate(dcant_change = as.character(dcant_change),
         dcant_change = if_else(str_detect(dcant_change, "-"),
                                dcant_change,
                                paste0("+", dcant_change)),
         dcant_change = paste(dcant_change, "%"))

new_layer_total <- 
  newdat %>% 
  select(x, alluvium, count) %>% 
  group_by(x) %>% 
  summarise(dcant_change = sum(count)) %>% 
  ungroup()

new_layer_total <- new_layer_total %>% 
  mutate(y = dcant_change,
         dcant_change = as.character(round(dcant_change,2)),
         dcant_change = paste("global:",dcant_change))

g2 +
  geom_text(data = new_layer_basin,
            aes(
              x = x - 0.3,
              y = y,
              label = dcant_change
            ),
            inherit.aes = FALSE) +
  geom_label(data = new_layer_total,
            aes(
              x = x,
              y = y + 0.05,
              label = dcant_change
            ),
            inherit.aes = FALSE)


```

```{r budgets_basins_hemisphere_alluvial_order_basin_scaled_incl_sabine, eval=FALSE}

g2 <- dcant_budget_basin_MLR_all_plot %>%
  ggplot(aes(
    y = beta,
    x = period,
    alluvium = basin,
    fill  = basin,
    stratum = basin,
    label = basin
  )) +
  geom_alluvium() +
  geom_stratum() +
  stat_stratum(geom = "text",
               aes(label = paste(
                 round(after_stat(count),2)
                 # 100*round(after_stat(prop), 2), "%"
                 ))) +
  ggrepel::geom_label_repel(
    data = dcant_budget_basin_MLR_all_plot %>% filter(period == "2004 - 2014"),
    stat = "stratum",
    size = 4,
    nudge_x = .5,
    point.padding = 3,
    aes(fill = basin)
  )+
  scale_fill_brewer(palette = "Paired", guide = "none") +
  scale_color_brewer(palette = "Paired", guide = "none") +
  scale_y_continuous(limits = c(0, 1.7), expand = c(0, 0)) +
  guides(y = "none") +
  labs(title = dcant_pgc_scaled_label) +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        plot.title = element_text(hjust = 0.5))


newdat <- tibble(layer_data(g2))

change_basin <- 
  newdat %>% 
  select(x, alluvium, count) %>% 
  group_by(alluvium) %>% 
  arrange(x) %>% 
  mutate(dcant_change = round(100*(count - lag(count)) / lag(count))) %>% 
  ungroup()

coord_basin <- newdat %>%
  select(x, y, alluvium)

new_layer_basin <- left_join(
  change_basin %>% drop_na(),
  coord_basin
)

new_layer_basin <- new_layer_basin %>% 
  mutate(dcant_change = as.character(dcant_change),
         dcant_change = if_else(str_detect(dcant_change, "-"),
                                dcant_change,
                                paste0("+", dcant_change)),
         dcant_change = paste(dcant_change, "%"))

new_layer_total <- 
  newdat %>% 
  select(x, alluvium, count) %>% 
  group_by(x) %>% 
  summarise(dcant_change = sum(count)) %>% 
  ungroup()

new_layer_total <- new_layer_total %>% 
  mutate(y = dcant_change,
         dcant_change = as.character(round(dcant_change,2)),
         dcant_change = paste("global:",dcant_change))

g2 +
  geom_text(data = new_layer_basin,
            aes(
              x = x - 0.3,
              y = y,
              label = dcant_change
            ),
            inherit.aes = FALSE) +
  geom_label(data = new_layer_total,
            aes(
              x = x,
              y = y + 0.1,
              label = dcant_change
            ),
            inherit.aes = FALSE)


```


```{r budgets_basins_hemisphere_alluvial_order_basin_scaled_incl_sabine_uncertainty, fig.asp=0.9, eval=FALSE}

g2 <- dcant_budget_basin_MLR_all_plot %>%
  ggplot(aes(
    y = beta,
    x = period,
    alluvium = basin,
    fill  = basin,
    stratum = basin,
    label = basin
  )) +
  geom_alluvium() +
  geom_stratum() +
  ggrepel::geom_label_repel(
    data = dcant_budget_basin_MLR_all_plot %>% filter(period == "2004 - 2014"),
    stat = "stratum",
    size = 4,
    nudge_x = .5,
    point.padding = 3,
    aes(fill = basin)
  )+
  scale_fill_brewer(palette = "Paired", guide = "none") +
  scale_color_brewer(palette = "Paired", guide = "none") +
  scale_y_continuous(limits = c(0, 1.6), expand = c(0, 0)) +
  guides(y = "none") +
  labs(title = dcant_pgc_scaled_label) +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        plot.title = element_text(hjust = 0.5))


newdat <- tibble(layer_data(g2))

# construct budget labels

budget_basin <- 
  newdat %>% 
  select(x, y, alluvium, count)

budget_layer_basin <- budget_basin %>% 
  mutate(dcant = as.character(round(count,2)))

# construct uncertainty labels

uncertainty_basin <- 
  dcant_budget_basin_MLR_all_plot %>% 
  mutate(x = fct_recode(period,
                        "2" = "1994 - 2004",
                        "3" = "2004 - 2014")) %>% 
  select(x, alluvium = basin, dcant_sd_scaled) %>% 
  drop_na() %>% 
  arrange(x, alluvium)
  

coord_basin <- newdat %>%
  select(x, y, alluvium) %>% 
  filter(x != 1)

uncertainty_layer_basin <- bind_cols(
  coord_basin,
  uncertainty_basin %>% select(dcant_sd_scaled),
)

# construct change labels

change_basin <- 
  newdat %>% 
  select(x, alluvium, count) %>% 
  group_by(alluvium) %>% 
  arrange(x) %>% 
  mutate(dcant_change_abs = count - lag(count),
         dcant_change = round(100*(dcant_change_abs) / lag(count))) %>% 
  ungroup()

coord_basin <- newdat %>%
  select(x, y, alluvium)

new_layer_basin <- left_join(
  change_basin %>% drop_na(),
  coord_basin
)

new_layer_basin <- new_layer_basin %>% 
  mutate(dcant_change = as.character(dcant_change),
         dcant_change = if_else(str_detect(dcant_change, "-"),
                                dcant_change,
                                paste0("+", dcant_change)),
         dcant_change = paste0(dcant_change, "%"))

# construct global budget labels

new_layer_total <- 
  newdat %>% 
  select(x, alluvium, count) %>% 
  group_by(x) %>% 
  summarise(dcant_change = sum(count)) %>% 
  ungroup()

dcant_sd_scaled <- round(c(
  0.24,
  dcant_budget_global_all_ensemble_summary %>%
    pull(dcant_sd_scaled)
), 2)

new_layer_total <- bind_cols(new_layer_total, dcant_sd_scaled = dcant_sd_scaled)

new_layer_total <- new_layer_total %>% 
  mutate(y = dcant_change,
         dcant_sd_scaled_rel = round(100 * dcant_sd_scaled/dcant_change),
         dcant_change = as.character(round(dcant_change,2)),
         dcant_sd_scaled = round(dcant_sd_scaled,1),
         dcant_change = paste0(dcant_change, "\n(±", dcant_sd_scaled, ")"))

# basin change + uncertainty

budget_layer_basin <- full_join(budget_layer_basin,
                                uncertainty_layer_basin)

budget_layer_basin <- 
  budget_layer_basin %>% 
  mutate(dcant_sd_scaled_rel = 100*dcant_sd_scaled/count,
         dcant_sd_scaled_rel = as.character(round(dcant_sd_scaled_rel)),
         dcant_sd_scaled_numeric = dcant_sd_scaled,
         dcant_sd_scaled = round(dcant_sd_scaled, 2),
         dcant_sd_scaled = paste0("(±", dcant_sd_scaled, ")"),
         dcant_label = if_else(dcant_sd_scaled != "(±NA)",
                               paste0(dcant, "\n", dcant_sd_scaled),
                               dcant))


# uncertainty changes

uncertainty_changes <- budget_layer_basin %>% 
  select(x, alluvium, dcant_sd_scaled = dcant_sd_scaled_numeric) %>% 
  group_by(alluvium) %>% 
  mutate(dcant_change_uncert = sqrt(dcant_sd_scaled^2 + lag(dcant_sd_scaled)^2)) %>% 
  ungroup()


new_layer_basin <- left_join(new_layer_basin, uncertainty_changes) %>% 
  mutate(dcant_change_uncert_rel = 100*dcant_change_uncert/abs((count + lag(count))/2),
         dcant_change_label = if_else(!is.na(dcant_change_uncert),
                                      paste0(dcant_change, "\n(±", round(dcant_change_uncert_rel), "%)"),
                                      dcant_change))


g2 +
  geom_text(data = budget_layer_basin,
            aes(
              x = x,
              y = y,
              label = dcant_label
            ),
            size = 3,
            inherit.aes = FALSE) +
  geom_text(data = new_layer_basin,
            aes(
              x = x - 0.3,
              y = y,
              label = dcant_change_label
            ),
            size = 4,
            inherit.aes = FALSE)
  # geom_label(data = new_layer_total,
  #           aes(
  #             x = x,
  #             y = y + 0.13,
  #             label = dcant_change
  #           ),
  #           size = 4,
  #           inherit.aes = FALSE)



# ggsave(path = here::here("output/publication"),
#        filename = "Fig_budget_beta_basin_hemisphere.png",
#        height = 6,
#        width = 8)



```



## Depth layer

```{r depth_layer_budget_basin_MLR_standard_case, fig.asp=0.9}

dcant_budget_change <- dcant_budget_basin_MLR_layer_all %>%
  filter(estimate == "dcant",
         period != "1994 - 2014",
         inv_depth <= 3000,
         data_source == "obs") %>%
  rename(dcant = value) %>%
  select(-c(tref1, tref2, Version_ID)) %>%
  pivot_wider(names_from = period,
              values_from = dcant) %>%
  mutate(sign = if_else(`2004 - 2014` - `1994 - 2004` > 0,
                        "increase",
                        "decrease"))

dcant_budget_layer <- dcant_budget_basin_MLR_layer_all %>%
  filter(estimate == "dcant",
         period != "1994 - 2014",
         inv_depth <= 3400,
         data_source == "obs") %>%
  rename(dcant = value) %>%
  group_by(basin, period, data_source) %>% 
  mutate(dcant = if_else(is.na(lead(dcant)), 888, dcant),
         dcant = na_if(dcant, 888)) %>%
  fill(dcant) %>% 
  ungroup()

dcant_budget_layer %>%
  ggplot() +
  geom_hline(yintercept = 0) +
  geom_rect(
    data = dcant_budget_change,
    aes(
      xmin = inv_depth - 250,
      xmax = inv_depth + 250,
      ymin = `1994 - 2004`,
      ymax = `2004 - 2014`,
      fill = sign
    ),
    alpha = 0.4
  ) +
  geom_step(aes(inv_depth - 250, dcant, col = period), direction = "vh",
            size = 1) +
  coord_flip() +
  scale_x_reverse(breaks = seq(0, 3000, 500)) +
  scale_color_brewer(palette = "Set1", direction = -1, name = "period") +
  scale_fill_brewer(palette = "Set1", direction = -1, name = "") +
  facet_wrap(~ basin, ncol = 3, dir = "v") +
  labs(y = dcant_layer_budget_label,
       x = "Depth (m)") +
      theme(legend.position = c(0.8,0.2))


```

```{r depth_layer_budget_basin_MLR_ensemble, fig.asp=0.9}



dcant_budget_basin_MLR_layer_all_uncertainty <-
  dcant_budget_basin_MLR_layer_all_ensemble %>%
  filter(estimate == "dcant",
         period != "1994 - 2014",
         inv_depth <= 3400) %>%
  rename(dcant = value) %>%
  select(-c(method, estimate, Version_ID, tref1, tref2)) %>%
  group_by(basin, period, data_source, MLR_basins, Version_ID_group) %>%
  mutate(dcant = if_else(is.na(lead(dcant)), 888, dcant),
         dcant = na_if(dcant, 888)) %>%
  fill(dcant) %>%
  ungroup()

dcant_budget_basin_MLR_layer_all_uncertainty <- additive_uncertainty(dcant_budget_basin_MLR_layer_all_uncertainty)

delta_dcant_budget_basin_MLR_layer_all_uncertainty <- dcant_budget_basin_MLR_layer_all_uncertainty[[3]]
dcant_budget_basin_MLR_layer_all_uncertainty_contributions <- dcant_budget_basin_MLR_layer_all_uncertainty[[2]]
dcant_budget_basin_MLR_layer_all_uncertainty <- dcant_budget_basin_MLR_layer_all_uncertainty[[1]]

p_dcant_budget_depth_layer <- 
dcant_budget_basin_MLR_layer_all_uncertainty %>%
  filter(data_source == "obs") %>% 
  ggplot() +
  geom_hline(yintercept = 0, size = 0.1) +
  geom_rect(
    aes(
      xmin = inv_depth - 250,
      xmax = inv_depth + 250,
      ymin = std_case - sd*sd_factor,
      ymax = std_case + sd*sd_factor,
      fill = period
    ),
    alpha = 0.5
  ) +
  geom_step(aes(inv_depth - 250, std_case, col = period), direction = "vh",
            size = 1) +
  coord_flip() +
  scale_x_reverse(breaks = seq(0, 3000, 500), limits = c(3000, 0), expand = c(0,0)) +
  scale_color_manual(values = c("#EE7733", "#009988"), name = "Mean \u00B1 2σ") +
  scale_fill_manual(values = c("#EE7733", "#009988"), name = "Mean \u00B1 2σ") +
  labs(y = dcant_layer_budget_label,
       x = "Depth (m)") +
  facet_wrap(~ basin, ncol = 3, dir = "v", scales = "free_x") +
  theme(legend.position = c(0.9, 0.1))

p_dcant_budget_depth_layer

p_dcant_profiles + p_dcant_budget_depth_layer +
  plot_layout(ncol = 1) +
  plot_annotation(tag_levels = 'A')

ggsave(path = here::here("output/publication"),
       filename = "Fig_dcant_profiles_and_depth_layer_budget.png",
       height = 12,
       width = 8)

```

```{r depth_layer_budget_basin_MLR_ensemble_mod, fig.asp=0.9}


p_dcant_budget_depth_layer_mod <- 
dcant_budget_basin_MLR_layer_all_uncertainty %>%
  filter(data_source != "obs") %>% 
  mutate(data_source = case_when(
    data_source == "mod" ~ "Reconstruction",
    data_source == "mod_truth" ~ "Model truth"
  )) %>%  
  ggplot() +
  geom_hline(yintercept = 0, size = 0.1) +
  geom_rect(
    aes(
      xmin = inv_depth - 250,
      xmax = inv_depth + 250,
      ymin = std_case - sd*sd_factor,
      ymax = std_case + sd*sd_factor,
      fill = data_source
    ),
    alpha = 0.5
  ) +
  geom_step(aes(inv_depth - 250, std_case, col = data_source), direction = "vh",
            size = 1) +
  coord_flip() +
  scale_x_reverse(breaks = seq(0, 3000, 500), limits = c(3000, 0), expand = c(0,0)) +
  scale_color_manual(values = c("#009988", "#EE7733"), name = "Mean \u00B1 2σ") +
  scale_fill_manual(values = c("#009988", "#EE7733"), name = "Mean \u00B1 2σ") +
  labs(y = dcant_layer_budget_label,
       x = "Depth (m)") +
  facet_grid(period ~ basin, scales = "free_x") +
  theme(legend.position = "none")



p_dcant_budget_depth_layer_mod

p_dcant_profiles_mod + p_dcant_budget_depth_layer_mod +
  plot_layout(ncol = 1) +
  plot_annotation(tag_levels = 'A')

ggsave(path = here::here("output/publication"),
       filename = "FigS_dcant_profiles_and_depth_layer_budget_synthetic_data.png",
       height = 10,
       width = 7)

```

```{r dcant_layer_budget_stats, eval=FALSE}

dcant_budget_basin_MLR_layer_all_ensemble_stat <-
dcant_budget_basin_MLR_layer_all_ensemble %>%
  filter(estimate == "dcant",
         data_source == "obs",
         inv_depth < 3000,
         period %in% two_decades) %>% 
  group_by(basin,
           period,
           inv_depth) %>%
  summarise(dcant_sd = sd(value) * 2) %>%
  ungroup()

dcant_layer_budget_stat <-
  full_join(
    dcant_budget_basin_MLR_layer_all %>%
      filter(
        estimate == "dcant",
        data_source == "obs",
        inv_depth < 3000,
        period %in% two_decades
      ) %>% 
      select(basin, period, inv_depth, dcant = value),
    dcant_budget_basin_MLR_layer_all_ensemble_stat
  )  

rm(dcant_budget_basin_MLR_layer_all_ensemble_stat)  

dcant_layer_budget_stat %>%
  filter(period %in% two_decades) %>%
  arrange(period) %>% 
  group_by(basin, inv_depth) %>%
  mutate(delta_dcant = dcant - lag(dcant),
         RSS = sqrt(dcant_sd ^ 2 + lag(dcant_sd ^ 2))) %>%
  ungroup() %>%
  drop_na() %>% 
  filter(abs(delta_dcant) >= RSS) %>% 
  select(basin, inv_depth, delta_dcant, RSS) %>% 
  kable() %>%
  kable_styling() %>%
  scroll_box(height = "300px")


```






```{r depth_layer_budget_basin_MLR_cumulative, fig.asp=0.9}

dcant_budget_change <- dcant_budget_basin_MLR_layer_all %>%
  filter(estimate == "dcant",
         period != "1994 - 2014",
         inv_depth <= 3000,
         data_source == "obs") %>%
  rename(dcant = value) %>%
  arrange(inv_depth) %>% 
  group_by(data_source, basin, period) %>% 
  mutate(dcant_cum = cumsum(dcant)) %>% 
  ungroup() %>%
  select(-c(tref2, Version_ID, dcant)) %>%
  pivot_wider(names_from = period,
              values_from = dcant_cum) %>%
  mutate(sign = if_else(`2004 - 2014` - `1994 - 2004` > 0,
                        "increase",
                        "decrease"))

dcant_budget_layer <- dcant_budget_basin_MLR_layer_all %>%
  filter(estimate == "dcant",
         period != "1994 - 2014",
         inv_depth <= 3400,
         data_source == "obs") %>%
  rename(dcant = value) %>%
  arrange(inv_depth) %>% 
  group_by(data_source, basin, period) %>% 
  mutate(dcant_cum = cumsum(dcant)) %>% 
  ungroup() %>%
  group_by(basin, period, data_source) %>% 
  mutate(dcant_cum = if_else(is.na(lead(dcant_cum)), 888, dcant_cum),
         dcant_cum = na_if(dcant_cum, 888)) %>%
  fill(dcant_cum) %>% 
  ungroup()



dcant_budget_layer %>%
  ggplot() +
  geom_hline(yintercept = 0) +
  geom_rect(
    data = dcant_budget_change,
    aes(
      xmin = inv_depth - 250,
      xmax = inv_depth + 250,
      ymin = `1994 - 2004`,
      ymax = `2004 - 2014`,
      fill = sign
    ),
    alpha = 0.3
  ) +
  geom_step(aes(inv_depth - 250, dcant_cum, col = period), direction = "vh",
            size = 1) +
  coord_flip() +
  scale_x_reverse(breaks = seq(0, 3000, 500)) +
  scale_color_brewer(palette = "Set1",
                     direction = -1,
                     name = "Decade") +
  scale_fill_brewer(palette = "Set1",
                    direction = -1,
                    name = "Decadal change") +
  
  facet_wrap( ~ basin, ncol = 3, dir = "v") +
  labs(y = dcant_layer_budget_label,
       x = "Depth (m)",
       title = "Cumulative layer inventory change") +
      theme(legend.position = c(0.8,0.2))

```

# Time series

## eMLR only

```{r dcant_budget_time_series_member_connections}



dcant_budget_global_all_ensemble <-
  dcant_budget_basin_MLR_all_ensemble %>% 
  filter(basin == "Global")

dcant_budget_global_all_ensemble %>% 
  filter(data_source == "obs",
         period != "1994 - 2014") %>% 
  ggplot(aes(tref2, dcant, group = interaction(MLR_basins, Version_ID_group),
             col=Version_ID_group)) +
  geom_path() +
  geom_point()

dcant_budget_global_all_ensemble %>% 
  filter(data_source == "obs") %>% 
  select(MLR_basins, Version_ID_group, period, dcant) %>% 
  pivot_wider(names_from = period,
              values_from = dcant) %>% 
  ggplot(aes(`1994 - 2004`, `2004 - 2014`,
             col=MLR_basins)) +
  coord_equal() +
  geom_point() +
  facet_wrap(~ Version_ID_group)

dcant_budget_global_all_ensemble %>% 
  filter(data_source == "obs") %>% 
  select(MLR_basins, Version_ID_group, period, dcant) %>% 
  pivot_wider(names_from = period,
              values_from = dcant) %>% 
  ggplot(aes(`1994 - 2004`, `2004 - 2014`,
             col=Version_ID_group)) +
  coord_equal() +
  geom_point() +
  facet_wrap(~ MLR_basins)

dcant_budget_global_all_ensemble %>% 
  filter(data_source == "obs") %>% 
  select(MLR_basins, Version_ID_group, period, dcant) %>% 
  pivot_wider(names_from = period,
              values_from = dcant) %>% 
  ggplot(aes(`1994 - 2004`, `1994 - 2014`,
             col=Version_ID_group)) +
  coord_equal() +
  geom_point()

dcant_budget_global_all_ensemble %>% 
  filter(data_source == "obs") %>% 
  select(MLR_basins, Version_ID_group, period, dcant) %>% 
  pivot_wider(names_from = period,
              values_from = dcant) %>% 
  ggplot(aes(`1994 - 2004` + `2004 - 2014`, `1994 - 2014`,
             col=Version_ID_group)) +
  geom_abline(intercept = 0, slope = 1) +
  coord_equal() +
  scale_x_continuous(breaks = seq(0,100,1)) +
  scale_y_continuous(breaks = seq(0,100,1)) +
  geom_point()

```


```{r mean_tcant_over_time, fig.asp=0.6}

dcant_budget_global_ts <- dcant_budget_basin_MLR_all %>%
  filter(basin == "Global",
         data_source == "obs",
         period  %in% two_decades) %>% 
  select(year = tref2, dcant_mean = dcant)


dcant_budget_global_all_ensemble_summary <-
  dcant_budget_basin_MLR_all_ensemble %>%
  filter(period %in% c("1994 - 2004", "1994 - 2014"),
         data_source == "obs",
         basin == "Global") %>%
  group_by(data_source, tref2, period) %>%
  summarise(#dcant_mean = mean(dcant),
            dcant_sd = sd(dcant)*sd_factor) %>%
  ungroup()

dcant_budget_global_ts <- left_join(dcant_budget_global_ts,
                                    dcant_budget_global_all_ensemble_summary %>% 
                                      select(year = tref2, dcant_sd))


tcant_S04 <- bind_cols(year = 1994, dcant_mean = 118, dcant_sd = 19)

tcant_ts <- full_join(dcant_budget_global_ts, tcant_S04)

tcant_ts <- left_join(tcant_ts, co2_atm)

co2_atm_pi <- bind_cols(pCO2 = 280, dcant_mean = 0, year = 1800, dcant_sd = NA)

tcant_ts <- full_join(tcant_ts, co2_atm_pi)


tcant_ts <- tcant_ts %>%
  arrange(year) %>%
  mutate(
    tcant = cumsum(dcant_mean),
    tcant_sd = sqrt(dcant_sd ^ 2 + nth(dcant_sd,2) ^ 2)
  ) %>%
  mutate(
    tcant_sd = case_when(
      year == 1800 ~ 0,
      year == 1994 ~ dcant_sd,
      TRUE ~ tcant_sd
    ),
    dcant_sd_int = dcant_sd,
    dcant_sd = case_when(
      year == 1994 ~ 0,
      TRUE ~ dcant_sd
    )
  )

beta <- 1.57
co2_atm_pi_value <- 283
atm_co2_col <- "#CC3311"
tcant_col <- "#004488"

p_tcant_year <- tcant_ts %>%
  ggplot(aes(year, tcant)) +
  geom_line(data = co2_atm_reccap2 %>% filter(year > 1790),
            aes(year, (pCO2 - co2_atm_pi_value) * beta),
            col = atm_co2_col) +
  geom_linerange(aes(
    ymin = tcant - dcant_sd_int,
    ymax = tcant + dcant_sd_int,
    col = "Estimate\n±\ninterval\nuncertainty"
  ), size = 1) +
  geom_point(fill = "white", shape = 21,
             aes(col = "Estimate\n±\ninterval\nuncertainty")) +
  scale_y_continuous(name = expression(Total ~ oceanic ~ C[ant] ~ (PgC)),
                     sec.axis = sec_axis( ~ (. / beta + co2_atm_pi_value),
                                          name = expression(Atm. ~ pCO[2] ~ (µatm)))) +
  scale_x_continuous(name = "Year", breaks = seq(1800, 2000, 50)) +
  scale_color_manual(values = tcant_col) +
  theme(
    axis.title.y.right = element_text(color = atm_co2_col),
    axis.text.y.right = element_text(color = atm_co2_col),
    axis.ticks.y.right = element_line(color = atm_co2_col), 
    axis.title.y.left = element_text(color = tcant_col),
    axis.text.y.left = element_text(color = tcant_col),
    axis.ticks.y.left = element_line(color = tcant_col), 
    legend.background = element_rect(fill = "transparent"),
    legend.position = c(0.85, 0.2),
    legend.title = element_blank()
  )

p_tcant_year


atm_co2_col <- "transparent"

p_tcant_year_trans <- tcant_ts %>%
  ggplot(aes(year, tcant)) +
  geom_line(data = co2_atm_reccap2 %>% filter(year > 1790),
            aes(year, (pCO2 - co2_atm_pi_value) * beta),
            col = atm_co2_col) +
  geom_linerange(aes(
    ymin = tcant - dcant_sd_int,
    ymax = tcant + dcant_sd_int,
    col = "Estimate\n±\ninterval\nuncertainty"
  ), size = 1) +
  geom_point(fill = "white", shape = 21,
             aes(col = "Estimate\n±\ninterval\nuncertainty")) +
  scale_y_continuous(name = expression(Total ~ oceanic ~ C[ant] ~ (PgC)),
                     sec.axis = sec_axis( ~ (. / beta + co2_atm_pi_value),
                                          name = expression(Atm. ~ pCO[2] ~ (µatm)))) +
  scale_x_continuous(name = "Year", breaks = seq(1800, 2000, 50)) +
  scale_color_manual(values = tcant_col) +
  theme(
    axis.title.y.right = element_text(color = atm_co2_col),
    axis.text.y.right = element_text(color = atm_co2_col),
    axis.ticks.y.right = element_line(color = atm_co2_col),
    axis.title.y.left = element_text(color = tcant_col),
    axis.text.y.left = element_text(color = tcant_col),
    axis.ticks.y.left = element_line(color = tcant_col),
    legend.background = element_rect(fill = "transparent"),
    legend.position = c(0.85, 0.2),
    legend.title = element_blank()
  )

p_tcant_year_trans

```

```{r mean_tcant_over_atm_co2, fig.asp=1}

atm_co2_col <- "#CC3311"

p_tcant_atm_co2 <- tcant_ts %>%
  ggplot(aes(pCO2, tcant)) +
  geom_ribbon(aes(
    ymin = tcant - tcant_sd,
    ymax = tcant + tcant_sd,
    fill = "1800 - 2014",
    alpha = "1800 - 2014"
  )) +
  geom_ribbon(aes(
    ymin = tcant - dcant_sd,
    ymax = tcant + dcant_sd,
    fill = "1994 - 2014",
    alpha = "1994 - 2014"
  )) +
  geom_line(color = tcant_col) +
  geom_point(shape = 21, fill = "white", color = tcant_col) +
  scale_x_continuous(breaks = seq(280, 400, 30)) +
  scale_fill_manual(values = c(tcant_col, tcant_col), name = "Cumulative\nuncertainty") +
  scale_alpha_manual(values = c(0.2, 0.6), name = "Cumulative\nuncertainty") +
  scale_color_manual(values = "black", name = "") +
  geom_text(aes(label = year), nudge_x = -6, nudge_y = 6) +
  labs(x = expression(Atmospheric ~ pCO[2] ~ (µatm)),
       y = expression(Total ~ oceanic ~ C[ant] ~ (PgC))) +
  theme(
    axis.title.y.left = element_text(color = tcant_col),
    axis.text.y.left = element_text(color = tcant_col),
    axis.ticks.y.left = element_line(color = tcant_col),
    legend.background = element_rect(fill = "transparent"),
    legend.position = c(0.85, 0.25),
    axis.title.x = element_text(color = atm_co2_col),
    axis.text.x = element_text(color = atm_co2_col),
    axis.ticks.x = element_line(color = atm_co2_col)
  )

p_tcant_year / p_tcant_atm_co2 + 
  plot_annotation(tag_levels = 'A')

ggsave(path = here::here("output/publication"),
       filename = "Fig_dcant_budget_global_vs_atm_pCO2.png",
       height = 6,
       width = 7)


p_tcant_year / p_tcant_atm_co2

ggsave(path = here::here("output/presentation"),
       filename = "Fig_dcant_budget_global_vs_atm_pCO2.png",
       height = 6,
       width = 7)

p_tcant_year_trans / p_tcant_atm_co2

ggsave(path = here::here("output/presentation"),
       filename = "Fig_dcant_budget_global_vs_atm_pCO2_trans.png",
       height = 6,
       width = 7)

```

```{r beta_factors}

tcant_ts %>% 
  mutate(beta = dcant_mean / (pCO2-lag(pCO2)))

```



## incl fluxes

```{r exclude_Watson_from_GCB}

Ocean_Sink <- Ocean_Sink %>%
  filter(product != "Watson")

```


```{r GCB_carbon_sink_cum_1994_2007_reference}

Ocean_Sink_cum_1994 <-
  Ocean_Sink %>%
  filter(year >= 1994, year <= 2007) %>%
  mutate(fgco2_glob = if_else(year == 1994, 0, GtC_yr),
         fgco2_glob = fgco2_glob) %>% 
  arrange(year) %>%
  group_by(product, type) %>%
  mutate(fgco2_glob_cum = cumsum(fgco2_glob)) %>%
  ungroup()

Ocean_Sink_cum_1994 <-
  left_join(Ocean_Sink_cum_1994,
            co2_atm) 


Ocean_Sink_cum_1994 %>%
  group_split(type) %>%
  map(
    ~ ggplot(data = .x, aes(pCO2, fgco2_glob_cum, col = product)) +
      geom_line() +
      geom_point(shape = 21, fill = "white") +
      theme(legend.position = "bottom") +
      facet_grid(. ~ type)
  )

Ocean_Sink_cum_1994 <- Ocean_Sink_cum_1994 %>% 
  mutate(fgco2_glob_cum_total = fgco2_glob_cum + 118) %>%
  select(year, pCO2, product, fgco2_glob_cum, fgco2_glob_cum_total, type)

Ocean_Sink_cum_1994 <- Ocean_Sink_cum_1994 %>% 
  mutate(type = case_when(
    type == "data_products" ~ "Observation-based\nsurface flux\nproducts",
    TRUE ~ "Global Ocean\nBiogeochemical Models\n(GOBM)"
  ))

Ocean_Sink_cum_1994 %>% 
  filter(year == 2007) %>% 
  group_by(type) %>% 
  summarise(dcant_sd = sd(fgco2_glob_cum)*2) %>% 
  ungroup()


```

```{r GCB_carbon_sink_cum_1994}

Ocean_Sink_cum_1994 <-
  Ocean_Sink %>%
  filter(year >= 1994, year <= 2014) %>%
  mutate(fgco2_glob = if_else(year == 1994, 0, GtC_yr),
         fgco2_glob = fgco2_glob) %>% 
  arrange(year) %>%
  group_by(product, type) %>%
  mutate(fgco2_glob_cum = cumsum(fgco2_glob)) %>%
  ungroup()

Ocean_Sink_cum_1994 <-
  left_join(Ocean_Sink_cum_1994,
            co2_atm) 

Ocean_Sink_cum_1994 %>%
  group_split(type) %>%
  map(
    ~ ggplot(data = .x, aes(pCO2, fgco2_glob_cum, col = product)) +
      geom_line() +
      geom_point(shape = 21, fill = "white") +
      theme(legend.position = "bottom") +
      facet_grid(. ~ type)
  )


Ocean_Sink_cum_1994 <- Ocean_Sink_cum_1994 %>% 
  mutate(fgco2_glob_cum_total = fgco2_glob_cum + 118) %>%
  select(year, pCO2, product, fgco2_glob_cum, fgco2_glob_cum_total, type)

Ocean_Sink_cum_1994 <- Ocean_Sink_cum_1994 %>% 
  mutate(type = case_when(
    type == "data_products" ~ "Observation-based\nsurface flux\nproducts",
    TRUE ~ "Global Ocean\nBiogeochemical Models\n(GOBM)"
  ))

```

```{r GCB_carbon_sink_cum_2004}

tcant_2004 <- tcant_ts %>% 
  filter(year == 2004) %>% 
  pull(tcant)

Ocean_Sink_cum_2004 <-
  Ocean_Sink %>%
  filter(year >= 2004, year <= 2014) %>%
  mutate(fgco2_glob = if_else(year == 2004, 0, GtC_yr)) %>% 
  arrange(year) %>%
  group_by(product, type) %>%
  mutate(fgco2_glob_cum = cumsum(fgco2_glob)) %>%
  ungroup()

Ocean_Sink_cum_2004 <-
  left_join(Ocean_Sink_cum_2004,
            co2_atm) 

Ocean_Sink_cum_2004 %>%
  group_split(type) %>%
  map(
    ~ ggplot(data = .x, aes(pCO2, fgco2_glob_cum, col = product)) +
      geom_line() +
      geom_point(shape = 21, fill = "white") +
      theme(legend.position = "bottom") +
      facet_grid(. ~ type)
  )


Ocean_Sink_cum_2004 <- Ocean_Sink_cum_2004 %>% 
  mutate(fgco2_glob_cum_total = fgco2_glob_cum + tcant_2004) %>% 
  select(year, pCO2, product, fgco2_glob_cum, fgco2_glob_cum_total, type)

Ocean_Sink_cum_2004 <- Ocean_Sink_cum_2004 %>% 
  mutate(type = case_when(
    type == "data_products" ~ "Observation-based\nsurface flux\nproducts",
    TRUE ~ "Global Ocean\nBiogeochemical Models\n(GOBM)"
  ))

```



```{r mean_tcant_over_atm_co2_incl_fluxes, fig.asp=0.6}

tcant_ts_zoom <- tcant_ts %>%
  filter(year != 1800)

tcant_min = tcant_ts_zoom %>% pull(tcant) %>% min()
tcant_max =
  tcant_ts_zoom %>% pull(tcant) %>% max() +
  tcant_ts_zoom %>% pull(dcant_sd) %>% max() + 0.2

p_tcant_ts_zoom <-
  tcant_ts_zoom %>%
  ggplot(aes(pCO2, tcant)) +
  geom_ribbon(
    aes(ymin = tcant - dcant_sd,
        ymax = tcant + dcant_sd),
    alpha = 0.2,
    fill = tcant_col
  ) +
  geom_ribbon(
    aes(
      ymin = tcant - dcant_sd / 2,
      ymax = tcant + dcant_sd / 2
    ),
    alpha = 0.3,
    fill = tcant_col
  ) +
  geom_line(data = Ocean_Sink_cum_1994,
            aes(pCO2, fgco2_glob_cum_total, group = product, col = type)) +
  geom_point(
    data = Ocean_Sink_cum_1994,
    aes(pCO2, fgco2_glob_cum_total, group = product, col = type),
    size = 0.3
  ) +
  geom_point(
    data = Ocean_Sink_cum_1994 %>% filter(year %in% c(2004, 2014)),
    aes(
      pCO2,
      fgco2_glob_cum_total,
      col = type
    ),
    fill = "white",
    shape = 21
  ) +
  geom_line(aes(col = "eMLR(C*)")) +
  geom_point(aes(col = "eMLR(C*)"),
             shape = 21,
             fill = "white") +
  geom_text(aes(label = year), nudge_x = -2, nudge_y = 3) +
  scale_color_highcontrast(name = "Data source") +
  scale_fill_highcontrast(name = "Data source") +
  scale_y_continuous(limits = c(tcant_min, tcant_max)) +
  labs(x = expression(Atmospheric ~ pCO[2] ~ (µatm)),
       y = expression(Total ~ oceanic ~ carbon ~ storage ~ since ~ 1800 ~ (PgC))) +
  guides(colour = guide_legend(order = 1),
         fill = "none") +
  theme_classic() +
  theme(
    legend.background = element_rect(fill = "transparent"),
    legend.position = c(0.25, 0.83),
    legend.title = element_blank(),
    legend.box.just = "top",
    legend.box = "horizontal",
    legend.key.size = unit(2.5, 'lines'),
    panel.grid.major.y = element_line(colour = "black",
                                      size = 0.1)
  )

p_tcant_ts_zoom


```

```{r mean_tcant_over_atm_co2_incl_fluxes_boxplot, fig.asp=0.6}

dcant_type_box <-
  bind_rows(
    dcant_budget_basin_MLR_all_ensemble %>%
      filter(basin == "Global",
             data_source == "obs") %>%
      select(period, dcant) %>%
      mutate(type = "eMLR(C*)",
             dcant = dcant + 118,
             dcant = if_else(period == "2004 - 2014",
                             dcant + tcant_2004 - 118,
                             dcant)),
    Ocean_Sink_cum_1994 %>%
      filter(year %in% c(2004, 2014)) %>%
      mutate(period = if_else(year == 2004,
                              "1994 - 2004",
                              "1994 - 2014")) %>%
      select(period, dcant = fgco2_glob_cum_total, type),
    Ocean_Sink_cum_2004 %>%
      filter(year %in% c(2014)) %>%
      mutate(period = if_else(year == 2014,
                              "2004 - 2014",
                              "other")) %>%
      select(period, dcant = fgco2_glob_cum_total, type)
  )

dcant_type_box_stat <- dcant_type_box %>% 
  group_by(period, type) %>% 
  summarise(dcant_mean = mean(dcant),
            dcant_sd = sd(dcant)) %>% 
  ungroup()

dcant_type_box_stat <-
left_join(
  dcant_type_box_stat,
  dcant_budget_basin_MLR_all %>%
    filter(basin == "Global",
             data_source == "obs") %>%
    mutate(
      dcant = dcant + 118,
      dcant = if_else(period == "2004 - 2014",
                      dcant + tcant_2004 - 118,
                      dcant)
    ) %>%
    select(period, dcant_st_case = dcant)
)

dcant_type_box_stat <- dcant_type_box_stat %>% 
  mutate(dcant_mean = if_else(type == "eMLR(C*)",
                              dcant_st_case,
                              dcant_mean)) %>% 
  select(-dcant_st_case)

p_tcant_box <-
dcant_type_box %>%
  filter(period == "1994 - 2014") %>%
  ggplot(aes(period, dcant)) +
 geom_crossbar(
    data = dcant_type_box_stat %>%
      filter(period == "1994 - 2014"),
    position = position_dodge(width = 1),
    aes(
      x = period,
      y = dcant_mean,
      ymin = dcant_mean - dcant_sd,
      ymax = dcant_mean + dcant_sd,
      col = type,
      fill = type
    ), width = 0.7, alpha = 0.4
  ) +
  geom_crossbar(
    data = dcant_type_box_stat %>%
      filter(period == "1994 - 2014"),
    position = position_dodge(width = 1),
    aes(
      x = period,
      y = dcant_mean,
      ymin = dcant_mean - dcant_sd*2,
      ymax = dcant_mean + dcant_sd*2,
      col = type,
      fill = type
    ), width = 0.7, alpha = 0.2
  ) +
  geom_point(aes(fill = type),
              position = position_jitterdodge(
                dodge.width = 1,
                jitter.width = 0.1),
              shape = 21,
              alpha = 0.5) +
  scale_fill_highcontrast(
    name = "Data source",
    guide = "none"
  ) +
  scale_color_highcontrast(
    name = "Data source",
    guide = "none"
  ) +
  scale_y_continuous(limits = c(tcant_min, tcant_max)) +
  labs(x = "20yr period") +
  theme_classic() +
  theme(
    axis.line.y.left = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank(),
    axis.title.y = element_blank(),
    panel.grid.major.y = element_line(colour = "black",
                                      size = 0.1)
  )

p_tcant_box_10 <-
  dcant_type_box %>%
  filter(period != "1994 - 2014") %>%
  ggplot(aes(period, dcant)) +
  geom_crossbar(
    data = dcant_type_box_stat %>%
      filter(period != "1994 - 2014"),
    position = position_dodge(width = 1),
    aes(
      x = period,
      y = dcant_mean,
      ymin = dcant_mean - dcant_sd,
      ymax = dcant_mean + dcant_sd,
      col = type,
      fill = type
    ),
    width = 0.7,
    alpha = 0.4
  ) +
  geom_crossbar(
    data = dcant_type_box_stat %>%
      filter(period != "1994 - 2014"),
    position = position_dodge(width = 1),
    aes(
      x = period,
      y = dcant_mean,
      ymin = dcant_mean - dcant_sd * 2,
      ymax = dcant_mean + dcant_sd * 2,
      col = type,
      fill = type
    ),
    width = 0.7,
    alpha = 0.2
  ) +
  geom_point(
    aes(fill = type),
    position = position_jitterdodge(dodge.width = 1,
                                    jitter.width = 0.1),
    shape = 21,
    alpha = 0.5
  ) +
  geom_point(
    data = dcant_type_box_stat %>%
      filter(period != "1994 - 2014"),
    position = position_dodge(width = 1),
    aes(x = period,
        y = dcant_mean,
        col = type),
    fill = "white",
    shape = 21,
    size = 2
  ) +
  scale_fill_highcontrast(name = "Data source",
                          guide = "none") +
  scale_color_highcontrast(name = "Data source",
                           guide = "none") +
  scale_y_continuous(limits = c(tcant_min, tcant_max)) +
  labs(x = "10yr periods") +
  theme_classic() +
  theme(
    axis.line.y.left = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank(),
    axis.title.y = element_blank(),
    panel.grid.major.y = element_line(colour = "black",
                                      size = 0.1)
  )

p_tcant_ts_zoom + p_tcant_box + p_tcant_box_10 +
  plot_layout(ncol = 3, widths = c(6,1,1.8)) + 
  plot_annotation(tag_levels = 'A')

ggsave(path = here::here("output/publication"),
       filename = "Fig_dcant_budget_global_vs_GCB_ocean_sink.png",
       height = 6,
       width = 9)

p_tcant_ts_zoom + p_tcant_box_10 +
  plot_layout(ncol = 2, widths = c(6,1.8))

ggsave(path = here::here("output/presentation"),
       filename = "Fig_dcant_budget_global_vs_GCB_ocean_sink.png",
       height = 6,
       width = 9)

dcant_type_significance <- dcant_type_box_stat %>%
  mutate(dcant_mean = dcant_mean - 118,
         dcant_mean = if_else(period == "2004 - 2014",
                         dcant_mean - (tcant_2004 - 118),
                         dcant_mean),
         dcant_sd = dcant_sd * 2) %>%
  group_by(period) %>%
  mutate(
    dcant_diff = dcant_mean - first(dcant_mean),
    dcant_diff_rel = 100 * dcant_diff / first(dcant_mean),
    dcant_diff_sd = sqrt(dcant_sd ^ 2 + first(dcant_sd) ^ 2),
    dcant_diff_sd_comparison = dcant_diff_sd - abs(dcant_diff)
  ) %>%
  ungroup()

dcant_type_significance %>% 
  kable() %>%
  kable_styling() %>%
  scroll_box(height = "300px")

# Ocean_Sink %>% 
#   filter(between(year, 1994, 2007)) %>% 
#   arrange(year) %>% 
#   group_by(product) %>% 
#   mutate(GtC = cumsum(GtC_yr)) %>% 
#   ungroup() %>% 
#   # ggplot(aes(year, GtC, col=product)) +
#   # geom_line() %>% 
#   filter(year == 2007) %>% 
#   summarise(sd(GtC)*2)

```


```{r mean_tcant_over_atm_co2_incl_fluxes_mean, fig.asp=0.6}

Ocean_Sink_cum_1994_ensemble_mean <- Ocean_Sink_cum_1994 %>% 
  group_by(year, pCO2, type) %>% 
  summarise(fgco2_glob_cum_total_mean = mean(fgco2_glob_cum_total),
            fgco2_glob_cum_total_sd = sd(fgco2_glob_cum_total)) %>% 
  ungroup()

p_tcant_ts_zoom <-
tcant_ts_zoom %>%
  ggplot() +
  geom_ribbon(aes(pCO2, tcant,
                  ymin = tcant - dcant_sd,
                  ymax = tcant + dcant_sd,
              fill = "eMLR(C*)"),
              alpha = 0.2) +
  geom_ribbon(
    aes(pCO2, tcant,
        ymin = tcant - dcant_sd / 2,
        ymax = tcant + dcant_sd / 2,
              fill = "eMLR(C*)"),
    alpha = 0.3
  ) +
  # geom_ribbon(
  #   data = Ocean_Sink_cum_1994_ensemble_mean,
  #   aes(
  #     pCO2,
  #     ymin = fgco2_glob_cum_total_mean - fgco2_glob_cum_total_sd,
  #     ymax = fgco2_glob_cum_total_mean + fgco2_glob_cum_total_sd,
  #     fill = type
  #   ),
  #   alpha = 0.3
  # ) +
    geom_line(data = Ocean_Sink_cum_1994,
            aes(pCO2, fgco2_glob_cum_total, group = product, col = type), size = 0.3) +
  geom_line(data = Ocean_Sink_cum_1994_ensemble_mean,
            aes(pCO2, fgco2_glob_cum_total_mean, col = type), size = 2) +
  geom_point(
    data = Ocean_Sink_cum_1994_ensemble_mean,
    aes(pCO2, fgco2_glob_cum_total_mean, col = type), size = 1,
    shape = 21,
    fill = "white"
  ) +
  geom_point(
    data = Ocean_Sink_cum_1994_ensemble_mean %>% filter(year %in% c(2004, 2014)),
    aes(pCO2, fgco2_glob_cum_total_mean, col = type), size = 2,
    shape = 21,
    fill = "white"
  ) +
  # geom_point(
  #   data = Ocean_Sink_cum_1994 %>% filter(year %in% c(2004, 2014)),
  #   aes(
  #     pCO2,
  #     fgco2_glob_cum_total,
  #     col = type
  #   ),
  #   fill = "white",
  #   shape = 21
  # ) +
  geom_line(aes(pCO2, tcant, col = "eMLR(C*)"), size = 2) +
  geom_point(aes(pCO2, tcant, col = "eMLR(C*)"), size = 2,
             shape = 21,
             fill = "white") +
  geom_text(aes(pCO2, tcant, label = year), nudge_x = -2, nudge_y = 3) +
  scale_color_highcontrast(name = "Data source") +
  scale_fill_highcontrast(name = "Data source") +
  scale_y_continuous(limits = c(tcant_min, tcant_max)) +
  labs(
    x = expression(Atmospheric ~ pCO[2] ~ (µatm)),
    y = expression(Total ~ oceanic ~ carbon ~ storage ~ since ~ 1800 ~ (PgC))
  ) +
  guides(colour = guide_legend(order = 1),
         fill = "none") +
  theme_classic() +
  theme(
    legend.background = element_rect(fill = "transparent"),
    legend.position = c(0.25, 0.83),
    legend.title = element_blank(),
    legend.box.just = "top",
    legend.box = "horizontal",
    legend.key.size = unit(2.5, 'lines'),
    panel.grid.major.y = element_line(colour = "black",
                                      size = 0.1)
  )

p_tcant_ts_zoom


```

```{r mean_tcant_over_atm_co2_incl_fluxes_boxplot_ensemble, fig.asp=0.6}

p_tcant_ts_zoom + p_tcant_box_10 +
  plot_layout(ncol = 2, widths = c(6,1.8))

ggsave(path = here::here("output/presentation"),
       filename = "Fig_dcant_budget_global_vs_GCB_ocean_sink_ensemble.png",
       height = 6,
       width = 9)


```

# Revelle changes

```{r revelle_changes}

delta_revelle <- co2_atm %>%
  mutate(revelle = seacarb::buffer(24,
                                   pCO2,
                                   2300 * 1e-6)$BetaD,
         DIC = seacarb::carb(24,
                                   pCO2,
                                   2300 * 1e-6)$DIC,
         delta_DIC = (1/pCO2) * DIC * (1/revelle) *1e6,
         delta_DIC_rel = delta_DIC / mean(delta_DIC),
         delta_DIC_rel_cum = delta_DIC_rel - first(delta_DIC_rel),
         delta_year = year - first(year))
  
  
delta_revelle %>% 
  ggplot(aes(delta_year, pCO2)) +
  geom_path() +
  geom_point()
  
delta_revelle %>% 
  ggplot(aes(delta_year,1/revelle)) +
  geom_smooth(method = "lm", aes(col="lm"), se = FALSE) +
  geom_path() +
  geom_point()
  
delta_revelle %>% 
  ggplot(aes(delta_year,delta_DIC_rel)) +
  geom_smooth(method = "lm", aes(col="lm"), se = FALSE) +
  geom_path() +
  geom_point()
  
delta_revelle %>% 
  ggplot(aes(delta_year,delta_DIC_rel_cum)) +
  geom_smooth(method = "lm", aes(col="lm"), se = FALSE) +
  geom_path() +
  geom_point()

min(delta_revelle$delta_DIC_rel_cum / max(delta_revelle$delta_year))

```

# GCB implications

## Land sink

```{r GCB_land_sink_assesment}

flux_label <- expression(CO[2]~flux~(PgC~yr^{-1}))

flux_components <- Global_Carbon_Budget %>% 
  distinct(estimate) %>% 
  pull()

emission_components <- flux_components[c(1,2,6)]
sink_components <- flux_components[3:5]

estimates <- Global_Carbon_Budget %>%
  select(-GtC) %>%
  pivot_wider(names_from = estimate,
              values_from = GtC_yr) %>%
  mutate(`fossil emissions` = 
           `fossil emissions excluding carbonation` - `cement carbonation sink`) %>%
  select(-c(`fossil emissions excluding carbonation`, `cement carbonation sink`)) %>% 
  pivot_longer(-year,
               names_to = "estimate",
               values_to = "GtC_yr")

estimates <- estimates %>%
  filter(!(estimate %in% c("budget imbalance")),
         year >= 1960) %>%
  mutate(
    sign = if_else(estimate %in% sink_components,
                   "sinks",
                   "emissions"),
    GtC_yr = if_else(sign == "sinks",
                     -GtC_yr,
                     GtC_yr)
    # GtC_yr = if_else(estimate == "cement carbonation sink",
    #                  -GtC_yr,
    #                  GtC_yr)
  )

emissions_sinks <- estimates %>% 
  group_by(year, sign) %>% 
  summarise(GtC_yr = sum(GtC_yr)) %>% 
  ungroup()

estimates %>% distinct(estimate) %>% pull()

p_stacked_fluxes <- estimates %>%
  mutate(
    estimate = fct_relevel(
      estimate,
      "fossil emissions",
      "land-use change emissions",
      "atmospheric growth",
      "land sink",
      "ocean sink"
    )
  ) %>%
  ggplot() +
  geom_area(aes(year, GtC_yr, fill = estimate),
            col = "black",
            alpha = 0.7,
            size = 0.5) +
  # geom_line(data = emissions_sinks %>%   mutate(GtC_yr = if_else(sign == "emissions",
  #                                                                -GtC_yr,
  #                                                                GtC_yr)),
  #           aes(year, GtC_yr, linetype = sign)) +
  scale_fill_manual(values = c("#BBBBBB", "#CCBB44", "#66CCEE", "#228833", "#4477AA"),
                    name = "flux component") +
  geom_hline(yintercept = 0) +
  scale_x_continuous(expand = c(0,0)) +
  labs(y = flux_label,
       title = "Carbon emissions and sinks",
       subtitle = "Global Carbon Budget | Friedlingstein et al. (2021)") +
  theme(axis.title.x = element_blank())

p_stacked_fluxes

ggsave(path = here::here("output/presentation"),
       filename = "Fig_GCB_emissions_sinks.png",
       height = 4,
       width = 7)

p_individual_fluxes <- estimates %>%
  ggplot(aes(year, GtC_yr, col = estimate)) +
  geom_hline(yintercept = 0) +
  geom_path() +
  geom_point(size = 0.5) +
  scale_x_continuous(expand = c(0, 0)) +
  scale_color_bright(name = "flux component") +
  labs(y = flux_label,
       title = "Individual flux components from GCB") +
  theme(axis.title.x = element_blank())

p_individual_fluxes


BIM <- emissions_sinks %>% 
  pivot_wider(names_from = sign,
              values_from = GtC_yr) %>% 
  mutate(BIM = emissions + sinks)

p_BIM <- ggplot() +
  geom_line(data = Global_Carbon_Budget %>%
              filter(estimate == "budget imbalance",
                     year >= 1990),
            aes(year, GtC_yr, col = "reported")) +
  geom_line(data = BIM, aes(year, BIM, col = "recalculated")) +
  geom_hline(yintercept = 0) +
  scale_color_brewer(palette = "Set1") +
  scale_x_continuous(expand = c(0, 0)) +
  labs(y = flux_label,
       title = "BIM from GCB") +
  theme(axis.title.x = element_blank(),
        legend.title = element_blank())

p_BIM

p_land_sink_gcb <- estimates %>%
  select(year, estimate, GtC_yr) %>%
  pivot_wider(names_from = estimate,
              values_from = GtC_yr) %>%
  mutate(`land sink residual` = 
           `fossil emissions` + 
           `land-use change emissions` + 
           `atmospheric growth` + 
           `ocean sink`) %>%
  ggplot() +
  geom_line(aes(year, -`land sink residual`, col = "residual")) +
  geom_line(aes(year, `land sink`, col = "reported")) +
  scale_x_continuous(expand = c(0, 0)) +
  scale_color_brewer(palette = "Set1", name = "land sink\nestimate") +
  labs(y = flux_label,
       title = "Land sink estimates from GCB",
       subtitle = "Note: The offset between reported and residual estimate equals BIM") +
  theme(axis.title.x = element_blank(),
        legend.title = element_blank())

p_land_sink_gcb

Ocean_Sink_annual_mean <- Ocean_Sink %>%
  filter(year >= 1990) %>%
  group_by(year, type) %>%
  summarise(GtC_yr = -mean(GtC_yr)) %>%
  ungroup()

Ocean_Sink_annual_mean <- Ocean_Sink_annual_mean %>% 
  pivot_wider(names_from = type,
              values_from = GtC_yr,
              names_prefix = "ocean_sink_")

estimates_wide <- estimates %>%
  select(year, estimate, GtC_yr) %>%
  pivot_wider(names_from = estimate,
              values_from = GtC_yr)

estimates_wide <-
  full_join(estimates_wide, Ocean_Sink_annual_mean)

dcant_interior <- tcant_ts_zoom %>% 
  filter(year > 2000) %>%
  mutate(dcant_mean = dcant_mean/10) %>% 
  pull(dcant_mean)

cnat <-
  dcant_type_significance %>%
  filter(type == "Observation-based\nsurface flux\nproducts" ,
         period %in% two_decades) %>%
  mutate(dcant_diff = dcant_diff/10) %>% 
  pull(dcant_diff)

estimates_wide <- estimates_wide %>% 
  mutate(ocean_sink_interior_Cant = case_when(
    between(year, 1994, 2003) ~ -dcant_interior[1],
    between(year, 2004, 2013) ~ -dcant_interior[2],
    TRUE ~ NaN
  )) %>% 
  mutate(ocean_sink_interior_net = case_when(
    between(year, 1994, 2003) ~ -dcant_interior[1]-cnat[1],
    between(year, 2004, 2013) ~ -dcant_interior[2]-cnat[2],
    TRUE ~ NaN
  ))


p_ocean_sinks <- estimates_wide %>%
  select(year, starts_with("ocean")) %>% 
  rename(GCB_mean = `ocean sink`) %>% 
  pivot_longer(-year,
               names_to = "estimate",
               names_prefix = "ocean_sink_",
               values_to = "GtC_yr") %>% 
  mutate(estimate = str_replace(estimate, "_", " ")) %>% 
  ggplot(aes(year, GtC_yr, col = estimate)) +
  geom_path() +
  geom_point(size = 0.5) +
  scale_x_continuous(expand = c(0, 0)) +
  scale_color_brewer(palette = "Set1", name = "ocean sink\nestimate") +
  labs(y = flux_label,
       title = "Ocean sink estimates",
       subtitle = "Note: Watson et al. (2020) is included in data products and GCB mean") +
  theme(axis.title.x = element_blank(),
        legend.title = element_blank())

p_ocean_sinks

estimates_long <- estimates_wide %>%
  select(year, starts_with("ocean")) %>% 
  rename(GCB_mean = `ocean sink`) %>% 
  pivot_longer(-year,
               names_to = "estimate",
               names_prefix = "ocean_sink_",
               values_to = "GtC_yr") %>% 
  filter(estimate %in% c("data_products", "models"),
         year >= 1990)

p_ocean_sinks_presentation <- estimates_long %>%
  # mutate(estimate = str_replace(estimate, "_", " ")) %>% 
  ggplot() +
  geom_path(data = Ocean_Sink %>% filter(year >= 1990),
            aes(year, GtC_yr, group = product, col = type), size = 0.3) +
  geom_path(aes(year, -GtC_yr, col = estimate), size = 2) +
  geom_point(aes(year, -GtC_yr, col = estimate), size = 2, fill = "white", shape = 21) +
  scale_x_continuous(expand = c(0, 0)) +
  scale_color_manual(values = c("#BB5566", "#DDAA33"),
                     name = "ocean sink\nestimate") +
  labs(y = flux_label,
       title = "Ocean Carbon sink",
       subtitle = "Global Carbon Budget | Friedlingstein et al. (2021)") +
  theme(axis.title.x = element_blank(),
        legend.title = element_blank())

p_ocean_sinks_presentation

ggsave(path = here::here("output/presentation"),
       filename = "Fig_GCB_ocean_sinks.png",
       height = 4,
       width = 6)

p_ocean_sinks_presentation <-
  estimates_long %>%
  # mutate(estimate = str_replace(estimate, "_", " ")) %>%
  ggplot() +
  geom_path(
    data = Ocean_Sink %>% filter(year >= 1990),
    aes(year, GtC_yr, group = product, col = type),
    size = 0.3
  ) +
  geom_path(aes(year, -GtC_yr, col = estimate), size = 2) +
  geom_point(
    aes(year, -GtC_yr, col = estimate),
    size = 2,
    fill = "white",
    shape = 21
  ) +
  geom_path(
    data =             tibble(
      year = c(1994, 2007),
      estimate = "ocean_interior",
      GtC_yr = -2.6
    ),
    aes(year, -GtC_yr, col = estimate),
    size = 2
  )+
  geom_rect(
    data =             tibble(
      year_min = 1994,
      year_max = 2007,
      estimate = "ocean_interior",
      GtC_yr_min = -2.6 - 0.3,
      GtC_yr_max = -2.6 + 0.3,
    ),
    aes(xmax = year_max, xmin = year_min, ymin = -GtC_yr_min, ymax = -GtC_yr_max, col = estimate),
    fill = "transparent"
  )+
  scale_x_continuous(expand = c(0, 0)) +
  scale_color_manual(values = c("#BB5566", "#DDAA33","#004488"),
                     name = "ocean sink\nestimate") +
  labs(y = flux_label,
       title = "Ocean Carbon sink",
       subtitle = "Global Carbon Budget | Friedlingstein et al. (2021)") +
  theme(axis.title.x = element_blank(),
        legend.title = element_blank())

p_ocean_sinks_presentation

ggsave(path = here::here("output/presentation"),
       filename = "Fig_GCB_ocean_sinks_eMLR.png",
       height = 4,
       width = 6)

land_sink <-
  estimates_wide %>%
  mutate(emissions_atmosphere = `fossil emissions` +
           `land-use change emissions` +
           `atmospheric growth`) %>%
  rename(ocean_sink_gcb_mean = `ocean sink`) %>%
  select(year, emissions_atmosphere, starts_with("ocean")) %>%
  pivot_longer(
    starts_with("ocean_sink"),
    names_to = "ocean_sink_estimate",
    values_to = "ocean_sink",
    names_prefix = "ocean_sink_"
  ) %>%
  mutate(land_sink = -emissions_atmosphere - ocean_sink)


p_land_sink_residual <- land_sink %>%
  mutate(ocean_sink_estimate = 
           str_replace(ocean_sink_estimate, "_", " ")) %>% 
  ggplot() +
  geom_line(aes(year, land_sink, col = ocean_sink_estimate, linetype = "residual")) +
  geom_line(data = estimates_wide %>%
              filter(year >= 1990),
            aes(year, `land sink`, linetype = "reported")) +
  scale_x_continuous(expand = c(0, 0)) +
  scale_linetype_manual(values = c(2, 1), name = "land sink\nestimate") +
  scale_color_brewer(palette = "Set1",
                     name = "ocean sink\nestimate\nunderlying\nresidual") +
  guides(linetype = guide_legend(order = 1),
         color = guide_legend(order = 2)) +
  labs(y = flux_label,
       title = "Land sink estimates",
       subtitle = "Note: Residuals are determined for a range of ocean sink estimates") +
  theme(axis.title.x = element_blank())

p_land_sink_residual

land_sink <-
  full_join(
    land_sink,
    estimates_wide %>%
      select(year, land_sink_reported = `land sink`)
  )


p_land_sink_residual_delta <- land_sink %>%
  mutate(ocean_sink_estimate =
           str_replace(ocean_sink_estimate, "_", " ")) %>%
  ggplot() +
  geom_hline(yintercept = 0) +
  geom_line(aes(year, land_sink - land_sink_reported, col = ocean_sink_estimate)) +
  scale_x_continuous(expand = c(0, 0)) +
  scale_color_brewer(palette = "Set1",
                     name = "ocean sink\nestimate\nunderlying\nresidual") +
  labs(y = flux_label,
       title = "Land sink estimates (reported - residual)",
       subtitle = "Note: Residuals are determined for a range of ocean sink estimates") +
  theme(axis.title.x = element_blank())

p_land_sink_residual_delta

p_land_sink_residual_decade <- land_sink %>%
  mutate(period = cut(year, c(1993, 2003, 2013),
                      c("1994 - 2004", "2004 - 2014"))) %>%
  filter(!is.na(period)) %>%
  group_by(ocean_sink_estimate, period) %>%
  summarise(across(starts_with("land_sink"), list(mean = mean, sd = sd))) %>%
  ungroup() %>%
  mutate(ocean_sink_estimate =
           str_replace(ocean_sink_estimate, "_", " ")) %>%
  ggplot() +
  geom_pointrange(
    aes(
      period,
      land_sink_reported_mean,
      ymin = land_sink_reported_mean - land_sink_reported_sd,
      ymax = land_sink_reported_mean + land_sink_reported_sd,
      shape = "reported"
    ),
    position = position_dodge2(width = 0.6)
  ) +
  geom_pointrange(
    aes(
      period,
      land_sink_mean,
      ymin = land_sink_mean - land_sink_sd,
      ymax = land_sink_mean + land_sink_sd,
      col = ocean_sink_estimate,
      shape = "residual"
    ),
    position = position_dodge2(width = 0.5)
  ) +
  scale_color_brewer(palette = "Set1",
                     name = "ocean sink\nestimate\nunderlying\nresidual") +
  scale_shape_manual(values = c(17, 16), name = "land sink\nestimate") +
  guides(shape = guide_legend(order = 1),
         color = guide_legend(order = 2)) +
  theme(axis.title.x = element_blank()) +
  labs(y = flux_label,
       title = "Decadal mean land sink estimates",
       subtitle = "Note: Errorbars indicate the StDev of the IAV") +
  theme(axis.title.x = element_blank())

p_land_sink_residual_decade

pdf(
  file = here::here("output/publication/GCB_land_sink_residual.pdf"),
  height = 6,
  width = 9
)

p_stacked_fluxes
p_individual_fluxes
p_BIM
p_land_sink_gcb
p_ocean_sinks
p_land_sink_residual
p_land_sink_residual_delta
p_land_sink_residual_decade

dev.off()

rm(
  p_stacked_fluxes,
  p_individual_fluxes,
  p_BIM,
  p_land_sink_gcb,
  p_ocean_sinks,
  p_land_sink_residual,
  p_land_sink_residual_delta,
  p_land_sink_residual_decade,
  estimates,
  estimates_wide,
  land_sink,
  Ocean_Sink_annual_mean,
  flux_components,
  flux_label,
  emission_components,
  sink_components
)

```

## Net land sink


```{r GCB_net_land_sink_assesment}

flux_label <- expression(flux~(PgC~yr^{-1}))

Global_Carbon_Budget_net_land_sink <- Global_Carbon_Budget %>%
  select(year, estimate, GtC_yr) %>%
  pivot_wider(names_from = estimate,
              values_from = GtC_yr) %>%
  mutate(`net land sink` = `land sink` - `land-use change emissions`) %>%
  select(-c(`land sink`, `land-use change emissions`)) %>%
  pivot_longer(-year,
               names_to = "estimate",
               values_to = "GtC_yr")

flux_components <- Global_Carbon_Budget_net_land_sink %>% 
  distinct(estimate) %>% 
  pull()

emission_components <- flux_components[c(1,4)]
sink_components <- flux_components[c(2,3,6)]

estimates <- Global_Carbon_Budget_net_land_sink %>%
  filter(!(estimate %in% c("budget imbalance")),
         year >= 1990) %>%
  mutate(
    sign = if_else(estimate %in% sink_components,
                   "sinks",
                   "emissions"),
    GtC_yr = if_else(sign == "sinks",
                     -GtC_yr,
                     GtC_yr),
    GtC_yr = if_else(estimate == "cement carbonation sink",
                     -GtC_yr,
                     GtC_yr)
  )

emissions_sinks <- estimates %>% 
  group_by(year, sign) %>% 
  summarise(GtC_yr = sum(GtC_yr)) %>% 
  ungroup()


p_stacked_fluxes <- estimates %>%
  ggplot() +
  geom_area(aes(year, GtC_yr, fill = estimate),
            col = "white",
            alpha = 0.7,
            size = 0.5) +
  geom_line(data = emissions_sinks %>%   mutate(GtC_yr = if_else(sign == "emissions",
                                                                 -GtC_yr,
                                                                 GtC_yr)),
            aes(year, GtC_yr, linetype = sign)) +
  scale_fill_bright(name = "flux component") +
  geom_hline(yintercept = 0) +
  scale_x_continuous(expand = c(0,0)) +
  labs(y = flux_label,
       title = "Stacked emission and sink components from GCB",
       subtitle = "Note: The cement carbonation sink is accounted for in emissions") +
  theme(axis.title.x = element_blank())

p_stacked_fluxes

p_individual_fluxes <- estimates %>%
  ggplot(aes(year, GtC_yr, col = estimate)) +
  geom_hline(yintercept = 0) +
  geom_path() +
  geom_point(size = 0.5) +
  scale_x_continuous(expand = c(0, 0)) +
  scale_color_bright(name = "flux component") +
  labs(y = flux_label,
       title = "Individual flux components from GCB") +
  theme(axis.title.x = element_blank())

p_individual_fluxes


BIM <- emissions_sinks %>% 
  pivot_wider(names_from = sign,
              values_from = GtC_yr) %>% 
  mutate(BIM = emissions + sinks)

p_BIM <- ggplot() +
  geom_line(data = Global_Carbon_Budget %>%
              filter(estimate == "budget imbalance",
                     year >= 1990),
            aes(year, GtC_yr, col = "reported")) +
  geom_line(data = BIM, aes(year, BIM, col = "recalculated")) +
  geom_hline(yintercept = 0) +
  scale_color_brewer(palette = "Set1") +
  scale_x_continuous(expand = c(0, 0)) +
  labs(y = flux_label,
       title = "BIM from GCB") +
  theme(axis.title.x = element_blank(),
        legend.title = element_blank())

p_BIM

p_land_sink_gcb <- estimates %>%
  select(year, estimate, GtC_yr) %>%
  pivot_wider(names_from = estimate,
              values_from = GtC_yr) %>%
  mutate(`net land sink residual` = 
           `fossil emissions excluding carbonation` + 
           `cement carbonation sink` + 
           `atmospheric growth` + 
           `ocean sink`) %>%
  ggplot() +
  geom_line(aes(year, -`net land sink residual`, col = "residual")) +
  geom_line(aes(year, `net land sink`, col = "reported")) +
  scale_x_continuous(expand = c(0, 0)) +
  scale_color_brewer(palette = "Set1", name = "land sink\nestimate") +
  labs(y = flux_label,
       title = "Land sink estimates from GCB",
       subtitle = "Note: The offset between reported and residual estimate equals BIM") +
  theme(axis.title.x = element_blank(),
        legend.title = element_blank())

p_land_sink_gcb

Ocean_Sink_annual_mean <- Ocean_Sink %>%
  filter(year >= 1990) %>%
  group_by(year, type) %>%
  summarise(GtC_yr = -mean(GtC_yr)) %>%
  ungroup()

Ocean_Sink_annual_mean <- Ocean_Sink_annual_mean %>% 
  pivot_wider(names_from = type,
              values_from = GtC_yr,
              names_prefix = "ocean_sink_")

estimates_wide <- estimates %>%
  select(year, estimate, GtC_yr) %>%
  pivot_wider(names_from = estimate,
              values_from = GtC_yr)

estimates_wide <-
  full_join(estimates_wide, Ocean_Sink_annual_mean)

dcant_interior <- tcant_ts_zoom %>% 
  filter(year > 2000) %>%
  mutate(dcant_mean = dcant_mean/10) %>% 
  pull(dcant_mean)

cnat <-
  dcant_type_significance %>%
  filter(type == "Observation-based\nsurface flux\nproducts" ,
         period %in% two_decades) %>%
  mutate(dcant_diff = dcant_diff/10) %>% 
  pull(dcant_diff)

estimates_wide <- estimates_wide %>% 
  mutate(ocean_sink_interior_Cant = case_when(
    between(year, 1994, 2003) ~ -dcant_interior[1],
    between(year, 2004, 2013) ~ -dcant_interior[2],
    TRUE ~ NaN
  )) %>% 
  mutate(ocean_sink_interior_net = case_when(
    between(year, 1994, 2003) ~ -dcant_interior[1]-cnat[1],
    between(year, 2004, 2013) ~ -dcant_interior[2]-cnat[2],
    TRUE ~ NaN
  ))


p_ocean_sinks <- estimates_wide %>%
  select(year, starts_with("ocean")) %>% 
  rename(GCB_mean = `ocean sink`) %>% 
  pivot_longer(-year,
               names_to = "estimate",
               names_prefix = "ocean_sink_",
               values_to = "GtC_yr") %>% 
  mutate(estimate = str_replace(estimate, "_", " ")) %>% 
  ggplot(aes(year, GtC_yr, col = estimate)) +
  geom_path() +
  geom_point(size = 0.5) +
  scale_x_continuous(expand = c(0, 0)) +
  scale_color_brewer(palette = "Set1", name = "ocean sink\nestimate") +
  labs(y = flux_label,
       title = "Ocean sink estimates",
       subtitle = "Note: Watson et al. (2020) is included in data products and GCB mean") +
  theme(axis.title.x = element_blank(),
        legend.title = element_blank())

p_ocean_sinks

land_sink <-
  estimates_wide %>%
  mutate(emissions_atmosphere = `fossil emissions excluding carbonation` +
           `atmospheric growth`) %>%
  rename(ocean_sink_gcb_mean = `ocean sink`) %>%
  select(year, emissions_atmosphere, starts_with("ocean")) %>%
  pivot_longer(
    starts_with("ocean_sink"),
    names_to = "ocean_sink_estimate",
    values_to = "ocean_sink",
    names_prefix = "ocean_sink_"
  ) %>%
  mutate(net_land_sink = -emissions_atmosphere - ocean_sink)


p_land_sink_residual <- land_sink %>%
  mutate(ocean_sink_estimate = 
           str_replace(ocean_sink_estimate, "_", " ")) %>% 
  ggplot() +
  geom_line(aes(year, net_land_sink, col = ocean_sink_estimate, linetype = "residual")) +
  geom_line(data = estimates_wide %>%
              filter(year >= 1990),
            aes(year, `net land sink`, linetype = "reported")) +
  scale_x_continuous(expand = c(0, 0)) +
  scale_linetype_manual(values = c(2, 1), name = "net land sink\nestimate") +
  scale_color_brewer(palette = "Set1",
                     name = "ocean sink\nestimate\nunderlying\nresidual") +
  guides(linetype = guide_legend(order = 1),
         color = guide_legend(order = 2)) +
  labs(y = flux_label,
       title = "Net land sink estimates",
       subtitle = "Note: Residuals are determined for a range of ocean sink estimates") +
  theme(axis.title.x = element_blank())

p_land_sink_residual

land_sink <-
  full_join(
    land_sink,
    estimates_wide %>%
      select(year, net_land_sink_reported = `net land sink`)
  )


p_land_sink_residual_delta <- land_sink %>%
  mutate(ocean_sink_estimate =
           str_replace(ocean_sink_estimate, "_", " ")) %>%
  ggplot() +
  geom_hline(yintercept = 0) +
  geom_line(aes(year, net_land_sink - net_land_sink_reported, col = ocean_sink_estimate)) +
  scale_x_continuous(expand = c(0, 0)) +
  scale_color_brewer(palette = "Set1",
                     name = "ocean sink\nestimate\nunderlying\nresidual") +
  labs(y = flux_label,
       title = "Let land sink estimates (reported - residual)",
       subtitle = "Note: Residuals are determined for a range of ocean sink estimates") +
  theme(axis.title.x = element_blank())

p_land_sink_residual_delta

p_land_sink_residual_decade <- land_sink %>%
  mutate(period = cut(year, c(1993, 2003, 2013),
                      c("1994 - 2004", "2004 - 2014"))) %>%
  filter(!is.na(period)) %>%
  group_by(ocean_sink_estimate, period) %>%
  summarise(across(starts_with("net_land_sink"), list(mean = mean, sd = sd))) %>%
  ungroup() %>%
  mutate(ocean_sink_estimate =
           str_replace(ocean_sink_estimate, "_", " ")) %>%
  ggplot() +
  geom_pointrange(
    aes(
      period,
      net_land_sink_reported_mean,
      ymin = net_land_sink_reported_mean - net_land_sink_reported_sd,
      ymax = net_land_sink_reported_mean + net_land_sink_reported_sd,
      shape = "reported"
    ),
    position = position_dodge2(width = 0.6)
  ) +
  geom_pointrange(
    aes(
      period,
      net_land_sink_mean,
      ymin = net_land_sink_mean - net_land_sink_sd,
      ymax = net_land_sink_mean + net_land_sink_sd,
      col = ocean_sink_estimate,
      shape = "residual"
    ),
    position = position_dodge2(width = 0.5)
  ) +
  scale_color_brewer(palette = "Set1",
                     name = "ocean sink\nestimate\nunderlying\nresidual") +
  scale_shape_manual(values = c(17, 16), name = "land sink\nestimate") +
  guides(shape = guide_legend(order = 1),
         color = guide_legend(order = 2)) +
  theme(axis.title.x = element_blank()) +
  labs(y = flux_label,
       title = "Decadal mean land sink estimates",
       subtitle = "Note: Errorbars indicate the StDev of the IAV") +
  theme(axis.title.x = element_blank())

p_land_sink_residual_decade

pdf(
  file = here::here("output/publication/GCB_net_land_sink_residual.pdf"),
  height = 6,
  width = 9
)

p_stacked_fluxes
p_individual_fluxes
p_BIM
p_land_sink_gcb
p_ocean_sinks
p_land_sink_residual
p_land_sink_residual_delta
p_land_sink_residual_decade

dev.off()

rm(
  p_stacked_fluxes,
  p_individual_fluxes,
  p_BIM,
  p_land_sink_gcb,
  p_ocean_sinks,
  p_land_sink_residual,
  p_land_sink_residual_delta,
  p_land_sink_residual_decade,
  estimates,
  estimates_wide,
  land_sink,
  Ocean_Sink_annual_mean,
  flux_components,
  flux_label,
  emission_components,
  sink_components
)

```


# Emission removal

```{r removal_relative_to_emissions}

GCB_Cant_emissions <- Global_Carbon_Budget %>%
  mutate(year = cut(year, c(1994, 2004, 2014), c("2004", "2014")),
         year = as.numeric(as.character(year))) %>%
  drop_na() %>%
  filter(estimate %in% c(
    "fossil emissions excluding carbonation",
    "land-use change emissions"
  )) %>%
  group_by(year) %>%
  summarise(cant_emissions = sum(GtC_yr)) %>%
  ungroup()

left_join(GCB_Cant_emissions,
          tcant_ts_zoom) %>%
  mutate(
    dcant_per_emission = 100 * dcant_mean / cant_emissions,
    dcant_per_emission_sd = 100 * dcant_sd / cant_emissions
  ) %>%
  kable() %>%
  kable_styling() %>%
  scroll_box(height = "300px")

```



#### Map test color palettes

```{r inventory_maps_absolute_test_color_scales, fig.asp=0.4, eval=FALSE}

breaks <- c(-Inf, seq(0, 16, 2), Inf)

legend_title <- expression(atop(Delta * C["ant"],
                                (mol ~ m ^ {
                                  -2
                                })))

breaks_n <- length(breaks) - 1

dcant_inv_all_color_test <- dcant_inv_all %>%
  filter(data_source %in% c("obs"),
         period == "2004 - 2014") %>%
  mutate(dcant_int = cut(dcant,
                         breaks,
                         right = FALSE))

scico_continous_palettes <- c(
  "acton",
  "bamako",
  "batlow",
  "bilbao",
  "buda",
  "davos",
  "devon",
  "grayC",
  "hawaii",
  "imola",
  "lajolla",
  "lapaz",
  "nuuk",
  "oslo",
  "tokyo",
  "turku"
)

p_test_scico <- function(df, i_palette) {
  p_reg <- map +
    geom_raster(data = df,
                aes(lon, lat, fill = dcant_int)) +
    scale_fill_scico_d(
      palette = i_palette,
      drop = FALSE,
      name = legend_title,
      guide = "none"
    ) +
    labs(title = i_palette) +
    theme(axis.text = element_blank(),
          axis.ticks = element_blank())
  
  p_rev <- map +
    geom_raster(data = df,
              aes(lon, lat, fill = dcant_int)) +
    scale_fill_scico_d(
      palette = i_palette,
      drop = FALSE,
      name = legend_title,
      direction = -1,
      guide = "none"
    ) +
    labs(title = paste(i_palette, "rev")) +
    theme(axis.text = element_blank(),
          axis.ticks = element_blank())
  
  p_comb <- p_reg / p_rev
  
  return(p_comb)
}


all_plots_scico <- scico_continous_palettes %>% 
  # head(1) %>% 
  map(~p_test_scico(df = dcant_inv_all_color_test,
                      i_palette = .x))

viridis_continous_palettes <- c(
  "viridis",
  "magma",
  "inferno",
  "plasma"
)

p_test_viridis <- function(df, i_palette) {
  p_reg <- map +
    geom_raster(data = df,
                aes(lon, lat, fill = dcant_int)) +
    scale_fill_viridis_d(
      option = i_palette,
      drop = FALSE,
      name = legend_title,
      guide = "none"
    ) +
    labs(title = i_palette) +
    theme(axis.text = element_blank(),
          axis.ticks = element_blank())
  
  p_rev <- map +
    geom_raster(data = df,
              aes(lon, lat, fill = dcant_int)) +
    scale_fill_viridis_d(
      option = i_palette,
      drop = FALSE,
      name = legend_title,
      direction = -1,
      guide = "none"
    ) +
    labs(title = paste(i_palette, "rev")) +
    theme(axis.text = element_blank(),
          axis.ticks = element_blank())
  
  p_comb <- p_reg / p_rev
  
  return(p_comb)
}

all_plots_viridis <- viridis_continous_palettes %>% 
  # head(1) %>% 
  map(~p_test_viridis(df = dcant_inv_all_color_test,
                      i_palette = .x))



library(colorspace)

colorspace_continous_palettes <- c(
  # "Purple - Blue",
  # "Red - Purple",
  # "Blue - Yellow",
  # "Heat",
  # "Heat 2",
  "Rocket"
  # "Mako",
  # "Dark",
  # "Mint",
  # "Mint",
  # "BluGrn",
  # "Teal",
  # "Sunset",
  # "SunsetDark",
  # "ag_Sunset",
  # "YlOrRd",
  # "YlGnBu",
  # "RdPu"
)

p_test_colorspace <- function(df, i_palette) {
  
  i_palette <<- i_palette
  
  p_reg <- map +
    geom_raster(data = df,
                aes(lon, lat, fill = dcant_int)) +
    scale_fill_discrete_sequential(
      palette = i_palette,
      drop = FALSE,
      name = legend_title,
      guide = "none"
    ) +
    labs(title = i_palette) +
    theme(axis.text = element_blank(),
          axis.ticks = element_blank())
  
  p_rev <- map +
    geom_raster(data = df,
                aes(lon, lat, fill = dcant_int)) +
    scale_fill_discrete_sequential(
      palette = i_palette,
      drop = FALSE,
      name = legend_title,
      rev = FALSE,
      guide = "none"
    ) +
    labs(title = paste(i_palette, "rev")) +
    theme(axis.text = element_blank(),
          axis.ticks = element_blank())

  p_comb <- p_reg / p_rev
  
  return(p_comb)
  rm(i_palette)
  
}

all_plots_colorspace <- colorspace_continous_palettes %>%
  # head(2) %>%
  map(~p_test_colorspace(df = dcant_inv_all_color_test,
                           i_palette = .x))

all_plots_colorspace

all_plots <- c(all_plots_colorspace, all_plots_viridis, all_plots_scico)

pdf(here::here("output/publication/test_color_scales.pdf"),
    width = 4, height = 4)
all_plots
dev.off()

```


